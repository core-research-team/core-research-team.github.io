<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="soS2al0KuMZmiyPzu87KFbqGSn0K9edQ8EkWp_m35n0" />
  

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Oracle WebLogic Deserialization (CVE-2020-2883) (2) | Core-Research-Team</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="Oracle WebLogic Deserialization (CVE-2020-2883) (2)" />
<meta name="author" content="gpsfly" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="라온화이트햇 핵심연구팀 김동민" />
<meta property="og:description" content="라온화이트햇 핵심연구팀 김동민" />
<link rel="canonical" href="http://202.182.127.225:4000/2020-10-01/Oracle-WebLogic-Deserialization-(CVE-2020-2883)" />
<meta property="og:url" content="http://202.182.127.225:4000/2020-10-01/Oracle-WebLogic-Deserialization-(CVE-2020-2883)" />
<meta property="og:site_name" content="Core-Research-Team" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-10-01T00:00:00+00:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Oracle WebLogic Deserialization (CVE-2020-2883) (2)","dateModified":"2020-10-01T00:00:00+00:00","datePublished":"2020-10-01T00:00:00+00:00","author":{"@type":"Person","name":"gpsfly"},"url":"http://202.182.127.225:4000/2020-10-01/Oracle-WebLogic-Deserialization-(CVE-2020-2883)","mainEntityOfPage":{"@type":"WebPage","@id":"http://202.182.127.225:4000/2020-10-01/Oracle-WebLogic-Deserialization-(CVE-2020-2883)"},"description":"라온화이트햇 핵심연구팀 김동민","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.ico">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="http://202.182.127.225:4000/feed.xml" title="Core-Research-Team" />

  <!-- Google Analytics-->
  
 
</head>


  <body>

    <nav class="nav">
  <div class="nav-container">
    <a href="/">
      <h2 class="nav-title">RAON - Core Research Team</h2>
    </a>
    <ul>
      <li><a href="/about">About</a></li>
      <li><a href="/">Posts</a></li>
    </ul>
  </div>
</nav>


    <main>
      <div class="post"> 
   <h1 class="post-title">Oracle WebLogic Deserialization (CVE-2020-2883) (2)</h1>
   <div class="post-line"></div>

   
      
         
            <span class="tag"><center><i>CVE</i></center></span>
         
      
   
   
   <ul>
  <li><a href="#소개">소개</a></li>
  <li><a href="#patch-bypass">Patch Bypass</a></li>
  <li><a href="#the-full-gadget-chain">The Full Gadget Chain</a></li>
  <li><a href="#demonstrating-the-gadget-chains">Demonstrating the Gadget Chains</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
  <li><a href="#reference">Reference</a></li>
</ul>
   
   <p>라온화이트햇 핵심연구팀 김동민</p>

<h2 id="소개">소개</h2>

<p>Oracle WebLogic Deserialization (CVE-2020-2883)</p>

<p>지난 게시글(CVE-2020-2555)에 이어 해당 취약점 패치 이후 재발견된 취약점이며, ZDI 버그 리포트를 번역한 내용입니다. 또한, 이전 게시글의 확장 버전으로 많은 내용이 생략되었기 때문에 아래 링크를 통해 먼저 확인해 주시면 감사하겠습니다.</p>

<p><a href="https://core-research-team.github.io/2020-07-01/Oracle-WebLogic-Deserialization-CVE-2020-2555">Oracle WebLogic Deserialization CVE-2020-2555_1</a></p>

<h2 id="patch-bypass">Patch Bypass</h2>

<ul>
  <li>CVE-2020-2555 패치에서 아래 PoC에 대한 패치가 이루어지지 않았습니다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BadAttributeValueExpException</span><span class="o">.</span><span class="na">readObject</span><span class="o">()</span>
  <span class="n">com</span><span class="o">.</span><span class="na">tangosol</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">filter</span><span class="o">.</span><span class="na">LimitFilter</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span> <span class="c1">//&lt;--- CVE-2020-2555 patched here</span>
    <span class="n">com</span><span class="o">.</span><span class="na">tangosol</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">extractor</span><span class="o">.</span><span class="na">ChainedExtractor</span><span class="o">.</span><span class="na">extract</span><span class="o">()</span>
        <span class="n">com</span><span class="o">.</span><span class="na">tangosol</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">extractor</span><span class="o">.</span><span class="na">ReflectionExtractor</span><span class="o">().</span><span class="na">extract</span><span class="o">()</span>
            <span class="nc">Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">()</span>
            <span class="c1">//...</span>
            <span class="n">com</span><span class="o">.</span><span class="na">tangosol</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">extractor</span><span class="o">.</span><span class="na">ReflectionExtractor</span><span class="o">().</span><span class="na">extract</span><span class="o">()</span>
            <span class="nc">Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">()</span>
                <span class="nc">Runtime</span><span class="o">.</span><span class="na">exec</span><span class="o">()</span>
</code></pre></div></div>

<ul>
  <li>ChainedExtractor.extract ()를 호출하는 모든 기능은 여전히 원격 코드 실행이 발생합니다. Quynh Le 보고서에 따르면 ExtractorComparator 및 AbstractExtractor 클래스를 통해 여전히 ChainedExtractor.extract()를 호출하는 것이 가능합니다. 먼저 ExtractorComparator 클래스의 compare() 메소드를 살펴 보겠습니다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">int</span> <span class="nf">compare</span><span class="o">(</span><span class="no">T</span> <span class="n">o1</span><span class="o">,</span> <span class="no">T</span> <span class="n">o2</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Comparable</span> <span class="n">a1</span> <span class="o">=</span> <span class="o">(</span><span class="n">o1</span> <span class="k">instanceof</span> <span class="nc">InvocableMap</span><span class="o">.</span><span class="na">Entry</span><span class="o">)</span> <span class="o">?</span> <span class="o">(</span><span class="nc">Comparable</span><span class="o">)((</span><span class="nc">InvocableMap</span><span class="o">.</span><span class="na">Entry</span><span class="o">)</span><span class="n">o1</span><span class="o">).</span><span class="na">extract</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">m_extractor</span><span class="o">)</span> 
                                                                                <span class="o">:</span> <span class="o">(</span><span class="nc">Comparable</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">m_extractor</span><span class="o">.</span><span class="na">extract</span><span class="o">(</span><span class="n">o1</span><span class="o">);</span>

    
    <span class="nc">Comparable</span> <span class="n">a2</span> <span class="o">=</span> <span class="o">(</span><span class="n">o2</span> <span class="k">instanceof</span> <span class="nc">InvocableMap</span><span class="o">.</span><span class="na">Entry</span><span class="o">)</span> <span class="o">?</span> <span class="o">(</span><span class="nc">Comparable</span><span class="o">)((</span><span class="nc">InvocableMap</span><span class="o">.</span><span class="na">Entry</span><span class="o">)</span><span class="n">o2</span><span class="o">).</span><span class="na">extract</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">m_extractor</span><span class="o">)</span>
                                                                                 <span class="o">:</span> <span class="o">(</span><span class="nc">Comparable</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">m_extractor</span><span class="o">.</span><span class="na">extract</span><span class="o">(</span><span class="n">o2</span><span class="o">);</span>
    
    <span class="k">if</span> <span class="o">(</span><span class="n">a1</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
    <span class="o">{</span>
      <span class="k">return</span> <span class="o">(</span><span class="n">a2</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="k">if</span> <span class="o">(</span><span class="n">a2</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
    <span class="o">{</span>
      <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="k">return</span> <span class="n">a1</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">a2</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>위와 같이, this.m_extractor를 ChainedExtractor의 인스턴스로 세팅함으로써 ChainedExtractor.extract()를 호출하는 것이 가능합니다.</p>
  </li>
  <li>
    <p>마찬가지로, AbstractExtractor 클래스의 compare() 메소드 또한 사용가능합니다.</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">int</span> <span class="nf">compare</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o1</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">o2</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="nc">SafeComparator</span><span class="o">.</span><span class="na">compareSafe</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">extract</span><span class="o">(</span><span class="n">o1</span><span class="o">),</span> <span class="n">extract</span><span class="o">(</span><span class="n">o2</span><span class="o">));</span> <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>MultiExtractor 클래스를 사용하여 ChainedExtractor.extract() 메소드를 호출할 수 있습니다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractCompositeExtractor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">E</span><span class="o">&gt;</span>
  <span class="kd">extends</span> <span class="nc">AbstractExtractor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">E</span><span class="o">&gt;</span>
  <span class="o">[...</span><span class="na">Truncated</span><span class="o">...]</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiExtractor</span>
  <span class="kd">extends</span> <span class="nc">AbstractCompositeExtractor</span>
  <span class="o">[...</span><span class="na">Truncated</span><span class="o">...]</span>

    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">extract</span><span class="o">(</span><span class="nc">Object</span> <span class="n">oTarget</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">oTarget</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
    <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="nc">ValueExtractor</span><span class="o">[]</span> <span class="n">aExtractor</span> <span class="o">=</span> <span class="n">getExtractors</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">cExtractors</span> <span class="o">=</span> <span class="n">aExtractor</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="nc">Object</span><span class="o">[]</span> <span class="n">aValue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">cExtractors</span><span class="o">];</span>
    
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cExtractors</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
    <span class="o">{</span>
      <span class="n">aValue</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">aExtractor</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">extract</span><span class="o">(</span><span class="n">oTarget</span><span class="o">);&lt;-----------------------</span>
    <span class="o">}</span>
    
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ImmutableArrayList</span><span class="o">(</span><span class="n">aValue</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></div></div>

<h2 id="the-full-gadget-chain">The Full Gadget Chain</h2>

<ul>
  <li>full gadget chain을 개발하기 위해, readObject ()에서 임의의 Comparator.compare() 메서드를 호출할 수 있어야 합니다. 이는 ysoserial gadget에서 소개한 바와 같이 PriorityQueue 클래스를 사용하는 것 입니다.</li>
  <li><code class="highlighter-rouge">BeanShell1, Jython1, CommonsCollections2, CommonsBeanutils1, CommonsCollections4 and Groovy1</code></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">PriorityQueue</span><span class="o">.</span><span class="na">readObject</span><span class="o">()</span>
  <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">PriorityQueue</span><span class="o">.</span><span class="na">heapify</span><span class="o">()</span>
  <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">PriorityQueue</span><span class="o">.</span><span class="na">siftDown</span><span class="o">()</span>
  <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">PriorityQueue</span><span class="o">.</span><span class="na">siftDownUsingComparator</span><span class="o">()</span>
</code></pre></div></div>

<ul>
  <li>SiftUpUsingComparator()를 통해 임의의 Comparator.compare() 메서드를 호출할 수 있습니다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">siftUpUsingComparator</span><span class="o">(</span><span class="kt">int</span> <span class="n">paramInt</span><span class="o">,</span> <span class="no">E</span> <span class="n">paramE</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">paramInt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">paramInt</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">;</span>
      <span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">queue</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
      <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">comparator</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">paramE</span><span class="o">,</span> <span class="n">object</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)&lt;----------------</span>
        <span class="k">break</span><span class="o">;</span> 
      <span class="k">this</span><span class="o">.</span><span class="na">queue</span><span class="o">[</span><span class="n">paramInt</span><span class="o">]</span> <span class="o">=</span> <span class="n">object</span><span class="o">;</span>
      <span class="n">paramInt</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
    <span class="o">}</span> 
    <span class="k">this</span><span class="o">.</span><span class="na">queue</span><span class="o">[</span><span class="n">paramInt</span><span class="o">]</span> <span class="o">=</span> <span class="n">paramE</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>이를 수행하는 또 다른 방법은 아래와 같습니다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">javax</span><span class="o">.</span><span class="na">management</span><span class="o">.</span><span class="na">BadAttributeValueExpException</span><span class="o">.</span><span class="na">readObject</span><span class="o">()</span>  
  <span class="n">com</span><span class="o">.</span><span class="na">tangosol</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">sleepycat</span><span class="o">.</span><span class="na">persist</span><span class="o">.</span><span class="na">evolve</span><span class="o">.</span><span class="na">Mutations</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>
    <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">ConcurrentSkipListMap</span><span class="n">$SubMap</span><span class="o">.</span><span class="na">size</span><span class="o">()</span>
    <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">ConcurrentSkipListMap</span><span class="n">$SubMap</span><span class="o">.</span><span class="na">isBeforeEnd</span><span class="o">()</span>
      <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">ConcurrentSkipListMap</span><span class="o">.</span><span class="na">cpr</span><span class="o">()</span>
</code></pre></div></div>

<ul>
  <li>요약하면, Mutations 클래스의 toString() 메서드는 ConcurrentSkipListMap.size()를 호출할 수 있습니다. ConcurrentSkipListMap.size()에서 임의의 Comparator.compare() 메서드를 호출할 수 있습니다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ConcurrentSkipListMap</span><span class="n">$SubMap</span><span class="o">.</span><span class="na">class</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Comparator</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">cmp</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">comparator</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">ConcurrentSkipListMap</span><span class="o">.</span><span class="na">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">loNode</span><span class="o">(</span><span class="n">cmp</span><span class="o">);</span>
            <span class="n">isBeforeEnd</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">cmp</span><span class="o">);</span> <span class="o">&lt;---------------------------------------------------</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">n</span><span class="o">.</span><span class="na">getValidValue</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="o">++</span><span class="n">count</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">?</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">:</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">count</span><span class="o">;</span>
        <span class="o">}</span>
  <span class="o">[...</span><span class="na">Truncated</span><span class="o">...]</span>
    
  <span class="kt">boolean</span> <span class="nf">isBeforeEnd</span><span class="o">(</span><span class="nc">ConcurrentSkipListMap</span><span class="o">.</span><span class="na">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">n</span><span class="o">,</span> <span class="nc">Comparator</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">cmp</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">....</span>
        <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">cpr</span><span class="o">(</span><span class="n">cmp</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">hi</span><span class="o">);&lt;------------------------------------------------------</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hiInclusive</span><span class="o">))</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> 
  <span class="o">[...</span><span class="na">Truncated</span><span class="o">...]</span>
  
  <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">cpr</span><span class="o">(</span><span class="nc">Comparator</span> <span class="n">c</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">x</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">y</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">c</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">:</span> <span class="o">((</span><span class="nc">Comparable</span><span class="o">)</span><span class="n">x</span><span class="o">).</span><span class="na">compareTo</span><span class="o">(</span><span class="n">y</span><span class="o">);</span> <span class="o">&lt;--------</span>
    <span class="o">}</span>
</code></pre></div></div>

<h2 id="demonstrating-the-gadget-chains">Demonstrating the Gadget Chains</h2>

<ul>
  <li>위의 방법을 사용하여 ExtractorComparator을 통한 full gadget chain이 구성되었습니다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">javax</span><span class="o">.</span><span class="na">management</span><span class="o">.</span><span class="na">BadAttributeValueExpException</span><span class="o">.</span><span class="na">readObject</span><span class="o">()</span>  
  <span class="n">com</span><span class="o">.</span><span class="na">tangosol</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">sleepycat</span><span class="o">.</span><span class="na">persist</span><span class="o">.</span><span class="na">evolve</span><span class="o">.</span><span class="na">Mutations</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>
    <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">ConcurrentSkipListMap</span><span class="n">$SubMap</span><span class="o">.</span><span class="na">size</span><span class="o">()</span>
    <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">ConcurrentSkipListMap</span><span class="n">$SubMap</span><span class="o">.</span><span class="na">isBeforeEnd</span><span class="o">()</span>
      <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">ConcurrentSkipListMap</span><span class="o">.</span><span class="na">cpr</span><span class="o">()</span>
        <span class="n">com</span><span class="o">.</span><span class="na">tangosol</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">comparator</span><span class="o">.</span><span class="na">ExtractorComparator</span><span class="o">.</span><span class="na">compare</span><span class="o">()</span>
</code></pre></div></div>

<ul>
  <li>AbstractExtractor 의 경우 아래와 같은 체인이 사용되었습니다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">PriorityQueue</span><span class="o">.</span><span class="na">readObject</span><span class="o">()</span>
  <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">PriorityQueue</span><span class="o">.</span><span class="na">heapify</span><span class="o">()</span>
  <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">PriorityQueue</span><span class="o">.</span><span class="na">siftDown</span><span class="o">()</span>
  <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">PriorityQueue</span><span class="o">.</span><span class="na">siftDownUsingComparator</span><span class="o">()</span>
  <span class="n">com</span><span class="o">.</span><span class="na">tangosol</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">extractor</span><span class="o">.</span><span class="na">AbstractExtractor</span><span class="o">.</span><span class="na">compare</span><span class="o">()</span>
    <span class="n">com</span><span class="o">.</span><span class="na">tangosol</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">extractor</span><span class="o">.</span><span class="na">MultiExtractor</span><span class="o">.</span><span class="na">extract</span><span class="o">()</span>
      <span class="n">com</span><span class="o">.</span><span class="na">tangosol</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">extractor</span><span class="o">.</span><span class="na">ChainedExtractor</span><span class="o">.</span><span class="na">extract</span><span class="o">()</span>
        <span class="c1">//...</span>
        <span class="nc">Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">()</span>
            <span class="c1">//...</span>
          <span class="nc">Runtime</span><span class="o">.</span><span class="na">exec</span><span class="o">()</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<ul>
  <li>위 가젯을 사용하여 이전 게시글과 동일한 익스플로잇을 할 수 있으며, 이러한 Deserialize 취약점들이 여전히 많이 존재할 수 있음을 확인 하였습니다.</li>
  <li>오라클 블로그에서 T3/T3S 프로토콜 트래픽을 제한하는 방법등 과 같이 임시 조치 방안이 제시되어 있습니다.</li>
  <li>또한, 해당 취약점에 대한 패치는 2020년 7월 14일에 릴리즈 되었기 때문에 현재 바로 패치버전을 받을 수 있습니다.</li>
</ul>

<h2 id="reference">Reference</h2>

<ul>
  <li><a href="https://www.thezdi.com/blog/2020/5/8/details-on-the-oracle-weblogic-vulnerability-being-exploited-in-the-wild">https://www.thezdi.com/blog/2020/5/8/details-on-the-oracle-weblogic-vulnerability-being-exploited-in-the-wild</a></li>
  <li><a href="https://www.zerodayinitiative.com/advisories/ZDI-20-570/">https://www.zerodayinitiative.com/advisories/ZDI-20-570/</a></li>
  <li><a href="https://us-cert.cisa.gov/ncas/current-activity/2020/05/01/unpatched-oracle-weblogic-servers-vulnerable-cve-2020-2883">https://us-cert.cisa.gov/ncas/current-activity/2020/05/01/unpatched-oracle-weblogic-servers-vulnerable-cve-2020-2883</a></li>
  <li><a href="https://www.zerodayinitiative.com/blog/2020/3/5/cve-2020-2555-rce-through-a-deserialization-bug-in-oracles-weblogic-server">https://www.zerodayinitiative.com/blog/2020/3/5/cve-2020-2555-rce-through-a-deserialization-bug-in-oracles-weblogic-server</a></li>
  <li><a href="https://core-research-team.github.io/2020-07-01/Oracle-WebLogic-Deserialization-CVE-2020-2555">https://core-research-team.github.io/2020-07-01/Oracle-WebLogic-Deserialization-CVE-2020-2555</a></li>
</ul>

   </div>
</div>


  <!-- Start disqus 
<script src="/assets/js/disqusLoader.js" /></script>
<div id="disqus_thread"><h3>Discussion and feedback</h3></div>
<div class="disqus"></div>
<script>
    disqusLoader('.disqus', {
        scriptUrl: 'https://jekyll-tale.disqus.com/embed.js'
    });
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
End disqus -->


<div class="pagination">
  
   <a href="/2020-10-01/hybrid-fuzzing-1315f7575836434785ab9885c31279b7" class="left arrow">&#8592;</a>
  
  
   <a href="/2020-10-01/Midnightsun-CTF-Final-Maze-WriteUp-3d95f806977a4a09a3c265a00e98d62d" class="right arrow">&#8594;</a>
  

  <a href="#" class="top">Top</a>
</div>
    </main>

    <!--footer>
  <span>
    &copy; <time datetime="2021-01-07 01:13:56 +0000">2021</time> Core-Research-Team. Made with Jekyll using the <a href="https://github.com/chesterhow/tale/">Tale</a> theme.
  </span>
</footer-->

  </body>
</html>
