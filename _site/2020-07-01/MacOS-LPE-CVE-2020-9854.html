<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="soS2al0KuMZmiyPzu87KFbqGSn0K9edQ8EkWp_m35n0" />
  

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>MacOS LPE CVE-2020-9854 | Core-Research-Team</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="MacOS LPE CVE-2020-9854" />
<meta name="author" content="hkkiw0823" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="라온화이트햇 핵심연구팀 강인욱" />
<meta property="og:description" content="라온화이트햇 핵심연구팀 강인욱" />
<link rel="canonical" href="http://localhost:4000/2020-07-01/MacOS-LPE-CVE-2020-9854" />
<meta property="og:url" content="http://localhost:4000/2020-07-01/MacOS-LPE-CVE-2020-9854" />
<meta property="og:site_name" content="Core-Research-Team" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-01T00:00:00+00:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"MacOS LPE CVE-2020-9854","dateModified":"2020-07-01T00:00:00+00:00","datePublished":"2020-07-01T00:00:00+00:00","author":{"@type":"Person","name":"hkkiw0823"},"url":"http://localhost:4000/2020-07-01/MacOS-LPE-CVE-2020-9854","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020-07-01/MacOS-LPE-CVE-2020-9854"},"description":"라온화이트햇 핵심연구팀 강인욱","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.ico">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Core-Research-Team" />

  <!-- Google Analytics-->
  
 
</head>


  <body>

    <nav class="nav">
  <div class="nav-container">
    <a href="/">
      <h2 class="nav-title">RAON - Core Research Team</h2>
    </a>
    <ul>
      <li><a href="/about">About</a></li>
      <li><a href="/">Posts</a></li>
    </ul>
  </div>
</nav>


    <main>
      <div class="post"> 
   <h1 class="post-title">MacOS LPE CVE-2020-9854</h1>
   <div class="post-line"></div>

   
      
         
            <span class="tag"><center><i>CVE</i></center></span>
         
      
   
   
   <ul>
  <li><a href="#macos-lpe-cve-2020-9854">MacOS LPE CVE-2020-9854</a></li>
</ul>
   
   <p>라온화이트햇 핵심연구팀 강인욱</p>

<h1 id="macos-lpe-cve-2020-9854">MacOS LPE CVE-2020-9854</h1>

<p>MacOS 10.15.5 이하 에서 root 권한을 획득할 수 있는 취약점이 나왔다. 이 취약점에 대해 알아보자</p>

<h3 id="취약점1">취약점1</h3>

<p>첫 번째 취약점은 authd(Security.framework)에서 발생하는 취약점이다. 이 프레임워크는 키 체인 엑세스, 코드 서명 및 권한 부여를 포함한 보안 관련 상항을 관리한다.</p>

<p>사전 등록된 권한과 지원하는 rule은 아래의 URL에서 확인할 수 있다.</p>

<p><a href="https://opensource.apple.com/source/Security/Security-59306.11.20/OSX/authd/authorization.plist.auto.html">https://opensource.apple.com/source/Security/Security-59306.11.20/OSX/authd/authorization.plist.auto.html</a></p>

<p>해당 rule을 사용하면 rule 자격을 갖기 위해 클라이언트에게 필요한 권한을 매우 상세하게 제어할 수 있다. 일부 권한은 아래와 같이 팝업 대화상자에 비밀번호를 입력해야 한다.</p>

<p><img src="/assets/authd_popup.png" alt="/assets/authd_popup.png" /></p>

<p>authd 코드를 살펴보면 process.c 에서 재미있는 부분이 있다고 한다. 클라이언트로부터 코드 서명 관련 정보를 가져오는 코드 라인은 아래와 같다.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>

    <span class="nx">status</span> <span class="o">=</span> <span class="nx">SecCodeCopySigningInformation</span><span class="p">(</span><span class="nx">codeRef</span><span class="p">,</span> <span class="nx">kSecCSRequirementInformation</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">code_info</span><span class="p">);</span> <span class="c1">// [1]</span>
    <span class="nx">require_noerr_action</span><span class="p">(</span><span class="nx">status</span><span class="p">,</span> <span class="nx">done</span><span class="p">,</span> <span class="nx">os_log_debug</span><span class="p">(</span><span class="nx">AUTHD_LOG</span><span class="p">,</span> <span class="dl">"</span><span class="s2">process: PID %d SecCodeCopySigningInformation failed with %d</span><span class="dl">"</span><span class="p">,</span> <span class="nx">proc</span><span class="o">-&gt;</span><span class="nx">auditInfo</span><span class="p">.</span><span class="nx">pid</span><span class="p">,</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nx">status</span><span class="p">));</span>

    <span class="c1">// ...</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">CFDictionaryGetValueIfPresent</span><span class="p">(</span><span class="nx">code_info</span><span class="p">,</span> <span class="nx">kSecCodeInfoEntitlementsDict</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">CFGetTypeID</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">==</span> <span class="nx">CFDictionaryGetTypeID</span><span class="p">())</span> <span class="p">{</span>
            <span class="nx">proc</span><span class="o">-&gt;</span><span class="nx">code_entitlements</span> <span class="o">=</span> <span class="nx">CFDictionaryCreateCopy</span><span class="p">(</span><span class="nx">kCFAllocatorDefault</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span> <span class="c1">// [2]</span>
        <span class="p">}</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nx">NULL</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>코드에서 보듯이 클라이언트로 부터 데이터를 검색하기 위해 SecCodeCopySigningInformation 를 호출하고 자격을 찾으면 해당 값을 dict로 복사한다.</p>

<p>자 여기서 문제는 Apple 개발자 문서를 보면SecCodeCopySigningInformation의 문제를 알 수 있다고 한다.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">If</span> <span class="nx">the</span> <span class="nx">signing</span> <span class="nx">data</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">code</span> <span class="nx">is</span> <span class="nx">corrupt</span> <span class="nx">or</span> <span class="nx">invalid</span><span class="p">,</span> <span class="k">this</span> <span class="kd">function</span> <span class="nx">may</span> <span class="nx">fail</span> <span class="nx">or</span> <span class="nx">it</span> 
 <span class="nx">may</span> <span class="k">return</span> <span class="nx">partial</span> <span class="nx">data</span><span class="p">.</span> <span class="nx">To</span> <span class="nx">ensure</span> <span class="nx">that</span> <span class="nx">only</span> <span class="nx">valid</span> <span class="nx">data</span> <span class="nx">is</span> <span class="nx">returned</span> <span class="p">(</span><span class="nx">and</span> <span class="nx">errors</span> <span class="nx">are</span> 
 <span class="nx">raised</span> <span class="k">for</span> <span class="nx">invalid</span> <span class="nx">data</span><span class="p">),</span> <span class="nx">you</span> <span class="nx">must</span> <span class="nx">successfully</span> <span class="nx">call</span> <span class="nx">the</span> <span class="nx">SecCodeCheckValidity</span> <span class="nx">or</span> 
 <span class="nx">SecCodeCheckValidityWithErrors</span> <span class="kd">function</span> <span class="nx">before</span> <span class="nx">calling</span> <span class="nx">SecCodeCopySigningInformation</span><span class="p">.</span>
</code></pre></div></div>

<p>SecCodeCheckValidity의 기능은 디스크의 클라언트 바이너리를 CDHash와 비교하여 무결성을 확인한다. 하지만 이런 일이 절대 발생하지 않기 때문에 “authd”의 제재를 받지 않고 임의의 권한을 부여할 수 있다.</p>

<p>이제 “authd”가 어떤 권한에 관심이 있는지 알아 내야한다. 이것은 “authd” 내부적으로 프로세스가 필요한 권한을 가지고 있는지 확인하기 위해 사용 하는 함수이다.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">bool</span>
<span class="nx">process_has_entitlement_for_right</span><span class="p">(</span><span class="nx">process_t</span> <span class="nx">proc</span><span class="p">,</span> <span class="kd">const</span> <span class="nx">char</span> <span class="o">*</span> <span class="nx">right</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nx">bool</span> <span class="nx">entitled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">require</span><span class="p">(</span><span class="nx">right</span> <span class="o">!=</span> <span class="nx">NULL</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>

    <span class="nx">CFTypeRef</span> <span class="nx">rights</span> <span class="o">=</span> <span class="nx">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">proc</span><span class="o">-&gt;</span><span class="nx">code_entitlements</span> <span class="o">&amp;&amp;</span> <span class="nx">CFDictionaryGetValueIfPresent</span><span class="p">(</span><span class="nx">proc</span><span class="o">-&gt;</span><span class="nx">code_entitlements</span><span class="p">,</span> <span class="nx">CFSTR</span><span class="p">(</span><span class="dl">"</span><span class="s2">com.apple.private.AuthorizationServices</span><span class="dl">"</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">rights</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// [3]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">CFGetTypeID</span><span class="p">(</span><span class="nx">rights</span><span class="p">)</span> <span class="o">==</span> <span class="nx">CFArrayGetTypeID</span><span class="p">())</span> <span class="p">{</span>
            <span class="nx">CFStringRef</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">CFStringCreateWithCStringNoCopy</span><span class="p">(</span><span class="nx">kCFAllocatorDefault</span><span class="p">,</span> <span class="nx">right</span><span class="p">,</span> <span class="nx">kCFStringEncodingUTF8</span><span class="p">,</span> <span class="nx">kCFAllocatorNull</span><span class="p">);</span>
            <span class="nx">require</span><span class="p">(</span><span class="nx">key</span> <span class="o">!=</span> <span class="nx">NULL</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
            
            <span class="nx">CFIndex</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">CFArrayGetCount</span><span class="p">(</span><span class="nx">rights</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">CFIndex</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">CFEqual</span><span class="p">(</span><span class="nx">CFArrayGetValueAtIndex</span><span class="p">(</span><span class="nx">rights</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span> <span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">entitled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">CFReleaseSafe</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
<span class="nl">done</span><span class="p">:</span>
    <span class="k">return</span> <span class="nx">entitled</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>보시다시피 해당 문자열의 “com.apple.private.AuthorizationServices”  자격을 가진 것을 찾는다. 이는 array-string으로 되어 있다.</p>

<p>트리거하는 법은 아래와 같다.</p>

<ol>
  <li>원하는 자격으로 파일을 만든다. (예를 들면 system.install.apple-software )</li>
</ol>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="p">?</span><span class="nx">xml</span> <span class="nx">version</span><span class="o">=</span><span class="dl">"</span><span class="s2">1.0</span><span class="dl">"</span> <span class="nx">encoding</span><span class="o">=</span><span class="dl">"</span><span class="s2">UTF-8</span><span class="dl">"</span><span class="p">?</span><span class="o">&gt;</span>
<span class="p">&lt;</span><span class="err">!</span><span class="nc">DOCTYPE</span> <span class="nt">plist</span> <span class="nc">PUBLIC</span> <span class="err">"-</span><span class="c1">//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span>
<span class="err">&lt;</span><span class="nt">plist</span> <span class="na">version=</span><span class="s2">"1.0"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">dict</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">key</span><span class="p">&gt;</span>com.apple.private.AuthorizationServices<span class="p">&lt;/</span><span class="nt">key</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">array</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;</span>system.install.apple-software<span class="p">&lt;/</span><span class="nt">string</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">array</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">dict</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">plist</span><span class="p">&gt;</span>
</code></pre></div></div>

<ol>
  <li>프로그램을 작성하고 잠시 기다린 후 AuthorizationRef를 생성하고 “authd”에 권한을 요청한다.</li>
  <li>프로그램을 기다리는 동안, “codesign -f -s - –entitlements entitlements.xml ./test”를 실행한다.</li>
  <li>“authd”로그를 확인한다. 그러면 아래와 같은 것을 볼 수 있다.</li>
</ol>

<p><img src="/assets/log_authd.png" alt="/assets/log_authd.png" /></p>

<p>왜 프로그램을 실행하기 전에 코드사인을 먼저 해야하는지 궁금하다면 AppleMobileFileIntegretyDaemon 이 데몬 때문이다.</p>

<p>이 데몬은 바이너리의 자격과 서명을 검증하는 데몬인데, Apple이 서명하지 않은 프로그램이므로 권한이 제한되어 있기 때문에 실행할 수 없다.</p>

<p>authorization.plist를 분석하면 해당 권한을 보유하여 기본 사용자가 다음 권한을 얻을 수 있다.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Right</span>                                        <span class="nx">Private</span> <span class="nx">Framework</span> <span class="nx">implementing</span> <span class="nx">API</span>

<span class="nx">system</span><span class="p">.</span><span class="nx">install</span><span class="p">.</span><span class="nx">apple</span><span class="o">-</span><span class="nx">software</span>               <span class="c1">// PackageKit.framework/InstallKit.framework</span>
<span class="nx">system</span><span class="p">.</span><span class="nx">preferences</span><span class="p">.</span><span class="nx">nvram</span>                    <span class="c1">// SystemAdministrator.framework</span>
<span class="nx">com</span><span class="p">.</span><span class="nx">apple</span><span class="p">.</span><span class="nx">uninstalld</span><span class="p">.</span><span class="nx">uninstall</span>              <span class="c1">// Uninstall.framework</span>
<span class="nx">com</span><span class="p">.</span><span class="nx">apple</span><span class="p">.</span><span class="nx">opendirectoryd</span><span class="p">.</span><span class="nx">linkidentity</span>
<span class="nx">com</span><span class="p">.</span><span class="nx">apple</span><span class="p">.</span><span class="nx">ServiceManagement</span><span class="p">.</span><span class="nx">daemons</span><span class="p">.</span><span class="nx">modify</span>  <span class="c1">// ServiceManagement.framework</span>
<span class="nx">system</span><span class="p">.</span><span class="nx">services</span><span class="p">.</span><span class="nx">directory</span><span class="p">.</span><span class="nx">configure</span>
<span class="nx">com</span><span class="p">.</span><span class="nx">apple</span><span class="p">.</span><span class="nx">trust</span><span class="o">-</span><span class="nx">settings</span><span class="p">.</span><span class="nx">user</span>
<span class="nx">system</span><span class="p">.</span><span class="nx">install</span><span class="p">.</span><span class="nx">apple</span><span class="o">-</span><span class="nx">config</span><span class="o">-</span><span class="nx">data</span>            <span class="c1">// PackageKit.framework/InstallKit.framework</span>
<span class="nx">system</span><span class="p">.</span><span class="nx">services</span><span class="p">.</span><span class="nx">networkextension</span><span class="p">.</span><span class="nx">filtering</span>
<span class="nx">system</span><span class="p">.</span><span class="nx">install</span><span class="p">.</span><span class="nx">software</span><span class="p">.</span><span class="nx">iap</span>                 <span class="c1">// PackageKit.framework/InstallKit.framework</span>
<span class="nx">system</span><span class="p">.</span><span class="nx">install</span><span class="p">.</span><span class="nx">software</span><span class="p">.</span><span class="nx">mdm</span><span class="o">-</span><span class="nx">provided</span>        <span class="c1">// PackageKit.framework/InstallKit.framework</span>
<span class="nx">system</span><span class="p">.</span><span class="nx">install</span><span class="p">.</span><span class="nx">apple</span><span class="o">-</span><span class="nx">software</span><span class="p">.</span><span class="nx">standard</span><span class="o">-</span><span class="nx">user</span> <span class="c1">// PackageKit.framework/InstallKit.framework</span>
<span class="nx">system</span><span class="p">.</span><span class="nx">services</span><span class="p">.</span><span class="nx">systemconfiguration</span><span class="p">.</span><span class="nx">network</span>
<span class="nx">com</span><span class="p">.</span><span class="nx">apple</span><span class="p">.</span><span class="nx">activitymonitor</span><span class="p">.</span><span class="nx">kill</span>              <span class="c1">// Activicymonitor?</span>
<span class="nx">com</span><span class="p">.</span><span class="nx">apple</span><span class="p">.</span><span class="nx">XType</span><span class="p">.</span><span class="nx">fontmover</span><span class="p">.</span><span class="nx">restore</span>
<span class="nx">com</span><span class="p">.</span><span class="nx">apple</span><span class="p">.</span><span class="nx">security</span><span class="p">.</span><span class="nx">assessment</span><span class="p">.</span><span class="nx">update</span>
<span class="nx">system</span><span class="p">.</span><span class="nx">services</span><span class="p">.</span><span class="nx">networkextension</span><span class="p">.</span><span class="nx">vpn</span>
<span class="nx">com</span><span class="p">.</span><span class="nx">apple</span><span class="p">.</span><span class="nx">SoftwareUpdate</span><span class="p">.</span><span class="nx">scan</span>               <span class="c1">// SoftwareUpdate.framework/InstallKit.framework</span>
<span class="nx">com</span><span class="p">.</span><span class="nx">apple</span><span class="p">.</span><span class="nx">SoftwareUpdate</span><span class="p">.</span><span class="nx">modify</span><span class="o">-</span><span class="nx">settings</span>    <span class="c1">// SoftwareUpdate.framework/InstallKit.framework</span>
<span class="nx">system</span><span class="p">.</span><span class="nx">preferences</span><span class="p">.</span><span class="nx">security</span><span class="p">.</span><span class="nx">remotepair</span>
</code></pre></div></div>

<p>우리에게는 system.install.* 권한이 있다. PackageKit.framework 을 분석하면 흥미로운 API가 있음을 알 수 있다. 이 권한은 SIP로 보호되지 않은 위치에 Apple 서명 패키지를 설치할 수 있다.</p>

<h3 id="취약점2">취약점2</h3>

<p>PKG 파일은 기본적으로 설치할 파일, 코드 서명 및 pre/post-install 스크립트를 포함하는 아카이브이다. 이 pkgutil 유틸리티를 사용하면 이러한 아카이브의 내용을 추출할 수 있다.</p>

<p>일반적으로 pre/post-install 스크립트는 “installd”에 의해 root 권한으로 실행된다. 그러나 우리는 Apple이 서명하지 않았기 때문에 악의적인 스크립트를 사용하여 자체 패키지를 만들 수 없다.</p>

<p>그렇다면 Apple이 서명한 패키지를 찾은 경우 어떻게하면 이러한 스크립트 중 하나를 가로챌 수 있을까?</p>

<p>패키지가 Apple에 의해 서명된 경우, 스크립트는 “installd” 의해 실행되지 않고 “system_installd”에 실행 된다.</p>

<p>“system_installd”의 차이점은 “com.apple.rootless.install.heritable” 자격을 가지고 있다. 이 뜻은 모든 자식 프로세스가 SIP 제한 없이 실행된다는 것이다.</p>

<p>그렇다면 서명된 Apple 패키지를 어디서 찾을 수 있을까?</p>

<p>아래의 링크에서 찾을 수 있다.</p>

<p><a href="https://idmsa.apple.com/IDMSWebAuth/signin?appIdKey=891bd3417a7776362562d2197f89480a8547b108fd934911bcbea0110d07f757&amp;path=%2Fdownload%2Fmore%2F&amp;rv=1">https://idmsa.apple.com/IDMSWebAuth/signin?appIdKey=891bd3417a7776362562d2197f89480a8547b108fd934911bcbea0110d07f757&amp;path=%2Fdownload%2Fmore%2F&amp;rv=1</a></p>

<p>해당 링크를 보면 macOSPublicBetaAccessUtility.pkg에서 경로가 일치하는 한 높은 권한을 가진 실행 파일을 위조할 수 있는 걸 볼 수 있다.</p>

<p><img src="/assets/systeminstalld_script.png" alt="/assets/systeminstalld_script.png" /></p>

<h3 id="취약점3">취약점3</h3>

<p>이미 SIP 우회와 루트 권한으로 코드 실행을 할 수 있고 커널 코드 실행을 하기 위한 방법은 “kextutil”이다. 이 유틸리티는 커널 모듈을 로드/언로드 할 수 있다.</p>

<p>SIP이 비활성화된 시스템에서 커널 모듈을 로드하려는 경우 루트로 충분하다. 하지만 SIP이 있는 시스템에서는 Apple이 서명한 확장만 로드할 수 있다.</p>

<p>이론적으로 kextutil이 kext를 한 번만 열어 모든 파일을 로드하고 검사를 수행 한 다음 메모리에서 파일을 로드하면 문제가 없다. 파일 디스크립터를 사용하면 이 문제를 완화 할 수 있지만 실제로는 kext가 확인되는 시점과 커널에 로드되는 시점 사이에 경쟁 조건이 있다.</p>

<p>아래의 방법으로 100% 레이스 컨디션을 성공시킬 수 있다.</p>

<ol>
  <li>Apple의 서명이된 커널 모듈을 non-SIP protected인 곳(ex. acfs.kext)으로 복사한다.</li>
  <li>kextutl -interactive /tmp/acfs.text를 실행한다. (ktextutil이 자동으로 서명을 검증할 것이다.)</li>
  <li>바이너리를 덮어쓴다. (ex. mv kernelHax /Library/StagedExtensions/private/tmp/acfs.kext/Contents/MacOS/acfs)</li>
  <li>kextutil에 계속하도록 요청을 보내고 악성코드를 포함한 kext를 커널에 로드 한다.</li>
  <li>kextutil에 한번더 계속하도록 요청을 보내면 커널 모듈이 동작하도록 작동할 것이다.</li>
</ol>

<p>전체 인스플로잇 링크</p>

<p><a href="https://github.com/A2nkF/unauthd">https://github.com/A2nkF/unauthd</a></p>

   </div>
</div>


  <!-- Start disqus 
<script src="/assets/js/disqusLoader.js" /></script>
<div id="disqus_thread"><h3>Discussion and feedback</h3></div>
<div class="disqus"></div>
<script>
    disqusLoader('.disqus', {
        scriptUrl: 'https://jekyll-tale.disqus.com/embed.js'
    });
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
End disqus -->


<div class="pagination">
  
   <a href="/2020-07-01/Oracle-WebLogic-Deserialization-CVE-2020-2555" class="left arrow">&#8592;</a>
  
  
   <a href="/2020-07-01/Keylogger-and-Other-Functions" class="right arrow">&#8594;</a>
  

  <a href="#" class="top">Top</a>
</div>
    </main>

    <!--footer>
  <span>
    &copy; <time datetime="2020-09-02 13:28:59 +0000">2020</time> Core-Research-Team. Made with Jekyll using the <a href="https://github.com/chesterhow/tale/">Tale</a> theme.
  </span>
</footer-->

  </body>
</html>
