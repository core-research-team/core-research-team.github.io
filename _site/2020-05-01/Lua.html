<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="soS2al0KuMZmiyPzu87KFbqGSn0K9edQ8EkWp_m35n0" />
  

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Lua 기반의 후킹 스크립트 기능 구현에 대한 연구 | Core-Research-Team</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="Lua 기반의 후킹 스크립트 기능 구현에 대한 연구" />
<meta name="author" content="badspell" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="라온화이트햇 핵심연구팀 김재성" />
<meta property="og:description" content="라온화이트햇 핵심연구팀 김재성" />
<link rel="canonical" href="http://localhost:4000/2020-05-01/Lua" />
<meta property="og:url" content="http://localhost:4000/2020-05-01/Lua" />
<meta property="og:site_name" content="Core-Research-Team" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-01T00:00:00+00:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Lua 기반의 후킹 스크립트 기능 구현에 대한 연구","dateModified":"2020-05-01T00:00:00+00:00","datePublished":"2020-05-01T00:00:00+00:00","author":{"@type":"Person","name":"badspell"},"url":"http://localhost:4000/2020-05-01/Lua","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020-05-01/Lua"},"description":"라온화이트햇 핵심연구팀 김재성","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.ico">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Core-Research-Team" />

  <!-- Google Analytics-->
  
 
</head>


  <body>

    <nav class="nav">
  <div class="nav-container">
    <a href="/">
      <h2 class="nav-title">RAON - Core Research Team</h2>
    </a>
    <ul>
      <li><a href="/about">About</a></li>
      <li><a href="/">Posts</a></li>
    </ul>
  </div>
</nav>


    <main>
      <div class="post"> 
   <h1 class="post-title">Lua 기반의 후킹 스크립트 기능 구현에 대한 연구</h1>
   <div class="post-line"></div>

   
      
         
            <span class="tag"><center><i>Reversing</i></center></span>
         
      
   
   
   <ul>
  <li><a href="#1-개요">1. 개요</a></li>
  <li><a href="#2-lua-설치-및-예제">2. Lua 설치 및 예제</a></li>
  <li><a href="#3-후킹-스크립트-기능-구현">3. 후킹 스크립트 기능 구현</a></li>
  <li><a href="#4-실행--테스트">4. 실행 / 테스트</a></li>
  <li><a href="#5-마치며">5. 마치며</a></li>
</ul>
   
   <p>라온화이트햇 핵심연구팀 김재성</p>

<h1 id="1-개요">1. 개요</h1>

<hr />

<p>Lua는 C/C++에 이식되는 것을 염두하고 개발된 작고 가벼운 스크립트 언어입니다. 이미 작성된 프로그램의 컴파일 없이 코드를 실시간으로 변경할 수 있기 때문에 특히 게임에서 많이 활용되고 있는데 본문에서는 사용자가 함수 후킹을 쉽게 할 수 있도록 후킹 스크립트를 제공하는 목적으로 활용, 연구해보았습니다.</p>

<h1 id="2-lua-설치-및-예제">2. Lua 설치 및 예제</h1>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt <span class="nb">install</span> <span class="nt">-y</span> lua5.3 liblua5.3-dev
</code></pre></div></div>

<p>운영체제 Ubuntu 18.04 기준으로 위와 같은 명령어로 Lua을 쉽게 설치할 수 있습니다.</p>

<p>정상적으로 설치되었다면 python처럼 인터프리터를 사용하여 <code class="highlighter-rouge">Hello world</code>를 출력할 수 있습니다.</p>

<p><img src="/assets/2ec542e0-bc45-4750-a6bb-ee28a0d8810c/10788588-caf9-4202-b016-6760b1a1e1cb.png" alt="/assets/2ec542e0-bc45-4750-a6bb-ee28a0d8810c/10788588-caf9-4202-b016-6760b1a1e1cb.png" /></p>

<p><strong>lua-example.c</strong></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//gcc -o lua-example lua-example.c -llua5.3</span>
<span class="cp">#include "lua5.3/lua.h"
#include "lua5.3/lualib.h"
#include "lua5.3/lauxlib.h"
#include &lt;stdio.h&gt;
</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">c_xor</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">long</span> <span class="n">argv_1</span> <span class="o">=</span> <span class="n">lua_tointeger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kt">long</span> <span class="n">argv_2</span> <span class="o">=</span> <span class="n">lua_tointeger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="kt">long</span> <span class="n">result</span> <span class="o">=</span> <span class="n">argv_1</span> <span class="o">^</span> <span class="n">argv_2</span><span class="p">;</span>

    <span class="n">lua_pushinteger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">sum</span><span class="p">;</span>
    <span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">;</span>

    <span class="n">L</span> <span class="o">=</span> <span class="n">luaL_newstate</span><span class="p">();</span>

    <span class="n">luaL_openlibs</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>

    <span class="n">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">c_xor</span><span class="p">);</span>
    <span class="n">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">"c_xor"</span><span class="p">);</span>
    
    <span class="n">luaL_dofile</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">"script.lua"</span><span class="p">);</span>
    <span class="n">lua_close</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>script.lua</strong></p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">printf</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<span class="k">end</span>

<span class="n">x</span> <span class="o">=</span> <span class="mi">123</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">456</span>
<span class="n">printf</span><span class="p">(</span><span class="s2">"%d ^ %d = %d"</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c_xor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</code></pre></div></div>

<p>위의 소스코드는 Lua 스크립트에서 C의 <code class="highlighter-rouge">c_xor</code> 함수를 호출하고 결과를 출력하는 예제입니다.</p>

<p>C에서 lua_pushcfunction 함수를 이용해 c_xor 함수를 등록하면 Lua에서 해당 함수를 호출할 수 있게 됩니다. 반대로 Lua에서 선언된 함수를 C에서 호출하는 것도 가능합니다.</p>

<p>c_xor 함수에서는 lua_tointeger 함수를 이용해 Lua로부터 전달받은 인자를 C의 long형으로 변환하여 가져왔는데 아래처럼 다른 형식으로도 인자를 가져올 수 있도록 여러 함수를 지원합니다.</p>

<p><a href="https://www.notion.so/c205aad4e6bc492daa626c6817b12473">Lua 형식 변환 함수</a></p>

<p>이외에 lua_toboolean 같은 함수들도 있는데 <a href="https://www.lua.org/manual/5.3/manual.html">https://www.lua.org/manual/5.3/manual.html</a>에서 자세한 레퍼런스를 확인할 수 있습니다.</p>

<p>함수 반환 값의 경우 Lua는 반환 값을 한번에 여러 개 전달할 수 있는데 여기서는 1개만 전달할 것이므로 result 변수 값을 푸시(<code class="highlighter-rouge">lua_pushinteger(L, result)</code>)하고 <code class="highlighter-rouge">return 1</code>을 합니다.</p>

<p><img src="/assets/a06b3ab7-951c-4437-ac29-bba22f3bf0f4/dfebf1b1-02d8-427b-81b1-19edaeb1441e.png" alt="/assets/a06b3ab7-951c-4437-ac29-bba22f3bf0f4/dfebf1b1-02d8-427b-81b1-19edaeb1441e.png" /></p>

<p>컴파일은 <strong>gcc -o lua-example lua-example.c -llua5.3</strong> 명령어로 가능하고, 예제 실행 결과는 123과 456을 xor한 435가 출력됩니다.</p>

<h1 id="3-후킹-스크립트-기능-구현">3. 후킹 스크립트 기능 구현</h1>

<hr />

<p>후킹 용도는 사용자마다 다양하기 때문에 아래와 같은 형식으로 후킹이 가능하면 좋을 것 같다고 판단하였습니다. 해당 인터페이스로 구현하면 사용자는 새롭게 정의한 함수에서 원본 함수를 호출하지 않을 수도 있고 함수의 인자값을 조작하거나 반환 값을 변경할 수 있습니다.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">new_open</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">original_open</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">hook</span><span class="p">(</span><span class="s2">"open"</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"new_open"</span><span class="p">,</span> <span class="s2">"original_open"</span><span class="p">)</span>
</code></pre></div></div>

<p>위와 같은 형태로 구현하기 위해서는 다음과 같은 과정이 필요합니다.</p>

<ol>
  <li>hook 함수를 호출했을 때 open 함수 후킹</li>
  <li>후킹된 open 함수가 호출되었을때 Lua에서 정의한 new_open 함수 호출</li>
  <li>Lua 내에서 original_open 함수를 호출했을때 원본 open 함수 호출</li>
  <li>Lua의 new_open 함수에서 반환된 값을 open 반환 값으로 전달</li>
</ol>

<p>1번의 경우 편의상 frida-gum 모듈을 사용하였는데 원본 함수가 반드시 호출되는 Interceptor 대신 Replace 기능을 사용하였습니다. Replace의 경우 후킹된 함수가 반환하기 전에 다시 함수를 호출해주면 원본 함수가 호출되도록 구현되어있습니다.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		<span class="n">gum_init_embedded</span><span class="p">();</span>
    <span class="n">interceptor</span> <span class="o">=</span> <span class="n">gum_interceptor_obtain</span><span class="p">();</span>
    <span class="n">gum_interceptor_begin_transaction</span> <span class="p">(</span><span class="n">interceptor</span><span class="p">);</span>

    <span class="n">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">lua_replace_attach</span><span class="p">);</span>
    <span class="n">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">"hook"</span><span class="p">);</span>

    <span class="n">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">lua_pointer_to_string</span><span class="p">);</span>
    <span class="n">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">"p2string"</span><span class="p">);</span>

    <span class="n">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">lua_pointer_to_number</span><span class="p">);</span>
    <span class="n">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">"p2number"</span><span class="p">);</span>

    <span class="n">luaL_dofile</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">"hook.lua"</span><span class="p">);</span>

    <span class="n">gum_interceptor_end_transaction</span> <span class="p">(</span><span class="n">interceptor</span><span class="p">);</span>
</code></pre></div></div>

<p>이제 실제 구현을 위해 사용자에게 제공할 여러 함수를 정의합니다.
luaL_dofile가 호출되면 사용자가 작성한 Lua 스크립트를 파싱하여 사용자가 요구한 함수들을 후킹하게 됩니다.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_HookChain</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">argc</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">fn</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">newfn</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">orifn</span><span class="p">;</span>
<span class="p">}</span> <span class="n">HookChain</span><span class="p">,</span> <span class="o">*</span><span class="n">LpHookChain</span><span class="p">;</span>
<span class="n">HookChain</span> <span class="n">hc</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lua_replace_attach</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//printf("lua_replace_attach:: called\n");</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fn</span> <span class="o">=</span> <span class="n">luaL_checkstring</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">argc</span> <span class="o">=</span> <span class="n">luaL_checknumber</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">newfn</span> <span class="o">=</span> <span class="n">luaL_checkstring</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">orifn</span> <span class="o">=</span> <span class="n">luaL_checkstring</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

    <span class="n">hc</span><span class="p">[</span><span class="n">g_count</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">g_count</span><span class="p">;</span>
    <span class="n">hc</span><span class="p">[</span><span class="n">g_count</span><span class="p">].</span><span class="n">argc</span> <span class="o">=</span> <span class="n">argc</span><span class="p">;</span>
    <span class="n">string_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="p">[</span><span class="n">g_count</span><span class="p">].</span><span class="n">fn</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
    <span class="n">string_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="p">[</span><span class="n">g_count</span><span class="p">].</span><span class="n">newfn</span><span class="p">,</span> <span class="n">newfn</span><span class="p">);</span>
    <span class="n">string_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="p">[</span><span class="n">g_count</span><span class="p">].</span><span class="n">orifn</span><span class="p">,</span> <span class="n">orifn</span><span class="p">);</span>

    <span class="n">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">(</span><span class="n">lua_CFunction</span><span class="p">)</span><span class="n">original_function_handler</span><span class="p">);</span>
    <span class="n">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">orifn</span><span class="p">);</span>

    <span class="n">gum_interceptor_replace</span> <span class="p">(</span><span class="n">interceptor</span><span class="p">,</span>
            <span class="p">(</span><span class="n">gpointer</span><span class="p">)</span> <span class="n">gum_module_find_export_by_name</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="n">hook_handler</span><span class="p">,</span> <span class="n">GSIZE_TO_POINTER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="p">[</span><span class="n">g_count</span><span class="p">]));</span>

    <span class="n">lua_pushinteger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">g_count</span><span class="o">++</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Lua에서 hook함수를 호출하면 C 함수 lua_interceptor_attach가 호출되는데 총 4개의 인자를 받아서 처리합니다.</p>

<p>1번째 인자는 후킹할 함수의 exported된 이름인데 gum_module_find_export_by_name로 함수의 포인터로 전환되고 gum_interceptor_replace를 통해 후킹되게 됩니다.</p>

<p>2~4번째 인자는 각각 함수 인자의 갯수, 후킹되었을때 호출될 Lua 함수명, 원본함수로 쓸 Lua 함수명입니다.</p>

<p>후킹된 모든 함수는 공통적으로 hook_handler로 넘겨지고 1~4번째 인자 정보를 담은 데이터를 HookChain 구조체로 전달합니다.</p>

<p>추가적으로 Lua 스크립트에서 원본 함수를 호출할 수 있도록 별도의 함수(original_function_handler)를 정의해줍니다.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">long</span> <span class="nf">hook_handler</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">GumInvocationContext</span> <span class="o">*</span><span class="n">ic</span> <span class="o">=</span> <span class="n">gum_interceptor_get_current_invocation</span><span class="p">();</span>
    <span class="n">LpHookChain</span> <span class="n">hc</span> <span class="o">=</span> <span class="p">(</span><span class="n">LpHookChain</span><span class="p">)</span><span class="n">gum_invocation_context_get_replacement_data</span><span class="p">(</span><span class="n">ic</span><span class="p">);</span>
    <span class="c1">//printf("hook_handler:: id=%d func=%s\n", hc-&gt;id, hc-&gt;fn);</span>

    <span class="n">lua_getglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">newfn</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lua_pushlightuserdata</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">gum_invocation_context_get_nth_argument</span> <span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">lua_pcall</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="kt">long</span> <span class="n">ret_value</span> <span class="o">=</span> <span class="n">lua_tointeger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">lua_pop</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>후킹된 함수가 호출되었을때 hook_handler 함수가 실행되고 gum_invocation_context_get_replacement_data로 아까 저장했던 인자 데이터를 다시 가져옵니다.</p>

<p>두번째 인자로 전달받은 함수 인자 갯수(hc-&gt;argc)만큼 Lua인자를 push해주는데 인자가 string 타입인지 long 타입인지 정보를 알 수 없으므로 사용자 데이터 형식으로 인자를 전달한다음 Lua 함수를 호출합니다.</p>

<p>여기서 Lua 함수는 new_open이 됩니다.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">printf</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">new_open</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">original_open</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span>

    <span class="n">printf</span><span class="p">(</span><span class="s2">"new_open(%s, %d) =&gt; %d"</span><span class="p">,</span> <span class="n">p2string</span><span class="p">(</span><span class="n">pathname</span><span class="p">),</span> <span class="n">p2number</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">ret</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span> <span class="nf">lua_pointer_to_string</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span> <span class="c1">//p2string</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">lua_touserdata</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">lua_pushstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lua_pointer_to_number</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span> <span class="c1">//p2number</span>
<span class="p">{</span>
    <span class="kt">long</span> <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">lua_touserdata</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">lua_pushinteger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Lua 함수 new_open에서 pathname과 flag는 사용자 데이터이므로 이를 가공하고 출력하려면 Lua 형식으로 데이터를 변환할 필요성이 있습니다. 본문에서는 p2string, p2number와 같은 함수를 제공해주는 방식으로 해결하였습니다.</p>

<p>original_xxx 원본 함수 호출에 대한 구현은 다음의 방법으로 진행하였습니다.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LpHookChain</span> <span class="nf">find_by_original_function</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">orifn</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">orifn</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">g_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">hc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">orifn</span><span class="p">,</span> <span class="n">orifn</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">&amp;</span><span class="n">hc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">original_function_handler</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">lua_Debug</span> <span class="n">ar</span><span class="p">;</span>
    <span class="n">lua_getstack</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="p">);</span>
    <span class="n">lua_getinfo</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">"nSl"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="p">);</span>
    <span class="c1">//printf("original_function_handler:: %s\n", ar.name);</span>

    <span class="n">LpHookChain</span> <span class="n">hc</span> <span class="o">=</span> <span class="n">find_by_original_function</span><span class="p">(</span><span class="n">ar</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
    <span class="n">gpointer</span> <span class="n">fnpointer</span> <span class="o">=</span> <span class="p">(</span><span class="n">gpointer</span><span class="p">)</span><span class="n">gum_module_find_export_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">);</span>

    <span class="k">typedef</span> <span class="k">union</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">integer</span><span class="p">;</span>
        <span class="kt">double</span> <span class="n">number</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">variant</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">argc</span> <span class="o">=</span> <span class="n">lua_gettop</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
    <span class="n">variant</span> <span class="o">*</span><span class="n">argv</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">argc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">variant</span><span class="p">));</span>

    <span class="n">ffi_cif</span> <span class="n">cif</span><span class="p">;</span>
    <span class="n">ffi_type</span> <span class="o">**</span><span class="n">types</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">argc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ffi_type</span> <span class="o">*</span><span class="p">));</span>
    <span class="kt">void</span> <span class="o">**</span><span class="n">values</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">argc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">typ</span> <span class="o">=</span> <span class="n">lua_type</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">case</span> <span class="n">LUA_TNUMBER</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">lua_isinteger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ffi_type_sint</span><span class="p">;</span>
                <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">integer</span> <span class="o">=</span> <span class="n">lua_tointeger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
                <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">integer</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ffi_type_double</span><span class="p">;</span>
                <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">number</span> <span class="o">=</span> <span class="n">lua_tonumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
                <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">number</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">LUA_TSTRING</span><span class="p">:</span>
            <span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ffi_type_pointer</span><span class="p">;</span>
            <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">string</span> <span class="o">=</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
            <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">string</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">LUA_TLIGHTUSERDATA</span><span class="p">:</span>
            <span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ffi_type_pointer</span><span class="p">;</span>
            <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">string</span> <span class="o">=</span> <span class="n">lua_touserdata</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
            <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">string</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="nl">default:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Unhandled argment type=%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">typ</span><span class="p">);</span>
            <span class="n">abort</span><span class="p">();</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ffi_prep_cif</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cif</span><span class="p">,</span> <span class="n">FFI_DEFAULT_ABI</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ffi_type_sint</span><span class="p">,</span> <span class="n">types</span><span class="p">)</span> <span class="o">==</span> <span class="n">FFI_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ffi_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cif</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">fnpointer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="n">values</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">free</span><span class="p">(</span><span class="n">values</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">types</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>

    <span class="n">lua_pushinteger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Lua에서 호출하는 original_xxx 원본 함수들은 모두 original_function_handler 함수로 호출됩니다.</p>

<p>함수 구분은 Lua 함수명을 통해 가능하고 find_by_original_function을 통해 HookChain 구조체 정보를 가져올 수 있습니다.</p>

<p>Lua로부터 전달받은 인자의 속성이 LUA_TLIGHTUSERDATA이면 lua_touserdata로 변환해 그대로 원본 함수로 넘겨주고 long형이나 문자열 같은 데이터로 확인되면 C 함수로 호출이 가능하도록 적절한 타입으로 변환합니다.</p>

<p>마지막으로 HookChain 구조체를 통해 획득한 원래 함수에 대한 포인터와 인자 정보로 함수를 동적으로 호출해야 하는 문제를 ffi 라이브러리를 사용하여 해결하였습니다.</p>

<h1 id="4-실행--테스트">4. 실행 / 테스트</h1>

<hr />

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">printf</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">new_open</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">original_open</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span>

    <span class="n">printf</span><span class="p">(</span><span class="s2">"new_open(%s, %d) =&gt; %d"</span><span class="p">,</span> <span class="n">p2string</span><span class="p">(</span><span class="n">pathname</span><span class="p">),</span> <span class="n">p2number</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">ret</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">new_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">new_fd</span> <span class="o">=</span> <span class="n">original_open</span><span class="p">(</span><span class="s2">"/etc/hosts"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">original_read</span><span class="p">(</span><span class="n">new_fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

    <span class="n">printf</span><span class="p">(</span><span class="s2">"new_read(%d, %s, %d) =&gt; %d"</span><span class="p">,</span> <span class="n">new_fd</span><span class="p">,</span> <span class="n">p2string</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">p2number</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="n">ret</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>
<span class="k">end</span>

<span class="n">hook</span><span class="p">(</span><span class="s2">"open"</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"new_open"</span><span class="p">,</span> <span class="s2">"original_open"</span><span class="p">)</span>
<span class="n">hook</span><span class="p">(</span><span class="s2">"read"</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">"new_read"</span><span class="p">,</span> <span class="s2">"original_read"</span><span class="p">)</span>
</code></pre></div></div>

<p>위의 작성된 스크립트를 실행하면 read하는 모든 내용을 <code class="highlighter-rouge">/etc/hosts</code>파일의 내용으로 조작하여 반환할 수 있습니다.</p>

<p><strong>후킹 후 open, read 함수 호출</strong></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/etc/passwd"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">200</span><span class="p">];</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"[%d]</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">100</span><span class="p">));</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"buf =&gt; [%s]</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/assets/1860fb18-5071-4472-acb5-1b67e938ab2f/8646f3a2-35a0-4fa6-9cc7-70a7147767f3.png" alt="/assets/1860fb18-5071-4472-acb5-1b67e938ab2f/8646f3a2-35a0-4fa6-9cc7-70a7147767f3.png" /></p>

<p>실행결과, <code class="highlighter-rouge">/etc/passwd</code> 내용 대신 <code class="highlighter-rouge">/etc/hosts</code>로 조작되는 것을 확인할 수 있습니다.</p>

<h1 id="5-마치며">5. 마치며</h1>

<hr />

<p>Lua가 개발자 입장에서는 C/C++에 이식하기 편하고 가벼워 활용하기에는 좋았지만 사용자 입장에서는 생소한 문법일 수 있고 JS나 Python같이 기본적인 라이브러리를 많이 지원하지않는 것에 대해서는 아쉬움이 있었습니다.</p>

<p>Embedded JS나 Python으로 위와 비슷한 기능을 구현한다거나 Lua로 사용자를 위한 스크립트 기능을 구현해야할 일이 있다면 해당 문서를 참고하면 좋을 것 같습니다.</p>

   </div>
</div>


  <!-- Start disqus 
<script src="/assets/js/disqusLoader.js" /></script>
<div id="disqus_thread"><h3>Discussion and feedback</h3></div>
<div class="disqus"></div>
<script>
    disqusLoader('.disqus', {
        scriptUrl: 'https://jekyll-tale.disqus.com/embed.js'
    });
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
End disqus -->


<div class="pagination">
  
   <a href="/2020-05-01/iframe-broker-Story-of-Facebook-DOM-XSS" class="left arrow">&#8592;</a>
  
  
   <a href="/2020-05-01/HTTP-Request-Smuggling-HTTP-Desync-Attack-be0e1c6035f84533af79463b3ec49d75" class="right arrow">&#8594;</a>
  

  <a href="#" class="top">Top</a>
</div>
    </main>

    <!--footer>
  <span>
    &copy; <time datetime="2020-09-02 01:18:08 +0000">2020</time> Core-Research-Team. Made with Jekyll using the <a href="https://github.com/chesterhow/tale/">Tale</a> theme.
  </span>
</footer-->

  </body>
</html>
